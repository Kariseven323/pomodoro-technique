<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","analysis.rs"],"content":"//! 专注时段分析：基于历史记录统计时段/星期/标签效率，并生成摘要文案。\n\nuse std::collections::BTreeMap;\n\nuse chrono::{Datelike as _, NaiveDate, Weekday};\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::{DateRange, HistoryDay};\nuse crate::errors::{AppError, AppResult};\n\n/// 专注分析结果（用于前端图表渲染）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct FocusAnalysis {\n    /// 24 小时分布（按 `startTime` 的小时计数）。\n    pub hourly_counts: Vec\u003cu32\u003e,\n    /// 时段分布：`[0-6, 6-12, 12-18, 18-24]`。\n    pub period_counts: Vec\u003cu32\u003e,\n    /// 星期分布：`[周一..周日]`。\n    pub weekday_counts: Vec\u003cu32\u003e,\n    /// 交叉热力：`weekday_hour_counts[weekday][hour]`（7x24）。\n    pub weekday_hour_counts: Vec\u003cVec\u003cu32\u003e\u003e,\n    /// 标签效率：各标签平均专注时长（分钟）。\n    pub tag_efficiency: Vec\u003cTagEfficiency\u003e,\n    /// 文字总结（示例：「你在上午 9-11 点专注效率最高」）。\n    pub summary: String,\n}\n\n/// 标签效率条目。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TagEfficiency {\n    /// 标签名。\n    pub tag: String,\n    /// 平均时长（分钟）。\n    pub avg_duration: f64,\n    /// 样本数（番茄数量）。\n    pub count: u32,\n}\n\n/// 生成指定日期范围的专注分析（输入为按日分组的历史数据切片）。\npub fn get_focus_analysis(days: \u0026[HistoryDay], range: \u0026DateRange) -\u003e AppResult\u003cFocusAnalysis\u003e {\n    let (from, to) = parse_range(range)?;\n\n    let mut hourly = vec![0u32; 24];\n    let mut periods = vec![0u32; 4];\n    let mut weekday_counts = vec![0u32; 7];\n    let mut matrix = vec![vec![0u32; 24]; 7];\n\n    let mut tag_total: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n    let mut tag_count: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n\n    for day in days {\n        let day_date = match NaiveDate::parse_from_str(\u0026day.date, \"%Y-%m-%d\") {\n            Ok(d) =\u003e d,\n            Err(_) =\u003e continue,\n        };\n        if day_date \u003c from || day_date \u003e to {\n            continue;\n        }\n\n        let weekday_index = weekday_to_index(day_date.weekday());\n        for r in \u0026day.records {\n            let hour = parse_hour(\u0026r.start_time).unwrap_or(0);\n            hourly[hour] += 1;\n            periods[period_index(hour)] += 1;\n            weekday_counts[weekday_index] += 1;\n            matrix[weekday_index][hour] += 1;\n\n            *tag_total.entry(r.tag.clone()).or_insert(0) += r.duration;\n            *tag_count.entry(r.tag.clone()).or_insert(0) += 1;\n        }\n    }\n\n    let mut tag_efficiency: Vec\u003cTagEfficiency\u003e = tag_total\n        .into_iter()\n        .map(|(tag, total)| {\n            let count = tag_count.get(\u0026tag).copied().unwrap_or(0);\n            let avg = if count == 0 {\n                0.0\n            } else {\n                total as f64 / count as f64\n            };\n            TagEfficiency {\n                tag,\n                avg_duration: avg,\n                count,\n            }\n        })\n        .collect();\n\n    // 让“标签效率”更直观：按样本数/平均时长排序。\n    tag_efficiency.sort_by(|a, b| {\n        b.count\n            .cmp(\u0026a.count)\n            .then_with(|| b.avg_duration.total_cmp(\u0026a.avg_duration))\n    });\n\n    let summary = build_summary(\u0026hourly);\n\n    Ok(FocusAnalysis {\n        hourly_counts: hourly,\n        period_counts: periods,\n        weekday_counts,\n        weekday_hour_counts: matrix,\n        tag_efficiency,\n        summary,\n    })\n}\n\n/// 解析日期范围，并确保 `from \u003c= to`。\nfn parse_range(range: \u0026DateRange) -\u003e AppResult\u003c(NaiveDate, NaiveDate)\u003e {\n    let from = NaiveDate::parse_from_str(range.from.trim(), \"%Y-%m-%d\")\n        .map_err(|_| AppError::Validation(\"range.from 必须为 YYYY-MM-DD\".to_string()))?;\n    let to = NaiveDate::parse_from_str(range.to.trim(), \"%Y-%m-%d\")\n        .map_err(|_| AppError::Validation(\"range.to 必须为 YYYY-MM-DD\".to_string()))?;\n    if from \u003e to {\n        return Err(AppError::Validation(\n            \"日期范围不合法：from 不能晚于 to\".to_string(),\n        ));\n    }\n    Ok((from, to))\n}\n\n/// 从 `HH:mm` 中解析小时（0-23）。\nfn parse_hour(hhmm: \u0026str) -\u003e Option\u003cusize\u003e {\n    let hh = hhmm.split(':').next()?.trim();\n    let hour: usize = hh.parse().ok()?;\n    if hour \u003c 24 {\n        Some(hour)\n    } else {\n        None\n    }\n}\n\n/// 将小时映射到 4 个时段桶：0-6 / 6-12 / 12-18 / 18-24。\nfn period_index(hour: usize) -\u003e usize {\n    match hour {\n        0..=5 =\u003e 0,\n        6..=11 =\u003e 1,\n        12..=17 =\u003e 2,\n        _ =\u003e 3,\n    }\n}\n\n/// 将 chrono `Weekday` 转为 `[周一..周日]` 索引。\nfn weekday_to_index(weekday: Weekday) -\u003e usize {\n    match weekday {\n        Weekday::Mon =\u003e 0,\n        Weekday::Tue =\u003e 1,\n        Weekday::Wed =\u003e 2,\n        Weekday::Thu =\u003e 3,\n        Weekday::Fri =\u003e 4,\n        Weekday::Sat =\u003e 5,\n        Weekday::Sun =\u003e 6,\n    }\n}\n\n/// 生成摘要：取番茄数量最多的连续 2 小时窗口。\nfn build_summary(hourly: \u0026[u32]) -\u003e String {\n    if hourly.len() != 24 {\n        return \"暂无分析数据\".to_string();\n    }\n    let total: u32 = hourly.iter().sum();\n    if total == 0 {\n        return \"暂无分析数据\".to_string();\n    }\n\n    let mut best_start = 0usize;\n    let mut best_sum = 0u32;\n    for start in 0..23 {\n        let sum = hourly[start] + hourly[start + 1];\n        if sum \u003e best_sum {\n            best_sum = sum;\n            best_start = start;\n        }\n    }\n\n    let label = time_range_label(best_start, best_start + 2);\n    format!(\"你在{}专注效率最高\", label)\n}\n\n/// 将小时范围格式化为更自然的中文时段描述（例如“上午 9-11 点”）。\nfn time_range_label(from_hour: usize, to_hour: usize) -\u003e String {\n    let (prefix, display_from, display_to) = if from_hour \u003c 6 {\n        (\"凌晨\", from_hour, to_hour)\n    } else if from_hour \u003c 12 {\n        (\"上午\", from_hour, to_hour)\n    } else if from_hour \u003c 18 {\n        (\"下午\", from_hour - 12, to_hour - 12)\n    } else {\n        (\"晚上\", from_hour - 12, to_hour - 12)\n    };\n\n    // 处理 12/24 的显示：避免出现 “下午 0 点”。\n    let normalize = |h: usize, is_pm: bool| -\u003e usize {\n        if is_pm \u0026\u0026 h == 0 {\n            12\n        } else {\n            h\n        }\n    };\n    let is_pm = prefix == \"下午\" || prefix == \"晚上\";\n    let f = normalize(display_from, is_pm);\n    let t = normalize(display_to, is_pm);\n    format!(\"{prefix} {f}-{t} 点\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{HistoryRecord, Phase};\n\n    /// 构造一条最小的历史记录（用于专注分析测试）。\n    fn record(tag: \u0026str, start_time: \u0026str, duration: u32) -\u003e HistoryRecord {\n        HistoryRecord {\n            tag: tag.to_string(),\n            start_time: start_time.to_string(),\n            end_time: None,\n            duration,\n            phase: Phase::Work,\n            remark: String::new(),\n        }\n    }\n\n    /// `parse_range`：合法范围应通过，并返回正确的 NaiveDate。\n    #[test]\n    fn parse_range_accepts_valid_range() {\n        let (from, to) = parse_range(\u0026DateRange {\n            from: \"2025-01-01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .unwrap();\n        assert_eq!(from, NaiveDate::from_ymd_opt(2025, 1, 1).unwrap());\n        assert_eq!(to, NaiveDate::from_ymd_opt(2025, 1, 7).unwrap());\n    }\n\n    /// `parse_range`：当 from \u003e to 时应返回校验错误。\n    #[test]\n    fn parse_range_rejects_from_after_to() {\n        let err = parse_range(\u0026DateRange {\n            from: \"2025-01-08\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `parse_range`：日期格式错误应返回校验错误。\n    #[test]\n    fn parse_range_rejects_invalid_format() {\n        let err = parse_range(\u0026DateRange {\n            from: \"2025/01/01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `parse_hour`：应支持边界值（00:00/23:59）与常见格式。\n    #[test]\n    fn parse_hour_supports_boundaries() {\n        assert_eq!(parse_hour(\"00:00\"), Some(0));\n        assert_eq!(parse_hour(\"23:59\"), Some(23));\n        assert_eq!(parse_hour(\" 9:01 \"), Some(9));\n    }\n\n    /// `parse_hour`：非法格式应返回 None。\n    #[test]\n    fn parse_hour_rejects_invalid_format() {\n        assert_eq!(parse_hour(\"\"), None);\n        assert_eq!(parse_hour(\"xx:yy\"), None);\n        assert_eq!(parse_hour(\"24:00\"), None);\n        assert_eq!(parse_hour(\"12\"), Some(12));\n    }\n\n    /// `period_index`：应按 0/6/12/18 边界映射到 4 个时段桶。\n    #[test]\n    fn period_index_respects_boundaries() {\n        assert_eq!(period_index(0), 0);\n        assert_eq!(period_index(5), 0);\n        assert_eq!(period_index(6), 1);\n        assert_eq!(period_index(11), 1);\n        assert_eq!(period_index(12), 2);\n        assert_eq!(period_index(17), 2);\n        assert_eq!(period_index(18), 3);\n        assert_eq!(period_index(23), 3);\n    }\n\n    /// `weekday_to_index`：应将周一到周日映射为 0..=6。\n    #[test]\n    fn weekday_to_index_maps_mon_to_sun() {\n        assert_eq!(weekday_to_index(Weekday::Mon), 0);\n        assert_eq!(weekday_to_index(Weekday::Tue), 1);\n        assert_eq!(weekday_to_index(Weekday::Wed), 2);\n        assert_eq!(weekday_to_index(Weekday::Thu), 3);\n        assert_eq!(weekday_to_index(Weekday::Fri), 4);\n        assert_eq!(weekday_to_index(Weekday::Sat), 5);\n        assert_eq!(weekday_to_index(Weekday::Sun), 6);\n    }\n\n    /// `build_summary`：空数据应返回“暂无分析数据”。\n    #[test]\n    fn build_summary_returns_no_data_when_empty() {\n        assert_eq!(build_summary(\u0026vec![0u32; 24]), \"暂无分析数据\");\n    }\n\n    /// `build_summary`：应选择番茄数量最多的连续 2 小时窗口。\n    #[test]\n    fn build_summary_picks_best_two_hour_window() {\n        let mut hourly = vec![0u32; 24];\n        hourly[8] = 1;\n        hourly[9] = 3;\n        hourly[10] = 3; // 9-11 窗口合计 6，为最大\n        hourly[11] = 1;\n        let summary = build_summary(\u0026hourly);\n        assert!(summary.contains(\"专注效率最高\"));\n        assert!(summary.contains(\"上午 9-11 点\"));\n    }\n\n    /// `time_range_label`：应按凌晨/上午/下午/晚上输出，并处理 12 点边界。\n    #[test]\n    fn time_range_label_formats_periods_and_12_boundary() {\n        assert_eq!(time_range_label(0, 2), \"凌晨 0-2 点\");\n        assert_eq!(time_range_label(6, 8), \"上午 6-8 点\");\n        assert_eq!(time_range_label(12, 14), \"下午 12-2 点\");\n        assert_eq!(time_range_label(18, 20), \"晚上 6-8 点\");\n    }\n\n    /// `get_focus_analysis`：空历史应返回全 0 分布与“暂无分析数据”摘要。\n    #[test]\n    fn get_focus_analysis_handles_empty_days() {\n        let out = get_focus_analysis(\n            \u0026[],\n            \u0026DateRange {\n                from: \"2025-01-01\".to_string(),\n                to: \"2025-01-07\".to_string(),\n            },\n        )\n        .unwrap();\n        assert_eq!(out.hourly_counts, vec![0u32; 24]);\n        assert_eq!(out.period_counts, vec![0u32; 4]);\n        assert_eq!(out.weekday_counts, vec![0u32; 7]);\n        assert_eq!(out.weekday_hour_counts.len(), 7);\n        assert_eq!(out.weekday_hour_counts[0].len(), 24);\n        assert_eq!(out.tag_efficiency.len(), 0);\n        assert_eq!(out.summary, \"暂无分析数据\");\n    }\n\n    /// `get_focus_analysis`：单日数据应正确累计小时/时段/星期与标签效率。\n    #[test]\n    fn get_focus_analysis_handles_single_day() {\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(), // 2025-01-01 是周三\n            records: vec![\n                record(\"学习\", \"09:10\", 25),\n                record(\"学习\", \"09:40\", 30),\n                record(\"工作\", \"10:00\", 15),\n            ],\n        }];\n\n        let out = get_focus_analysis(\n            \u0026days,\n            \u0026DateRange {\n                from: \"2025-01-01\".to_string(),\n                to: \"2025-01-01\".to_string(),\n            },\n        )\n        .unwrap();\n\n        assert_eq!(out.hourly_counts[9], 2);\n        assert_eq!(out.hourly_counts[10], 1);\n        assert_eq!(out.period_counts[1], 3); // 6-12\n\n        // 周三 -\u003e index 2\n        assert_eq!(out.weekday_counts[2], 3);\n        assert_eq!(out.weekday_hour_counts[2][9], 2);\n        assert_eq!(out.weekday_hour_counts[2][10], 1);\n\n        // 标签效率按样本数排序：学习(2) 在前\n        assert_eq!(out.tag_efficiency[0].tag, \"学习\");\n        assert_eq!(out.tag_efficiency[0].count, 2);\n        assert!((out.tag_efficiency[0].avg_duration - 27.5).abs() \u003c 1e-9);\n        assert_eq!(out.tag_efficiency[1].tag, \"工作\");\n        assert_eq!(out.tag_efficiency[1].count, 1);\n        assert!((out.tag_efficiency[1].avg_duration - 15.0).abs() \u003c 1e-9);\n    }\n\n    /// `get_focus_analysis`：日期范围应为闭区间，并忽略范围外数据与非法日期。\n    #[test]\n    fn get_focus_analysis_respects_inclusive_range_and_skips_invalid_dates() {\n        let days = vec![\n            HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![record(\"A\", \"08:00\", 25)],\n            },\n            HistoryDay {\n                date: \"2025-01-02\".to_string(),\n                records: vec![record(\"B\", \"09:00\", 25)],\n            },\n            HistoryDay {\n                date: \"2025-01-03\".to_string(),\n                records: vec![record(\"C\", \"10:00\", 25)],\n            },\n            HistoryDay {\n                date: \"bad-date\".to_string(),\n                records: vec![record(\"D\", \"11:00\", 25)],\n            },\n        ];\n\n        let out = get_focus_analysis(\n            \u0026days,\n            \u0026DateRange {\n                from: \"2025-01-02\".to_string(),\n                to: \"2025-01-03\".to_string(),\n            },\n        )\n        .unwrap();\n\n        assert_eq!(out.hourly_counts[8], 0);\n        assert_eq!(out.hourly_counts[9], 1);\n        assert_eq!(out.hourly_counts[10], 1);\n        assert_eq!(out.tag_efficiency.len(), 2);\n        assert_eq!(out.tag_efficiency[0].tag, \"B\");\n        assert_eq!(out.tag_efficiency[1].tag, \"C\");\n    }\n}\n","traces":[{"line":45,"address":[33103673,33104996,33101984],"length":1,"stats":{"Line":1}},{"line":46,"address":[65727985],"length":1,"stats":{"Line":1}},{"line":48,"address":[33102269],"length":1,"stats":{"Line":1}},{"line":49,"address":[33102344],"length":1,"stats":{"Line":1}},{"line":50,"address":[33102389],"length":1,"stats":{"Line":1}},{"line":51,"address":[33102554,33102461],"length":1,"stats":{"Line":2}},{"line":53,"address":[33102577],"length":1,"stats":{"Line":1}},{"line":54,"address":[33102622],"length":1,"stats":{"Line":1}},{"line":56,"address":[65729395],"length":1,"stats":{"Line":2}},{"line":57,"address":[33102885,33103695],"length":1,"stats":{"Line":2}},{"line":58,"address":[33103782],"length":1,"stats":{"Line":1}},{"line":59,"address":[65729676],"length":1,"stats":{"Line":0}},{"line":61,"address":[33103803],"length":1,"stats":{"Line":1}},{"line":65,"address":[33103913],"length":1,"stats":{"Line":1}},{"line":66,"address":[33104890,33103976],"length":1,"stats":{"Line":2}},{"line":67,"address":[33104133],"length":1,"stats":{"Line":1}},{"line":68,"address":[33104242,33104321],"length":1,"stats":{"Line":1}},{"line":69,"address":[33104346,33104309,33104447],"length":1,"stats":{"Line":2}},{"line":70,"address":[33104531,33104470,33104416],"length":1,"stats":{"Line":2}},{"line":71,"address":[33104650,33104562,33104504],"length":1,"stats":{"Line":2}},{"line":73,"address":[33104695,33104785,33104624],"length":1,"stats":{"Line":2}},{"line":74,"address":[33104766,33104895,33104830],"length":1,"stats":{"Line":2}},{"line":78,"address":[33102911],"length":1,"stats":{"Line":1}},{"line":80,"address":[27686515,27686208,27686230],"length":1,"stats":{"Line":3}},{"line":81,"address":[27686324,27686258],"length":1,"stats":{"Line":2}},{"line":82,"address":[27686389,27686375],"length":1,"stats":{"Line":1}},{"line":83,"address":[27686380],"length":1,"stats":{"Line":0}},{"line":85,"address":[27686399],"length":1,"stats":{"Line":1}},{"line":87,"address":[27686473],"length":1,"stats":{"Line":1}},{"line":88,"address":[27686437],"length":1,"stats":{"Line":1}},{"line":89,"address":[27686467],"length":1,"stats":{"Line":1}},{"line":96,"address":[27686128],"length":1,"stats":{"Line":3}},{"line":97,"address":[27686170],"length":1,"stats":{"Line":1}},{"line":98,"address":[27686174],"length":1,"stats":{"Line":1}},{"line":99,"address":[27686193,27686558,27686544],"length":1,"stats":{"Line":3}},{"line":102,"address":[33103122],"length":1,"stats":{"Line":1}},{"line":104,"address":[33103388],"length":1,"stats":{"Line":1}},{"line":105,"address":[33103196],"length":1,"stats":{"Line":1}},{"line":106,"address":[33103236],"length":1,"stats":{"Line":1}},{"line":107,"address":[33103276],"length":1,"stats":{"Line":1}},{"line":108,"address":[33103316],"length":1,"stats":{"Line":1}},{"line":109,"address":[33103356],"length":1,"stats":{"Line":1}},{"line":115,"address":[33099488],"length":1,"stats":{"Line":1}},{"line":116,"address":[33099692,33099526,33099624],"length":1,"stats":{"Line":3}},{"line":117,"address":[33099614,33099664],"length":1,"stats":{"Line":4}},{"line":118,"address":[33099842,33099737,33099922],"length":1,"stats":{"Line":2}},{"line":119,"address":[33099829,33099891],"length":1,"stats":{"Line":1}},{"line":120,"address":[33099968],"length":1,"stats":{"Line":1}},{"line":121,"address":[33100053],"length":1,"stats":{"Line":1}},{"line":122,"address":[33100022],"length":1,"stats":{"Line":1}},{"line":125,"address":[33099996],"length":1,"stats":{"Line":1}},{"line":129,"address":[33099152],"length":1,"stats":{"Line":1}},{"line":130,"address":[33099181],"length":1,"stats":{"Line":1}},{"line":131,"address":[33099329],"length":1,"stats":{"Line":1}},{"line":132,"address":[33099447,33099432],"length":1,"stats":{"Line":2}},{"line":133,"address":[33099454],"length":1,"stats":{"Line":1}},{"line":135,"address":[33099438],"length":1,"stats":{"Line":1}},{"line":140,"address":[33100144],"length":1,"stats":{"Line":1}},{"line":142,"address":[33100154,33100183],"length":1,"stats":{"Line":2}},{"line":143,"address":[33100166,33100222],"length":1,"stats":{"Line":2}},{"line":144,"address":[33100205,33100255],"length":1,"stats":{"Line":2}},{"line":145,"address":[33100239],"length":1,"stats":{"Line":1}},{"line":150,"address":[33101968],"length":1,"stats":{"Line":1}},{"line":151,"address":[33101975],"length":1,"stats":{"Line":1}},{"line":163,"address":[33100819,33100288,33100825],"length":1,"stats":{"Line":1}},{"line":164,"address":[33100331],"length":1,"stats":{"Line":1}},{"line":165,"address":[33100383],"length":1,"stats":{"Line":0}},{"line":167,"address":[33100347],"length":1,"stats":{"Line":1}},{"line":168,"address":[33100371],"length":1,"stats":{"Line":1}},{"line":169,"address":[33100408],"length":1,"stats":{"Line":1}},{"line":172,"address":[33100428],"length":1,"stats":{"Line":1}},{"line":173,"address":[33100437],"length":1,"stats":{"Line":1}},{"line":174,"address":[33100445,33100485],"length":1,"stats":{"Line":2}},{"line":175,"address":[33100999,33100848,33100540],"length":1,"stats":{"Line":2}},{"line":176,"address":[33100988,33101029],"length":1,"stats":{"Line":2}},{"line":177,"address":[33101020],"length":1,"stats":{"Line":1}},{"line":178,"address":[33101024],"length":1,"stats":{"Line":1}},{"line":182,"address":[33100554,33100646],"length":1,"stats":{"Line":1}},{"line":183,"address":[33100703,33100619],"length":1,"stats":{"Line":2}},{"line":187,"address":[33101040],"length":1,"stats":{"Line":1}},{"line":188,"address":[33101367,33101083,33101146],"length":1,"stats":{"Line":3}},{"line":189,"address":[33101112],"length":1,"stats":{"Line":1}},{"line":190,"address":[33101094,33101208],"length":1,"stats":{"Line":2}},{"line":191,"address":[33101174],"length":1,"stats":{"Line":1}},{"line":192,"address":[33101156,33101352,33101536],"length":1,"stats":{"Line":3}},{"line":193,"address":[33101459,33101243,33101541],"length":1,"stats":{"Line":2}},{"line":195,"address":[33101218,33101354,33101275],"length":1,"stats":{"Line":2}},{"line":199,"address":[27686048],"length":1,"stats":{"Line":1}},{"line":200,"address":[27686074,27686088],"length":1,"stats":{"Line":2}},{"line":201,"address":[27686101],"length":1,"stats":{"Line":1}},{"line":203,"address":[27686083],"length":1,"stats":{"Line":1}},{"line":206,"address":[33101426,33101554],"length":1,"stats":{"Line":2}},{"line":207,"address":[33101596],"length":1,"stats":{"Line":1}},{"line":208,"address":[33101634],"length":1,"stats":{"Line":1}},{"line":209,"address":[33101667],"length":1,"stats":{"Line":1}}],"covered":92,"coverable":95},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","app_data.rs"],"content":"//! PRD 约定的数据结构（settings / blacklist / tags / history）。\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\n/// Store 文件名（最终路径由后端根据平台解析到统一的数据根目录下）。\npub const STORE_FILE_NAME: \u0026str = \"pomodoro-data.json\";\n\n/// Store 内部主键（保存整棵 `AppData`）。\npub const STORE_KEY: \u0026str = \"appData\";\n\n/// 计时器/历史记录阶段（与前端 `Phase` 类型对齐）。\n#[derive(Debug, Copy, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub enum Phase {\n    /// 工作（番茄）。\n    Work,\n    /// 短休息。\n    ShortBreak,\n    /// 长休息。\n    LongBreak,\n}\n\nimpl Default for Phase {\n    /// 默认阶段：工作（用于旧数据缺失字段时的兼容回填）。\n    fn default() -\u003e Self {\n        Self::Work\n    }\n}\n\n/// 番茄钟设置。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct Settings {\n    /// 工作时长（分钟）。\n    pub pomodoro: u32,\n    /// 短休息时长（分钟）。\n    pub short_break: u32,\n    /// 长休息时长（分钟）。\n    pub long_break: u32,\n    /// 长休息间隔（每 N 个番茄触发）。\n    pub long_break_interval: u32,\n    /// 是否启用“休息结束后自动进入工作倒计时”（连续番茄模式）。\n    #[serde(default)]\n    pub auto_continue_enabled: bool,\n    /// 连续番茄数量：在该次数内，休息结束后自动开始下一次工作倒计时。\n    #[serde(default = \"default_auto_continue_pomodoros\")]\n    pub auto_continue_pomodoros: u32,\n    /// 每日目标番茄数量（0 表示不设目标）。\n    #[serde(default = \"default_daily_goal\")]\n    pub daily_goal: u32,\n    /// 每周目标番茄数量（0 表示不设目标）。\n    #[serde(default = \"default_weekly_goal\")]\n    pub weekly_goal: u32,\n    /// 窗口是否置顶（主窗口）。\n    #[serde(default)]\n    pub always_on_top: bool,\n}\n\n/// 默认连续番茄数量（用于旧版本数据缺失字段时的兼容回填）。\nfn default_auto_continue_pomodoros() -\u003e u32 {\n    4\n}\n\n/// 默认每日目标（PRD v2：8）。\nfn default_daily_goal() -\u003e u32 {\n    8\n}\n\n/// 默认每周目标（PRD v2：40）。\nfn default_weekly_goal() -\u003e u32 {\n    40\n}\n\nimpl Default for Settings {\n    /// PRD 默认设置：25/5/15/4。\n    fn default() -\u003e Self {\n        Self {\n            pomodoro: 25,\n            short_break: 5,\n            long_break: 15,\n            long_break_interval: 4,\n            auto_continue_enabled: false,\n            auto_continue_pomodoros: 4,\n            daily_goal: default_daily_goal(),\n            weekly_goal: default_weekly_goal(),\n            always_on_top: false,\n        }\n    }\n}\n\n/// 黑名单条目（以进程名为主键）。\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct BlacklistItem {\n    /// 进程名（例如 `WeChat.exe`）。\n    pub name: String,\n    /// 展示名（例如 `微信`）。\n    pub display_name: String,\n}\n\n/// 黑名单模板（可内置/可自定义）。\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct BlacklistTemplate {\n    /// 模板 id（内置模板为固定值，自定义模板可为 uuid/自定义字符串）。\n    pub id: String,\n    /// 模板名称。\n    pub name: String,\n    /// 是否为内置模板（内置模板不可删除）。\n    pub builtin: bool,\n    /// 模板包含的黑名单进程集合。\n    pub processes: Vec\u003cBlacklistItem\u003e,\n}\n\n/// 单条历史记录（仅记录完成的“工作”阶段）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct HistoryRecord {\n    /// 任务标签。\n    pub tag: String,\n    /// 开始时间（HH:mm）。\n    pub start_time: String,\n    /// 结束时间（HH:mm；旧数据可能缺失，前端可按 `start_time + duration` 推导展示）。\n    #[serde(default)]\n    pub end_time: Option\u003cString\u003e,\n    /// 本次番茄时长（分钟）。\n    pub duration: u32,\n    /// 阶段类型（用于导出/分析；当前仅记录工作阶段）。\n    #[serde(default)]\n    pub phase: Phase,\n    /// 备注（完成后可填写，也可在历史中编辑）。\n    #[serde(default)]\n    pub remark: String,\n}\n\n/// 某一天的历史集合。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct HistoryDay {\n    /// 日期（YYYY-MM-DD）。\n    pub date: String,\n    /// 当日记录。\n    pub records: Vec\u003cHistoryRecord\u003e,\n}\n\n/// 日期范围（闭区间）：`from \u003c= date \u003c= to`。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct DateRange {\n    /// 起始日期（YYYY-MM-DD）。\n    pub from: String,\n    /// 结束日期（YYYY-MM-DD）。\n    pub to: String,\n}\n\n/// 应用持久化数据根对象。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct AppData {\n    /// 用户设置。\n    pub settings: Settings,\n    /// 进程黑名单。\n    pub blacklist: Vec\u003cBlacklistItem\u003e,\n    /// 黑名单模板列表（包含内置模板与自定义模板）。\n    #[serde(default)]\n    pub blacklist_templates: Vec\u003cBlacklistTemplate\u003e,\n    /// 当前启用的模板 id 列表（支持同时启用多套模板）。\n    #[serde(default)]\n    pub active_template_ids: Vec\u003cString\u003e,\n    /// 兼容字段：旧/示例数据中的单一激活模板（用于自动迁移到 `active_template_ids`）。\n    #[serde(default)]\n    pub active_template_id: Option\u003cString\u003e,\n    /// 历史标签。\n    pub tags: Vec\u003cString\u003e,\n    /// 历史记录（按日分组）。\n    pub history: Vec\u003cHistoryDay\u003e,\n    /// 调试历史记录（仅开发环境使用，与正式数据隔离）。\n    #[serde(default)]\n    pub history_dev: Vec\u003cHistoryDay\u003e,\n}\n\nimpl Default for AppData {\n    /// PRD 初始数据：默认 settings + 默认 tags + 空 blacklist/history。\n    fn default() -\u003e Self {\n        let templates = builtin_templates();\n        let active = vec![\"work\".to_string()];\n        let blacklist = templates\n            .iter()\n            .find(|t| t.id == \"work\")\n            .map(|t| t.processes.clone())\n            .unwrap_or_default();\n\n        Self {\n            settings: Settings::default(),\n            blacklist,\n            blacklist_templates: templates,\n            active_template_ids: active.clone(),\n            active_template_id: active.first().cloned(),\n            tags: vec![\n                \"工作\".to_string(),\n                \"学习\".to_string(),\n                \"阅读\".to_string(),\n                \"写作\".to_string(),\n            ],\n            history: Vec::new(),\n            history_dev: Vec::new(),\n        }\n    }\n}\n\nimpl AppData {\n    /// 将旧版本数据迁移到 v2 结构（回填缺失字段、补齐内置模板、兼容单模板字段）。\n    pub fn migrate_v2(\u0026mut self) -\u003e bool {\n        let mut changed = false;\n\n        if self.blacklist_templates.is_empty() {\n            self.blacklist_templates = builtin_templates();\n            changed = true;\n        }\n\n        if self.active_template_ids.is_empty() {\n            if let Some(id) = self.active_template_id.clone() {\n                self.active_template_ids = vec![id];\n                changed = true;\n            }\n        }\n\n        // 保持 `active_template_id` 与数组一致，便于示例/兼容。\n        let first = self.active_template_ids.first().cloned();\n        if self.active_template_id != first {\n            self.active_template_id = first;\n            changed = true;\n        }\n\n        changed\n    }\n}\n\n/// 构建 PRD v2 内置黑名单模板列表。\nfn builtin_templates() -\u003e Vec\u003cBlacklistTemplate\u003e {\n    vec![\n        BlacklistTemplate {\n            id: \"work\".to_string(),\n            name: \"工作模式\".to_string(),\n            builtin: true,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Douyin.exe\".to_string(),\n                    display_name: \"抖音\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Bilibili.exe\".to_string(),\n                    display_name: \"B站\".to_string(),\n                },\n            ],\n        },\n        BlacklistTemplate {\n            id: \"study\".to_string(),\n            name: \"学习模式\".to_string(),\n            builtin: true,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Steam.exe\".to_string(),\n                    display_name: \"游戏平台\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Bilibili.exe\".to_string(),\n                    display_name: \"视频网站\".to_string(),\n                },\n            ],\n        },\n        BlacklistTemplate {\n            id: \"deep\".to_string(),\n            name: \"深度专注\".to_string(),\n            builtin: true,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Douyin.exe\".to_string(),\n                    display_name: \"抖音\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Bilibili.exe\".to_string(),\n                    display_name: \"B站\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"chrome.exe\".to_string(),\n                    display_name: \"浏览器（Chrome）\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"msedge.exe\".to_string(),\n                    display_name: \"浏览器（Edge）\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"firefox.exe\".to_string(),\n                    display_name: \"浏览器（Firefox）\".to_string(),\n                },\n            ],\n        },\n    ]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// v2 迁移：当模板列表缺失时应补齐内置模板，并修复激活模板字段。\n    #[test]\n    fn migrate_v2_fills_templates_and_active_ids() {\n        let mut data = AppData {\n            blacklist_templates: Vec::new(),\n            active_template_ids: Vec::new(),\n            active_template_id: Some(\"work\".to_string()),\n            ..AppData::default()\n        };\n\n        let changed = data.migrate_v2();\n        assert!(changed);\n        assert!(!data.blacklist_templates.is_empty());\n        assert!(!data.active_template_ids.is_empty());\n        assert_eq!(data.active_template_ids[0], \"work\");\n        assert_eq!(data.active_template_id.as_deref(), Some(\"work\"));\n    }\n\n    /// v2 迁移：应保证 `active_template_id` 与数组首项一致，便于兼容读取。\n    #[test]\n    fn migrate_v2_keeps_active_template_id_in_sync() {\n        let mut data = AppData {\n            active_template_ids: vec![\"deep\".to_string()],\n            active_template_id: Some(\"work\".to_string()),\n            ..AppData::default()\n        };\n\n        let changed = data.migrate_v2();\n        assert!(changed);\n        assert_eq!(data.active_template_id.as_deref(), Some(\"deep\"));\n    }\n\n    /// `Settings::default`：默认值应符合 PRD 约定（25/5/15/4 + 目标值）。\n    #[test]\n    fn settings_default_matches_prd() {\n        let s = Settings::default();\n        assert_eq!(s.pomodoro, 25);\n        assert_eq!(s.short_break, 5);\n        assert_eq!(s.long_break, 15);\n        assert_eq!(s.long_break_interval, 4);\n        assert_eq!(s.auto_continue_enabled, false);\n        assert_eq!(s.auto_continue_pomodoros, 4);\n        assert_eq!(s.daily_goal, 8);\n        assert_eq!(s.weekly_goal, 40);\n        assert_eq!(s.always_on_top, false);\n    }\n\n    /// `builtin_templates`：应包含固定的内置模板集合，且均标记为 builtin。\n    #[test]\n    fn builtin_templates_have_expected_ids_and_flags() {\n        let templates = builtin_templates();\n        assert!(templates.len() \u003e= 3);\n        assert!(templates.iter().all(|t| t.builtin));\n\n        let ids: std::collections::BTreeSet\u003cString\u003e =\n            templates.iter().map(|t| t.id.clone()).collect();\n        assert_eq!(ids.len(), templates.len());\n        assert!(ids.contains(\"work\"));\n        assert!(ids.contains(\"study\"));\n        assert!(ids.contains(\"deep\"));\n    }\n\n    /// `AppData::default`：应填充默认模板/默认激活模板，并回填默认黑名单与标签。\n    #[test]\n    fn app_data_default_initializes_templates_blacklist_and_tags() {\n        let data = AppData::default();\n\n        assert!(!data.blacklist_templates.is_empty());\n        assert_eq!(data.active_template_ids.first().map(|s| s.as_str()), Some(\"work\"));\n        assert_eq!(data.active_template_id.as_deref(), Some(\"work\"));\n\n        let work_template = data\n            .blacklist_templates\n            .iter()\n            .find(|t| t.id == \"work\")\n            .expect(\"work 模板必须存在\");\n        assert_eq!(data.blacklist, work_template.processes);\n\n        assert_eq!(\n            data.tags,\n            vec![\"工作\".to_string(), \"学习\".to_string(), \"阅读\".to_string(), \"写作\".to_string()]\n        );\n        assert!(data.history.is_empty());\n    }\n}\n","traces":[{"line":79,"address":[32995248],"length":1,"stats":{"Line":1}},{"line":87,"address":[32995262],"length":1,"stats":{"Line":1}},{"line":88,"address":[32995271],"length":1,"stats":{"Line":1}},{"line":193,"address":[32992944,32994774,32994722],"length":1,"stats":{"Line":1}},{"line":194,"address":[32992961],"length":1,"stats":{"Line":1}},{"line":195,"address":[32993063,32994769,32993005],"length":1,"stats":{"Line":2}},{"line":196,"address":[32993284,32993382],"length":1,"stats":{"Line":2}},{"line":198,"address":[32120670,32120656],"length":1,"stats":{"Line":3}},{"line":199,"address":[32120720,32120704],"length":1,"stats":{"Line":3}},{"line":203,"address":[32993477],"length":1,"stats":{"Line":1}},{"line":206,"address":[32993602],"length":1,"stats":{"Line":1}},{"line":207,"address":[32993669,32993749],"length":1,"stats":{"Line":2}},{"line":208,"address":[32994103,32994031,32993791,32993959,32994144,32994728,32993896,32993849],"length":1,"stats":{"Line":3}},{"line":214,"address":[32994360],"length":1,"stats":{"Line":1}},{"line":215,"address":[32994419],"length":1,"stats":{"Line":1}},{"line":222,"address":[32957008,32957761,32957790],"length":1,"stats":{"Line":1}},{"line":223,"address":[32957028],"length":1,"stats":{"Line":1}},{"line":225,"address":[32957209,32957049],"length":1,"stats":{"Line":2}},{"line":226,"address":[32957092,32957118],"length":1,"stats":{"Line":1}},{"line":227,"address":[32957204],"length":1,"stats":{"Line":1}},{"line":230,"address":[32957067],"length":1,"stats":{"Line":1}},{"line":231,"address":[32957756,32957308],"length":1,"stats":{"Line":2}},{"line":232,"address":[32957645,32957402,32957460],"length":1,"stats":{"Line":2}},{"line":233,"address":[32957743],"length":1,"stats":{"Line":1}},{"line":238,"address":[32957219],"length":1,"stats":{"Line":1}},{"line":239,"address":[32958066,32957838,32957282],"length":1,"stats":{"Line":3}},{"line":240,"address":[32957939,32957876],"length":1,"stats":{"Line":1}},{"line":241,"address":[32958061],"length":1,"stats":{"Line":1}},{"line":244,"address":[32957844],"length":1,"stats":{"Line":1}},{"line":249,"address":[32956925,32951552,32956946],"length":1,"stats":{"Line":1}},{"line":250,"address":[32951579,32953065,32951625,32956912,32956740,32954520],"length":1,"stats":{"Line":2}},{"line":251,"address":[32952937],"length":1,"stats":{"Line":1}},{"line":252,"address":[32951589],"length":1,"stats":{"Line":1}},{"line":253,"address":[32951657],"length":1,"stats":{"Line":1}},{"line":255,"address":[32952051,32952665,32951739,32952258,32951797,32951844,32952465,32956941],"length":1,"stats":{"Line":3}},{"line":256,"address":[32951948],"length":1,"stats":{"Line":1}},{"line":257,"address":[32951805],"length":1,"stats":{"Line":1}},{"line":258,"address":[32951876],"length":1,"stats":{"Line":1}},{"line":260,"address":[32952155],"length":1,"stats":{"Line":1}},{"line":261,"address":[32952012],"length":1,"stats":{"Line":1}},{"line":262,"address":[32952083],"length":1,"stats":{"Line":1}},{"line":264,"address":[32952362],"length":1,"stats":{"Line":1}},{"line":265,"address":[32952219],"length":1,"stats":{"Line":1}},{"line":266,"address":[32952290],"length":1,"stats":{"Line":1}},{"line":268,"address":[32952569],"length":1,"stats":{"Line":1}},{"line":269,"address":[32952426],"length":1,"stats":{"Line":1}},{"line":270,"address":[32952497],"length":1,"stats":{"Line":1}},{"line":274,"address":[32954377],"length":1,"stats":{"Line":1}},{"line":275,"address":[32953029],"length":1,"stats":{"Line":1}},{"line":276,"address":[32953097],"length":1,"stats":{"Line":1}},{"line":278,"address":[32953237,32953905,32953179,32954105,32953698,32953284,32953491,32956936],"length":1,"stats":{"Line":3}},{"line":279,"address":[32953388],"length":1,"stats":{"Line":1}},{"line":280,"address":[32953245],"length":1,"stats":{"Line":1}},{"line":281,"address":[32953316],"length":1,"stats":{"Line":1}},{"line":283,"address":[32953595],"length":1,"stats":{"Line":1}},{"line":284,"address":[32953452],"length":1,"stats":{"Line":1}},{"line":285,"address":[32953523],"length":1,"stats":{"Line":1}},{"line":287,"address":[32953802],"length":1,"stats":{"Line":1}},{"line":288,"address":[32953659],"length":1,"stats":{"Line":1}},{"line":289,"address":[32953730],"length":1,"stats":{"Line":1}},{"line":291,"address":[32954009],"length":1,"stats":{"Line":1}},{"line":292,"address":[32953866],"length":1,"stats":{"Line":1}},{"line":293,"address":[32953937],"length":1,"stats":{"Line":1}},{"line":297,"address":[32956588],"length":1,"stats":{"Line":1}},{"line":298,"address":[32954481],"length":1,"stats":{"Line":1}},{"line":299,"address":[32954552],"length":1,"stats":{"Line":1}},{"line":301,"address":[32956931,32955567,32954692,32955360,32955153,32956181,32955981,32954946,32954634,32955774,32954739],"length":1,"stats":{"Line":3}},{"line":302,"address":[32954843],"length":1,"stats":{"Line":1}},{"line":303,"address":[32954700],"length":1,"stats":{"Line":1}},{"line":304,"address":[32954771],"length":1,"stats":{"Line":1}},{"line":306,"address":[32955050],"length":1,"stats":{"Line":1}},{"line":307,"address":[32954907],"length":1,"stats":{"Line":1}},{"line":308,"address":[32954978],"length":1,"stats":{"Line":1}},{"line":310,"address":[32955257],"length":1,"stats":{"Line":1}},{"line":311,"address":[32955114],"length":1,"stats":{"Line":1}},{"line":312,"address":[32955185],"length":1,"stats":{"Line":1}},{"line":314,"address":[32955464],"length":1,"stats":{"Line":1}},{"line":315,"address":[32955321],"length":1,"stats":{"Line":1}},{"line":316,"address":[32955392],"length":1,"stats":{"Line":1}},{"line":318,"address":[32955671],"length":1,"stats":{"Line":1}},{"line":319,"address":[32955528],"length":1,"stats":{"Line":1}},{"line":320,"address":[32955599],"length":1,"stats":{"Line":1}},{"line":322,"address":[32955878],"length":1,"stats":{"Line":1}},{"line":323,"address":[32955735],"length":1,"stats":{"Line":1}},{"line":324,"address":[32955806],"length":1,"stats":{"Line":1}},{"line":326,"address":[32956085],"length":1,"stats":{"Line":1}},{"line":327,"address":[32955942],"length":1,"stats":{"Line":1}},{"line":328,"address":[32956013],"length":1,"stats":{"Line":1}}],"covered":88,"coverable":88},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","analysis.rs"],"content":"//! 分析相关命令：专注时段分析。\n\nuse crate::analysis::FocusAnalysis;\nuse crate::app_data::DateRange;\nuse crate::errors::AppResult;\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{history_for_ui, validate_date_range};\n\n/// 获取指定范围的专注分析数据（用于“专注时段分析”图表/摘要）。\n#[tauri::command]\npub fn get_focus_analysis(\n    state: tauri::State\u003c'_, AppState\u003e,\n    range: DateRange,\n) -\u003e Result\u003cFocusAnalysis, String\u003e {\n    to_ipc_result(get_focus_analysis_impl(\u0026*state, \u0026range))\n}\n\n/// 获取专注分析的内部实现。\nfn get_focus_analysis_impl\u003cS: CommandState\u003e(state: \u0026S, range: \u0026DateRange) -\u003e AppResult\u003cFocusAnalysis\u003e {\n    validate_date_range(range)?;\n    let data = state.data_snapshot();\n    crate::analysis::get_focus_analysis(history_for_ui(\u0026data), range)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{AppData, HistoryDay, HistoryRecord, Phase};\n    use crate::commands::state_like::TestState;\n\n    /// `get_focus_analysis_impl`：应校验日期范围，并在开发环境优先使用 `history_dev`。\n    #[test]\n    fn get_focus_analysis_prefers_history_dev_and_validates_range() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![HistoryRecord {\n                    tag: \"A\".to_string(),\n                    start_time: \"09:00\".to_string(),\n                    end_time: None,\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                }],\n            }],\n            history_dev: vec![HistoryDay {\n                date: \"2025-01-02\".to_string(),\n                records: vec![HistoryRecord {\n                    tag: \"B\".to_string(),\n                    start_time: \"10:00\".to_string(),\n                    end_time: None,\n                    duration: 30,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                }],\n            }],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n\n        let out = get_focus_analysis_impl(\n            \u0026state,\n            \u0026DateRange {\n                from: \"2025-01-02\".to_string(),\n                to: \"2025-01-02\".to_string(),\n            },\n        )\n        .unwrap();\n        assert_eq!(out.hourly_counts[10], 1);\n        assert!(out.tag_efficiency.iter().any(|t| t.tag == \"B\"));\n\n        let err = get_focus_analysis_impl(\n            \u0026state,\n            \u0026DateRange {\n                from: \"2025-01-03\".to_string(),\n                to: \"2025-01-01\".to_string(),\n            },\n        )\n        .unwrap_err();\n        assert!(matches!(err, crate::errors::AppError::Validation(_)));\n    }\n}\n","traces":[{"line":14,"address":[33084552,33084416],"length":1,"stats":{"Line":0}},{"line":18,"address":[33084447,33084506],"length":1,"stats":{"Line":0}},{"line":22,"address":[34924790,34924784,34924816,34925120,34924480,34925126],"length":1,"stats":{"Line":1}},{"line":23,"address":[34924531,34924867],"length":1,"stats":{"Line":1}},{"line":24,"address":[34924988,34924652],"length":1,"stats":{"Line":1}},{"line":25,"address":[34925052,34924662,34924716,34924998],"length":1,"stats":{"Line":2}}],"covered":4,"coverable":6},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","blacklist.rs"],"content":"//! 黑名单相关命令：设置黑名单、专注期锁定校验等。\n\nuse crate::app_data::BlacklistItem;\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{normalize_name, validate_blacklist_items};\n\n/// 设置黑名单（专注期内仅允许“新增”，不允许移除）。\n#[tauri::command]\npub fn set_blacklist(\n    state: tauri::State\u003c'_, AppState\u003e,\n    blacklist: Vec\u003cBlacklistItem\u003e,\n) -\u003e Result\u003cVec\u003cBlacklistItem\u003e, String\u003e {\n    to_ipc_result(set_blacklist_impl(\u0026*state, blacklist))\n}\n\n/// 设置黑名单的内部实现（便于统一错误处理）。\nfn set_blacklist_impl\u003cS: CommandState\u003e(state: \u0026S, blacklist: Vec\u003cBlacklistItem\u003e) -\u003e AppResult\u003cVec\u003cBlacklistItem\u003e\u003e {\n    set_blacklist_impl_with_killer(state, blacklist, |names| crate::processes::kill_names_best_effort(names))\n}\n\n/// 设置黑名单的可注入实现：用于在测试中 mock 进程终止逻辑。\nfn set_blacklist_impl_with_killer\u003cS: CommandState\u003e(\n    state: \u0026S,\n    blacklist: Vec\u003cBlacklistItem\u003e,\n    kill_names: impl FnOnce(\u0026[String]) -\u003e crate::processes::KillSummary,\n) -\u003e AppResult\u003cVec\u003cBlacklistItem\u003e\u003e {\n    validate_blacklist_items(\u0026blacklist)?;\n\n    let (added_names, should_kill_added) = state.update_data_and_timer(\n        |data, timer_runtime| {\n            let locked = timer_runtime.blacklist_locked();\n\n            if locked {\n                let old_names: std::collections::BTreeSet\u003cString\u003e = data\n                    .blacklist\n                    .iter()\n                    .map(|b| normalize_name(\u0026b.name))\n                    .collect();\n                let new_names: std::collections::BTreeSet\u003cString\u003e =\n                    blacklist.iter().map(|b| normalize_name(\u0026b.name)).collect();\n\n                if !old_names.is_subset(\u0026new_names) {\n                    return Err(AppError::BlacklistLocked);\n                }\n            }\n\n            let old_names: std::collections::BTreeSet\u003cString\u003e = data\n                .blacklist\n                .iter()\n                .map(|b| normalize_name(\u0026b.name))\n                .collect();\n\n            let added: Vec\u003cString\u003e = blacklist\n                .iter()\n                .filter(|b| !old_names.contains(\u0026normalize_name(\u0026b.name)))\n                .map(|b| b.name.clone())\n                .collect();\n\n            data.blacklist = blacklist.clone();\n\n            // PRD：番茄周期内可动态添加并立即终止。\n            let should_kill = locked \u0026\u0026 !added.is_empty();\n\n            Ok((added, should_kill))\n        },\n        true,\n    )?;\n\n    if should_kill_added {\n        tracing::info!(target: \"blacklist\", \"专注期新增黑名单条目，立即尝试终止：{:?}\", added_names);\n        let payload = kill_names(\u0026added_names);\n        let _ = state.emit_kill_result(payload);\n    }\n\n    Ok(state.data_snapshot().blacklist)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `set_blacklist_impl_with_killer`：非锁定状态下允许增删，且不触发终止逻辑。\n    #[test]\n    fn set_blacklist_allows_replace_when_not_locked() {\n        let state = TestState::new(crate::app_data::AppData::default());\n        let blacklist = vec![BlacklistItem {\n            name: \"a.exe\".to_string(),\n            display_name: \"A\".to_string(),\n        }];\n\n        let out = set_blacklist_impl_with_killer(\u0026state, blacklist.clone(), |_names| crate::processes::KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        })\n        .unwrap();\n\n        assert_eq!(out, blacklist);\n        assert_eq!(state.data_snapshot().blacklist, blacklist);\n        assert!(state.take_kill_results().is_empty());\n    }\n\n    /// `set_blacklist_impl_with_killer`：锁定状态下禁止移除旧条目，但允许新增并触发 best-effort 终止。\n    #[test]\n    fn set_blacklist_enforces_lock_and_kills_added_items() {\n        let state = TestState::new(crate::app_data::AppData::default());\n\n        // 先设置一个旧黑名单。\n        let old = vec![BlacklistItem {\n            name: \"old.exe\".to_string(),\n            display_name: \"Old\".to_string(),\n        }];\n        set_blacklist_impl_with_killer(\u0026state, old.clone(), |_names| crate::processes::KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        })\n        .unwrap();\n\n        // 进入“工作阶段锁定”态：让 timer_runtime.blacklist_locked() 为 true。\n        state\n            .update_data_and_timer(\n                |data, timer_runtime| {\n                    let clock = crate::timer::SystemClock;\n                    timer_runtime.start(\u0026data.settings, \u0026clock);\n                    Ok(())\n                },\n                false,\n            )\n            .unwrap();\n        assert!(state.timer_snapshot().blacklist_locked);\n\n        // 尝试移除 old：应失败。\n        let err = set_blacklist_impl_with_killer(\u0026state, vec![], |_names| crate::processes::KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        })\n        .unwrap_err();\n        assert!(matches!(err, AppError::BlacklistLocked));\n\n        // 新增一条：允许，并应触发 kill。\n        let next = vec![\n            old[0].clone(),\n            BlacklistItem {\n                name: \"new.exe\".to_string(),\n                display_name: \"New\".to_string(),\n            },\n        ];\n        let out = set_blacklist_impl_with_killer(\u0026state, next.clone(), |names| {\n            crate::processes::KillSummary {\n                items: vec![crate::processes::termination::KillItem {\n                    name: names[0].clone(),\n                    pids: vec![1],\n                    killed: 1,\n                    failed: 0,\n                    requires_admin: false,\n                }],\n                requires_admin: false,\n            }\n        })\n        .unwrap();\n\n        assert_eq!(out, next);\n        let kills = state.take_kill_results();\n        assert_eq!(kills.len(), 1);\n        assert_eq!(kills[0].items[0].name, \"new.exe\");\n    }\n}\n","traces":[{"line":13,"address":[30042022,30041824,30041998],"length":1,"stats":{"Line":0}},{"line":17,"address":[30041850,30041926],"length":1,"stats":{"Line":0}},{"line":21,"address":[31657360],"length":1,"stats":{"Line":0}},{"line":22,"address":[31657377,31657392,31657414],"length":1,"stats":{"Line":0}},{"line":26,"address":[31663184,31667256,31667120,31657440,31661352,31659384,31665288,31663320,31661216,31663344,31659248,31665152,31661376,31659408,31665312],"length":1,"stats":{"Line":4}},{"line":31,"address":[31657483,31661419,31659353,31657583,31663289,31663487,31659551,31665257,31661519,31659451,31663387,31665455,31667225,31661321,31665355],"length":1,"stats":{"Line":8}},{"line":33,"address":[31665757,31665253,31661821,31661317,31665630,31657758,31657885,31659853,31663285,31663789,31667221,31659726,31661694,31659349,31663662],"length":1,"stats":{"Line":6}},{"line":34,"address":[31672294,31669798,31673488,31667280,31668454,31671040,31671046,31672288,31672320,31668624,31669872,31668448,31673494,31669792,31671120],"length":1,"stats":{"Line":4}},{"line":35,"address":[31669942,31672390,31668694,31667350,31671190],"length":1,"stats":{"Line":4}},{"line":37,"address":[31669966,31668718,31671214,31672414,31667374],"length":1,"stats":{"Line":4}},{"line":38,"address":[31671296,31668800,31670048,31672496,31667456],"length":1,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[31671307,31670059,31668811,31672507,31667467],"length":1,"stats":{"Line":2}},{"line":41,"address":[31673811,31673584,31673683,31672518,31668822,31675155,31670070,31673648,31673712,31671318,31673619,31673747,31675120,31667478,31673776],"length":1,"stats":{"Line":6}},{"line":42,"address":[31672534,31668838,31667494,31671334,31670086],"length":1,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[31671411,31668915,31673520,31675312,31675091,31672611,31674736,31667571,31670163,31674771,31674195,31668848,31673555,31667504,31672544,31674160,31675056,31670096,31675347,31671344],"length":1,"stats":{"Line":6}},{"line":46,"address":[31669055,31667711,31671551,31669000,31672696,31670248,31670303,31667656,31671496,31672751],"length":1,"stats":{"Line":4}},{"line":47,"address":[31669069,31672765,31671565,31667725,31670317],"length":1,"stats":{"Line":1}},{"line":51,"address":[31667383,31669975,31671223,31668727,31672423],"length":1,"stats":{"Line":3}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[31668738,31669986,31667394,31671234,31672434],"length":1,"stats":{"Line":3}},{"line":54,"address":[31668749,31669997,31671245,31674224,31674800,31674707,31674259,31674835,31674448,31674672,31674992,31675027,31667405,31672445,31674483],"length":1,"stats":{"Line":9}},{"line":55,"address":[31670013,31667421,31668765,31671261,31672461],"length":1,"stats":{"Line":3}},{"line":57,"address":[31670023,31672471,31667431,31668775,31671271],"length":1,"stats":{"Line":3}},{"line":58,"address":[31672951,31667911,31669255,31671751,31670503],"length":1,"stats":{"Line":3}},{"line":59,"address":[31674288,31673854,31672994,31673840,31675440,31671794,31670546,31669298,31674512,31674526,31667954,31674000,31674014,31674302,31675454],"length":1,"stats":{"Line":9}},{"line":60,"address":[31674864,31675411,31674928,31675283,31674963,31673017,31675184,31674899,31675248,31675219,31675376,31667977,31671817,31669321,31670569],"length":1,"stats":{"Line":9}},{"line":61,"address":[31671840,31670592,31673040,31668000,31669344],"length":1,"stats":{"Line":3}},{"line":63,"address":[31670612,31668088,31670680,31673128,31671916,31671928,31673060,31670668,31673116,31669432,31671860,31668076,31668020,31669420,31669364],"length":1,"stats":{"Line":6}},{"line":66,"address":[31672034,31673472,31673234,31668432,31669538,31672272,31671024,31668194,31669776,31670786],"length":1,"stats":{"Line":4}},{"line":68,"address":[31669586,31673282,31668242,31672082,31670834],"length":1,"stats":{"Line":3}},{"line":73,"address":[31665913,31658041,31660009,31663945,31661977],"length":1,"stats":{"Line":3}},{"line":74,"address":[31664045,31660036,31658141,31662004,31658068,31660109,31662348,31660380,31663972,31664316,31666013,31658412,31665940,31666284,31662077],"length":1,"stats":{"Line":2}},{"line":75,"address":[31666526,31664268,31667216,31658364,31661312,31662300,31658654,31664558,31666236,31660332,31662590,31663280,31665248,31660622,31659344],"length":1,"stats":{"Line":1}},{"line":76,"address":[31666629,31658757,31662693,31660725,31664661],"length":1,"stats":{"Line":1}},{"line":79,"address":[31666659,31658058,31660755,31662723,31661994,31664691,31663962,31665930,31660026,31658787],"length":1,"stats":{"Line":6}}],"covered":30,"coverable":37},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","export.rs"],"content":"//! 导出相关命令：将历史记录导出为 CSV/JSON。\n\nuse serde::Serialize;\nuse tauri_plugin_dialog::DialogExt as _;\n\nuse crate::app_data::{DateRange, HistoryDay, HistoryRecord, Phase};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::history::get_history_impl;\nuse super::types::{ExportField, ExportFormat, ExportRequest};\nuse super::validation::validate_date_range;\n\n/// 导出历史记录：弹出保存对话框并写入 CSV/JSON，返回保存的文件路径。\n#[tauri::command]\npub async fn export_history(\n    app: tauri::AppHandle,\n    state: tauri::State\u003c'_, AppState\u003e,\n    request: ExportRequest,\n) -\u003e Result\u003cString, String\u003e {\n    to_ipc_result(export_history_impl(\u0026app, \u0026state, request))\n}\n\n/// 导出历史的内部实现：校验范围、弹出保存对话框、写入文件。\nfn export_history_impl(\n    app: \u0026tauri::AppHandle,\n    state: \u0026AppState,\n    request: ExportRequest,\n) -\u003e AppResult\u003cString\u003e {\n    validate_date_range(\u0026request.range)?;\n\n    let mut fields = request.fields;\n    if fields.is_empty() {\n        fields = vec![\n            ExportField::Date,\n            ExportField::StartTime,\n            ExportField::EndTime,\n            ExportField::Duration,\n            ExportField::Tag,\n            ExportField::Phase,\n        ];\n    }\n\n    let ext = match request.format {\n        ExportFormat::Csv =\u003e \"csv\",\n        ExportFormat::Json =\u003e \"json\",\n    };\n\n    let default_name = format!(\n        \"pomodoro-history-{}-{}.{}\",\n        request.range.from, request.range.to, ext\n    );\n\n    // 后端弹出系统保存对话框（PRD v2）。\n    let Some(path) = app\n        .dialog()\n        .file()\n        .set_file_name(\u0026default_name)\n        .blocking_save_file()\n    else {\n        return Err(AppError::Validation(\"已取消导出\".to_string()));\n    };\n\n    let path = path\n        .into_path()\n        .map_err(|_| AppError::Invariant(\"导出路径解析失败\".to_string()))?;\n\n    let days = get_history_impl(state, \u0026request.range)?;\n    let export_rows = flatten_days_to_rows(\u0026days);\n\n    match request.format {\n        ExportFormat::Csv =\u003e export_csv(\u0026path, \u0026fields, \u0026export_rows)?,\n        ExportFormat::Json =\u003e export_json(\u0026path, \u0026request.range, \u0026export_rows)?,\n    }\n\n    tracing::info!(target: \"storage\", \"导出历史成功：path={}\", path.to_string_lossy());\n    Ok(path.to_string_lossy().to_string())\n}\n\n/// 将按日分组的历史拉平成导出行（每条记录一行）。\nfn flatten_days_to_rows(days: \u0026[HistoryDay]) -\u003e Vec\u003cExportRow\u003e {\n    let mut out = Vec::new();\n    for day in days {\n        for r in \u0026day.records {\n            out.push(ExportRow {\n                date: day.date.clone(),\n                record: r.clone(),\n            });\n        }\n    }\n    out\n}\n\n/// 单条导出行：`date + record`。\n#[derive(Debug, Clone)]\nstruct ExportRow {\n    date: String,\n    record: HistoryRecord,\n}\n\n/// 将 `startTime + duration` 推导出 `endTime`（用于旧数据缺失 `end_time` 的兼容）。\nfn derive_end_time_hhmm(start_time: \u0026str, duration_minutes: u32) -\u003e Option\u003cString\u003e {\n    let parts: Vec\u003c\u0026str\u003e = start_time.split(':').collect();\n    if parts.len() != 2 {\n        return None;\n    }\n    let h: i32 = parts[0].parse().ok()?;\n    let m: i32 = parts[1].parse().ok()?;\n    if !(0..=23).contains(\u0026h) || !(0..=59).contains(\u0026m) {\n        return None;\n    }\n    let total = h * 60 + m + duration_minutes as i32;\n    let hh = ((total / 60) % 24 + 24) % 24;\n    let mm = ((total % 60) + 60) % 60;\n    Some(format!(\"{:02}:{:02}\", hh, mm))\n}\n\n/// 导出 CSV 文件（字段可配置）。\nfn export_csv(path: \u0026std::path::Path, fields: \u0026[ExportField], rows: \u0026[ExportRow]) -\u003e AppResult\u003c()\u003e {\n    let file = std::fs::File::create(path)\n        .map_err(|e| AppError::Invariant(format!(\"创建导出文件失败：{e}\")))?;\n    let mut wtr = csv::Writer::from_writer(file);\n\n    let header: Vec\u003c\u0026str\u003e = fields\n        .iter()\n        .map(|f| match f {\n            ExportField::Date =\u003e \"date\",\n            ExportField::StartTime =\u003e \"start_time\",\n            ExportField::EndTime =\u003e \"end_time\",\n            ExportField::Duration =\u003e \"duration\",\n            ExportField::Tag =\u003e \"tag\",\n            ExportField::Phase =\u003e \"phase\",\n            ExportField::Remark =\u003e \"remark\",\n        })\n        .collect();\n    wtr.write_record(\u0026header)\n        .map_err(|e| AppError::Invariant(format!(\"写入 CSV 头失败：{e}\")))?;\n\n    for row in rows {\n        let mut record: Vec\u003cString\u003e = Vec::new();\n        for f in fields {\n            let v = match f {\n                ExportField::Date =\u003e row.date.clone(),\n                ExportField::StartTime =\u003e row.record.start_time.clone(),\n                ExportField::EndTime =\u003e row\n                    .record\n                    .end_time\n                    .clone()\n                    .or_else(|| derive_end_time_hhmm(\u0026row.record.start_time, row.record.duration))\n                    .unwrap_or_default(),\n                ExportField::Duration =\u003e row.record.duration.to_string(),\n                ExportField::Tag =\u003e row.record.tag.clone(),\n                ExportField::Phase =\u003e match row.record.phase {\n                    Phase::Work =\u003e \"work\".to_string(),\n                    Phase::ShortBreak =\u003e \"shortBreak\".to_string(),\n                    Phase::LongBreak =\u003e \"longBreak\".to_string(),\n                },\n                ExportField::Remark =\u003e row.record.remark.clone(),\n            };\n            record.push(v);\n        }\n        wtr.write_record(\u0026record)\n            .map_err(|e| AppError::Invariant(format!(\"写入 CSV 行失败：{e}\")))?;\n    }\n    wtr.flush()\n        .map_err(|e| AppError::Invariant(format!(\"写入 CSV 失败：{e}\")))?;\n    Ok(())\n}\n\n/// JSON 导出文件顶层结构。\n#[derive(Debug, Clone, Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct JsonExport {\n    export_date: String,\n    range: DateRange,\n    records: Vec\u003cJsonExportRecord\u003e,\n}\n\n/// JSON 导出单条记录结构。\n#[derive(Debug, Clone, Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct JsonExportRecord {\n    date: String,\n    start_time: String,\n    end_time: String,\n    duration: u32,\n    tag: String,\n    phase: String,\n    remark: String,\n}\n\n/// 导出 JSON 文件（字段固定为 PRD v2 示例的 superset）。\nfn export_json(path: \u0026std::path::Path, range: \u0026DateRange, rows: \u0026[ExportRow]) -\u003e AppResult\u003c()\u003e {\n    let today = chrono::Local::now().format(\"%Y-%m-%d\").to_string();\n    let mut records: Vec\u003cJsonExportRecord\u003e = Vec::new();\n    for row in rows {\n        let end_time = row\n            .record\n            .end_time\n            .clone()\n            .or_else(|| derive_end_time_hhmm(\u0026row.record.start_time, row.record.duration))\n            .unwrap_or_default();\n        let phase = match row.record.phase {\n            Phase::Work =\u003e \"work\",\n            Phase::ShortBreak =\u003e \"shortBreak\",\n            Phase::LongBreak =\u003e \"longBreak\",\n        }\n        .to_string();\n        records.push(JsonExportRecord {\n            date: row.date.clone(),\n            start_time: row.record.start_time.clone(),\n            end_time,\n            duration: row.record.duration,\n            tag: row.record.tag.clone(),\n            phase,\n            remark: row.record.remark.clone(),\n        });\n    }\n\n    let out = JsonExport {\n        export_date: today,\n        range: range.clone(),\n        records,\n    };\n\n    let json = serde_json::to_string_pretty(\u0026out)?;\n    std::fs::write(path, json).map_err(|e| AppError::Invariant(format!(\"写入 JSON 失败：{e}\")))?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `derive_end_time_hhmm`：应支持合法时间与跨日回绕。\n    #[test]\n    fn derive_end_time_handles_wrap() {\n        assert_eq!(derive_end_time_hhmm(\"09:00\", 25).as_deref(), Some(\"09:25\"));\n        assert_eq!(derive_end_time_hhmm(\"23:50\", 20).as_deref(), Some(\"00:10\"));\n    }\n\n    /// `derive_end_time_hhmm`：非法输入应返回 None。\n    #[test]\n    fn derive_end_time_rejects_invalid_input() {\n        assert_eq!(derive_end_time_hhmm(\"bad\", 25), None);\n        assert_eq!(derive_end_time_hhmm(\"24:00\", 25), None);\n        assert_eq!(derive_end_time_hhmm(\"23:99\", 25), None);\n    }\n\n    /// `flatten_days_to_rows`：应按记录数拉平为导出行。\n    #[test]\n    fn flatten_days_to_rows_flattens() {\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![\n                HistoryRecord {\n                    tag: \"A\".to_string(),\n                    start_time: \"09:00\".to_string(),\n                    end_time: None,\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                },\n                HistoryRecord {\n                    tag: \"B\".to_string(),\n                    start_time: \"10:00\".to_string(),\n                    end_time: None,\n                    duration: 5,\n                    phase: Phase::ShortBreak,\n                    remark: String::new(),\n                },\n            ],\n        }];\n\n        let rows = flatten_days_to_rows(\u0026days);\n        assert_eq!(rows.len(), 2);\n        assert_eq!(rows[0].date, \"2025-01-01\");\n        assert_eq!(rows[0].record.tag, \"A\");\n        assert_eq!(rows[1].record.tag, \"B\");\n    }\n\n    /// `export_csv`：应按字段顺序写入表头与行，并在缺失 end_time 时推导。\n    #[test]\n    fn export_csv_writes_expected_content() {\n        let dir = tempfile::tempdir().unwrap();\n        let path = dir.path().join(\"out.csv\");\n\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"A\".to_string(),\n                start_time: \"09:00\".to_string(),\n                end_time: None,\n                duration: 25,\n                phase: Phase::Work,\n                remark: \"hi\".to_string(),\n            }],\n        }];\n        let rows = flatten_days_to_rows(\u0026days);\n\n        export_csv(\n            \u0026path,\n            \u0026[\n                ExportField::Date,\n                ExportField::StartTime,\n                ExportField::EndTime,\n                ExportField::Duration,\n                ExportField::Tag,\n                ExportField::Phase,\n                ExportField::Remark,\n            ],\n            \u0026rows,\n        )\n        .unwrap();\n\n        let content = std::fs::read_to_string(\u0026path).unwrap();\n        let lines: Vec\u003c\u0026str\u003e = content.lines().collect();\n        assert_eq!(lines[0], \"date,start_time,end_time,duration,tag,phase,remark\");\n        assert_eq!(lines[1], \"2025-01-01,09:00,09:25,25,A,work,hi\");\n    }\n\n    /// `export_json`：应写入可解析 JSON，且包含 range 与 records。\n    #[test]\n    fn export_json_writes_parseable_json() {\n        let dir = tempfile::tempdir().unwrap();\n        let path = dir.path().join(\"out.json\");\n\n        let range = DateRange {\n            from: \"2025-01-01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        };\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"A\".to_string(),\n                start_time: \"09:00\".to_string(),\n                end_time: None,\n                duration: 25,\n                phase: Phase::Work,\n                remark: String::new(),\n            }],\n        }];\n        let rows = flatten_days_to_rows(\u0026days);\n\n        export_json(\u0026path, \u0026range, \u0026rows).unwrap();\n        let content = std::fs::read_to_string(\u0026path).unwrap();\n        let v: serde_json::Value = serde_json::from_str(\u0026content).unwrap();\n        assert_eq!(v[\"range\"][\"from\"], \"2025-01-01\");\n        assert_eq!(v[\"range\"][\"to\"], \"2025-01-07\");\n        assert_eq!(v[\"records\"].as_array().unwrap().len(), 1);\n        assert_eq!(v[\"records\"][0][\"date\"], \"2025-01-01\");\n        assert_eq!(v[\"records\"][0][\"endTime\"], \"09:25\");\n    }\n}\n","traces":[{"line":17,"address":[31580384],"length":1,"stats":{"Line":0}},{"line":22,"address":[29772714,29772636],"length":1,"stats":{"Line":0}},{"line":26,"address":[31580496,31584519,31584812],"length":1,"stats":{"Line":0}},{"line":31,"address":[31584740,31580665,31580570],"length":1,"stats":{"Line":0}},{"line":33,"address":[31580805],"length":1,"stats":{"Line":0}},{"line":34,"address":[31580906,31580845,31581241],"length":1,"stats":{"Line":0}},{"line":35,"address":[31581193,31580955],"length":1,"stats":{"Line":0}},{"line":45,"address":[31580920],"length":1,"stats":{"Line":0}},{"line":46,"address":[31581275],"length":1,"stats":{"Line":0}},{"line":47,"address":[31581246],"length":1,"stats":{"Line":0}},{"line":50,"address":[31581310],"length":1,"stats":{"Line":0}},{"line":56,"address":[31581706],"length":1,"stats":{"Line":0}},{"line":59,"address":[31581676],"length":1,"stats":{"Line":0}},{"line":62,"address":[31581978,31584627],"length":1,"stats":{"Line":0}},{"line":65,"address":[31584576,31582092,31582199,31581851],"length":1,"stats":{"Line":0}},{"line":67,"address":[31582069,31582135],"length":1,"stats":{"Line":0}},{"line":69,"address":[31584564,31582379,31582312],"length":1,"stats":{"Line":0}},{"line":70,"address":[31582583,31582670],"length":1,"stats":{"Line":0}},{"line":72,"address":[31582685],"length":1,"stats":{"Line":0}},{"line":73,"address":[31582846,31583174,31582743],"length":1,"stats":{"Line":0}},{"line":74,"address":[31584525,31583228,31582709],"length":1,"stats":{"Line":0}},{"line":77,"address":[31583146,31583444,31583695],"length":1,"stats":{"Line":0}},{"line":78,"address":[31583675,31584070,31584149],"length":1,"stats":{"Line":0}},{"line":82,"address":[31586512,31587177,31587183],"length":1,"stats":{"Line":1}},{"line":83,"address":[31586560],"length":1,"stats":{"Line":1}},{"line":84,"address":[31586575,31586639],"length":1,"stats":{"Line":2}},{"line":85,"address":[31586740,31586815],"length":1,"stats":{"Line":2}},{"line":86,"address":[31587008],"length":1,"stats":{"Line":1}},{"line":87,"address":[31586925],"length":1,"stats":{"Line":1}},{"line":88,"address":[31586957],"length":1,"stats":{"Line":1}},{"line":92,"address":[31586771],"length":1,"stats":{"Line":1}},{"line":103,"address":[31586493,31584880,31586499],"length":1,"stats":{"Line":1}},{"line":104,"address":[31584924],"length":1,"stats":{"Line":1}},{"line":105,"address":[31584995,31585066],"length":1,"stats":{"Line":2}},{"line":106,"address":[31585112],"length":1,"stats":{"Line":1}},{"line":108,"address":[31585072,31586488,31585135],"length":1,"stats":{"Line":2}},{"line":109,"address":[31586483,31585334],"length":1,"stats":{"Line":1}},{"line":110,"address":[31585574,31585634],"length":1,"stats":{"Line":2}},{"line":111,"address":[31585619],"length":1,"stats":{"Line":1}},{"line":113,"address":[31585674,31585721,31585811],"length":1,"stats":{"Line":2}},{"line":114,"address":[31586010,31585809,31585833],"length":1,"stats":{"Line":2}},{"line":115,"address":[31586035,31586008,31586230],"length":1,"stats":{"Line":2}},{"line":116,"address":[31586187,31586251],"length":1,"stats":{"Line":2}},{"line":120,"address":[31577877,31575744,31577838],"length":1,"stats":{"Line":1}},{"line":121,"address":[31575980,31575897,31575855],"length":1,"stats":{"Line":2}},{"line":122,"address":[29771195,29771168],"length":1,"stats":{"Line":1}},{"line":123,"address":[31576034],"length":1,"stats":{"Line":1}},{"line":127,"address":[29770944,29770954],"length":1,"stats":{"Line":3}},{"line":128,"address":[29770985],"length":1,"stats":{"Line":1}},{"line":129,"address":[29771011],"length":1,"stats":{"Line":1}},{"line":130,"address":[29771034],"length":1,"stats":{"Line":1}},{"line":131,"address":[29771057],"length":1,"stats":{"Line":1}},{"line":132,"address":[29771080],"length":1,"stats":{"Line":1}},{"line":133,"address":[29771103],"length":1,"stats":{"Line":1}},{"line":134,"address":[29771126],"length":1,"stats":{"Line":1}},{"line":137,"address":[31576335,31577844,31576442,31576243],"length":1,"stats":{"Line":2}},{"line":138,"address":[31576312,31576378],"length":1,"stats":{"Line":1}},{"line":140,"address":[31576483],"length":1,"stats":{"Line":1}},{"line":141,"address":[31576611],"length":1,"stats":{"Line":1}},{"line":142,"address":[31577002,31576931],"length":1,"stats":{"Line":2}},{"line":143,"address":[31577098],"length":1,"stats":{"Line":1}},{"line":144,"address":[31577593,31577371],"length":1,"stats":{"Line":2}},{"line":145,"address":[31577657,31577398],"length":1,"stats":{"Line":2}},{"line":146,"address":[31577429,31577714],"length":1,"stats":{"Line":2}},{"line":150,"address":[31577680],"length":1,"stats":{"Line":3}},{"line":152,"address":[31577460,31577716],"length":1,"stats":{"Line":2}},{"line":153,"address":[31577718,31577491],"length":1,"stats":{"Line":2}},{"line":154,"address":[31577522],"length":1,"stats":{"Line":1}},{"line":155,"address":[31577813,31577720],"length":1,"stats":{"Line":2}},{"line":156,"address":[31577751,31577818],"length":1,"stats":{"Line":0}},{"line":157,"address":[31577823,31577782],"length":1,"stats":{"Line":0}},{"line":159,"address":[31577567,31577828],"length":1,"stats":{"Line":2}},{"line":161,"address":[31577595,31577833],"length":1,"stats":{"Line":2}},{"line":163,"address":[31577191,31577143,31577298],"length":1,"stats":{"Line":2}},{"line":164,"address":[29771712,29771739],"length":1,"stats":{"Line":1}},{"line":166,"address":[31576641,31576796,31576689,31576891],"length":1,"stats":{"Line":2}},{"line":167,"address":[31576666,31576732],"length":1,"stats":{"Line":1}},{"line":168,"address":[31576826],"length":1,"stats":{"Line":1}},{"line":194,"address":[31580351,31579337,31577920],"length":1,"stats":{"Line":1}},{"line":195,"address":[31578002],"length":1,"stats":{"Line":1}},{"line":196,"address":[31578243],"length":1,"stats":{"Line":1}},{"line":197,"address":[31580240,31578260,31578333],"length":1,"stats":{"Line":3}},{"line":198,"address":[31578434],"length":1,"stats":{"Line":1}},{"line":202,"address":[29772096,29772064],"length":1,"stats":{"Line":3}},{"line":204,"address":[31579431,31579549],"length":1,"stats":{"Line":2}},{"line":205,"address":[31579464],"length":1,"stats":{"Line":1}},{"line":206,"address":[31579493],"length":1,"stats":{"Line":0}},{"line":207,"address":[31579522],"length":1,"stats":{"Line":0}},{"line":210,"address":[31580002],"length":1,"stats":{"Line":1}},{"line":211,"address":[31579638],"length":1,"stats":{"Line":1}},{"line":212,"address":[31579700],"length":1,"stats":{"Line":1}},{"line":213,"address":[31579769],"length":1,"stats":{"Line":1}},{"line":214,"address":[31579809],"length":1,"stats":{"Line":1}},{"line":215,"address":[31579823],"length":1,"stats":{"Line":1}},{"line":216,"address":[31579891],"length":1,"stats":{"Line":1}},{"line":217,"address":[31579931],"length":1,"stats":{"Line":1}},{"line":223,"address":[31578513],"length":1,"stats":{"Line":1}},{"line":227,"address":[31578732,31579343,31578779],"length":1,"stats":{"Line":2}},{"line":228,"address":[29772144,29772171],"length":1,"stats":{"Line":2}},{"line":229,"address":[31579231],"length":1,"stats":{"Line":1}}],"covered":73,"coverable":100},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","history.rs"],"content":"//! 历史相关命令：查询历史、编辑备注等。\n\nuse crate::app_data::{DateRange, HistoryDay, HistoryRecord};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{history_for_ui, history_for_ui_mut, validate_date_range, validate_ymd};\n\n/// 获取指定日期范围内的历史记录（按日分组）。\n#[tauri::command]\npub fn get_history(\n    state: tauri::State\u003c'_, AppState\u003e,\n    range: DateRange,\n) -\u003e Result\u003cVec\u003cHistoryDay\u003e, String\u003e {\n    to_ipc_result(get_history_impl(\u0026*state, \u0026range))\n}\n\n/// 获取历史的内部实现：校验日期范围后按 `YYYY-MM-DD` 字符串过滤（闭区间）。\npub(crate) fn get_history_impl\u003cS: CommandState\u003e(state: \u0026S, range: \u0026DateRange) -\u003e AppResult\u003cVec\u003cHistoryDay\u003e\u003e {\n    validate_date_range(range)?;\n\n    let data = state.data_snapshot();\n    let mut out: Vec\u003cHistoryDay\u003e = history_for_ui(\u0026data)\n        .iter()\n        .filter(|d| d.date \u003e= range.from \u0026\u0026 d.date \u003c= range.to)\n        .cloned()\n        .collect();\n\n    // 让 UI 的“默认本周”更自然：按日期倒序展示。\n    out.sort_by(|a, b| b.date.cmp(\u0026a.date));\n    Ok(out)\n}\n\n/// 设置某条历史记录的备注（用于“完成后填写”与“历史中编辑”）。\n#[tauri::command]\npub fn set_history_remark(\n    state: tauri::State\u003c'_, AppState\u003e,\n    date: String,\n    record_index: usize,\n    remark: String,\n) -\u003e Result\u003cHistoryRecord, String\u003e {\n    to_ipc_result(set_history_remark_impl(\u0026*state, date, record_index, remark))\n}\n\n/// 设置备注的内部实现：按日期 + 索引定位并持久化。\nfn set_history_remark_impl\u003cS: CommandState\u003e(\n    state: \u0026S,\n    date: String,\n    record_index: usize,\n    remark: String,\n) -\u003e AppResult\u003cHistoryRecord\u003e {\n    let date = date.trim().to_string();\n    validate_ymd(\u0026date)?;\n\n    let remark = remark.trim().to_string();\n    state.update_data(|data| {\n        let list = history_for_ui_mut(data);\n        let Some(day) = list.iter_mut().find(|d| d.date == date) else {\n            return Err(AppError::Validation(\"找不到指定日期的历史记录\".to_string()));\n        };\n        if record_index \u003e= day.records.len() {\n            return Err(AppError::Validation(\"历史记录索引超出范围\".to_string()));\n        }\n        day.records[record_index].remark = remark.clone();\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"storage\", \"更新历史备注：date={} index={}\", date, record_index);\n    let data = state.data_snapshot();\n    let day = history_for_ui(\u0026data)\n        .iter()\n        .find(|d| d.date == date)\n        .ok_or_else(|| AppError::Invariant(\"写入后读取历史失败\".to_string()))?;\n    Ok(day.records[record_index].clone())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{AppData, Phase};\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `get_history_impl`：应按闭区间筛选，并按日期倒序返回。\n    #[test]\n    fn get_history_filters_and_sorts_desc() {\n        let data = AppData {\n            history: vec![\n                HistoryDay {\n                    date: \"2025-01-01\".to_string(),\n                    records: Vec::new(),\n                },\n                HistoryDay {\n                    date: \"2025-01-03\".to_string(),\n                    records: Vec::new(),\n                },\n            ],\n            history_dev: vec![\n                HistoryDay {\n                    date: \"2025-01-02\".to_string(),\n                    records: Vec::new(),\n                },\n                HistoryDay {\n                    date: \"2025-01-04\".to_string(),\n                    records: Vec::new(),\n                },\n            ],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n\n        let out = get_history_impl(\n            \u0026state,\n            \u0026DateRange {\n                from: \"2025-01-02\".to_string(),\n                to: \"2025-01-04\".to_string(),\n            },\n        )\n        .unwrap();\n        assert_eq!(out.len(), 2);\n        assert_eq!(out[0].date, \"2025-01-04\");\n        assert_eq!(out[1].date, \"2025-01-02\");\n    }\n\n    /// `set_history_remark_impl`：应更新指定记录的备注并返回更新后的记录。\n    #[test]\n    fn set_history_remark_updates_record() {\n        let data = AppData {\n            history_dev: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![HistoryRecord {\n                    tag: \"学习\".to_string(),\n                    start_time: \"09:00\".to_string(),\n                    end_time: Some(\"09:25\".to_string()),\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                }],\n            }],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n\n        let updated =\n            set_history_remark_impl(\u0026state, \"2025-01-01\".to_string(), 0, \" OK \".to_string())\n                .unwrap();\n        assert_eq!(updated.remark, \"OK\");\n\n        let snapshot = state.data_snapshot();\n        let day = snapshot\n            .history_dev\n            .iter()\n            .find(|d| d.date == \"2025-01-01\")\n            .unwrap();\n        assert_eq!(day.records[0].remark, \"OK\");\n    }\n\n    /// `set_history_remark_impl`：不存在日期或索引越界应返回校验错误。\n    #[test]\n    fn set_history_remark_rejects_missing_day_or_out_of_range() {\n        let state = TestState::new(AppData::default());\n\n        let err = set_history_remark_impl(\u0026state, \"2025-01-01\".to_string(), 0, \"x\".to_string())\n            .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let data = AppData {\n            history_dev: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n        let err = set_history_remark_impl(\u0026state, \"2025-01-01\".to_string(), 1, \"x\".to_string())\n            .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n}\n","traces":[{"line":13,"address":[29782032,29782160],"length":1,"stats":{"Line":0}},{"line":17,"address":[29782116,29782061],"length":1,"stats":{"Line":0}},{"line":21,"address":[29488279,29488304,29488871,29487712,29488877,29488285],"length":1,"stats":{"Line":1}},{"line":22,"address":[29487763,29488355],"length":1,"stats":{"Line":1}},{"line":24,"address":[29488482,29487890],"length":1,"stats":{"Line":1}},{"line":25,"address":[29487900,29488492,29488549,29487957],"length":1,"stats":{"Line":2}},{"line":27,"address":[29489040,29489066,29488944,29488970,29488024,29488616],"length":1,"stats":{"Line":3}},{"line":32,"address":[29488677,29488150,29489168,29488085,29488742,29489136,29488928,29488896],"length":1,"stats":{"Line":4}},{"line":33,"address":[29488162,29488754],"length":1,"stats":{"Line":1}},{"line":38,"address":[29782176,29782476],"length":1,"stats":{"Line":0}},{"line":44,"address":[29782220,29782329],"length":1,"stats":{"Line":0}},{"line":48,"address":[29491275,29489184,29491360,29491339,29493451,29493515],"length":1,"stats":{"Line":1}},{"line":54,"address":[29491434,29491517,29489341,29489258],"length":1,"stats":{"Line":2}},{"line":55,"address":[29493478,29489498,29491583,29489407,29491674,29491302],"length":1,"stats":{"Line":2}},{"line":57,"address":[29489661,29491837],"length":1,"stats":{"Line":1}},{"line":58,"address":[29494254,29489768,29492067,29493536,29494286,29492174,29489998,29491944,29489891,29491281,29493457,29494400,29495118,29495150],"length":1,"stats":{"Line":5}},{"line":59,"address":[29494443,29493579],"length":1,"stats":{"Line":1}},{"line":60,"address":[29495473,29494467,29495456,29493603,29495504,29495521],"length":1,"stats":{"Line":3}},{"line":61,"address":[29493761,29494625],"length":1,"stats":{"Line":1}},{"line":63,"address":[29494585,29493721],"length":1,"stats":{"Line":1}},{"line":64,"address":[29493927,29494791],"length":1,"stats":{"Line":1}},{"line":66,"address":[29493856,29494720,29495131,29494267,29494905,29494041],"length":1,"stats":{"Line":1}},{"line":67,"address":[29494234,29495098],"length":1,"stats":{"Line":1}},{"line":70,"address":[29490301,29492477,29490023,29492199],"length":1,"stats":{"Line":1}},{"line":71,"address":[29490291,29492467],"length":1,"stats":{"Line":1}},{"line":72,"address":[29490725,29492981,29490614,29490671,29493088,29490805,29492847,29490912,29492790,29492901],"length":1,"stats":{"Line":4}},{"line":74,"address":[29490757,29494369,29494352,29495168,29495185,29492933],"length":1,"stats":{"Line":3}},{"line":75,"address":[29495360,29493024,29495216,29490848,29495230,29495374,29492958,29490782],"length":1,"stats":{"Line":1}},{"line":76,"address":[29490953,29493129],"length":1,"stats":{"Line":1}}],"covered":25,"coverable":29},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","settings.rs"],"content":"//! 设置相关命令：更新 settings、设置目标等。\n\nuse crate::app_data::{Phase, Settings};\nuse crate::errors::AppResult;\nuse crate::state::AppState;\nuse crate::timer;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::types::AppSnapshot;\n\n/// 更新设置（带范围校验），并在必要时重置当前阶段的剩余时间。\n#[tauri::command]\npub fn update_settings(\n    state: tauri::State\u003c'_, AppState\u003e,\n    settings: Settings,\n) -\u003e Result\u003cAppSnapshot, String\u003e {\n    to_ipc_result((|| -\u003e AppResult\u003cAppSnapshot\u003e {\n        let out = update_settings_impl(\u0026*state, settings)?;\n        let _ = crate::tray::refresh_tray(\u0026*state);\n        Ok(out)\n    })())\n}\n\n/// 更新设置的内部实现（便于统一错误处理与托盘复用）。\nfn update_settings_impl\u003cS: CommandState\u003e(state: \u0026S, settings: Settings) -\u003e AppResult\u003cAppSnapshot\u003e {\n    timer::validate_settings(\u0026settings)?;\n\n    tracing::info!(\n        target: \"storage\",\n        \"更新设置：pomodoro={} shortBreak={} longBreak={} longBreakInterval={} dailyGoal={} weeklyGoal={} alwaysOnTop={}\",\n        settings.pomodoro,\n        settings.short_break,\n        settings.long_break,\n        settings.long_break_interval,\n        settings.daily_goal,\n        settings.weekly_goal,\n        settings.always_on_top\n    );\n\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            data.settings = settings.clone();\n\n            // 若当前未运行，则根据阶段同步剩余时间，以保证 UI 与设置一致。\n            if !timer_runtime.is_running {\n                match timer_runtime.phase {\n                    Phase::Work =\u003e {\n                        timer_runtime.remaining_seconds = settings.pomodoro as u64 * 60;\n                    }\n                    Phase::ShortBreak =\u003e {\n                        timer_runtime.remaining_seconds = settings.short_break as u64 * 60;\n                    }\n                    Phase::LongBreak =\u003e {\n                        timer_runtime.remaining_seconds = settings.long_break as u64 * 60;\n                    }\n                }\n            }\n            Ok(())\n        },\n        true,\n    )?;\n\n    let _ = state.emit_timer_snapshot();\n\n    Ok(AppSnapshot {\n        data: state.data_snapshot(),\n        timer: state.timer_snapshot(),\n    })\n}\n\n/// 设置每日/每周目标（0 表示不设目标），并持久化到 settings。\n#[tauri::command]\npub fn set_goals(\n    state: tauri::State\u003c'_, AppState\u003e,\n    daily: u32,\n    weekly: u32,\n) -\u003e Result\u003cSettings, String\u003e {\n    to_ipc_result(set_goals_impl(\u0026*state, daily, weekly))\n}\n\n/// 设置目标的内部实现（便于统一错误处理）。\nfn set_goals_impl\u003cS: CommandState\u003e(state: \u0026S, daily: u32, weekly: u32) -\u003e AppResult\u003cSettings\u003e {\n    let mut next = state.data_snapshot().settings;\n    next.daily_goal = daily;\n    next.weekly_goal = weekly;\n    timer::validate_settings(\u0026next)?;\n\n    state.update_data(|data| {\n        data.settings.daily_goal = daily;\n        data.settings.weekly_goal = weekly;\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"timer\", \"设置目标：dailyGoal={} weeklyGoal={}\", daily, weekly);\n    let _ = state.emit_timer_snapshot();\n\n    Ok(state.data_snapshot().settings)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `update_settings_impl`：应校验设置参数，并在未运行时同步当前阶段剩余时间。\n    #[test]\n    fn update_settings_updates_data_and_remaining_when_not_running() {\n        let state = TestState::new(AppData::default());\n\n        // 默认 phase=Work 且未运行，更新 pomodoro 后应同步 remaining_seconds。\n        let mut next = state.data_snapshot().settings;\n        next.pomodoro = 10;\n        let snapshot = update_settings_impl(\u0026state, next.clone()).unwrap();\n        assert_eq!(snapshot.data.settings.pomodoro, 10);\n        assert_eq!(snapshot.timer.remaining_seconds, 10 * 60);\n\n        // 切到短休息阶段且未运行，更新 short_break 后应同步 remaining_seconds。\n        state\n            .update_timer(|t, _d| {\n                t.phase = Phase::ShortBreak;\n                t.is_running = false;\n                Ok(())\n            })\n            .unwrap();\n        let mut next2 = state.data_snapshot().settings;\n        next2.short_break = 7;\n        let snapshot2 = update_settings_impl(\u0026state, next2.clone()).unwrap();\n        assert_eq!(snapshot2.timer.phase, Phase::ShortBreak);\n        assert_eq!(snapshot2.timer.remaining_seconds, 7 * 60);\n    }\n\n    /// `update_settings_impl`：运行中不应强制改写 remaining_seconds（避免打断当前倒计时）。\n    #[test]\n    fn update_settings_does_not_override_remaining_when_running() {\n        let state = TestState::new(AppData::default());\n        state\n            .update_timer(|t, _d| {\n                t.phase = Phase::Work;\n                t.is_running = true;\n                t.remaining_seconds = 3;\n                Ok(())\n            })\n            .unwrap();\n\n        let mut next = state.data_snapshot().settings;\n        next.pomodoro = 50;\n        let snapshot = update_settings_impl(\u0026state, next).unwrap();\n        assert_eq!(snapshot.timer.remaining_seconds, 3);\n    }\n\n    /// `update_settings_impl`：非法设置应返回校验错误。\n    #[test]\n    fn update_settings_rejects_invalid_settings() {\n        let state = TestState::new(AppData::default());\n        let mut next = state.data_snapshot().settings;\n        next.pomodoro = 0;\n        let err = update_settings_impl(\u0026state, next).unwrap_err();\n        assert!(matches!(err, crate::errors::AppError::Validation(_)));\n    }\n\n    /// `set_goals_impl`：应写入 daily/weekly 目标并返回最新 settings。\n    #[test]\n    fn set_goals_updates_settings() {\n        let state = TestState::new(AppData::default());\n        let out = set_goals_impl(\u0026state, 3, 7).unwrap();\n        assert_eq!(out.daily_goal, 3);\n        assert_eq!(out.weekly_goal, 7);\n        assert_eq!(state.data_snapshot().settings.daily_goal, 3);\n        assert_eq!(state.data_snapshot().settings.weekly_goal, 7);\n    }\n}\n","traces":[{"line":14,"address":[30814624],"length":1,"stats":{"Line":0}},{"line":18,"address":[30917702,30917264],"length":1,"stats":{"Line":0}},{"line":19,"address":[30917286],"length":1,"stats":{"Line":0}},{"line":20,"address":[30917559,30917621],"length":1,"stats":{"Line":0}},{"line":21,"address":[30917643],"length":1,"stats":{"Line":0}},{"line":26,"address":[30920454,30919104,30919078,30917728],"length":1,"stats":{"Line":1}},{"line":27,"address":[30919147,30917771],"length":1,"stats":{"Line":1}},{"line":29,"address":[30919512,30919250,30917874,30918136],"length":1,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[30919436,30920228,30918060,30918852],"length":1,"stats":{"Line":1}},{"line":42,"address":[30920944,30920480],"length":1,"stats":{"Line":1}},{"line":43,"address":[30920994,30920530],"length":1,"stats":{"Line":1}},{"line":46,"address":[30921062,30920598],"length":1,"stats":{"Line":1}},{"line":47,"address":[30920609,30920665,30921129,30921073],"length":1,"stats":{"Line":1}},{"line":48,"address":[30921228,30920764],"length":1,"stats":{"Line":1}},{"line":49,"address":[30921230,30920766,30921136,30920760,30920672,30921224],"length":1,"stats":{"Line":2}},{"line":51,"address":[30921257,30920793],"length":1,"stats":{"Line":1}},{"line":52,"address":[30921253,30921262,30921163,30920699,30920789,30920798],"length":1,"stats":{"Line":2}},{"line":54,"address":[30920825,30921289],"length":1,"stats":{"Line":0}},{"line":55,"address":[30921191,30920727,30920821,30921294,30920830,30921285],"length":1,"stats":{"Line":0}},{"line":59,"address":[30920650,30921114],"length":1,"stats":{"Line":1}},{"line":64,"address":[30918894,30920270],"length":1,"stats":{"Line":1}},{"line":66,"address":[30918983,30920359],"length":1,"stats":{"Line":1}},{"line":67,"address":[30920297,30918921],"length":1,"stats":{"Line":1}},{"line":68,"address":[30920315,30918939],"length":1,"stats":{"Line":1}},{"line":74,"address":[30814752],"length":1,"stats":{"Line":0}},{"line":79,"address":[30814787],"length":1,"stats":{"Line":0}},{"line":83,"address":[30915968,30914864],"length":1,"stats":{"Line":1}},{"line":84,"address":[30914902,30916006],"length":1,"stats":{"Line":1}},{"line":85,"address":[30914974,30916078],"length":1,"stats":{"Line":1}},{"line":86,"address":[30916086,30914982],"length":1,"stats":{"Line":1}},{"line":87,"address":[30916094,30914990],"length":1,"stats":{"Line":1}},{"line":89,"address":[30915118,30916325,30916222,30917216,30915221,30917120],"length":1,"stats":{"Line":2}},{"line":90,"address":[30917138,30917234],"length":1,"stats":{"Line":1}},{"line":91,"address":[30917146,30917242],"length":1,"stats":{"Line":1}},{"line":92,"address":[30917154,30917250],"length":1,"stats":{"Line":1}},{"line":95,"address":[30915613,30916717,30915246,30916350],"length":1,"stats":{"Line":1}},{"line":96,"address":[30915427,30916531],"length":1,"stats":{"Line":1}},{"line":98,"address":[30915458,30916562],"length":1,"stats":{"Line":1}}],"covered":29,"coverable":47},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","tags.rs"],"content":"//! 标签相关命令：设置当前标签、管理标签列表。\n\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::types::AppSnapshot;\n\n/// 设置当前番茄的任务标签；若为新标签则追加到 tags 并持久化。\n#[tauri::command]\npub fn set_current_tag(\n    state: tauri::State\u003c'_, AppState\u003e,\n    tag: String,\n) -\u003e Result\u003cAppSnapshot, String\u003e {\n    to_ipc_result(set_current_tag_impl(\u0026*state, tag))\n}\n\n/// 设置当前标签的内部实现（便于统一错误处理）。\nfn set_current_tag_impl\u003cS: CommandState\u003e(state: \u0026S, tag: String) -\u003e AppResult\u003cAppSnapshot\u003e {\n    let clock = crate::timer::SystemClock;\n    let tag = tag.trim().to_string();\n    if tag.is_empty() {\n        return Err(AppError::Validation(\"标签不能为空\".to_string()));\n    }\n\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            timer_runtime.set_current_tag(tag.clone(), \u0026clock);\n            if !data.tags.iter().any(|t| t == \u0026tag) {\n                data.tags.push(tag);\n            }\n            Ok(())\n        },\n        true,\n    )?;\n\n    let _ = state.emit_timer_snapshot();\n\n    Ok(AppSnapshot {\n        data: state.data_snapshot(),\n        timer: state.timer_snapshot(),\n    })\n}\n\n/// 新增一个标签到历史标签列表（持久化）。\n#[tauri::command]\npub fn add_tag(state: tauri::State\u003c'_, AppState\u003e, tag: String) -\u003e Result\u003cVec\u003cString\u003e, String\u003e {\n    to_ipc_result(add_tag_impl(\u0026*state, tag))\n}\n\n/// 新增标签的内部实现（便于统一错误处理）。\nfn add_tag_impl\u003cS: CommandState\u003e(state: \u0026S, tag: String) -\u003e AppResult\u003cVec\u003cString\u003e\u003e {\n    let tag = tag.trim().to_string();\n    if tag.is_empty() {\n        return Err(AppError::Validation(\"标签不能为空\".to_string()));\n    }\n\n    state.update_data(|data| {\n        if !data.tags.iter().any(|t| t == \u0026tag) {\n            data.tags.push(tag);\n        }\n        Ok(())\n    })?;\n\n    Ok(state.data_snapshot().tags)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n    use crate::commands::state_like::TestState;\n\n    /// `set_current_tag_impl`：空白标签应被拒绝。\n    #[test]\n    fn set_current_tag_rejects_blank() {\n        let state = TestState::new(AppData::default());\n        let err = set_current_tag_impl(\u0026state, \"   \".to_string()).unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `set_current_tag_impl`：应更新计时器当前标签，并在必要时追加到 tags。\n    #[test]\n    fn set_current_tag_updates_timer_and_tags() {\n        let state = TestState::new(AppData::default());\n        let snapshot = set_current_tag_impl(\u0026state, \"新标签\".to_string()).unwrap();\n        assert_eq!(snapshot.timer.current_tag, \"新标签\");\n        assert!(snapshot.data.tags.iter().any(|t| t == \"新标签\"));\n        assert!(state.emitted_timer_snapshot_count() \u003e= 1);\n    }\n\n    /// `add_tag_impl`：应 trim 并去重追加到 tags。\n    #[test]\n    fn add_tag_trims_and_dedupes() {\n        let state = TestState::new(AppData::default());\n        let tags = add_tag_impl(\u0026state, \"  新标签  \".to_string()).unwrap();\n        assert!(tags.iter().any(|t| t == \"新标签\"));\n\n        let tags2 = add_tag_impl(\u0026state, \"新标签\".to_string()).unwrap();\n        let count = tags2.iter().filter(|t| *t == \"新标签\").count();\n        assert_eq!(count, 1);\n    }\n}\n","traces":[{"line":12,"address":[30029757,30029786,30029568],"length":1,"stats":{"Line":0}},{"line":16,"address":[30029595,30029676],"length":1,"stats":{"Line":0}},{"line":20,"address":[33412437,33413365,33413542,33412640,33411712,33412614],"length":1,"stats":{"Line":1}},{"line":21,"address":[33411755,33412683],"length":1,"stats":{"Line":1}},{"line":22,"address":[33411763,33412759,33411831,33412691],"length":1,"stats":{"Line":2}},{"line":23,"address":[33412871,33411887,33411943,33412815],"length":1,"stats":{"Line":2}},{"line":24,"address":[33413390,33412957,33412462,33412029],"length":1,"stats":{"Line":2}},{"line":27,"address":[33412022,33413111,33413371,33412183,33412079,33412443,33412950,33413007],"length":1,"stats":{"Line":2}},{"line":28,"address":[33413568,33414411,33413950,33412882,33413979,33414382,33414000,33411954],"length":1,"stats":{"Line":2}},{"line":29,"address":[33413699,33413616,33414048,33414131],"length":1,"stats":{"Line":2}},{"line":30,"address":[33414445,33413727,33414159,33414480,33414493,33414432],"length":1,"stats":{"Line":3}},{"line":31,"address":[33413844,33414354,33414276,33413922],"length":1,"stats":{"Line":2}},{"line":33,"address":[33413903,33414335],"length":1,"stats":{"Line":1}},{"line":38,"address":[33412221,33413149],"length":1,"stats":{"Line":1}},{"line":40,"address":[33412323,33413251],"length":1,"stats":{"Line":1}},{"line":41,"address":[33413184,33412256],"length":1,"stats":{"Line":1}},{"line":42,"address":[33413204,33412276],"length":1,"stats":{"Line":1}},{"line":48,"address":[30029966,30029994,30029792],"length":1,"stats":{"Line":0}},{"line":49,"address":[30029894,30029818],"length":1,"stats":{"Line":0}},{"line":53,"address":[33408832,33409888,33410780,33409724,33410926,33409870],"length":1,"stats":{"Line":1}},{"line":54,"address":[33408951,33410007,33409931,33408875],"length":1,"stats":{"Line":2}},{"line":55,"address":[33409063,33410119,33409007,33410063],"length":1,"stats":{"Line":2}},{"line":56,"address":[33410187,33409131,33409749,33410805],"length":1,"stats":{"Line":0}},{"line":59,"address":[33410341,33411243,33411272,33411280,33411579,33409181,33411608,33409730,33409285,33409074,33410130,33410237,33410786,33410944],"length":1,"stats":{"Line":3}},{"line":60,"address":[33411677,33410987,33411406,33411323,33411070,33411616,33411629,33411664],"length":1,"stats":{"Line":4}},{"line":61,"address":[33411152,33411488,33411551,33411215],"length":1,"stats":{"Line":2}},{"line":63,"address":[33411199,33411535],"length":1,"stats":{"Line":1}},{"line":66,"address":[33409323,33410379],"length":1,"stats":{"Line":1}}],"covered":23,"coverable":28},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","templates.rs"],"content":"//! 黑名单模板相关命令：查询/保存/删除/应用模板。\n\nuse crate::app_data::{BlacklistItem, BlacklistTemplate};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{normalize_name, validate_blacklist_items};\n\n/// 获取全部黑名单模板（包含内置与自定义）。\n#[tauri::command]\npub fn get_templates(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cVec\u003cBlacklistTemplate\u003e, String\u003e {\n    to_ipc_result(get_templates_impl(\u0026*state))\n}\n\n/// 获取模板的内部实现。\nfn get_templates_impl\u003cS: CommandState\u003e(state: \u0026S) -\u003e AppResult\u003cVec\u003cBlacklistTemplate\u003e\u003e {\n    Ok(state.data_snapshot().blacklist_templates)\n}\n\n/// 保存模板：新增或更新自定义模板（内置模板不可覆盖）。\n#[tauri::command]\npub fn save_template(\n    state: tauri::State\u003c'_, AppState\u003e,\n    template: BlacklistTemplate,\n) -\u003e Result\u003cBlacklistTemplate, String\u003e {\n    to_ipc_result(save_template_impl(\u0026*state, template))\n}\n\n/// 保存模板的内部实现：校验字段并持久化。\nfn save_template_impl\u003cS: CommandState\u003e(state: \u0026S, mut template: BlacklistTemplate) -\u003e AppResult\u003cBlacklistTemplate\u003e {\n    template.name = template.name.trim().to_string();\n    if template.name.is_empty() {\n        return Err(AppError::Validation(\"模板名称不能为空\".to_string()));\n    }\n    if template.builtin {\n        return Err(AppError::Validation(\"内置模板不可保存覆盖\".to_string()));\n    }\n\n    if template.id.trim().is_empty() {\n        let ts = chrono::Utc::now().timestamp_millis();\n        template.id = format!(\"custom-{ts}\");\n    }\n\n    validate_blacklist_items(\u0026template.processes)?;\n\n    state.update_data(|data| {\n        if let Some(existing) = data\n            .blacklist_templates\n            .iter()\n            .find(|t| t.id == template.id)\n        {\n            if existing.builtin {\n                return Err(AppError::Validation(\"内置模板不可覆盖\".to_string()));\n            }\n        }\n\n        let mut next: Vec\u003cBlacklistTemplate\u003e = Vec::new();\n        let mut replaced = false;\n        for t in \u0026data.blacklist_templates {\n            if t.id == template.id {\n                next.push(template.clone());\n                replaced = true;\n            } else {\n                next.push(t.clone());\n            }\n        }\n        if !replaced {\n            next.push(template.clone());\n        }\n        data.blacklist_templates = next;\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"storage\", \"保存模板：id={} name={}\", template.id, template.name);\n    Ok(template)\n}\n\n/// 删除自定义模板（内置模板不可删除）。\n#[tauri::command]\npub fn delete_template(state: tauri::State\u003c'_, AppState\u003e, id: String) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(delete_template_impl(\u0026*state, id))\n}\n\n/// 删除模板的内部实现。\nfn delete_template_impl\u003cS: CommandState\u003e(state: \u0026S, id: String) -\u003e AppResult\u003cbool\u003e {\n    let id = id.trim().to_string();\n    if id.is_empty() {\n        return Err(AppError::Validation(\"模板 id 不能为空\".to_string()));\n    }\n\n    let mut deleted = false;\n    state.update_data(|data| {\n        let Some(existing) = data.blacklist_templates.iter().find(|t| t.id == id) else {\n            return Ok(());\n        };\n        if existing.builtin {\n            return Err(AppError::Validation(\"内置模板不可删除\".to_string()));\n        }\n\n        data.blacklist_templates = data\n            .blacklist_templates\n            .iter()\n            .filter(|t| t.id != id)\n            .cloned()\n            .collect();\n\n        data.active_template_ids.retain(|x| x != \u0026id);\n        data.active_template_id = data.active_template_ids.first().cloned();\n        deleted = true;\n        Ok(())\n    })?;\n\n    if deleted {\n        tracing::info!(target: \"storage\", \"删除模板：id={}\", id);\n    }\n\n    Ok(deleted)\n}\n\n/// 应用/切换模板：支持同时启用多套模板；返回应用后的黑名单。\n#[tauri::command]\npub fn apply_template(\n    state: tauri::State\u003c'_, AppState\u003e,\n    id: String,\n) -\u003e Result\u003cVec\u003cBlacklistItem\u003e, String\u003e {\n    to_ipc_result(apply_template_impl(\u0026*state, id))\n}\n\n/// 应用模板的内部实现：在专注期锁定时禁止切换模板。\nfn apply_template_impl\u003cS: CommandState\u003e(state: \u0026S, id: String) -\u003e AppResult\u003cVec\u003cBlacklistItem\u003e\u003e {\n    let id = id.trim().to_string();\n    if id.is_empty() {\n        return Err(AppError::Validation(\"模板 id 不能为空\".to_string()));\n    }\n\n    let locked = state.timer_snapshot().blacklist_locked;\n    if locked {\n        return Err(AppError::BlacklistLocked);\n    }\n\n    state.update_data(|data| {\n        let exists = data.blacklist_templates.iter().any(|t| t.id == id);\n        if !exists {\n            return Err(AppError::Validation(\"模板不存在\".to_string()));\n        }\n\n        if data.active_template_ids.iter().any(|x| x == \u0026id) {\n            data.active_template_ids.retain(|x| x != \u0026id);\n        } else {\n            data.active_template_ids.push(id.clone());\n        }\n\n        data.active_template_ids.sort();\n        data.active_template_id = data.active_template_ids.first().cloned();\n        data.blacklist = compute_blacklist_from_active_templates(data);\n        Ok(())\n    })?;\n\n    let out = state.data_snapshot().blacklist;\n    tracing::info!(target: \"blacklist\", \"应用模板后黑名单条目数={}\", out.len());\n    Ok(out)\n}\n\n/// 根据当前启用模板集合计算“有效黑名单”（按进程名去重，忽略大小写）。\nfn compute_blacklist_from_active_templates(data: \u0026crate::app_data::AppData) -\u003e Vec\u003cBlacklistItem\u003e {\n    let active: std::collections::BTreeSet\u003cString\u003e =\n        data.active_template_ids.iter().cloned().collect();\n    let mut out: Vec\u003cBlacklistItem\u003e = Vec::new();\n    let mut seen: std::collections::BTreeSet\u003cString\u003e = std::collections::BTreeSet::new();\n\n    for t in \u0026data.blacklist_templates {\n        if !active.contains(\u0026t.id) {\n            continue;\n        }\n        for p in \u0026t.processes {\n            let key = normalize_name(\u0026p.name);\n            if seen.insert(key) {\n                out.push(p.clone());\n            }\n        }\n    }\n\n    out\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `get_templates_impl`：应直接返回当前模板列表。\n    #[test]\n    fn get_templates_returns_templates() {\n        let data = AppData::default();\n        let state = TestState::new(data.clone());\n        let out = get_templates_impl(\u0026state).unwrap();\n        assert_eq!(out, data.blacklist_templates);\n    }\n\n    /// `save_template_impl`：应拒绝空名称或 builtin 模板覆盖。\n    #[test]\n    fn save_template_rejects_invalid_template() {\n        let state = TestState::new(AppData::default());\n\n        let err = save_template_impl(\n            \u0026state,\n            BlacklistTemplate {\n                id: \"\".to_string(),\n                name: \"   \".to_string(),\n                builtin: false,\n                processes: Vec::new(),\n            },\n        )\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let err = save_template_impl(\n            \u0026state,\n            BlacklistTemplate {\n                id: \"x\".to_string(),\n                name: \"X\".to_string(),\n                builtin: true,\n                processes: Vec::new(),\n            },\n        )\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `save_template_impl`：id 为空时应自动生成，且应新增/更新自定义模板。\n    #[test]\n    fn save_template_generates_id_and_upserts() {\n        let state = TestState::new(AppData::default());\n        let tpl = BlacklistTemplate {\n            id: \"\".to_string(),\n            name: \" 自定义 \".to_string(),\n            builtin: false,\n            processes: vec![BlacklistItem {\n                name: \"WeChat.exe\".to_string(),\n                display_name: \"微信\".to_string(),\n            }],\n        };\n\n        let saved = save_template_impl(\u0026state, tpl).unwrap();\n        assert!(saved.id.starts_with(\"custom-\"));\n        assert_eq!(saved.name, \"自定义\");\n\n        let templates = state.data_snapshot().blacklist_templates;\n        assert!(templates.iter().any(|t| t.id == saved.id));\n\n        let updated = save_template_impl(\n            \u0026state,\n            BlacklistTemplate {\n                id: saved.id.clone(),\n                name: \"自定义2\".to_string(),\n                builtin: false,\n                processes: vec![BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                }],\n            },\n        )\n        .unwrap();\n        assert_eq!(updated.id, saved.id);\n        assert_eq!(updated.name, \"自定义2\");\n    }\n\n    /// `delete_template_impl`：应拒绝删除内置模板，并正确删除自定义模板与激活信息。\n    #[test]\n    fn delete_template_enforces_builtin_and_updates_active_ids() {\n        let mut data = AppData::default();\n        data.blacklist_templates.push(BlacklistTemplate {\n            id: \"custom-1\".to_string(),\n            name: \"自定义\".to_string(),\n            builtin: false,\n            processes: vec![BlacklistItem {\n                name: \"a.exe\".to_string(),\n                display_name: \"A\".to_string(),\n            }],\n        });\n        data.active_template_ids = vec![\"custom-1\".to_string(), \"work\".to_string()];\n        data.active_template_id = Some(\"custom-1\".to_string());\n        let state = TestState::new(data);\n\n        let err = delete_template_impl(\u0026state, \"work\".to_string()).unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let deleted = delete_template_impl(\u0026state, \"custom-1\".to_string()).unwrap();\n        assert!(deleted);\n        let snap = state.data_snapshot();\n        assert!(!snap.blacklist_templates.iter().any(|t| t.id == \"custom-1\"));\n        assert!(!snap.active_template_ids.iter().any(|x| x == \"custom-1\"));\n        assert_eq!(snap.active_template_id.as_deref(), snap.active_template_ids.first().map(|s| s.as_str()));\n    }\n\n    /// `apply_template_impl`：锁定时禁止切换；未锁定时应切换 active ids 并按进程名去重。\n    #[test]\n    fn apply_template_toggles_and_dedupes_blacklist() {\n        let mut data = AppData::default();\n        data.blacklist_templates.push(BlacklistTemplate {\n            id: \"custom-1\".to_string(),\n            name: \"自定义\".to_string(),\n            builtin: false,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"wechat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n            ],\n        });\n        let state = TestState::new(data);\n\n        // 锁定：模拟工作阶段开始。\n        state\n            .update_data_and_timer(\n                |d, t| {\n                    let clock = crate::timer::SystemClock;\n                    t.start(\u0026d.settings, \u0026clock);\n                    Ok(())\n                },\n                false,\n            )\n            .unwrap();\n        assert!(state.timer_snapshot().blacklist_locked);\n\n        let err = apply_template_impl(\u0026state, \"custom-1\".to_string()).unwrap_err();\n        assert!(matches!(err, AppError::BlacklistLocked));\n\n        // 解除锁定（跳到休息阶段即可）。\n        state\n            .update_timer(|t, d| {\n                t.skip(\u0026d.settings, 1);\n                Ok(())\n            })\n            .unwrap();\n        assert!(!state.timer_snapshot().blacklist_locked);\n\n        // 切换启用 custom-1：应生效，并去重 wechat。\n        let out = apply_template_impl(\u0026state, \"custom-1\".to_string()).unwrap();\n        let wechat_count = out.iter().filter(|x| normalize_name(\u0026x.name) == \"wechat.exe\").count();\n        assert_eq!(wechat_count, 1);\n        assert!(state\n            .data_snapshot()\n            .active_template_ids\n            .iter()\n            .any(|x| x == \"custom-1\"));\n    }\n}\n","traces":[{"line":13,"address":[31555120],"length":1,"stats":{"Line":0}},{"line":14,"address":[31555139],"length":1,"stats":{"Line":0}},{"line":18,"address":[31271560,31271566,31270752,31271144,31271150,31271168],"length":1,"stats":{"Line":1}},{"line":19,"address":[31271203,31270787],"length":1,"stats":{"Line":1}},{"line":24,"address":[31555428,31555200,31555453],"length":1,"stats":{"Line":0}},{"line":28,"address":[31555227,31555311],"length":1,"stats":{"Line":0}},{"line":32,"address":[31273710,31271584,31273744,31275870],"length":1,"stats":{"Line":1}},{"line":33,"address":[31271725,31273885,31273802,31271642],"length":1,"stats":{"Line":2}},{"line":34,"address":[31274076,31271916],"length":1,"stats":{"Line":1}},{"line":35,"address":[31275762,31274119,31271959,31273602],"length":1,"stats":{"Line":2}},{"line":37,"address":[31271951,31274111],"length":1,"stats":{"Line":1}},{"line":38,"address":[31275646,31272021,31273486,31274181],"length":1,"stats":{"Line":2}},{"line":41,"address":[31274228,31274631,31272471,31272001,31272068,31274161],"length":1,"stats":{"Line":3}},{"line":42,"address":[31274308,31272148],"length":1,"stats":{"Line":1}},{"line":43,"address":[31272212,31274372],"length":1,"stats":{"Line":1}},{"line":46,"address":[31272124,31274654,31273476,31272494,31274284,31275636],"length":1,"stats":{"Line":2}},{"line":48,"address":[31276758,31274833,31277702,31276848,31277730,31274963,31276786,31272803,31273459,31272673,31275904,31275619],"length":1,"stats":{"Line":2}},{"line":49,"address":[31275955,31276957,31276899,31276013],"length":1,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[31275978,31276922],"length":1,"stats":{"Line":1}},{"line":52,"address":[31275998,31276942,31277792,31277840,31277809,31277857],"length":1,"stats":{"Line":3}},{"line":54,"address":[31276998,31276054],"length":1,"stats":{"Line":1}},{"line":55,"address":[31277062,31276118],"length":1,"stats":{"Line":0}},{"line":59,"address":[31276060,31277004],"length":1,"stats":{"Line":1}},{"line":60,"address":[31277030,31276086],"length":1,"stats":{"Line":1}},{"line":61,"address":[31276094,31277038,31277223,31276279],"length":1,"stats":{"Line":2}},{"line":62,"address":[31277329,31277592,31277697,31276753,31276385,31276648],"length":1,"stats":{"Line":3}},{"line":63,"address":[31276738,31276687,31277631,31277682],"length":1,"stats":{"Line":2}},{"line":64,"address":[31276745,31277689],"length":1,"stats":{"Line":1}},{"line":66,"address":[31276710,31276667,31277611,31277654],"length":1,"stats":{"Line":2}},{"line":69,"address":[31276399,31277343],"length":1,"stats":{"Line":1}},{"line":70,"address":[31276422,31277445,31276501,31277366],"length":1,"stats":{"Line":2}},{"line":72,"address":[31277459,31276515,31276434,31277378],"length":1,"stats":{"Line":1}},{"line":73,"address":[31276624,31277568],"length":1,"stats":{"Line":1}},{"line":76,"address":[31272828,31274988,31275297,31273137],"length":1,"stats":{"Line":1}},{"line":77,"address":[31275248,31273088],"length":1,"stats":{"Line":1}},{"line":82,"address":[31555680,31555882,31555854],"length":1,"stats":{"Line":0}},{"line":83,"address":[31555706,31555782],"length":1,"stats":{"Line":0}},{"line":87,"address":[31285534,31283200,31284384,31284350],"length":1,"stats":{"Line":1}},{"line":88,"address":[31283243,31283311,31284427,31284495],"length":1,"stats":{"Line":2}},{"line":89,"address":[31284549,31284608,31283424,31283365],"length":1,"stats":{"Line":2}},{"line":90,"address":[31283474,31284658,31285438,31284254],"length":1,"stats":{"Line":0}},{"line":93,"address":[31284619,31283435],"length":1,"stats":{"Line":1}},{"line":94,"address":[31283628,31286368,31284228,31287103,31283524,31284812,31286351,31285412,31284708,31285616,31284651,31283467],"length":1,"stats":{"Line":5}},{"line":95,"address":[31287425,31287360,31285680,31286432,31287377,31287408],"length":1,"stats":{"Line":3}},{"line":96,"address":[31285788,31286540],"length":1,"stats":{"Line":0}},{"line":98,"address":[31286523,31285771],"length":1,"stats":{"Line":1}},{"line":99,"address":[31286664,31285912],"length":1,"stats":{"Line":1}},{"line":102,"address":[31285902,31286557,31286654,31286844,31285805,31286092,31286019,31286771],"length":1,"stats":{"Line":3}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[31286577,31285825],"length":1,"stats":{"Line":1}},{"line":105,"address":[31286603,31285851,31287185,31287312,31287329,31287168],"length":1,"stats":{"Line":3}},{"line":106,"address":[31285874,31286626],"length":1,"stats":{"Line":1}},{"line":107,"address":[31285892,31286055,31286644,31286807],"length":1,"stats":{"Line":1}},{"line":109,"address":[31286868,31287264,31286116,31287216,31287229,31287277],"length":1,"stats":{"Line":3}},{"line":110,"address":[31286887,31286135,31286199,31286951],"length":1,"stats":{"Line":1}},{"line":111,"address":[31287080,31286328],"length":1,"stats":{"Line":1}},{"line":112,"address":[31287083,31286331],"length":1,"stats":{"Line":1}},{"line":115,"address":[31284837,31283653],"length":1,"stats":{"Line":1}},{"line":116,"address":[31283707,31284891],"length":1,"stats":{"Line":1}},{"line":119,"address":[31283668,31284852],"length":1,"stats":{"Line":1}},{"line":124,"address":[31555674,31555472,31555646],"length":1,"stats":{"Line":0}},{"line":128,"address":[31555498,31555574],"length":1,"stats":{"Line":0}},{"line":132,"address":[31279616,31281198,31279598,31277888,31281326,31279470],"length":1,"stats":{"Line":1}},{"line":133,"address":[31279659,31279733,31277931,31278005],"length":1,"stats":{"Line":2}},{"line":134,"address":[31279846,31278118,31279787,31278059],"length":1,"stats":{"Line":2}},{"line":135,"address":[31279502,31278144,31279872,31281230],"length":1,"stats":{"Line":0}},{"line":138,"address":[31278178,31279865,31279906,31278137],"length":1,"stats":{"Line":2}},{"line":139,"address":[31278215,31279943],"length":1,"stats":{"Line":1}},{"line":140,"address":[31279982,31278254],"length":1,"stats":{"Line":1}},{"line":143,"address":[31278242,31282113,31278409,31282176,31281204,31278305,31281392,31279970,31280137,31279476,31282897,31280033],"length":1,"stats":{"Line":3}},{"line":144,"address":[31282937,31281443,31282912,31283056,31282227,31283081],"length":1,"stats":{"Line":3}},{"line":145,"address":[31282284,31281500],"length":1,"stats":{"Line":1}},{"line":146,"address":[31282288,31281504],"length":1,"stats":{"Line":0}},{"line":149,"address":[31281605,31282960,31282389,31282973,31283008,31283021],"length":1,"stats":{"Line":3}},{"line":150,"address":[31283152,31283165,31283104,31282528,31283117,31281744],"length":1,"stats":{"Line":0}},{"line":152,"address":[31281690,31282474],"length":1,"stats":{"Line":1}},{"line":155,"address":[31281758,31282542],"length":1,"stats":{"Line":1}},{"line":156,"address":[31282644,31281860,31281796,31282580],"length":1,"stats":{"Line":1}},{"line":157,"address":[31281975,31281997,31282781,31282759],"length":1,"stats":{"Line":1}},{"line":158,"address":[31282885,31282101],"length":1,"stats":{"Line":1}},{"line":161,"address":[31280175,31278447],"length":1,"stats":{"Line":1}},{"line":162,"address":[31280553,31280895,31279167,31278825],"length":1,"stats":{"Line":1}},{"line":163,"address":[31280810,31279082],"length":1,"stats":{"Line":1}},{"line":167,"address":[31556655,31556679,31555888],"length":1,"stats":{"Line":1}},{"line":168,"address":[31555926],"length":1,"stats":{"Line":1}},{"line":170,"address":[31555994],"length":1,"stats":{"Line":1}},{"line":171,"address":[31556038],"length":1,"stats":{"Line":1}},{"line":173,"address":[31556104,31556172],"length":1,"stats":{"Line":2}},{"line":174,"address":[31556278,31556375],"length":1,"stats":{"Line":2}},{"line":177,"address":[31556389],"length":1,"stats":{"Line":1}},{"line":178,"address":[31556525],"length":1,"stats":{"Line":1}},{"line":179,"address":[31556583],"length":1,"stats":{"Line":1}},{"line":180,"address":[31556620],"length":1,"stats":{"Line":1}},{"line":185,"address":[31556294],"length":1,"stats":{"Line":1}}],"covered":79,"coverable":95},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","timer.rs"],"content":"//! 计时器相关命令：开始/暂停/重置/跳过（供前端与托盘复用）。\n\nuse crate::app_data::Phase;\nuse crate::errors::AppResult;\nuse crate::state::AppState;\nuse crate::timer::{compute_today_stats, TimerClock, TimerSnapshot};\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\n\n/// 开始计时（若处于工作阶段首次开始，则终止黑名单进程）。\n#[tauri::command]\npub fn timer_start(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_start_impl(\u0026state))\n}\n\n/// 托盘复用：开始计时的内部实现（不暴露给前端）。\npub fn timer_start_inner(state: \u0026AppState) -\u003e AppResult\u003c()\u003e {\n    timer_start_transition_with_deps(\n        state,\n        \u0026crate::timer::SystemClock,\n        |names| crate::processes::kill_names_best_effort(names),\n    )?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(())\n}\n\n/// 开始计时的 IPC 入口实现：先执行内部逻辑，再返回快照。\nfn timer_start_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_start_inner(state)?;\n    Ok(state.timer_snapshot())\n}\n\n/// 开始计时的可测试实现：可注入 clock 与 kill 函数（避免测试中触发系统调用）。\nfn timer_start_transition_with_deps\u003cS: CommandState\u003e(\n    state: \u0026S,\n    clock: \u0026dyn TimerClock,\n    kill_names: impl FnOnce(\u0026[String]) -\u003e crate::processes::KillSummary,\n) -\u003e AppResult\u003c()\u003e {\n    let (names_to_kill, should_kill) = state.update_data_and_timer(\n        |data, timer_runtime| {\n            let should_kill = timer_runtime.phase == Phase::Work\n                \u0026\u0026 !timer_runtime.blacklist_locked()\n                \u0026\u0026 !timer_runtime.is_running;\n            let names: Vec\u003cString\u003e = data.blacklist.iter().map(|b| b.name.clone()).collect();\n            timer_runtime.start(\u0026data.settings, clock);\n            Ok((names, should_kill))\n        },\n        false,\n    )?;\n\n    tracing::info!(\n        target: \"timer\",\n        \"开始计时：phase={:?} tag={} remaining={}s\",\n        state.timer_snapshot().phase,\n        state.timer_snapshot().current_tag,\n        state.timer_snapshot().remaining_seconds\n    );\n\n    if should_kill {\n        tracing::info!(target: \"blacklist\", \"工作阶段首次开始，尝试终止黑名单进程：{:?}\", names_to_kill);\n        let payload = kill_names(\u0026names_to_kill);\n        let _ = state.emit_kill_result(payload);\n    }\n\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n/// 暂停计时。\n#[tauri::command]\npub fn timer_pause(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_pause_impl(\u0026state))\n}\n\n/// 托盘复用：暂停计时的内部实现（不暴露给前端）。\npub fn timer_pause_inner(state: \u0026AppState) -\u003e AppResult\u003c()\u003e {\n    timer_pause_transition(state)?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(())\n}\n\n/// 暂停计时的 IPC 入口实现：先执行内部逻辑，再返回快照。\nfn timer_pause_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_pause_inner(state)?;\n    Ok(state.timer_snapshot())\n}\n\n/// 暂停计时的可测试实现：不依赖托盘与系统资源。\nfn timer_pause_transition\u003cS: CommandState\u003e(state: \u0026S) -\u003e AppResult\u003c()\u003e {\n    state.update_timer(|timer_runtime, _data| {\n        timer_runtime.pause();\n        Ok(())\n    })?;\n\n    tracing::info!(\n        target: \"timer\",\n        \"暂停计时：phase={:?} remaining={}s\",\n        state.timer_snapshot().phase,\n        state.timer_snapshot().remaining_seconds\n    );\n\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n/// 重置计时（回到工作阶段初始状态）。\n#[tauri::command]\npub fn timer_reset(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_reset_impl(\u0026state))\n}\n\n/// 重置计时的内部实现（便于统一错误处理）。\nfn timer_reset_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_reset_transition(state)?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(state.timer_snapshot())\n}\n\n/// 重置计时的可测试实现：不依赖托盘与系统资源。\nfn timer_reset_transition\u003cS: CommandState\u003e(state: \u0026S) -\u003e AppResult\u003c()\u003e {\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            timer_runtime.reset(\u0026data.settings);\n            Ok(())\n        },\n        false,\n    )?;\n\n    tracing::info!(target: \"timer\", \"重置计时器：回到工作阶段\");\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n/// 跳过当前阶段（不写入历史）。\n#[tauri::command]\npub fn timer_skip(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_skip_impl(\u0026state))\n}\n\n/// 跳过阶段的内部实现（便于统一错误处理）。\nfn timer_skip_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_skip_transition_with_clock(state, \u0026crate::timer::SystemClock)?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(state.timer_snapshot())\n}\n\n/// 跳过阶段的可测试实现：可注入 `clock`，避免依赖真实日期。\nfn timer_skip_transition_with_clock\u003cS: CommandState\u003e(state: \u0026S, clock: \u0026dyn TimerClock) -\u003e AppResult\u003c()\u003e {\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            let today = clock.today_date();\n            let completed_today = compute_today_stats(data, \u0026today).total;\n            timer_runtime.skip(\u0026data.settings, completed_today);\n            Ok(())\n        },\n        false,\n    )?;\n\n    tracing::info!(target: \"timer\", \"跳过阶段：phase={:?}\", state.timer_snapshot().phase);\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{AppData, BlacklistItem, HistoryDay, HistoryRecord, Phase, Settings};\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// 固定时钟：用于让命令层测试稳定可复现。\n    struct FixedClock {\n        today: String,\n        now: String,\n        week_from: String,\n        week_to: String,\n    }\n\n    impl FixedClock {\n        /// 构造一个固定时钟（weekRange 默认覆盖 today）。\n        fn new(today: \u0026str, now: \u0026str) -\u003e Self {\n            Self {\n                today: today.to_string(),\n                now: now.to_string(),\n                week_from: today.to_string(),\n                week_to: today.to_string(),\n            }\n        }\n    }\n\n    impl TimerClock for FixedClock {\n        /// 返回固定日期。\n        fn today_date(\u0026self) -\u003e String {\n            self.today.clone()\n        }\n\n        /// 返回固定时间。\n        fn now_hhmm(\u0026self) -\u003e String {\n            self.now.clone()\n        }\n\n        /// 返回固定周范围。\n        fn current_week_range(\u0026self) -\u003e (String, String) {\n            (self.week_from.clone(), self.week_to.clone())\n        }\n    }\n\n    /// `timer_start_transition_with_deps`：工作阶段首次开始应触发 kill，并广播快照。\n    #[test]\n    fn timer_start_kills_on_first_work_start() {\n        let mut data = AppData::default();\n        data.blacklist = vec![BlacklistItem {\n            name: \"a.exe\".to_string(),\n            display_name: \"A\".to_string(),\n        }];\n        data.settings = Settings {\n            pomodoro: 1,\n            ..data.settings\n        };\n        let state = TestState::new(data);\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n\n        timer_start_transition_with_deps(\u0026state, \u0026clock, |names| crate::processes::KillSummary {\n            items: vec![crate::processes::termination::KillItem {\n                name: names[0].clone(),\n                pids: vec![1],\n                killed: 1,\n                failed: 0,\n                requires_admin: false,\n            }],\n            requires_admin: false,\n        })\n        .unwrap();\n\n        assert!(state.timer_snapshot().is_running);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n        let kills = state.take_kill_results();\n        assert_eq!(kills.len(), 1);\n        assert_eq!(kills[0].items[0].name, \"a.exe\");\n\n        // 再次开始：不应重复 kill。\n        timer_start_transition_with_deps(\u0026state, \u0026clock, |_names| unreachable!(\"不应再触发 kill\")).unwrap();\n        assert_eq!(state.take_kill_results().len(), 0);\n        assert_eq!(state.emitted_timer_snapshot_count(), 2);\n    }\n\n    /// `timer_pause_transition`：暂停应设置 is_running=false 并广播快照。\n    #[test]\n    fn timer_pause_pauses_and_emits() {\n        let state = TestState::new(AppData::default());\n        state\n            .update_timer(|t, _d| {\n                t.is_running = true;\n                Ok(())\n            })\n            .unwrap();\n\n        timer_pause_transition(\u0026state).unwrap();\n        assert!(!state.timer_snapshot().is_running);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n    }\n\n    /// `timer_reset_transition`：应回到工作阶段初始剩余时间并广播快照。\n    #[test]\n    fn timer_reset_resets_and_emits() {\n        let mut data = AppData::default();\n        data.settings.pomodoro = 2;\n        let state = TestState::new(data);\n        state\n            .update_timer(|t, _d| {\n                t.phase = Phase::LongBreak;\n                t.remaining_seconds = 1;\n                t.is_running = true;\n                Ok(())\n            })\n            .unwrap();\n\n        timer_reset_transition(\u0026state).unwrap();\n        let snap = state.timer_snapshot();\n        assert_eq!(snap.phase, Phase::Work);\n        assert_eq!(snap.remaining_seconds, 2 * 60);\n        assert!(!snap.is_running);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n    }\n\n    /// `timer_skip_transition_with_clock`：应按 completed_today 与 long_break_interval 切换阶段并广播快照。\n    #[test]\n    fn timer_skip_switches_phase_and_emits() {\n        let mut data = AppData::default();\n        data.settings.short_break = 1;\n        data.settings.long_break = 2;\n        data.settings.long_break_interval = 2;\n        data.history = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"学习\".to_string(),\n                start_time: \"08:00\".to_string(),\n                end_time: Some(\"08:25\".to_string()),\n                duration: 25,\n                phase: Phase::Work,\n                remark: String::new(),\n            }],\n        }];\n        let state = TestState::new(data);\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n\n        // completed_today=1，跳过工作阶段后 completed_today_after=1，不是 2 的倍数 -\u003e 短休息。\n        timer_skip_transition_with_clock(\u0026state, \u0026clock).unwrap();\n        assert_eq!(state.timer_snapshot().phase, Phase::ShortBreak);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n    }\n}\n","traces":[{"line":13,"address":[30885840],"length":1,"stats":{"Line":0}},{"line":14,"address":[30885862],"length":1,"stats":{"Line":0}},{"line":18,"address":[30886960],"length":1,"stats":{"Line":0}},{"line":22,"address":[33085686,33085664],"length":1,"stats":{"Line":0}},{"line":24,"address":[30887105],"length":1,"stats":{"Line":0}},{"line":25,"address":[30887136],"length":1,"stats":{"Line":0}},{"line":29,"address":[30886576],"length":1,"stats":{"Line":0}},{"line":30,"address":[30886605],"length":1,"stats":{"Line":0}},{"line":31,"address":[30886709],"length":1,"stats":{"Line":0}},{"line":35,"address":[33093164,33095284,33091088,33093200,33095312,33097388,33097396,33095276,33093172],"length":1,"stats":{"Line":2}},{"line":40,"address":[33091242,33095466,33095367,33091143,33095573,33093255,33093461,33093354,33091349],"length":1,"stats":{"Line":4}},{"line":41,"address":[33098235,33097813,33097840,33097424,33098699,33097819,33098229,33098304,33098693],"length":1,"stats":{"Line":2}},{"line":42,"address":[33097500,33097520,33098380,33097916,33097936,33098400],"length":1,"stats":{"Line":3}},{"line":43,"address":[33097948,33098412,33097532],"length":1,"stats":{"Line":2}},{"line":44,"address":[33097962,33097546,33098426],"length":1,"stats":{"Line":1}},{"line":45,"address":[33097561,33099024,33099059,33097977,33098441,33098995,33098960,33099088,33099123],"length":1,"stats":{"Line":6}},{"line":46,"address":[33098500,33098036,33097620],"length":1,"stats":{"Line":2}},{"line":47,"address":[33098101,33097685,33098565],"length":1,"stats":{"Line":2}},{"line":52,"address":[33096057,33093945,33091833],"length":1,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[33091768,33093880,33095992],"length":1,"stats":{"Line":2}},{"line":61,"address":[33094523,33092411,33092711,33096635,33096935,33094823],"length":1,"stats":{"Line":1}},{"line":62,"address":[33092663,33097383,33095063,33093159,33092951,33096887,33094775,33097175,33095271],"length":1,"stats":{"Line":1}},{"line":63,"address":[33093057,33095169,33097281],"length":1,"stats":{"Line":1}},{"line":66,"address":[33095202,33096625,33093090,33097314,33094513,33092401],"length":1,"stats":{"Line":4}},{"line":67,"address":[33097329,33095217,33093105],"length":1,"stats":{"Line":2}},{"line":72,"address":[30885680],"length":1,"stats":{"Line":0}},{"line":73,"address":[30885702],"length":1,"stats":{"Line":0}},{"line":77,"address":[30886768],"length":1,"stats":{"Line":0}},{"line":78,"address":[30886797],"length":1,"stats":{"Line":0}},{"line":79,"address":[30886901],"length":1,"stats":{"Line":0}},{"line":80,"address":[30886932],"length":1,"stats":{"Line":0}},{"line":84,"address":[30886160],"length":1,"stats":{"Line":0}},{"line":85,"address":[30886189],"length":1,"stats":{"Line":0}},{"line":86,"address":[30886293],"length":1,"stats":{"Line":0}},{"line":90,"address":[33087359,33085712,33086527,33086521,33086544,33087353],"length":1,"stats":{"Line":1}},{"line":91,"address":[33086652,33087376,33085742,33087536,33086574,33085820],"length":1,"stats":{"Line":2}},{"line":92,"address":[33087573,33087413],"length":1,"stats":{"Line":1}},{"line":93,"address":[33087428,33087588],"length":1,"stats":{"Line":1}},{"line":96,"address":[33086065,33086945,33085845,33086113,33086149,33086677,33086186,33086897,33086981,33087018],"length":1,"stats":{"Line":1}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[33086854,33086022],"length":1,"stats":{"Line":1}},{"line":104,"address":[33086053,33086885],"length":1,"stats":{"Line":1}},{"line":109,"address":[30885760],"length":1,"stats":{"Line":0}},{"line":110,"address":[30885782],"length":1,"stats":{"Line":0}},{"line":114,"address":[30886352],"length":1,"stats":{"Line":0}},{"line":115,"address":[30886382],"length":1,"stats":{"Line":0}},{"line":116,"address":[30886487],"length":1,"stats":{"Line":0}},{"line":117,"address":[30886518],"length":1,"stats":{"Line":0}},{"line":121,"address":[33087600,33088176],"length":1,"stats":{"Line":1}},{"line":122,"address":[33087710,33088206,33087630,33088286],"length":1,"stats":{"Line":1}},{"line":123,"address":[33088800,33088880],"length":1,"stats":{"Line":1}},{"line":124,"address":[33088837,33088917],"length":1,"stats":{"Line":1}},{"line":125,"address":[33088859,33088939],"length":1,"stats":{"Line":1}},{"line":130,"address":[33088311,33087735,33087955,33088531],"length":1,"stats":{"Line":1}},{"line":131,"address":[33087912,33088488],"length":1,"stats":{"Line":1}},{"line":132,"address":[33088519,33087943],"length":1,"stats":{"Line":1}},{"line":137,"address":[30885600],"length":1,"stats":{"Line":0}},{"line":138,"address":[30885622],"length":1,"stats":{"Line":0}},{"line":142,"address":[30885920],"length":1,"stats":{"Line":0}},{"line":143,"address":[30885950],"length":1,"stats":{"Line":0}},{"line":144,"address":[30886067],"length":1,"stats":{"Line":0}},{"line":145,"address":[30886098],"length":1,"stats":{"Line":0}},{"line":149,"address":[33089008,33090403,33089693,33089699,33090397,33089712],"length":1,"stats":{"Line":1}},{"line":150,"address":[33089135,33089758,33089054,33089839],"length":1,"stats":{"Line":1}},{"line":151,"address":[33090464,33090800,33090720,33090726,33091062,33091056],"length":1,"stats":{"Line":1}},{"line":152,"address":[33090859,33090523],"length":1,"stats":{"Line":1}},{"line":153,"address":[33090622,33090544,33090880,33090958],"length":1,"stats":{"Line":2}},{"line":154,"address":[33091006,33090670],"length":1,"stats":{"Line":1}},{"line":155,"address":[33091025,33090689],"length":1,"stats":{"Line":1}},{"line":160,"address":[33089864,33089380,33090084,33089160],"length":1,"stats":{"Line":1}},{"line":161,"address":[33090041,33089337],"length":1,"stats":{"Line":1}},{"line":162,"address":[33090072,33089368],"length":1,"stats":{"Line":1}}],"covered":40,"coverable":80},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","validation.rs"],"content":"//! 命令层输入校验与通用数据选择逻辑（避免散落在各个模块中）。\n\nuse crate::app_data::{BlacklistItem, DateRange, HistoryDay};\nuse crate::errors::{AppError, AppResult};\n\n/// 校验黑名单条目：名称不能为空、不得重复（忽略大小写）。\npub(crate) fn validate_blacklist_items(items: \u0026[BlacklistItem]) -\u003e AppResult\u003c()\u003e {\n    let mut seen = std::collections::BTreeSet::\u003cString\u003e::new();\n    for it in items {\n        if it.name.trim().is_empty() {\n            return Err(AppError::Validation(\"黑名单进程名不能为空\".to_string()));\n        }\n        if it.display_name.trim().is_empty() {\n            return Err(AppError::Validation(\"黑名单显示名不能为空\".to_string()));\n        }\n        let key = normalize_name(\u0026it.name);\n        if !seen.insert(key) {\n            return Err(AppError::Validation(\"黑名单存在重复进程名\".to_string()));\n        }\n    }\n    Ok(())\n}\n\n/// 规范化进程名用于比较（Windows 下大小写不敏感）。\npub(crate) fn normalize_name(name: \u0026str) -\u003e String {\n    name.trim().to_ascii_lowercase()\n}\n\n/// 校验日期字符串是否符合 `YYYY-MM-DD`。\npub(crate) fn validate_ymd(date: \u0026str) -\u003e AppResult\u003c()\u003e {\n    chrono::NaiveDate::parse_from_str(date, \"%Y-%m-%d\")\n        .map_err(|_| AppError::Validation(\"日期格式必须为 YYYY-MM-DD\".to_string()))?;\n    Ok(())\n}\n\n/// 校验日期范围：格式正确且 `from \u003c= to`。\npub(crate) fn validate_date_range(range: \u0026DateRange) -\u003e AppResult\u003c()\u003e {\n    validate_ymd(range.from.trim())?;\n    validate_ymd(range.to.trim())?;\n    if range.from.trim() \u003e range.to.trim() {\n        return Err(AppError::Validation(\n            \"日期范围不合法：from 不能晚于 to\".to_string(),\n        ));\n    }\n    Ok(())\n}\n\n/// 选择供“历史页面/导出/分析”使用的历史数据源（开发环境：优先 `history_dev`）。\npub(crate) fn history_for_ui(data: \u0026crate::app_data::AppData) -\u003e \u0026Vec\u003cHistoryDay\u003e {\n    if cfg!(debug_assertions) \u0026\u0026 !data.history_dev.is_empty() {\n        \u0026data.history_dev\n    } else {\n        \u0026data.history\n    }\n}\n\n/// 选择供“历史备注编辑”使用的可变历史数据源（开发环境：优先 `history_dev`）。\npub(crate) fn history_for_ui_mut(data: \u0026mut crate::app_data::AppData) -\u003e \u0026mut Vec\u003cHistoryDay\u003e {\n    if cfg!(debug_assertions) \u0026\u0026 !data.history_dev.is_empty() {\n        \u0026mut data.history_dev\n    } else {\n        \u0026mut data.history\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n\n    /// `normalize_name`：应 trim 并转为小写，用于忽略大小写比较。\n    #[test]\n    fn normalize_name_trims_and_lowercases() {\n        assert_eq!(normalize_name(\" WeChat.EXE \"), \"wechat.exe\");\n    }\n\n    /// `validate_blacklist_items`：空列表应通过。\n    #[test]\n    fn validate_blacklist_items_accepts_empty() {\n        assert!(validate_blacklist_items(\u0026[]).is_ok());\n    }\n\n    /// `validate_blacklist_items`：名称与显示名不能为空。\n    #[test]\n    fn validate_blacklist_items_rejects_blank_fields() {\n        let err = validate_blacklist_items(\u0026[BlacklistItem {\n            name: \"   \".to_string(),\n            display_name: \"微信\".to_string(),\n        }])\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let err = validate_blacklist_items(\u0026[BlacklistItem {\n            name: \"WeChat.exe\".to_string(),\n            display_name: \"   \".to_string(),\n        }])\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `validate_blacklist_items`：应拒绝重复进程名（忽略大小写）。\n    #[test]\n    fn validate_blacklist_items_rejects_duplicates_case_insensitive() {\n        let err = validate_blacklist_items(\u0026[\n            BlacklistItem {\n                name: \"WeChat.exe\".to_string(),\n                display_name: \"微信\".to_string(),\n            },\n            BlacklistItem {\n                name: \"wechat.exe\".to_string(),\n                display_name: \"微信\".to_string(),\n            },\n        ])\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `validate_ymd`：合法日期应通过，非法格式应失败。\n    #[test]\n    fn validate_ymd_accepts_and_rejects() {\n        assert!(validate_ymd(\"2025-01-01\").is_ok());\n        assert!(matches!(validate_ymd(\"2025/01/01\"), Err(AppError::Validation(_))));\n    }\n\n    /// `validate_date_range`：应校验格式并确保 from \u003c= to。\n    #[test]\n    fn validate_date_range_validates_order_and_format() {\n        assert!(validate_date_range(\u0026DateRange {\n            from: \"2025-01-01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .is_ok());\n\n        assert!(matches!(\n            validate_date_range(\u0026DateRange {\n                from: \"2025-01-08\".to_string(),\n                to: \"2025-01-07\".to_string(),\n            }),\n            Err(AppError::Validation(_))\n        ));\n\n        assert!(matches!(\n            validate_date_range(\u0026DateRange {\n                from: \"bad\".to_string(),\n                to: \"2025-01-07\".to_string(),\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n\n    /// `history_for_ui`：开发环境下若存在 `history_dev`，应优先返回它。\n    #[test]\n    fn history_for_ui_prefers_history_dev_in_debug() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            history_dev: vec![HistoryDay {\n                date: \"2099-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            ..AppData::default()\n        };\n\n        let out = history_for_ui(\u0026data);\n        assert_eq!(out[0].date, \"2099-01-01\");\n    }\n\n    /// `history_for_ui_mut`：当 `history_dev` 为空时应回退到 `history`。\n    #[test]\n    fn history_for_ui_mut_falls_back_to_history() {\n        let mut data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            history_dev: Vec::new(),\n            ..AppData::default()\n        };\n\n        history_for_ui_mut(\u0026mut data).push(HistoryDay {\n            date: \"2025-01-02\".to_string(),\n            records: Vec::new(),\n        });\n        assert_eq!(data.history.len(), 2);\n        assert!(data.history_dev.is_empty());\n    }\n}\n","traces":[{"line":7,"address":[33121024,33121946,33121952],"length":1,"stats":{"Line":1}},{"line":8,"address":[33121084],"length":1,"stats":{"Line":1}},{"line":9,"address":[33121105,33121184],"length":1,"stats":{"Line":2}},{"line":10,"address":[33121285,33121353],"length":1,"stats":{"Line":2}},{"line":11,"address":[33121863,33121427],"length":1,"stats":{"Line":2}},{"line":13,"address":[33121406,33121471],"length":1,"stats":{"Line":2}},{"line":14,"address":[33121778,33121541],"length":1,"stats":{"Line":2}},{"line":16,"address":[33121593,33121524],"length":1,"stats":{"Line":2}},{"line":17,"address":[33121616],"length":1,"stats":{"Line":1}},{"line":18,"address":[33121641],"length":1,"stats":{"Line":1}},{"line":21,"address":[33121307],"length":1,"stats":{"Line":1}},{"line":25,"address":[33120336],"length":1,"stats":{"Line":1}},{"line":26,"address":[33120386],"length":1,"stats":{"Line":1}},{"line":30,"address":[33120000],"length":1,"stats":{"Line":1}},{"line":31,"address":[33120133,33120201,33120057],"length":1,"stats":{"Line":3}},{"line":32,"address":[28669216,28669237],"length":1,"stats":{"Line":4}},{"line":33,"address":[33120239],"length":1,"stats":{"Line":1}},{"line":37,"address":[33120480],"length":1,"stats":{"Line":1}},{"line":38,"address":[33120516],"length":1,"stats":{"Line":1}},{"line":39,"address":[33120642],"length":1,"stats":{"Line":1}},{"line":40,"address":[33120787],"length":1,"stats":{"Line":1}},{"line":41,"address":[33120930],"length":1,"stats":{"Line":1}},{"line":42,"address":[33120899],"length":1,"stats":{"Line":1}},{"line":45,"address":[33120890],"length":1,"stats":{"Line":1}},{"line":49,"address":[33120272],"length":1,"stats":{"Line":1}},{"line":50,"address":[33120285,33120311],"length":1,"stats":{"Line":2}},{"line":51,"address":[33120302],"length":1,"stats":{"Line":1}},{"line":53,"address":[33120317],"length":1,"stats":{"Line":0}},{"line":58,"address":[33120416],"length":1,"stats":{"Line":1}},{"line":59,"address":[33120470,33120429,33120455],"length":1,"stats":{"Line":3}},{"line":60,"address":[33120446],"length":1,"stats":{"Line":1}},{"line":62,"address":[33120461],"length":1,"stats":{"Line":1}}],"covered":31,"coverable":32},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","errors.rs"],"content":"//! 统一错误类型与 `Result` 别名。\n\nuse thiserror::Error;\n\n/// 应用内部通用错误。\n#[derive(Debug, Error)]\npub enum AppError {\n    /// JSON 序列化/反序列化失败。\n    #[error(\"JSON 处理失败：{0}\")]\n    Json(#[from] serde_json::Error),\n\n    /// Store 插件失败。\n    #[error(\"Store 失败：{0}\")]\n    Store(#[from] tauri_plugin_store::Error),\n\n    /// Tauri 框架错误。\n    #[error(\"Tauri 运行失败：{0}\")]\n    Tauri(#[from] tauri::Error),\n\n    /// 系统通知失败。\n    #[error(\"通知失败：{0}\")]\n    Notification(#[from] tauri_plugin_notification::Error),\n\n    /// 参数校验失败。\n    #[error(\"参数不合法：{0}\")]\n    Validation(String),\n\n    /// 黑名单在专注期被锁定，禁止移除。\n    #[error(\"专注期内禁止移除黑名单进程\")]\n    BlacklistLocked,\n\n    /// 平台不支持。\n    #[error(\"当前平台不支持：{0}\")]\n    #[cfg_attr(windows, allow(dead_code))]\n    UnsupportedPlatform(String),\n\n    /// 内部不变量被破坏（逻辑错误）。\n    #[error(\"内部错误：{0}\")]\n    Invariant(String),\n\n    /// 终止进程失败（通常是权限不足，仅 Windows 使用）。\n    #[error(\"终止进程失败：{0}\")]\n    #[cfg(windows)]\n    KillFailed(String),\n}\n\n/// 应用内部 `Result` 统一别名。\npub type AppResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `AppError::Json`：Display 应包含“JSON 处理失败”前缀。\n    #[test]\n    fn app_error_display_json() {\n        let err = serde_json::from_str::\u003cserde_json::Value\u003e(\"{\").unwrap_err();\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"JSON 处理失败：\"));\n    }\n\n    /// `AppError::Store`：Display 应包含“Store 失败”前缀。\n    #[test]\n    fn app_error_display_store() {\n        let err = tauri_plugin_store::Error::Io(std::io::Error::new(\n            std::io::ErrorKind::Other,\n            \"boom\",\n        ));\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"Store 失败：\"));\n        assert!(app_err.to_string().contains(\"boom\"));\n    }\n\n    /// `AppError::Tauri`：Display 应包含“Tauri 运行失败”前缀。\n    #[test]\n    fn app_error_display_tauri() {\n        let err = tauri::Error::AssetNotFound(\"missing\".to_string());\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"Tauri 运行失败：\"));\n        assert!(app_err.to_string().contains(\"asset not found\"));\n    }\n\n    /// `AppError::Notification`：Display 应包含“通知失败”前缀。\n    #[test]\n    fn app_error_display_notification() {\n        let err = tauri_plugin_notification::Error::Io(std::io::Error::new(\n            std::io::ErrorKind::Other,\n            \"notify\",\n        ));\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"通知失败：\"));\n        assert!(app_err.to_string().contains(\"notify\"));\n    }\n\n    /// `AppError::Validation`：Display 应包含“参数不合法”前缀与原始信息。\n    #[test]\n    fn app_error_display_validation() {\n        let app_err = AppError::Validation(\"bad\".to_string());\n        assert_eq!(app_err.to_string(), \"参数不合法：bad\");\n    }\n\n    /// `AppError::BlacklistLocked`：Display 应为固定文案。\n    #[test]\n    fn app_error_display_blacklist_locked() {\n        let app_err = AppError::BlacklistLocked;\n        assert_eq!(app_err.to_string(), \"专注期内禁止移除黑名单进程\");\n    }\n\n    /// `AppError::UnsupportedPlatform`：Display 应包含“不支持”与原因。\n    #[test]\n    fn app_error_display_unsupported_platform() {\n        let app_err = AppError::UnsupportedPlatform(\"x\".to_string());\n        assert_eq!(app_err.to_string(), \"当前平台不支持：x\");\n    }\n\n    /// `AppError::Invariant`：Display 应包含“内部错误”前缀。\n    #[test]\n    fn app_error_display_invariant() {\n        let app_err = AppError::Invariant(\"oops\".to_string());\n        assert_eq!(app_err.to_string(), \"内部错误：oops\");\n    }\n\n    /// `AppError::KillFailed`：Windows 下 Display 应包含“终止进程失败”前缀。\n    #[cfg(windows)]\n    #[test]\n    fn app_error_display_kill_failed_on_windows() {\n        let app_err = AppError::KillFailed(\"ACCESS_DENIED\".to_string());\n        assert!(app_err.to_string().contains(\"终止进程失败：\"));\n        assert!(app_err.to_string().contains(\"ACCESS_DENIED\"));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","processes","enumeration.rs"],"content":"//! 进程枚举与图标提取（用于黑名单管理 UI）。\n\nuse std::collections::BTreeMap;\n\nuse serde::{Deserialize, Serialize};\nuse sysinfo::System;\nuse ts_rs::TS;\n\n#[cfg(windows)]\nuse crate::errors::AppError;\nuse crate::errors::AppResult;\n\n/// 前端展示用的进程信息。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct ProcessInfo {\n    /// 进程名（例如 `WeChat.exe`）。\n    pub name: String,\n    /// 代表性 PID（用于展示）。\n    pub pid: u32,\n    /// 可执行文件路径（若可获取）。\n    pub exe_path: Option\u003cString\u003e,\n    /// 进程图标（data URL：`data:image/png;base64,...`）。\n    pub icon_data_url: Option\u003cString\u003e,\n}\n\n/// 内部用的“进程快照”条目（用于将 sysinfo 结果转为可测试的纯数据流）。\n#[derive(Debug, Clone)]\nstruct ProcessEntry {\n    /// 进程名。\n    name: String,\n    /// PID。\n    pid: u32,\n    /// 可执行文件路径。\n    exe_path: Option\u003cString\u003e,\n}\n\n/// 获取当前运行进程列表（按进程名去重并按名称排序）。\npub fn list_processes() -\u003e AppResult\u003cVec\u003cProcessInfo\u003e\u003e {\n    let mut system = System::new_all();\n    system.refresh_all();\n\n    let entries = system.processes().iter().map(|(pid, process)| {\n        let exe_path = process.exe().and_then(|p| {\n            if p.as_os_str().is_empty() {\n                None\n            } else {\n                Some(p.to_string_lossy().to_string())\n            }\n        });\n        ProcessEntry {\n            name: process.name().to_string(),\n            pid: pid.as_u32(),\n            exe_path,\n        }\n    });\n\n    Ok(list_processes_from_entries(entries))\n}\n\n/// 将“进程快照”条目列表转为前端展示用 `ProcessInfo`（去重、排序、图标 best-effort）。\nfn list_processes_from_entries(entries: impl IntoIterator\u003cItem = ProcessEntry\u003e) -\u003e Vec\u003cProcessInfo\u003e {\n    let mut by_name: BTreeMap\u003cString, ProcessInfo\u003e = BTreeMap::new();\n\n    for entry in entries {\n        let exe_path = entry.exe_path.and_then(|p| {\n            if p.trim().is_empty() {\n                None\n            } else {\n                Some(p)\n            }\n        });\n\n        by_name.entry(entry.name.clone()).or_insert_with(|| ProcessInfo {\n            name: entry.name,\n            pid: entry.pid,\n            exe_path: exe_path.clone(),\n            icon_data_url: exe_path\n                .as_deref()\n                .and_then(|p| icon_data_url_best_effort(p).ok().flatten()),\n        });\n    }\n\n    by_name.into_values().collect()\n}\n\n/// 将可执行文件路径转为图标 data URL（失败时返回 `Ok(None)`）。\nfn icon_data_url_best_effort(exe_path: \u0026str) -\u003e AppResult\u003cOption\u003cString\u003e\u003e {\n    #[cfg(windows)]\n    {\n        use base64::Engine as _;\n        use std::path::Path;\n        let png = extract_exe_icon_png(Path::new(exe_path), 32)?;\n        Ok(Some(format!(\n            \"data:image/png;base64,{}\",\n            base64::engine::general_purpose::STANDARD.encode(png)\n        )))\n    }\n\n    #[cfg(not(windows))]\n    {\n        let _ = exe_path;\n        Ok(None)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `list_processes_from_entries`：应按名称去重并按名称排序。\n    #[test]\n    fn list_processes_dedupes_and_sorts_by_name() {\n        let entries = vec![\n            ProcessEntry {\n                name: \"b.exe\".to_string(),\n                pid: 2,\n                exe_path: Some(\"/bin/b\".to_string()),\n            },\n            ProcessEntry {\n                name: \"a.exe\".to_string(),\n                pid: 1,\n                exe_path: Some(\"/bin/a\".to_string()),\n            },\n            // 重复名称：应保留第一次插入的 pid/exe_path\n            ProcessEntry {\n                name: \"a.exe\".to_string(),\n                pid: 999,\n                exe_path: Some(\"/bin/a2\".to_string()),\n            },\n        ];\n\n        let out = list_processes_from_entries(entries);\n        assert_eq!(out.len(), 2);\n        assert_eq!(out[0].name, \"a.exe\");\n        assert_eq!(out[0].pid, 1);\n        assert_eq!(out[0].exe_path.as_deref(), Some(\"/bin/a\"));\n        assert_eq!(out[1].name, \"b.exe\");\n    }\n\n    /// `list_processes_from_entries`：空 exe_path 应规范化为 None，避免 UI 展示异常。\n    #[test]\n    fn list_processes_normalizes_empty_exe_path() {\n        let entries = vec![ProcessEntry {\n            name: \"a.exe\".to_string(),\n            pid: 1,\n            exe_path: Some(\"\".to_string()),\n        }];\n\n        let out = list_processes_from_entries(entries);\n        assert_eq!(out.len(), 1);\n        assert!(out[0].exe_path.is_none());\n        #[cfg(not(windows))]\n        assert!(out[0].icon_data_url.is_none());\n    }\n}\n\n/// Windows：从 exe 路径提取小图标并编码为 PNG（32x32）。\n#[cfg(windows)]\nfn extract_exe_icon_png(exe_path: \u0026std::path::Path, size: i32) -\u003e AppResult\u003cVec\u003cu8\u003e\u003e {\n    use image::{ImageBuffer, Rgba};\n    use windows::core::PCWSTR;\n    use windows::Win32::Foundation::HANDLE;\n    use windows::Win32::Graphics::Gdi::{\n        CreateCompatibleDC, CreateDIBSection, DeleteDC, DeleteObject, GetDIBits, SelectObject,\n        BITMAPINFO, BITMAPINFOHEADER, BI_RGB, DIB_RGB_COLORS, HBITMAP, HBRUSH, HDC, HGDIOBJ,\n        RGBQUAD,\n    };\n    use windows::Win32::Storage::FileSystem::FILE_FLAGS_AND_ATTRIBUTES;\n    use windows::Win32::UI::Shell::{SHGetFileInfoW, SHFILEINFOW, SHGFI_ICON, SHGFI_SMALLICON};\n    use windows::Win32::UI::WindowsAndMessaging::{DestroyIcon, DrawIconEx, DI_NORMAL};\n\n    /// 图标句柄守卫：确保 `DestroyIcon` 被调用。\n    struct IconGuard(windows::Win32::UI::WindowsAndMessaging::HICON);\n    impl Drop for IconGuard {\n        /// 释放图标句柄。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = DestroyIcon(self.0);\n            }\n        }\n    }\n\n    /// DC 句柄守卫：确保 `DeleteDC` 被调用。\n    struct DcGuard(HDC);\n    impl Drop for DcGuard {\n        /// 释放 DC。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = DeleteDC(self.0);\n            }\n        }\n    }\n\n    /// 位图句柄守卫：确保 `DeleteObject` 被调用。\n    struct BitmapGuard(HBITMAP);\n    impl Drop for BitmapGuard {\n        /// 释放位图句柄。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = DeleteObject(self.0);\n            }\n        }\n    }\n\n    let wide = to_wide_null(exe_path.to_string_lossy().as_ref());\n    let mut shfi = SHFILEINFOW::default();\n\n    unsafe {\n        let ok = SHGetFileInfoW(\n            PCWSTR(wide.as_ptr()),\n            FILE_FLAGS_AND_ATTRIBUTES(0),\n            Some(\u0026mut shfi as *mut SHFILEINFOW),\n            std::mem::size_of::\u003cSHFILEINFOW\u003e() as u32,\n            SHGFI_ICON | SHGFI_SMALLICON,\n        );\n        if ok == 0 {\n            return Err(AppError::Invariant(\"提取图标失败（SHGetFileInfoW 返回 0）\".to_string()));\n        }\n\n        let hicon = shfi.hIcon;\n        if hicon.0.is_null() {\n            return Err(AppError::Invariant(\"提取图标失败（HICON 为空）\".to_string()));\n        }\n        let icon = IconGuard(hicon);\n\n        let dc: HDC = CreateCompatibleDC(HDC(std::ptr::null_mut()));\n        if dc.0.is_null() {\n            return Err(AppError::Invariant(\"CreateCompatibleDC 失败\".to_string()));\n        }\n        let dc = DcGuard(dc);\n\n        let mut bmi = BITMAPINFO {\n            bmiHeader: BITMAPINFOHEADER {\n                biSize: std::mem::size_of::\u003cBITMAPINFOHEADER\u003e() as u32,\n                biWidth: size,\n                biHeight: -size,\n                biPlanes: 1,\n                biBitCount: 32,\n                biCompression: BI_RGB.0 as u32,\n                biSizeImage: 0,\n                biXPelsPerMeter: 0,\n                biYPelsPerMeter: 0,\n                biClrUsed: 0,\n                biClrImportant: 0,\n            },\n            bmiColors: [RGBQUAD::default(); 1],\n        };\n\n        let mut bits: *mut core::ffi::c_void = std::ptr::null_mut();\n        let hbmp: HBITMAP = CreateDIBSection(\n            dc.0,\n            \u0026bmi,\n            DIB_RGB_COLORS,\n            \u0026mut bits,\n            HANDLE(std::ptr::null_mut()),\n            0,\n        )\n        .map_err(|e| AppError::Invariant(format!(\"CreateDIBSection 失败（{e:?}）\")))?;\n\n        if hbmp.0.is_null() || bits.is_null() {\n            return Err(AppError::Invariant(\"CreateDIBSection 失败（句柄/像素指针为空）\".to_string()));\n        }\n        let hbmp = BitmapGuard(hbmp);\n\n        let old: HGDIOBJ = SelectObject(dc.0, hbmp.0);\n        let _ = DrawIconEx(\n            dc.0,\n            0,\n            0,\n            icon.0,\n            size,\n            size,\n            0,\n            HBRUSH(std::ptr::null_mut()),\n            DI_NORMAL,\n        );\n\n        let mut buf = vec![0u8; (size * size * 4) as usize];\n        let scanlines = GetDIBits(\n            dc.0,\n            hbmp.0,\n            0,\n            size as u32,\n            Some(buf.as_mut_ptr() as *mut core::ffi::c_void),\n            \u0026mut bmi,\n            DIB_RGB_COLORS,\n        );\n\n        // 恢复旧对象，避免 DC 状态污染。\n        let _ = SelectObject(dc.0, old);\n\n        if scanlines == 0 {\n            return Err(AppError::Invariant(\"GetDIBits 失败\".to_string()));\n        }\n\n        // Windows DIB 为 BGRA，这里转为 RGBA。\n        for px in buf.chunks_exact_mut(4) {\n            px.swap(0, 2);\n        }\n\n        let img: ImageBuffer\u003cRgba\u003cu8\u003e, _\u003e = ImageBuffer::from_raw(size as u32, size as u32, buf)\n            .ok_or_else(|| AppError::Invariant(\"从像素缓冲构建图像失败\".to_string()))?;\n\n        let mut png: Vec\u003cu8\u003e = Vec::new();\n        img.write_to(\u0026mut std::io::Cursor::new(\u0026mut png), image::ImageFormat::Png)\n            .map_err(|e| AppError::Invariant(format!(\"PNG 编码失败：{e}\")))?;\n\n        // 通过 Drop 自动清理：hbmp/dc/icon。\n        let _ = (hbmp, dc, icon);\n\n        Ok(png)\n    }\n}\n\n/// Windows：将 `\u0026str` 转为以 `\\\\0` 结尾的 UTF-16。\n#[cfg(windows)]\nfn to_wide_null(s: \u0026str) -\u003e Vec\u003cu16\u003e {\n    use std::os::windows::ffi::OsStrExt;\n    std::ffi::OsStr::new(s)\n        .encode_wide()\n        .chain(Some(0))\n        .collect()\n}\n","traces":[{"line":40,"address":[27798988,27798994,27798736],"length":1,"stats":{"Line":0}},{"line":41,"address":[27798753],"length":1,"stats":{"Line":0}},{"line":42,"address":[27798777],"length":1,"stats":{"Line":0}},{"line":44,"address":[27798829],"length":1,"stats":{"Line":0}},{"line":45,"address":[28343787,28344331,28344325,28344096],"length":1,"stats":{"Line":0}},{"line":46,"address":[28344149,28344233],"length":1,"stats":{"Line":0}},{"line":47,"address":[28344220],"length":1,"stats":{"Line":0}},{"line":49,"address":[28344189,28344275],"length":1,"stats":{"Line":0}},{"line":52,"address":[28344006],"length":1,"stats":{"Line":0}},{"line":53,"address":[28343886,28343814],"length":1,"stats":{"Line":0}},{"line":54,"address":[28343907],"length":1,"stats":{"Line":0}},{"line":55,"address":[28343976],"length":1,"stats":{"Line":0}},{"line":59,"address":[27798909],"length":1,"stats":{"Line":0}},{"line":63,"address":[28346304,28346284,28345424,28346241,28347144,28347187],"length":1,"stats":{"Line":1}},{"line":64,"address":[28345446,28346325],"length":1,"stats":{"Line":1}},{"line":66,"address":[28346599,28346414,28345636,28347139,28345536,28346236,28345706,28346502],"length":1,"stats":{"Line":4}},{"line":67,"address":[28346712,28347480,28348144,28348408,28345819,28347216],"length":1,"stats":{"Line":2}},{"line":68,"address":[28348171,28348243,28347430,28347243,28347315,28348358],"length":1,"stats":{"Line":3}},{"line":69,"address":[28347437,28348365],"length":1,"stats":{"Line":1}},{"line":71,"address":[28348301,28347373],"length":1,"stats":{"Line":1}},{"line":75,"address":[28348121,28348030,28346107,28346921,28347010,28347504,28346018,28347710,28347801,28347824],"length":1,"stats":{"Line":4}},{"line":76,"address":[28347526,28347846],"length":1,"stats":{"Line":1}},{"line":77,"address":[28347871,28347863,28347543,28347551],"length":1,"stats":{"Line":2}},{"line":78,"address":[28347547,28347877,28347867,28347557],"length":1,"stats":{"Line":2}},{"line":79,"address":[28347616,28347936],"length":1,"stats":{"Line":1}},{"line":80,"address":[28347940,28347620],"length":1,"stats":{"Line":1}},{"line":81,"address":[28348432,28348009,28347689,28348535,28348455,28348512],"length":1,"stats":{"Line":3}},{"line":85,"address":[28345879,28346782],"length":1,"stats":{"Line":1}},{"line":89,"address":[27799008],"length":1,"stats":{"Line":1}},{"line":104,"address":[27799021],"length":1,"stats":{"Line":1}}],"covered":17,"coverable":30},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","processes","termination.rs"],"content":"//! 进程终止与权限检测（用于专注模式自动清理干扰程序）。\n\nuse serde::{Deserialize, Serialize};\nuse sysinfo::System;\nuse ts_rs::TS;\n\n#[cfg(windows)]\nuse crate::errors::AppError;\nuse crate::errors::AppResult;\n\n/// 单个进程名的终止结果。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct KillItem {\n    /// 进程名。\n    pub name: String,\n    /// 尝试终止的 PID 列表。\n    pub pids: Vec\u003cu32\u003e,\n    /// 成功数量。\n    pub killed: u32,\n    /// 失败数量。\n    pub failed: u32,\n    /// 是否存在“需要管理员权限”导致的失败。\n    pub requires_admin: bool,\n}\n\n/// 一次批量终止的汇总结果。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct KillSummary {\n    /// 各进程名的明细。\n    pub items: Vec\u003cKillItem\u003e,\n    /// 是否有任何条目需要管理员权限。\n    pub requires_admin: bool,\n}\n\n/// 终止所有匹配 `process_name` 的进程（返回可用于 UI 展示的汇总结果）。\nfn kill_by_name(process_name: \u0026str) -\u003e AppResult\u003cKillSummary\u003e {\n    tracing::debug!(target: \"blacklist\", \"尝试终止进程：{}\", process_name);\n    let mut system = System::new_all();\n    system.refresh_all();\n\n    let mut items: Vec\u003cKillItem\u003e = Vec::new();\n    let mut any_requires_admin = false;\n\n    let mut pids: Vec\u003cu32\u003e = system\n        .processes()\n        .iter()\n        .filter_map(|(pid, p)| {\n            if eq_process_name(p.name(), process_name) {\n                Some(pid.as_u32())\n            } else {\n                None\n            }\n        })\n        .collect();\n\n    pids.sort_unstable();\n\n    if pids.is_empty() {\n        tracing::debug!(target: \"blacklist\", \"未找到匹配进程：{}\", process_name);\n        return Ok(KillSummary {\n            items: vec![KillItem {\n                name: process_name.to_string(),\n                pids,\n                killed: 0,\n                failed: 0,\n                requires_admin: false,\n            }],\n            requires_admin: false,\n        });\n    }\n\n    let mut killed = 0u32;\n    let mut failed = 0u32;\n    #[cfg(windows)]\n    let mut requires_admin = false;\n    #[cfg(not(windows))]\n    let requires_admin = false;\n\n    for pid in \u0026pids {\n        match kill_pid(*pid) {\n            Ok(true) =\u003e killed += 1,\n            Ok(false) =\u003e {\n                failed += 1;\n            }\n            #[cfg(windows)]\n            Err(AppError::KillFailed(msg)) =\u003e {\n                failed += 1;\n                if msg.contains(\"ACCESS_DENIED\") || msg.contains(\"权限\") {\n                    requires_admin = true;\n                }\n            }\n            Err(e) =\u003e return Err(e),\n        }\n    }\n\n    any_requires_admin |= requires_admin;\n    items.push(KillItem {\n        name: process_name.to_string(),\n        pids,\n        killed,\n        failed,\n        requires_admin,\n    });\n\n    if failed \u003e 0 {\n        tracing::warn!(\n            target: \"blacklist\",\n            \"终止进程存在失败：name={} killed={} failed={} requiresAdmin={}\",\n            process_name,\n            killed,\n            failed,\n            requires_admin\n        );\n    } else {\n        tracing::info!(\n            target: \"blacklist\",\n            \"终止进程成功：name={} killed={}\",\n            process_name,\n            killed\n        );\n    }\n\n    Ok(KillSummary {\n        items,\n        requires_admin: any_requires_admin,\n    })\n}\n\n/// 批量终止若干进程名（best-effort）：忽略单个名称的错误并合并为一次汇总结果。\npub fn kill_names_best_effort(names: \u0026[String]) -\u003e KillSummary {\n    kill_names_best_effort_with(names, |name| kill_by_name(name))\n}\n\n/// `kill_names_best_effort` 的可注入实现：便于在单元测试中 mock `kill_by_name`。\nfn kill_names_best_effort_with(\n    names: \u0026[String],\n    mut kill_by_name_fn: impl FnMut(\u0026str) -\u003e AppResult\u003cKillSummary\u003e,\n) -\u003e KillSummary {\n    if names.is_empty() {\n        return KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        };\n    }\n\n    let mut all_items = Vec::new();\n    let mut requires_admin = false;\n\n    for name in names {\n        if let Ok(summary) = kill_by_name_fn(name) {\n            requires_admin |= summary.requires_admin;\n            all_items.extend(summary.items);\n        }\n    }\n\n    KillSummary {\n        items: all_items,\n        requires_admin,\n    }\n}\n\n/// 以 PID 终止进程（返回是否成功）。\nfn kill_pid(pid: u32) -\u003e AppResult\u003cbool\u003e {\n    #[cfg(windows)]\n    {\n        kill_pid_windows(pid)\n    }\n\n    #[cfg(not(windows))]\n    {\n        kill_pid_fallback(pid)\n    }\n}\n\n/// 非 Windows 平台的兜底终止实现（用于开发环境）。\n#[cfg(not(windows))]\nfn kill_pid_fallback(pid: u32) -\u003e AppResult\u003cbool\u003e {\n    let mut system = System::new_all();\n    system.refresh_all();\n    let Some(process) = system.process(sysinfo::Pid::from_u32(pid)) else {\n        return Ok(false);\n    };\n    Ok(process.kill())\n}\n\n/// Windows 平台：通过 Win32 API 强制终止指定 PID。\n#[cfg(windows)]\nfn kill_pid_windows(pid: u32) -\u003e AppResult\u003cbool\u003e {\n    use windows::Win32::Foundation::CloseHandle;\n    use windows::Win32::System::Threading::{OpenProcess, TerminateProcess, PROCESS_TERMINATE};\n\n    /// 进程句柄守卫：确保 `CloseHandle` 被调用。\n    struct HandleGuard(windows::Win32::Foundation::HANDLE);\n    impl Drop for HandleGuard {\n        /// 释放进程句柄。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = CloseHandle(self.0);\n            }\n        }\n    }\n\n    unsafe {\n        let handle = OpenProcess(PROCESS_TERMINATE, false, pid).map_err(|e| {\n            AppError::KillFailed(format!(\n                \"OpenProcess 失败（{e:?}）ACCESS_DENIED 可能需要管理员权限\"\n            ))\n        })?;\n        let handle = HandleGuard(handle);\n\n        let result = TerminateProcess(handle.0, 1).map(|_| true).map_err(|e| {\n            AppError::KillFailed(format!(\n                \"TerminateProcess 失败（{e:?}）ACCESS_DENIED 可能需要管理员权限\"\n            ))\n        });\n\n        result\n    }\n}\n\n/// 进程名对比（Windows 下不区分大小写）。\nfn eq_process_name(a: \u0026str, b: \u0026str) -\u003e bool {\n    if cfg!(windows) {\n        a.eq_ignore_ascii_case(b)\n    } else {\n        a == b\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `kill_names_best_effort_with`：空列表应返回空结果。\n    #[test]\n    fn kill_names_best_effort_handles_empty_list() {\n        let out = kill_names_best_effort_with(\u0026[], |_name| unreachable!(\"不应被调用\"));\n        assert!(out.items.is_empty());\n        assert!(!out.requires_admin);\n    }\n\n    /// `kill_names_best_effort_with`：应合并多个名称的汇总结果，并忽略单个名称的错误。\n    #[test]\n    fn kill_names_best_effort_merges_and_ignores_errors() {\n        let names = vec![\"a.exe\".to_string(), \"b.exe\".to_string(), \"bad.exe\".to_string()];\n        let out = kill_names_best_effort_with(\u0026names, |name| {\n            if name == \"bad.exe\" {\n                return Err(crate::errors::AppError::Invariant(\"boom\".to_string()));\n            }\n            Ok(KillSummary {\n                items: vec![KillItem {\n                    name: name.to_string(),\n                    pids: vec![1],\n                    killed: 1,\n                    failed: 0,\n                    requires_admin: name == \"b.exe\",\n                }],\n                requires_admin: name == \"b.exe\",\n            })\n        });\n\n        assert_eq!(out.items.len(), 2);\n        assert!(out.items.iter().any(|it| it.name == \"a.exe\"));\n        assert!(out.items.iter().any(|it| it.name == \"b.exe\"));\n        assert!(out.requires_admin);\n    }\n\n    /// `eq_process_name`：非 Windows 下应大小写敏感；Windows 下应忽略大小写。\n    #[test]\n    #[cfg(not(windows))]\n    fn eq_process_name_is_case_sensitive_on_non_windows() {\n        assert!(eq_process_name(\"WeChat.exe\", \"WeChat.exe\"));\n        assert!(!eq_process_name(\"WeChat.exe\", \"wechat.exe\"));\n    }\n\n    /// `eq_process_name`：Windows 下应忽略 ASCII 大小写。\n    #[test]\n    #[cfg(windows)]\n    fn eq_process_name_is_case_insensitive_on_windows() {\n        assert!(eq_process_name(\"WeChat.exe\", \"wechat.exe\"));\n        assert!(eq_process_name(\"WECHAT.EXE\", \"wechat.exe\"));\n    }\n}\n","traces":[{"line":40,"address":[32386497,32386464,32382224],"length":1,"stats":{"Line":0}},{"line":41,"address":[32382490,32382263],"length":1,"stats":{"Line":0}},{"line":42,"address":[32382443],"length":1,"stats":{"Line":0}},{"line":43,"address":[32382476],"length":1,"stats":{"Line":0}},{"line":45,"address":[32382822],"length":1,"stats":{"Line":0}},{"line":46,"address":[32382829],"length":1,"stats":{"Line":0}},{"line":51,"address":[31046304,31046344],"length":1,"stats":{"Line":0}},{"line":52,"address":[31046354,31046395],"length":1,"stats":{"Line":0}},{"line":53,"address":[31046402],"length":1,"stats":{"Line":0}},{"line":55,"address":[31046387],"length":1,"stats":{"Line":0}},{"line":60,"address":[32383086,32382994],"length":1,"stats":{"Line":0}},{"line":62,"address":[32383093],"length":1,"stats":{"Line":0}},{"line":63,"address":[32385606,32383193,32385358],"length":1,"stats":{"Line":0}},{"line":64,"address":[32386287],"length":1,"stats":{"Line":0}},{"line":65,"address":[32385591,32385857,32385908,32385996,32386470],"length":1,"stats":{"Line":0}},{"line":66,"address":[32385865],"length":1,"stats":{"Line":0}},{"line":67,"address":[32385940],"length":1,"stats":{"Line":0}},{"line":76,"address":[32383132],"length":1,"stats":{"Line":0}},{"line":77,"address":[32383143],"length":1,"stats":{"Line":0}},{"line":81,"address":[32383154],"length":1,"stats":{"Line":0}},{"line":83,"address":[32383170,32383240],"length":1,"stats":{"Line":0}},{"line":84,"address":[32385208,32383346,32385126],"length":1,"stats":{"Line":0}},{"line":85,"address":[32385240,32385302],"length":1,"stats":{"Line":0}},{"line":86,"address":[32385273],"length":1,"stats":{"Line":0}},{"line":87,"address":[32385218,32385266,32385278],"length":1,"stats":{"Line":0}},{"line":96,"address":[32385154],"length":1,"stats":{"Line":0}},{"line":100,"address":[32383366],"length":1,"stats":{"Line":0}},{"line":101,"address":[32383480],"length":1,"stats":{"Line":0}},{"line":102,"address":[32383391],"length":1,"stats":{"Line":0}},{"line":103,"address":[32383426],"length":1,"stats":{"Line":0}},{"line":104,"address":[32383466],"length":1,"stats":{"Line":0}},{"line":105,"address":[32383473],"length":1,"stats":{"Line":0}},{"line":109,"address":[32383595],"length":1,"stats":{"Line":0}},{"line":110,"address":[32383633,32384457],"length":1,"stats":{"Line":0}},{"line":119,"address":[32384139,32383605,32383671],"length":1,"stats":{"Line":0}},{"line":127,"address":[32383999],"length":1,"stats":{"Line":0}},{"line":128,"address":[32383944],"length":1,"stats":{"Line":0}},{"line":129,"address":[32383992],"length":1,"stats":{"Line":0}},{"line":134,"address":[32386880],"length":1,"stats":{"Line":0}},{"line":135,"address":[31048608,31048661],"length":1,"stats":{"Line":0}},{"line":139,"address":[31049423,31050223,31049562,31050362,31051023,31048688,31049488,31048762,31050288],"length":1,"stats":{"Line":2}},{"line":143,"address":[31048801,31049547,31050401,31048747,31049601,31050347],"length":1,"stats":{"Line":4}},{"line":144,"address":[31050252,31051052,31049452],"length":1,"stats":{"Line":1}},{"line":145,"address":[31048824,31049624,31050424],"length":1,"stats":{"Line":1}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[31048812,31049612,31050412],"length":1,"stats":{"Line":1}},{"line":151,"address":[31049644,31050444,31048844],"length":1,"stats":{"Line":1}},{"line":153,"address":[31050452,31048917,31049717,31048852,31050517,31049652],"length":1,"stats":{"Line":2}},{"line":154,"address":[31049017,31049817,31050617,31049165,31050037,31049965,31050837,31049237,31050765],"length":1,"stats":{"Line":3}},{"line":155,"address":[31050069,31050869,31049269],"length":1,"stats":{"Line":1}},{"line":156,"address":[31049294,31050200,31050894,31051000,31049400,31050094],"length":1,"stats":{"Line":2}},{"line":167,"address":[32386928],"length":1,"stats":{"Line":0}},{"line":175,"address":[32386944],"length":1,"stats":{"Line":0}},{"line":181,"address":[32386560,32386858,32386864],"length":1,"stats":{"Line":0}},{"line":182,"address":[32386588],"length":1,"stats":{"Line":0}},{"line":183,"address":[32386612],"length":1,"stats":{"Line":0}},{"line":184,"address":[32386668],"length":1,"stats":{"Line":0}},{"line":185,"address":[32386788],"length":1,"stats":{"Line":0}},{"line":187,"address":[32386768,32386821],"length":1,"stats":{"Line":0}},{"line":226,"address":[32386512],"length":1,"stats":{"Line":1}},{"line":230,"address":[32386536],"length":1,"stats":{"Line":1}}],"covered":12,"coverable":61},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","notification.rs"],"content":"//! 阶段结束通知与目标达成提醒（通过可注入 Notifier 实现，便于测试）。\n\nuse crate::app_data::{Phase, Settings};\nuse crate::errors::AppResult;\n\n/// 通知发送抽象：用于将“通知内容生成”与“通知实现（Tauri/其它）”解耦。\npub trait Notifier {\n    /// 发送一条系统通知。\n    fn notify(\u0026self, title: \u0026str, body: \u0026str) -\u003e AppResult\u003c()\u003e;\n}\n\n/// Tauri 通知实现（基于 `tauri-plugin-notification`）。\npub struct TauriNotifier\u003c'a\u003e {\n    app: \u0026'a tauri::AppHandle,\n}\n\nimpl\u003c'a\u003e TauriNotifier\u003c'a\u003e {\n    /// 创建一个基于 `AppHandle` 的通知器。\n    pub fn new(app: \u0026'a tauri::AppHandle) -\u003e Self {\n        Self { app }\n    }\n}\n\nimpl Notifier for TauriNotifier\u003c'_\u003e {\n    /// 发送系统通知（失败时返回 `AppError::Notification`）。\n    fn notify(\u0026self, title: \u0026str, body: \u0026str) -\u003e AppResult\u003c()\u003e {\n        use tauri_plugin_notification::NotificationExt as _;\n        self.app.notification().builder().title(title).body(body).show()?;\n        Ok(())\n    }\n}\n\n/// 发送阶段结束通知，并给出下一阶段预告。\npub fn notify_phase_end(\n    notifier: \u0026dyn Notifier,\n    ended: Phase,\n    next: Phase,\n    next_auto_started: bool,\n    settings: \u0026Settings,\n) -\u003e AppResult\u003c()\u003e {\n    let preview = phase_preview(next, next_auto_started, settings);\n    let (title, body) = match ended {\n        Phase::Work =\u003e (\"专注完成\".to_string(), format!(\"{}。{}\", \"本阶段已结束\", preview)),\n        Phase::ShortBreak =\u003e (\"短休息结束\".to_string(), preview),\n        Phase::LongBreak =\u003e (\"长休息结束\".to_string(), preview),\n    };\n\n    notifier.notify(\u0026title, \u0026body)?;\n    Ok(())\n}\n\n/// 在工作阶段完成后，根据每日/每周目标的阈值触发提醒。\npub fn notify_goal_progress_if_needed(\n    notifier: \u0026dyn Notifier,\n    settings: \u0026Settings,\n    daily_before: u32,\n    daily_after: u32,\n    weekly_before: u32,\n    weekly_after: u32,\n) -\u003e AppResult\u003c()\u003e {\n    let daily_goal = settings.daily_goal;\n    if daily_goal \u003e 0 {\n        let half = daily_goal.div_ceil(2);\n        if daily_before \u003c half \u0026\u0026 daily_after \u003e= half {\n            notifier.notify(\"今日目标进度\", \u0026format!(\"已完成今日目标 50%（{daily_after}/{daily_goal}）\"))?;\n        }\n        if daily_before \u003c daily_goal \u0026\u0026 daily_after \u003e= daily_goal {\n            notifier.notify(\"今日目标达成\", \u0026format!(\"恭喜！已完成今日目标（{daily_after}/{daily_goal}）\"))?;\n        }\n    }\n\n    let weekly_goal = settings.weekly_goal;\n    if weekly_goal \u003e 0 {\n        let half = weekly_goal.div_ceil(2);\n        if weekly_before \u003c half \u0026\u0026 weekly_after \u003e= half {\n            notifier.notify(\"本周目标进度\", \u0026format!(\"已完成本周目标 50%（{weekly_after}/{weekly_goal}）\"))?;\n        }\n        if weekly_before \u003c weekly_goal \u0026\u0026 weekly_after \u003e= weekly_goal {\n            notifier.notify(\"本周目标达成\", \u0026format!(\"恭喜！已完成本周目标（{weekly_after}/{weekly_goal}）\"))?;\n        }\n    }\n\n    Ok(())\n}\n\n/// 生成“下一阶段预告”文案（区分是否已自动开始）。\nfn phase_preview(next: Phase, next_auto_started: bool, settings: \u0026Settings) -\u003e String {\n    let prefix = if next_auto_started { \"已自动开始\" } else { \"即将开始\" };\n    match next {\n        Phase::Work =\u003e format!(\"{prefix}工作 {} 分钟\", settings.pomodoro),\n        Phase::ShortBreak =\u003e format!(\"{prefix}短休息 {} 分钟\", settings.short_break),\n        Phase::LongBreak =\u003e format!(\"{prefix}长休息 {} 分钟\", settings.long_break),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use std::cell::RefCell;\n\n    /// 记录型通知器：将所有通知内容收集起来，便于断言。\n    struct RecordingNotifier {\n        calls: RefCell\u003cVec\u003c(String, String)\u003e\u003e,\n    }\n\n    impl RecordingNotifier {\n        /// 创建一个空的记录型通知器。\n        fn new() -\u003e Self {\n            Self {\n                calls: RefCell::new(Vec::new()),\n            }\n        }\n\n        /// 取出已记录的通知（按调用顺序）。\n        fn take(\u0026self) -\u003e Vec\u003c(String, String)\u003e {\n            std::mem::take(\u0026mut *self.calls.borrow_mut())\n        }\n    }\n\n    impl Notifier for RecordingNotifier {\n        /// 记录通知内容并返回成功。\n        fn notify(\u0026self, title: \u0026str, body: \u0026str) -\u003e AppResult\u003c()\u003e {\n            self.calls\n                .borrow_mut()\n                .push((title.to_string(), body.to_string()));\n            Ok(())\n        }\n    }\n\n    /// `phase_preview`：应按阶段输出时长，并区分“自动开始/即将开始”前缀。\n    #[test]\n    fn phase_preview_formats_for_all_phases() {\n        let settings = Settings {\n            pomodoro: 25,\n            short_break: 5,\n            long_break: 15,\n            ..Settings::default()\n        };\n\n        assert_eq!(\n            phase_preview(Phase::Work, false, \u0026settings),\n            \"即将开始工作 25 分钟\"\n        );\n        assert_eq!(\n            phase_preview(Phase::ShortBreak, false, \u0026settings),\n            \"即将开始短休息 5 分钟\"\n        );\n        assert_eq!(\n            phase_preview(Phase::LongBreak, true, \u0026settings),\n            \"已自动开始长休息 15 分钟\"\n        );\n    }\n\n    /// `notify_phase_end`：工作/短休息/长休息结束应发送对应标题与预告文案。\n    #[test]\n    fn notify_phase_end_sends_expected_titles_and_bodies() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            pomodoro: 25,\n            short_break: 5,\n            long_break: 15,\n            ..Settings::default()\n        };\n\n        notify_phase_end(\n            \u0026notifier,\n            Phase::Work,\n            Phase::ShortBreak,\n            false,\n            \u0026settings,\n        )\n        .unwrap();\n        notify_phase_end(\n            \u0026notifier,\n            Phase::ShortBreak,\n            Phase::Work,\n            true,\n            \u0026settings,\n        )\n        .unwrap();\n        notify_phase_end(\n            \u0026notifier,\n            Phase::LongBreak,\n            Phase::Work,\n            false,\n            \u0026settings,\n        )\n        .unwrap();\n\n        let calls = notifier.take();\n        assert_eq!(calls.len(), 3);\n        assert_eq!(calls[0].0, \"专注完成\");\n        assert_eq!(calls[0].1, \"本阶段已结束。即将开始短休息 5 分钟\");\n        assert_eq!(calls[1].0, \"短休息结束\");\n        assert_eq!(calls[1].1, \"已自动开始工作 25 分钟\");\n        assert_eq!(calls[2].0, \"长休息结束\");\n        assert_eq!(calls[2].1, \"即将开始工作 25 分钟\");\n    }\n\n    /// `notify_goal_progress_if_needed`：当目标为 0 时不应发送任何通知。\n    #[test]\n    fn notify_goal_progress_skips_when_goals_are_zero() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            daily_goal: 0,\n            weekly_goal: 0,\n            ..Settings::default()\n        };\n\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 0, 100, 0, 100).unwrap();\n        assert!(notifier.take().is_empty());\n    }\n\n    /// `notify_goal_progress_if_needed`：应在跨过 50% 与 100% 阈值时发送提醒（含一次跨多个阈值）。\n    #[test]\n    fn notify_goal_progress_sends_threshold_notifications() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            daily_goal: 5,  // half = 3\n            weekly_goal: 4, // half = 2\n            ..Settings::default()\n        };\n\n        // 日目标：2 -\u003e 5 同时跨过 50% 与 100%；周目标：1 -\u003e 4 同时跨过 50% 与 100%。\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 2, 5, 1, 4).unwrap();\n\n        let calls = notifier.take();\n        assert_eq!(calls.len(), 4);\n        assert_eq!(calls[0].0, \"今日目标进度\");\n        assert!(calls[0].1.contains(\"50%（5/5）\"));\n        assert_eq!(calls[1].0, \"今日目标达成\");\n        assert!(calls[1].1.contains(\"（5/5）\"));\n        assert_eq!(calls[2].0, \"本周目标进度\");\n        assert!(calls[2].1.contains(\"50%（4/4）\"));\n        assert_eq!(calls[3].0, \"本周目标达成\");\n        assert!(calls[3].1.contains(\"（4/4）\"));\n    }\n\n    /// `notify_goal_progress_if_needed`：未跨过阈值时不应重复提醒（幂等）。\n    #[test]\n    fn notify_goal_progress_is_idempotent_when_not_crossing() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            daily_goal: 4, // half = 2\n            weekly_goal: 0,\n            ..Settings::default()\n        };\n\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 2, 2, 0, 0).unwrap();\n        assert!(notifier.take().is_empty());\n\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 3, 3, 0, 0).unwrap();\n        assert!(notifier.take().is_empty());\n    }\n}\n","traces":[{"line":19,"address":[33720352],"length":1,"stats":{"Line":0}},{"line":26,"address":[33720080],"length":1,"stats":{"Line":0}},{"line":28,"address":[33720156],"length":1,"stats":{"Line":0}},{"line":29,"address":[33720325],"length":1,"stats":{"Line":0}},{"line":34,"address":[33721827,33721136,33722618],"length":1,"stats":{"Line":1}},{"line":41,"address":[33721256],"length":1,"stats":{"Line":1}},{"line":42,"address":[33721735,33721295],"length":1,"stats":{"Line":2}},{"line":43,"address":[33721471,33721326],"length":1,"stats":{"Line":2}},{"line":44,"address":[33721833,33721357],"length":1,"stats":{"Line":2}},{"line":45,"address":[33721981,33721391],"length":1,"stats":{"Line":2}},{"line":48,"address":[33721807,33722200],"length":1,"stats":{"Line":2}},{"line":49,"address":[33722412],"length":1,"stats":{"Line":1}},{"line":53,"address":[33722656,33725114,33725120],"length":1,"stats":{"Line":1}},{"line":61,"address":[33722772],"length":1,"stats":{"Line":1}},{"line":62,"address":[33722782],"length":1,"stats":{"Line":1}},{"line":63,"address":[33722829],"length":1,"stats":{"Line":1}},{"line":64,"address":[33722876,33722909],"length":1,"stats":{"Line":2}},{"line":65,"address":[33725165,33722926],"length":1,"stats":{"Line":1}},{"line":67,"address":[33723445,33722887],"length":1,"stats":{"Line":2}},{"line":68,"address":[33725149,33723473],"length":1,"stats":{"Line":1}},{"line":72,"address":[33722800],"length":1,"stats":{"Line":1}},{"line":73,"address":[33722810],"length":1,"stats":{"Line":1}},{"line":74,"address":[33724012],"length":1,"stats":{"Line":1}},{"line":75,"address":[33724056,33724086],"length":1,"stats":{"Line":2}},{"line":76,"address":[33724103,33725133],"length":1,"stats":{"Line":1}},{"line":78,"address":[33724580,33724067],"length":1,"stats":{"Line":2}},{"line":79,"address":[33725098,33724608],"length":1,"stats":{"Line":1}},{"line":83,"address":[33724000],"length":1,"stats":{"Line":1}},{"line":87,"address":[33720368],"length":1,"stats":{"Line":1}},{"line":88,"address":[33720426],"length":1,"stats":{"Line":1}},{"line":89,"address":[33720478],"length":1,"stats":{"Line":1}},{"line":90,"address":[33720521],"length":1,"stats":{"Line":1}},{"line":91,"address":[33720711],"length":1,"stats":{"Line":1}},{"line":92,"address":[33720922],"length":1,"stats":{"Line":1}}],"covered":30,"coverable":34},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","runtime.rs"],"content":"//! 计时器运行态与核心状态机（tick、阶段切换、写入历史）。\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::{AppData, HistoryDay, HistoryRecord, Phase, Settings};\nuse crate::errors::AppResult;\nuse crate::timer::notification;\nuse crate::timer::stats;\n\n/// 时间来源：用于将状态机与系统时间解耦，便于单元测试。\npub trait TimerClock {\n    /// 获取今天日期字符串（YYYY-MM-DD）。\n    fn today_date(\u0026self) -\u003e String;\n    /// 获取当前时间字符串（HH:mm）。\n    fn now_hhmm(\u0026self) -\u003e String;\n    /// 获取本周日期范围（周一为起始），返回 `(from, to)`（YYYY-MM-DD）。\n    fn current_week_range(\u0026self) -\u003e (String, String);\n}\n\n/// 默认时间来源：使用本机时钟（`chrono::Local`）。\npub struct SystemClock;\n\nimpl TimerClock for SystemClock {\n    /// 获取今天日期字符串（YYYY-MM-DD）。\n    fn today_date(\u0026self) -\u003e String {\n        chrono::Local::now().format(\"%Y-%m-%d\").to_string()\n    }\n\n    /// 获取当前时间字符串（HH:mm）。\n    fn now_hhmm(\u0026self) -\u003e String {\n        chrono::Local::now().format(\"%H:%M\").to_string()\n    }\n\n    /// 获取本周日期范围（周一为起始），返回 `(from, to)`（YYYY-MM-DD）。\n    fn current_week_range(\u0026self) -\u003e (String, String) {\n        use chrono::{Datelike as _, Duration as ChronoDuration, Weekday};\n        let today = chrono::Local::now().date_naive();\n        let weekday = today.weekday();\n        let offset_days = match weekday {\n            Weekday::Mon =\u003e 0,\n            Weekday::Tue =\u003e 1,\n            Weekday::Wed =\u003e 2,\n            Weekday::Thu =\u003e 3,\n            Weekday::Fri =\u003e 4,\n            Weekday::Sat =\u003e 5,\n            Weekday::Sun =\u003e 6,\n        };\n        let from = today - ChronoDuration::days(offset_days);\n        let to = from + ChronoDuration::days(6);\n        (\n            from.format(\"%Y-%m-%d\").to_string(),\n            to.format(\"%Y-%m-%d\").to_string(),\n        )\n    }\n}\n\n/// 前端渲染/托盘展示所需的计时器快照。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TimerSnapshot {\n    /// 当前阶段。\n    pub phase: Phase,\n    /// 剩余秒数。\n    pub remaining_seconds: u64,\n    /// 是否运行中。\n    pub is_running: bool,\n    /// 当前任务标签。\n    pub current_tag: String,\n    /// 专注期内黑名单是否锁定（只能增不能减）。\n    pub blacklist_locked: bool,\n    /// 当前设置（用于前端展示/校验）。\n    pub settings: Settings,\n    /// 今日统计（用于主界面展示）。\n    pub today_stats: stats::TodayStats,\n    /// 本周统计（用于主界面展示）。\n    pub week_stats: stats::WeekStats,\n    /// 目标进度（用于主界面展示与提醒判断）。\n    pub goal_progress: stats::GoalProgress,\n}\n\n/// tick 结果：用于决定是否需要持久化与是否发生阶段切换。\npub struct TickResult {\n    /// 是否写入了历史（需要持久化）。\n    pub history_changed: bool,\n    /// 是否发生阶段结束切换（用于托盘/通知刷新）。\n    pub phase_ended: bool,\n    /// 是否在“休息结束”后自动开始了工作阶段（用于触发黑名单终止逻辑）。\n    pub work_auto_started: bool,\n    /// 若本次 tick 完成了工作阶段，则携带“新记录已写入”的事件负载。\n    pub work_completed_event: Option\u003cWorkCompletedEvent\u003e,\n}\n\n/// 工作阶段完成事件：用于前端弹出“备注填写”并定位到对应记录。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct WorkCompletedEvent {\n    /// 记录日期（YYYY-MM-DD）。\n    pub date: String,\n    /// 当日记录索引（从 0 开始）。\n    pub record_index: usize,\n    /// 写入的记录内容。\n    pub record: HistoryRecord,\n}\n\n/// 计时器运行态（不持久化；重启后回到默认工作阶段）。\npub struct TimerRuntime {\n    /// 当前阶段。\n    pub phase: Phase,\n    /// 剩余秒数。\n    pub remaining_seconds: u64,\n    /// 是否运行中。\n    pub is_running: bool,\n    /// 当前任务标签（用于下一次完成记录）。\n    pub current_tag: String,\n    /// 工作阶段首次开始时的日期（YYYY-MM-DD）。\n    work_started_date: Option\u003cString\u003e,\n    /// 工作阶段首次开始时的时间（HH:mm）。\n    work_started_time: Option\u003cString\u003e,\n    /// 专注期黑名单锁定标记：一旦工作阶段开始，就禁止移除黑名单条目。\n    work_lock_active: bool,\n    /// 连续番茄“自动推进”剩余工作次数（仅影响：休息结束后是否自动开始工作）。\n    auto_work_remaining: u32,\n}\n\nimpl TimerRuntime {\n    /// 构造新的计时器运行态：工作阶段 + `settings.pomodoro`。\n    pub fn new(settings: \u0026Settings, tags: \u0026[String], clock: \u0026dyn TimerClock) -\u003e Self {\n        Self {\n            phase: Phase::Work,\n            remaining_seconds: settings.pomodoro as u64 * 60,\n            is_running: false,\n            current_tag: tags\n                .first()\n                .cloned()\n                .unwrap_or_else(|| \"工作\".to_string()),\n            work_started_date: None,\n            work_started_time: None,\n            work_lock_active: false,\n            auto_work_remaining: 0,\n        }\n        .with_normalized_tag(clock)\n    }\n\n    /// 基于当前数据生成快照（使用系统时钟计算今日/本周统计）。\n    pub fn snapshot(\u0026self, data: \u0026AppData) -\u003e TimerSnapshot {\n        self.snapshot_with_clock(data, \u0026SystemClock)\n    }\n\n    /// 基于当前数据生成快照（可注入 `clock`，用于测试与边界场景）。\n    pub fn snapshot_with_clock(\u0026self, data: \u0026AppData, clock: \u0026dyn TimerClock) -\u003e TimerSnapshot {\n        let today = clock.today_date();\n        let (from, to) = clock.current_week_range();\n        let today_stats = stats::compute_today_stats(data, \u0026today);\n        let week_stats = stats::compute_week_stats(data, \u0026from, \u0026to);\n\n        TimerSnapshot {\n            phase: self.phase,\n            remaining_seconds: self.remaining_seconds,\n            is_running: self.is_running,\n            current_tag: self.current_tag.clone(),\n            blacklist_locked: self.blacklist_locked(),\n            settings: data.settings.clone(),\n            today_stats: today_stats.clone(),\n            week_stats: week_stats.clone(),\n            goal_progress: stats::GoalProgress {\n                daily_goal: data.settings.daily_goal,\n                daily_completed: today_stats.total,\n                weekly_goal: data.settings.weekly_goal,\n                weekly_completed: week_stats.total,\n            },\n        }\n    }\n\n    /// 专注期内黑名单锁定判断。\n    pub fn blacklist_locked(\u0026self) -\u003e bool {\n        self.phase == Phase::Work \u0026\u0026 self.work_lock_active\n    }\n\n    /// 更新当前标签。\n    pub fn set_current_tag(\u0026mut self, tag: String, clock: \u0026dyn TimerClock) {\n        self.current_tag = tag;\n        *self = std::mem::take(self).with_normalized_tag(clock);\n    }\n\n    /// 启动计时；若为工作阶段首次开始则记录开始时间并锁定黑名单。\n    pub fn start(\u0026mut self, settings: \u0026Settings, clock: \u0026dyn TimerClock) {\n        if self.is_running {\n            return;\n        }\n        self.is_running = true;\n        if self.phase == Phase::Work \u0026\u0026 !self.work_lock_active {\n            self.work_lock_active = true;\n            self.work_started_date = Some(clock.today_date());\n            self.work_started_time = Some(clock.now_hhmm());\n            self.init_auto_work_remaining_if_needed(settings);\n        }\n    }\n\n    /// 暂停计时。\n    pub fn pause(\u0026mut self) {\n        self.is_running = false;\n    }\n\n    /// 重置为工作阶段初始状态（不会清空历史）。\n    pub fn reset(\u0026mut self, settings: \u0026Settings) {\n        self.phase = Phase::Work;\n        self.remaining_seconds = settings.pomodoro as u64 * 60;\n        self.is_running = false;\n        self.work_started_date = None;\n        self.work_started_time = None;\n        self.work_lock_active = false;\n        self.auto_work_remaining = 0;\n    }\n\n    /// 跳过当前阶段（工作阶段不会写入历史）。\n    pub fn skip(\u0026mut self, settings: \u0026Settings, completed_today: u32) {\n        let next = next_phase(self.phase, settings.long_break_interval, completed_today);\n        self.apply_phase(next, settings);\n        self.is_running = false;\n    }\n\n    /// 每秒 tick：递减剩余时间，并在归零时完成阶段切换与（必要时）写入历史。\n    pub fn tick(\n        \u0026mut self,\n        data: \u0026mut AppData,\n        clock: \u0026dyn TimerClock,\n        notifier: \u0026dyn notification::Notifier,\n    ) -\u003e AppResult\u003cTickResult\u003e {\n        if !self.is_running {\n            return Ok(TickResult {\n                history_changed: false,\n                phase_ended: false,\n                work_auto_started: false,\n                work_completed_event: None,\n            });\n        }\n        if self.remaining_seconds \u003e 0 {\n            self.remaining_seconds -= 1;\n        }\n        if self.remaining_seconds \u003e 0 {\n            return Ok(TickResult {\n                history_changed: false,\n                phase_ended: false,\n                work_auto_started: false,\n                work_completed_event: None,\n            });\n        }\n\n        let ended_phase = self.phase;\n        let mut history_changed = false;\n        let mut work_completed_event: Option\u003cWorkCompletedEvent\u003e = None;\n\n        let today = clock.today_date();\n        let (from, to) = clock.current_week_range();\n        let mut completed_today_after = stats::compute_today_stats(data, \u0026today).total;\n        let completed_today_before = completed_today_after;\n        let completed_week_before = stats::compute_week_stats(data, \u0026from, \u0026to).total;\n        let mut completed_week_after = completed_week_before;\n\n        if ended_phase == Phase::Work {\n            let created = self.append_work_record(data, clock)?;\n            history_changed = true;\n            completed_today_after += 1;\n            completed_week_after += 1;\n            self.decrease_auto_work_remaining_after_work_end(\u0026data.settings);\n            work_completed_event = Some(created);\n            tracing::info!(\n                target: \"timer\",\n                \"工作阶段完成：date={} tag={} duration={}m todayCompleted={} weekCompleted={}\",\n                self.work_started_date.clone().unwrap_or_else(|| today.clone()),\n                self.current_tag,\n                data.settings.pomodoro,\n                completed_today_after,\n                completed_week_after\n            );\n            notification::notify_goal_progress_if_needed(\n                notifier,\n                \u0026data.settings,\n                completed_today_before,\n                completed_today_after,\n                completed_week_before,\n                completed_week_after,\n            )?;\n        }\n\n        let next = next_phase(ended_phase, data.settings.long_break_interval, completed_today_after);\n        self.apply_phase(next, \u0026data.settings);\n        self.is_running = false;\n\n        let next_auto_started = self.start_next_phase_if_needed(next, \u0026data.settings, clock);\n\n        notification::notify_phase_end(notifier, ended_phase, next, next_auto_started, \u0026data.settings)?;\n\n        tracing::info!(\n            target: \"timer\",\n            \"阶段切换：ended={:?} next={:?} nextAutoStarted={}\",\n            ended_phase,\n            next,\n            next_auto_started\n        );\n\n        Ok(TickResult {\n            history_changed,\n            phase_ended: true,\n            work_auto_started: next == Phase::Work \u0026\u0026 next_auto_started,\n            work_completed_event,\n        })\n    }\n\n    /// 将当前工作阶段写入 `history`（仅在自然完成时调用）。\n    fn append_work_record(\u0026mut self, data: \u0026mut AppData, clock: \u0026dyn TimerClock) -\u003e AppResult\u003cWorkCompletedEvent\u003e {\n        let date = self\n            .work_started_date\n            .clone()\n            .unwrap_or_else(|| clock.today_date());\n        let start_time = self\n            .work_started_time\n            .clone()\n            .unwrap_or_else(|| clock.now_hhmm());\n        let end_time = clock.now_hhmm();\n\n        let record = HistoryRecord {\n            tag: self.current_tag.clone(),\n            start_time,\n            end_time: Some(end_time),\n            duration: data.settings.pomodoro,\n            phase: Phase::Work,\n            remark: String::new(),\n        };\n\n        let day = ensure_day(\u0026mut data.history, \u0026date);\n        day.records.push(record.clone());\n        let record_index = day.records.len().saturating_sub(1);\n        Ok(WorkCompletedEvent {\n            date,\n            record_index,\n            record,\n        })\n    }\n\n    /// 应用阶段切换：重置剩余时间与锁定标记。\n    fn apply_phase(\u0026mut self, phase: Phase, settings: \u0026Settings) {\n        self.phase = phase;\n        self.remaining_seconds = phase_seconds(phase, settings);\n        self.work_started_date = None;\n        self.work_started_time = None;\n        self.work_lock_active = false;\n    }\n\n    /// 初始化“连续番茄自动推进”的剩余工作次数（仅在工作阶段首次开始时触发）。\n    fn init_auto_work_remaining_if_needed(\u0026mut self, settings: \u0026Settings) {\n        if !settings.auto_continue_enabled {\n            return;\n        }\n        if self.auto_work_remaining \u003e 0 {\n            return;\n        }\n        self.auto_work_remaining = settings.auto_continue_pomodoros;\n    }\n\n    /// 在一个工作阶段自然结束后递减“自动推进”的剩余次数。\n    fn decrease_auto_work_remaining_after_work_end(\u0026mut self, settings: \u0026Settings) {\n        if !settings.auto_continue_enabled {\n            self.auto_work_remaining = 0;\n            return;\n        }\n        if self.auto_work_remaining \u003e 0 {\n            self.auto_work_remaining -= 1;\n        }\n    }\n\n    /// 按规则决定是否自动开始“下一阶段”的倒计时，并返回是否已自动开始。\n    fn start_next_phase_if_needed(\u0026mut self, next: Phase, settings: \u0026Settings, clock: \u0026dyn TimerClock) -\u003e bool {\n        match next {\n            Phase::ShortBreak | Phase::LongBreak =\u003e {\n                // 工作结束后始终自动进入休息倒计时。\n                self.start(settings, clock);\n                true\n            }\n            Phase::Work =\u003e {\n                // 休息结束后：仅在“连续番茄自动推进”开启且仍有剩余时自动开始工作。\n                if settings.auto_continue_enabled \u0026\u0026 self.auto_work_remaining \u003e 0 {\n                    self.start(settings, clock);\n                    true\n                } else {\n                    false\n                }\n            }\n        }\n    }\n\n    /// 规范化当前标签：用于防御性处理空白标签，保证 UI 与导出稳定。\n    fn with_normalized_tag(mut self, clock: \u0026dyn TimerClock) -\u003e Self {\n        if self.current_tag.trim().is_empty() {\n            self.current_tag = \"工作\".to_string();\n        }\n        // 若计时器已经在工作阶段运行中，且日期/时间缺失，则补齐（避免中途迁移导致的 None）。\n        if self.phase == Phase::Work \u0026\u0026 self.is_running {\n            if self.work_started_date.is_none() {\n                self.work_started_date = Some(clock.today_date());\n            }\n            if self.work_started_time.is_none() {\n                self.work_started_time = Some(clock.now_hhmm());\n            }\n        }\n        self\n    }\n}\n\nimpl Default for TimerRuntime {\n    /// 仅用于 `std::mem::take` 的内部占位默认值（不应被业务直接使用）。\n    fn default() -\u003e Self {\n        Self {\n            phase: Phase::Work,\n            remaining_seconds: 0,\n            is_running: false,\n            current_tag: \"工作\".to_string(),\n            work_started_date: None,\n            work_started_time: None,\n            work_lock_active: false,\n            auto_work_remaining: 0,\n        }\n    }\n}\n\n/// 计算某阶段的总秒数。\nfn phase_seconds(phase: Phase, settings: \u0026Settings) -\u003e u64 {\n    match phase {\n        Phase::Work =\u003e settings.pomodoro as u64 * 60,\n        Phase::ShortBreak =\u003e settings.short_break as u64 * 60,\n        Phase::LongBreak =\u003e settings.long_break as u64 * 60,\n    }\n}\n\n/// 基于“当前阶段 + 今日已完成番茄数 + 长休息间隔”推导下一阶段。\nfn next_phase(current: Phase, long_break_interval: u32, completed_today_after: u32) -\u003e Phase {\n    match current {\n        Phase::Work =\u003e {\n            if long_break_interval \u003e 0 \u0026\u0026 completed_today_after.is_multiple_of(long_break_interval) {\n                Phase::LongBreak\n            } else {\n                Phase::ShortBreak\n            }\n        }\n        Phase::ShortBreak | Phase::LongBreak =\u003e Phase::Work,\n    }\n}\n\n/// 在历史数组中确保存在指定日期的 `HistoryDay`，并返回可变引用。\nfn ensure_day\u003c'a\u003e(history: \u0026'a mut Vec\u003cHistoryDay\u003e, date: \u0026str) -\u003e \u0026'a mut HistoryDay {\n    if let Some(index) = history.iter().position(|d| d.date == date) {\n        return \u0026mut history[index];\n    }\n\n    history.push(HistoryDay {\n        date: date.to_string(),\n        records: Vec::new(),\n    });\n    let last_index = history.len().saturating_sub(1);\n    \u0026mut history[last_index]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// 固定时间源：用于让单元测试在任意时间运行都可复现。\n    struct FixedClock {\n        today: String,\n        now: String,\n        week_from: String,\n        week_to: String,\n    }\n\n    impl FixedClock {\n        /// 构造一个固定时钟（weekRange 默认覆盖 today）。\n        fn new(today: \u0026str, now: \u0026str) -\u003e Self {\n            Self {\n                today: today.to_string(),\n                now: now.to_string(),\n                week_from: today.to_string(),\n                week_to: today.to_string(),\n            }\n        }\n\n        /// 覆盖本周范围（闭区间）。\n        fn with_week_range(mut self, from: \u0026str, to: \u0026str) -\u003e Self {\n            self.week_from = from.to_string();\n            self.week_to = to.to_string();\n            self\n        }\n    }\n\n    impl TimerClock for FixedClock {\n        /// 返回固定的日期。\n        fn today_date(\u0026self) -\u003e String {\n            self.today.clone()\n        }\n\n        /// 返回固定的时间。\n        fn now_hhmm(\u0026self) -\u003e String {\n            self.now.clone()\n        }\n\n        /// 返回固定的周范围。\n        fn current_week_range(\u0026self) -\u003e (String, String) {\n            (self.week_from.clone(), self.week_to.clone())\n        }\n    }\n\n    /// 空通知器：测试时忽略通知副作用。\n    struct NoopNotifier;\n\n    impl notification::Notifier for NoopNotifier {\n        /// 忽略通知发送并返回成功。\n        fn notify(\u0026self, _title: \u0026str, _body: \u0026str) -\u003e AppResult\u003c()\u003e {\n            Ok(())\n        }\n    }\n\n    /// `tick` 在归零时会写入历史并切换到休息阶段。\n    #[test]\n    fn tick_completes_work_and_switches_to_break() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.pomodoro = 1;\n        data.settings.short_break = 1;\n        data.settings.long_break = 1;\n        data.settings.long_break_interval = 4;\n        data.tags = vec![\"学习\".to_string()];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n        runtime.remaining_seconds = 1;\n\n        let out = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert!(out.history_changed);\n        assert!(out.phase_ended);\n        assert!(out.work_completed_event.is_some());\n        assert_eq!(runtime.phase, Phase::ShortBreak);\n        assert!(runtime.is_running);\n        assert_eq!(runtime.remaining_seconds, (data.settings.short_break as u64) * 60);\n        assert_eq!(data.history.len(), 1);\n        assert_eq!(data.history[0].records.len(), 1);\n    }\n\n    /// 当今日完成数达到长休息间隔倍数时，应进入长休息阶段。\n    #[test]\n    fn tick_uses_long_break_interval() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.pomodoro = 1;\n        data.settings.short_break = 1;\n        data.settings.long_break = 2;\n        data.settings.long_break_interval = 2;\n        data.tags = vec![\"A\".to_string()];\n\n        // 预置 1 条工作记录：让本次完成后达到 2，从而触发长休息。\n        data.history.push(HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"A\".to_string(),\n                start_time: \"08:00\".to_string(),\n                end_time: Some(\"08:25\".to_string()),\n                duration: 25,\n                phase: Phase::Work,\n                remark: String::new(),\n            }],\n        });\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n        runtime.remaining_seconds = 1;\n\n        let _ = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert_eq!(runtime.phase, Phase::LongBreak);\n        assert!(runtime.is_running);\n        assert_eq!(runtime.remaining_seconds, (data.settings.long_break as u64) * 60);\n    }\n\n    /// 休息结束后：未开启连续番茄时不应自动开始工作倒计时。\n    #[test]\n    fn break_end_does_not_auto_start_work_when_disabled() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.short_break = 1;\n        data.settings.auto_continue_enabled = false;\n        data.tags = vec![\"A\".to_string()];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.phase = Phase::ShortBreak;\n        runtime.remaining_seconds = 1;\n        runtime.is_running = true;\n\n        let out = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert!(out.phase_ended);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert!(!runtime.is_running);\n    }\n\n    /// 休息结束后：开启连续番茄且仍有剩余时应自动开始工作倒计时。\n    #[test]\n    fn break_end_auto_starts_work_when_enabled_and_remaining() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.pomodoro = 1;\n        data.settings.short_break = 1;\n        data.settings.auto_continue_enabled = true;\n        data.settings.auto_continue_pomodoros = 2;\n        data.tags = vec![\"A\".to_string()];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n\n        // 快速完成一次工作 -\u003e 自动进入短休息并开始。\n        runtime.remaining_seconds = 1;\n        let _ = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert_eq!(runtime.phase, Phase::ShortBreak);\n        assert!(runtime.is_running);\n\n        // 快速结束短休息 -\u003e 自动开始下一次工作。\n        runtime.remaining_seconds = 1;\n        let out = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert!(out.phase_ended);\n        assert!(out.work_auto_started);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert!(runtime.is_running);\n    }\n\n    /// `TimerRuntime::new`：应初始化为工作阶段、剩余时间与默认标签（空标签列表回退为“工作”）。\n    #[test]\n    fn timer_runtime_new_initializes_with_defaults_and_tag_fallback() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let settings = Settings {\n            pomodoro: 25,\n            ..Settings::default()\n        };\n\n        let runtime = TimerRuntime::new(\u0026settings, \u0026[], \u0026clock);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert_eq!(runtime.remaining_seconds, 25 * 60);\n        assert!(!runtime.is_running);\n        assert_eq!(runtime.current_tag, \"工作\");\n        assert!(!runtime.blacklist_locked());\n    }\n\n    /// `start`：重复启动应幂等，并在工作阶段首次启动时锁定黑名单。\n    #[test]\n    fn start_is_idempotent_and_locks_blacklist_on_first_work_start() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut runtime = TimerRuntime::new(\u0026Settings::default(), \u0026[\"学习\".to_string()], \u0026clock);\n\n        runtime.start(\u0026Settings::default(), \u0026clock);\n        assert!(runtime.is_running);\n        assert!(runtime.blacklist_locked());\n\n        runtime.start(\u0026Settings::default(), \u0026clock);\n        assert!(runtime.is_running);\n        assert!(runtime.blacklist_locked());\n    }\n\n    /// `pause`：暂停后应处于非运行态。\n    #[test]\n    fn pause_stops_running() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut runtime = TimerRuntime::new(\u0026Settings::default(), \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.start(\u0026Settings::default(), \u0026clock);\n        runtime.pause();\n        assert!(!runtime.is_running);\n    }\n\n    /// `reset`：应回到工作阶段初始剩余时间，并解除锁定与运行态。\n    #[test]\n    fn reset_restores_initial_state() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut settings = Settings::default();\n        settings.pomodoro = 10;\n        settings.short_break = 1;\n        settings.long_break = 1;\n\n        let mut runtime = TimerRuntime::new(\u0026settings, \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.start(\u0026settings, \u0026clock);\n        runtime.remaining_seconds = 3;\n        assert!(runtime.blacklist_locked());\n\n        runtime.reset(\u0026settings);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert_eq!(runtime.remaining_seconds, 10 * 60);\n        assert!(!runtime.is_running);\n        assert!(!runtime.blacklist_locked());\n    }\n\n    /// `skip`：跳过不会写入历史（不依赖 data），并应切换到下一阶段且解除锁定。\n    #[test]\n    fn skip_switches_phase_and_unlocks_blacklist() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut settings = Settings::default();\n        settings.pomodoro = 1;\n        settings.short_break = 2;\n        settings.long_break = 3;\n        settings.long_break_interval = 4;\n\n        let mut runtime = TimerRuntime::new(\u0026settings, \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.start(\u0026settings, \u0026clock);\n        assert!(runtime.blacklist_locked());\n\n        runtime.skip(\u0026settings, 1);\n        assert_eq!(runtime.phase, Phase::ShortBreak);\n        assert_eq!(runtime.remaining_seconds, 2 * 60);\n        assert!(!runtime.is_running);\n        assert!(!runtime.blacklist_locked());\n    }\n\n    /// `set_current_tag`：空白标签应规范化为“工作”。\n    #[test]\n    fn set_current_tag_normalizes_blank_tag() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut runtime = TimerRuntime::new(\u0026Settings::default(), \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.set_current_tag(\"   \".to_string(), \u0026clock);\n        assert_eq!(runtime.current_tag, \"工作\");\n    }\n\n    /// `snapshot_with_clock`：快照应包含目标进度与今日/本周统计，并保留运行态字段。\n    #[test]\n    fn snapshot_with_clock_includes_stats_and_goal_progress() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let mut data = AppData::default();\n        data.settings.daily_goal = 3;\n        data.settings.weekly_goal = 10;\n        data.tags = vec![\"学习\".to_string()];\n        data.history = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![\n                HistoryRecord {\n                    tag: \"学习\".to_string(),\n                    start_time: \"08:00\".to_string(),\n                    end_time: Some(\"08:25\".to_string()),\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                },\n                HistoryRecord {\n                    tag: \"学习\".to_string(),\n                    start_time: \"08:30\".to_string(),\n                    end_time: Some(\"08:55\".to_string()),\n                    duration: 25,\n                    phase: Phase::ShortBreak,\n                    remark: String::new(),\n                },\n            ],\n        }];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n\n        let snapshot = runtime.snapshot_with_clock(\u0026data, \u0026clock);\n        assert_eq!(snapshot.phase, Phase::Work);\n        assert!(snapshot.is_running);\n        assert_eq!(snapshot.current_tag, \"学习\");\n        assert!(snapshot.blacklist_locked);\n        assert_eq!(snapshot.settings.daily_goal, 3);\n        assert_eq!(snapshot.today_stats.total, 1);\n        assert_eq!(snapshot.week_stats.total, 1);\n        assert_eq!(snapshot.goal_progress.daily_goal, 3);\n        assert_eq!(snapshot.goal_progress.daily_completed, 1);\n        assert_eq!(snapshot.goal_progress.weekly_goal, 10);\n        assert_eq!(snapshot.goal_progress.weekly_completed, 1);\n    }\n}\n","traces":[{"line":26,"address":[28202584,28202578,28202416],"length":1,"stats":{"Line":1}},{"line":27,"address":[28202441],"length":1,"stats":{"Line":1}},{"line":31,"address":[28203266,28203104,28203272],"length":1,"stats":{"Line":1}},{"line":32,"address":[28203129],"length":1,"stats":{"Line":1}},{"line":36,"address":[28203051,28203079,28202608],"length":1,"stats":{"Line":1}},{"line":38,"address":[28202632],"length":1,"stats":{"Line":1}},{"line":39,"address":[28202670],"length":1,"stats":{"Line":1}},{"line":40,"address":[28202682],"length":1,"stats":{"Line":1}},{"line":49,"address":[28202695],"length":1,"stats":{"Line":1}},{"line":50,"address":[28202721],"length":1,"stats":{"Line":1}},{"line":52,"address":[28202742],"length":1,"stats":{"Line":1}},{"line":53,"address":[28202918,28202832],"length":1,"stats":{"Line":2}},{"line":130,"address":[28207984],"length":1,"stats":{"Line":1}},{"line":133,"address":[28208381,28208060],"length":1,"stats":{"Line":1}},{"line":144,"address":[28208358],"length":1,"stats":{"Line":1}},{"line":148,"address":[28213856],"length":1,"stats":{"Line":1}},{"line":149,"address":[28213877],"length":1,"stats":{"Line":1}},{"line":153,"address":[28205744,28206849,28206855],"length":1,"stats":{"Line":1}},{"line":154,"address":[28205827],"length":1,"stats":{"Line":1}},{"line":155,"address":[28205854,28205914],"length":1,"stats":{"Line":2}},{"line":156,"address":[28205986,28206070],"length":1,"stats":{"Line":2}},{"line":157,"address":[28206167,28206085],"length":1,"stats":{"Line":2}},{"line":160,"address":[28206229],"length":1,"stats":{"Line":1}},{"line":161,"address":[28206236],"length":1,"stats":{"Line":1}},{"line":162,"address":[28206245],"length":1,"stats":{"Line":1}},{"line":163,"address":[28206252],"length":1,"stats":{"Line":1}},{"line":164,"address":[28206316],"length":1,"stats":{"Line":1}},{"line":165,"address":[28206373],"length":1,"stats":{"Line":1}},{"line":166,"address":[28206411],"length":1,"stats":{"Line":1}},{"line":167,"address":[28206434],"length":1,"stats":{"Line":1}},{"line":168,"address":[28206539],"length":1,"stats":{"Line":1}},{"line":178,"address":[28204384],"length":1,"stats":{"Line":1}},{"line":179,"address":[28204397],"length":1,"stats":{"Line":1}},{"line":183,"address":[28204368,28204096],"length":1,"stats":{"Line":1}},{"line":184,"address":[28204147],"length":1,"stats":{"Line":1}},{"line":185,"address":[28204254],"length":1,"stats":{"Line":1}},{"line":189,"address":[28213830,28213408],"length":1,"stats":{"Line":1}},{"line":190,"address":[28213466],"length":1,"stats":{"Line":1}},{"line":193,"address":[28213476],"length":1,"stats":{"Line":1}},{"line":194,"address":[28213480,28213512],"length":1,"stats":{"Line":2}},{"line":195,"address":[28213532],"length":1,"stats":{"Line":1}},{"line":196,"address":[28213590,28213536],"length":1,"stats":{"Line":1}},{"line":197,"address":[28213676,28213733],"length":1,"stats":{"Line":1}},{"line":198,"address":[28213820],"length":1,"stats":{"Line":1}},{"line":203,"address":[28213072],"length":1,"stats":{"Line":1}},{"line":204,"address":[28213077],"length":1,"stats":{"Line":1}},{"line":208,"address":[28213396,28213088],"length":1,"stats":{"Line":1}},{"line":209,"address":[28213107],"length":1,"stats":{"Line":1}},{"line":210,"address":[28213179,28213111],"length":1,"stats":{"Line":1}},{"line":211,"address":[28213145],"length":1,"stats":{"Line":1}},{"line":212,"address":[28213197,28213159],"length":1,"stats":{"Line":1}},{"line":213,"address":[28213278,28213303],"length":1,"stats":{"Line":1}},{"line":214,"address":[28213380],"length":1,"stats":{"Line":1}},{"line":215,"address":[28213384],"length":1,"stats":{"Line":1}},{"line":219,"address":[28208512],"length":1,"stats":{"Line":1}},{"line":220,"address":[28208539],"length":1,"stats":{"Line":1}},{"line":221,"address":[28208566],"length":1,"stats":{"Line":1}},{"line":222,"address":[28208579],"length":1,"stats":{"Line":1}},{"line":226,"address":[28213037,28208592,28212947],"length":1,"stats":{"Line":1}},{"line":232,"address":[28208719],"length":1,"stats":{"Line":1}},{"line":233,"address":[28208759],"length":1,"stats":{"Line":0}},{"line":237,"address":[28208741],"length":1,"stats":{"Line":0}},{"line":240,"address":[28208944,28208845],"length":1,"stats":{"Line":2}},{"line":241,"address":[28208899,28208946],"length":1,"stats":{"Line":1}},{"line":243,"address":[28208878],"length":1,"stats":{"Line":1}},{"line":244,"address":[28209064],"length":1,"stats":{"Line":0}},{"line":248,"address":[28209046],"length":1,"stats":{"Line":0}},{"line":252,"address":[28208983],"length":1,"stats":{"Line":1}},{"line":253,"address":[28208993],"length":1,"stats":{"Line":1}},{"line":254,"address":[28209001],"length":1,"stats":{"Line":1}},{"line":256,"address":[28209027],"length":1,"stats":{"Line":1}},{"line":257,"address":[28209202,28209259],"length":1,"stats":{"Line":2}},{"line":258,"address":[28209331,28209430],"length":1,"stats":{"Line":2}},{"line":259,"address":[28209466],"length":1,"stats":{"Line":1}},{"line":260,"address":[28209495],"length":1,"stats":{"Line":1}},{"line":261,"address":[28209679],"length":1,"stats":{"Line":1}},{"line":263,"address":[28209686,28211606],"length":1,"stats":{"Line":2}},{"line":264,"address":[28209814,28212971],"length":1,"stats":{"Line":1}},{"line":265,"address":[28210038],"length":1,"stats":{"Line":1}},{"line":266,"address":[28210046,28210108],"length":1,"stats":{"Line":1}},{"line":267,"address":[28210213,28210192,28210083],"length":1,"stats":{"Line":2}},{"line":268,"address":[28210199],"length":1,"stats":{"Line":1}},{"line":269,"address":[28210342,28210231],"length":1,"stats":{"Line":1}},{"line":270,"address":[28210441,28210824,28210945],"length":1,"stats":{"Line":1}},{"line":281,"address":[28210774],"length":1,"stats":{"Line":1}},{"line":283,"address":[28210781],"length":1,"stats":{"Line":1}},{"line":285,"address":[28210789],"length":1,"stats":{"Line":1}},{"line":289,"address":[28211634,28209736],"length":1,"stats":{"Line":2}},{"line":290,"address":[28211641],"length":1,"stats":{"Line":1}},{"line":291,"address":[28211695],"length":1,"stats":{"Line":1}},{"line":293,"address":[28211699],"length":1,"stats":{"Line":1}},{"line":295,"address":[28212914,28211762],"length":1,"stats":{"Line":1}},{"line":297,"address":[28211964,28212256],"length":1,"stats":{"Line":1}},{"line":305,"address":[28212728],"length":1,"stats":{"Line":1}},{"line":306,"address":[28212216],"length":1,"stats":{"Line":1}},{"line":308,"address":[28212227,28212624],"length":1,"stats":{"Line":2}},{"line":309,"address":[28212656],"length":1,"stats":{"Line":1}},{"line":314,"address":[28204448,28205728,28205637],"length":1,"stats":{"Line":1}},{"line":315,"address":[28204517],"length":1,"stats":{"Line":1}},{"line":318,"address":[27694069,27694048],"length":1,"stats":{"Line":1}},{"line":319,"address":[28204615],"length":1,"stats":{"Line":1}},{"line":322,"address":[27694096,27694117],"length":1,"stats":{"Line":1}},{"line":323,"address":[28204795,28204733],"length":1,"stats":{"Line":2}},{"line":326,"address":[28204803],"length":1,"stats":{"Line":1}},{"line":328,"address":[28204905],"length":1,"stats":{"Line":1}},{"line":329,"address":[28204977],"length":1,"stats":{"Line":1}},{"line":331,"address":[28204995],"length":1,"stats":{"Line":1}},{"line":334,"address":[28205287,28205198],"length":1,"stats":{"Line":2}},{"line":335,"address":[28205312],"length":1,"stats":{"Line":1}},{"line":336,"address":[28205369],"length":1,"stats":{"Line":1}},{"line":337,"address":[28205499],"length":1,"stats":{"Line":1}},{"line":338,"address":[28205420],"length":1,"stats":{"Line":1}},{"line":340,"address":[28205468],"length":1,"stats":{"Line":1}},{"line":345,"address":[28204072,28203792],"length":1,"stats":{"Line":1}},{"line":346,"address":[28203825],"length":1,"stats":{"Line":1}},{"line":347,"address":[28203828],"length":1,"stats":{"Line":1}},{"line":348,"address":[28203880,28203855],"length":1,"stats":{"Line":1}},{"line":349,"address":[28203986,28203961],"length":1,"stats":{"Line":1}},{"line":350,"address":[28204063],"length":1,"stats":{"Line":1}},{"line":354,"address":[28207920],"length":1,"stats":{"Line":1}},{"line":355,"address":[28207940],"length":1,"stats":{"Line":1}},{"line":358,"address":[28207952],"length":1,"stats":{"Line":1}},{"line":361,"address":[28207968],"length":1,"stats":{"Line":1}},{"line":365,"address":[28208400],"length":1,"stats":{"Line":1}},{"line":366,"address":[28208419],"length":1,"stats":{"Line":1}},{"line":367,"address":[28208430],"length":1,"stats":{"Line":1}},{"line":370,"address":[28208489,28208444],"length":1,"stats":{"Line":2}},{"line":371,"address":[28208491,28208460],"length":1,"stats":{"Line":1}},{"line":376,"address":[28207744],"length":1,"stats":{"Line":1}},{"line":377,"address":[28207795],"length":1,"stats":{"Line":1}},{"line":380,"address":[28207841],"length":1,"stats":{"Line":1}},{"line":381,"address":[28207846],"length":1,"stats":{"Line":1}},{"line":385,"address":[28207813,28207858],"length":1,"stats":{"Line":2}},{"line":386,"address":[28207891],"length":1,"stats":{"Line":1}},{"line":387,"address":[28207896],"length":1,"stats":{"Line":1}},{"line":389,"address":[28207853],"length":1,"stats":{"Line":1}},{"line":396,"address":[28206880,28207713],"length":1,"stats":{"Line":1}},{"line":397,"address":[28207211,28206936,28207000],"length":1,"stats":{"Line":3}},{"line":398,"address":[28207078],"length":1,"stats":{"Line":1}},{"line":401,"address":[28207264,28207220,28207053],"length":1,"stats":{"Line":3}},{"line":402,"address":[28207503,28207275],"length":1,"stats":{"Line":0}},{"line":403,"address":[28207341],"length":1,"stats":{"Line":0}},{"line":405,"address":[28207512,28207309,28207708],"length":1,"stats":{"Line":0}},{"line":406,"address":[28207531],"length":1,"stats":{"Line":0}},{"line":409,"address":[28207236],"length":1,"stats":{"Line":1}},{"line":415,"address":[28225200],"length":1,"stats":{"Line":1}},{"line":420,"address":[28225213],"length":1,"stats":{"Line":1}},{"line":430,"address":[28213904],"length":1,"stats":{"Line":1}},{"line":431,"address":[28213925],"length":1,"stats":{"Line":1}},{"line":432,"address":[28213961,28214044],"length":1,"stats":{"Line":2}},{"line":433,"address":[28214079,28213988],"length":1,"stats":{"Line":2}},{"line":434,"address":[28214104,28214016],"length":1,"stats":{"Line":2}},{"line":439,"address":[28203680],"length":1,"stats":{"Line":1}},{"line":440,"address":[28203707],"length":1,"stats":{"Line":1}},{"line":442,"address":[28203743,28203724],"length":1,"stats":{"Line":2}},{"line":443,"address":[28203764],"length":1,"stats":{"Line":1}},{"line":445,"address":[28203738],"length":1,"stats":{"Line":1}},{"line":448,"address":[28203731],"length":1,"stats":{"Line":1}},{"line":453,"address":[28203296,28203661,28203667],"length":1,"stats":{"Line":1}},{"line":454,"address":[27694025,27694000],"length":1,"stats":{"Line":3}},{"line":455,"address":[28203404],"length":1,"stats":{"Line":1}},{"line":458,"address":[28203520],"length":1,"stats":{"Line":1}},{"line":459,"address":[28203423],"length":1,"stats":{"Line":1}},{"line":460,"address":[28203455],"length":1,"stats":{"Line":1}},{"line":462,"address":[28203606],"length":1,"stats":{"Line":1}},{"line":463,"address":[28203639],"length":1,"stats":{"Line":1}}],"covered":158,"coverable":166},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","stats.rs"],"content":"//! 计时器统计计算：今日/本周数据与目标进度。\n\nuse std::collections::BTreeMap;\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::{AppData, Phase};\n\n/// 标签计数条目。\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TagCount {\n    /// 标签名。\n    pub tag: String,\n    /// 完成次数。\n    pub count: u32,\n}\n\n/// 今日统计（总数 + 按标签分组）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TodayStats {\n    /// 今日完成的番茄总数。\n    pub total: u32,\n    /// 按标签统计。\n    pub by_tag: Vec\u003cTagCount\u003e,\n}\n\n/// 本周统计（总数 + 按标签分组）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct WeekStats {\n    /// 本周完成的番茄总数。\n    pub total: u32,\n    /// 按标签统计。\n    pub by_tag: Vec\u003cTagCount\u003e,\n}\n\n/// 目标进度（每日/每周）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct GoalProgress {\n    /// 每日目标（0 表示未设置）。\n    pub daily_goal: u32,\n    /// 今日已完成。\n    pub daily_completed: u32,\n    /// 每周目标（0 表示未设置）。\n    pub weekly_goal: u32,\n    /// 本周已完成。\n    pub weekly_completed: u32,\n}\n\n/// 计算指定日期（YYYY-MM-DD）的“今日统计”（仅统计工作阶段记录）。\npub fn compute_today_stats(data: \u0026AppData, today: \u0026str) -\u003e TodayStats {\n    let mut map: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n    let mut total = 0u32;\n\n    if let Some(day) = data.history.iter().find(|d| d.date == today) {\n        for r in \u0026day.records {\n            if r.phase != Phase::Work {\n                continue;\n            }\n            total += 1;\n            *map.entry(r.tag.clone()).or_insert(0) += 1;\n        }\n    }\n\n    TodayStats {\n        total,\n        by_tag: map\n            .into_iter()\n            .map(|(tag, count)| TagCount { tag, count })\n            .collect(),\n    }\n}\n\n/// 计算闭区间 `[from, to]`（YYYY-MM-DD）的“本周统计”（仅统计工作阶段记录）。\npub fn compute_week_stats(data: \u0026AppData, from: \u0026str, to: \u0026str) -\u003e WeekStats {\n    let mut map: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n    let mut total = 0u32;\n\n    for day in \u0026data.history {\n        if day.date.as_str() \u003c from || day.date.as_str() \u003e to {\n            continue;\n        }\n        for r in \u0026day.records {\n            if r.phase != Phase::Work {\n                continue;\n            }\n            total += 1;\n            *map.entry(r.tag.clone()).or_insert(0) += 1;\n        }\n    }\n\n    WeekStats {\n        total,\n        by_tag: map\n            .into_iter()\n            .map(|(tag, count)| TagCount { tag, count })\n            .collect(),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::app_data::{HistoryDay, HistoryRecord};\n\n    /// 构造一条测试用历史记录（默认仅填充必要字段）。\n    fn record(tag: \u0026str, phase: Phase) -\u003e HistoryRecord {\n        HistoryRecord {\n            tag: tag.to_string(),\n            start_time: \"09:00\".to_string(),\n            end_time: Some(\"09:25\".to_string()),\n            duration: 25,\n            phase,\n            remark: String::new(),\n        }\n    }\n\n    /// `compute_today_stats` 只统计工作阶段，并按标签汇总。\n    #[test]\n    fn compute_today_stats_counts_only_work() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![\n                    record(\"学习\", Phase::Work),\n                    record(\"工作\", Phase::Work),\n                    record(\"学习\", Phase::Work),\n                    record(\"短休息\", Phase::ShortBreak),\n                ],\n            }],\n            ..AppData::default()\n        };\n\n        let out = compute_today_stats(\u0026data, \"2025-01-01\");\n        assert_eq!(out.total, 3);\n        assert_eq!(\n            out.by_tag,\n            vec![\n                TagCount {\n                    tag: \"学习\".to_string(),\n                    count: 2\n                },\n                TagCount {\n                    tag: \"工作\".to_string(),\n                    count: 1\n                }\n            ]\n        );\n    }\n\n    /// `compute_week_stats` 按日期闭区间聚合，并忽略区间外的天。\n    #[test]\n    fn compute_week_stats_respects_range() {\n        let data = AppData {\n            history: vec![\n                HistoryDay {\n                    date: \"2025-01-01\".to_string(),\n                    records: vec![record(\"A\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-03\".to_string(),\n                    records: vec![record(\"A\", Phase::Work), record(\"B\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-10\".to_string(),\n                    records: vec![record(\"A\", Phase::Work)],\n                },\n            ],\n            ..AppData::default()\n        };\n\n        let out = compute_week_stats(\u0026data, \"2025-01-01\", \"2025-01-07\");\n        assert_eq!(out.total, 3);\n        assert_eq!(out.by_tag, vec![TagCount { tag: \"A\".to_string(), count: 2 }, TagCount { tag: \"B\".to_string(), count: 1 }]);\n    }\n\n    /// `compute_today_stats`：当指定日期不存在时应返回 0 与空分组。\n    #[test]\n    fn compute_today_stats_returns_zero_when_missing_day() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![record(\"A\", Phase::Work)],\n            }],\n            ..AppData::default()\n        };\n\n        let out = compute_today_stats(\u0026data, \"2025-01-02\");\n        assert_eq!(out.total, 0);\n        assert!(out.by_tag.is_empty());\n    }\n\n    /// `compute_week_stats`：应包含闭区间边界日期（from/to 当天）。\n    #[test]\n    fn compute_week_stats_includes_boundary_days() {\n        let data = AppData {\n            history: vec![\n                HistoryDay {\n                    date: \"2025-01-01\".to_string(),\n                    records: vec![record(\"A\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-07\".to_string(),\n                    records: vec![record(\"B\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-08\".to_string(),\n                    records: vec![record(\"C\", Phase::Work)],\n                },\n            ],\n            ..AppData::default()\n        };\n\n        let out = compute_week_stats(\u0026data, \"2025-01-01\", \"2025-01-07\");\n        assert_eq!(out.total, 2);\n        assert_eq!(\n            out.by_tag,\n            vec![\n                TagCount {\n                    tag: \"A\".to_string(),\n                    count: 1\n                },\n                TagCount {\n                    tag: \"B\".to_string(),\n                    count: 1\n                }\n            ]\n        );\n    }\n}\n","traces":[{"line":59,"address":[33767520,33768361,33768389],"length":1,"stats":{"Line":1}},{"line":60,"address":[33767566],"length":1,"stats":{"Line":1}},{"line":61,"address":[33767600],"length":1,"stats":{"Line":1}},{"line":63,"address":[31168704,31168721],"length":1,"stats":{"Line":4}},{"line":64,"address":[33768224,33767928,33767820],"length":1,"stats":{"Line":3}},{"line":65,"address":[33768033],"length":1,"stats":{"Line":1}},{"line":68,"address":[33768065,33768120],"length":1,"stats":{"Line":1}},{"line":69,"address":[33768101,33768229,33768164],"length":1,"stats":{"Line":2}},{"line":75,"address":[33767852],"length":1,"stats":{"Line":1}},{"line":83,"address":[33766448,33767485,33767513],"length":1,"stats":{"Line":1}},{"line":84,"address":[33766519],"length":1,"stats":{"Line":1}},{"line":85,"address":[33766556],"length":1,"stats":{"Line":1}},{"line":87,"address":[33766651,33766567],"length":1,"stats":{"Line":2}},{"line":88,"address":[33766752,33766976],"length":1,"stats":{"Line":2}},{"line":91,"address":[33767462,33767135],"length":1,"stats":{"Line":2}},{"line":92,"address":[33767271],"length":1,"stats":{"Line":1}},{"line":95,"address":[33767358,33767303],"length":1,"stats":{"Line":1}},{"line":96,"address":[33767402,33767339,33767467],"length":1,"stats":{"Line":2}},{"line":102,"address":[33766783],"length":1,"stats":{"Line":1}}],"covered":19,"coverable":19},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","validation.rs"],"content":"//! 设置参数校验（用于后端命令统一验证）。\n\nuse crate::app_data::Settings;\nuse crate::errors::{AppError, AppResult};\n\n/// 校验并规范化设置参数（同时满足 PRD 的范围约束）。\npub fn validate_settings(settings: \u0026Settings) -\u003e AppResult\u003c()\u003e {\n    if !(1..=60).contains(\u0026settings.pomodoro) {\n        return Err(AppError::Validation(\"番茄时长需在 1-60 分钟\".to_string()));\n    }\n    if !(1..=30).contains(\u0026settings.short_break) {\n        return Err(AppError::Validation(\"短休息需在 1-30 分钟\".to_string()));\n    }\n    if !(1..=60).contains(\u0026settings.long_break) {\n        return Err(AppError::Validation(\"长休息需在 1-60 分钟\".to_string()));\n    }\n    if !(1..=10).contains(\u0026settings.long_break_interval) {\n        return Err(AppError::Validation(\"长休息间隔需在 1-10 个番茄\".to_string()));\n    }\n    if !(1..=20).contains(\u0026settings.auto_continue_pomodoros) {\n        return Err(AppError::Validation(\n            \"连续番茄数量需在 1-20 个番茄\".to_string(),\n        ));\n    }\n    if settings.daily_goal \u003e 1000 {\n        return Err(AppError::Validation(\"每日目标建议不超过 1000\".to_string()));\n    }\n    if settings.weekly_goal \u003e 10000 {\n        return Err(AppError::Validation(\"每周目标建议不超过 10000\".to_string()));\n    }\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// 校验：合法边界应通过。\n    #[test]\n    fn validate_settings_accepts_valid_ranges() {\n        let settings = Settings {\n            pomodoro: 1,\n            short_break: 1,\n            long_break: 1,\n            long_break_interval: 1,\n            auto_continue_enabled: true,\n            auto_continue_pomodoros: 1,\n            daily_goal: 0,\n            weekly_goal: 0,\n            always_on_top: false,\n        };\n        assert!(validate_settings(\u0026settings).is_ok());\n    }\n\n    /// 校验：非法范围应返回 `Validation` 错误。\n    #[test]\n    fn validate_settings_rejects_out_of_range() {\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                pomodoro: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                pomodoro: 61,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                short_break: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                short_break: 31,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                long_break_interval: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                long_break_interval: 11,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n\n    /// 校验：连续番茄数量超出范围应失败。\n    #[test]\n    fn validate_settings_rejects_auto_continue_pomodoros_out_of_range() {\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                auto_continue_pomodoros: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                auto_continue_pomodoros: 21,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n\n    /// 校验：每日/每周目标过大应失败（用于防御性约束）。\n    #[test]\n    fn validate_settings_rejects_excessive_goals() {\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                daily_goal: 1001,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                weekly_goal: 10001,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n}\n","traces":[{"line":7,"address":[33879664],"length":1,"stats":{"Line":1}},{"line":8,"address":[33879694],"length":1,"stats":{"Line":1}},{"line":9,"address":[33879710],"length":1,"stats":{"Line":1}},{"line":11,"address":[33879799],"length":1,"stats":{"Line":1}},{"line":12,"address":[33879834],"length":1,"stats":{"Line":1}},{"line":14,"address":[33879941],"length":1,"stats":{"Line":1}},{"line":15,"address":[33879961],"length":1,"stats":{"Line":0}},{"line":17,"address":[33880080],"length":1,"stats":{"Line":1}},{"line":18,"address":[33880100],"length":1,"stats":{"Line":1}},{"line":20,"address":[33880219],"length":1,"stats":{"Line":1}},{"line":21,"address":[33880270],"length":1,"stats":{"Line":1}},{"line":22,"address":[33880239],"length":1,"stats":{"Line":1}},{"line":25,"address":[33880358],"length":1,"stats":{"Line":1}},{"line":26,"address":[33880387],"length":1,"stats":{"Line":1}},{"line":28,"address":[33880372],"length":1,"stats":{"Line":1}},{"line":29,"address":[33880518],"length":1,"stats":{"Line":1}},{"line":31,"address":[33880506],"length":1,"stats":{"Line":1}}],"covered":16,"coverable":17}]};
        var previousData = {"files":[{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","build.rs"],"content":"/// 构建脚本入口：生成 Tauri 所需的构建产物。\nfn main() {\n    tauri_build::build()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","analysis.rs"],"content":"//! 专注时段分析：基于历史记录统计时段/星期/标签效率，并生成摘要文案。\n\nuse std::collections::BTreeMap;\n\nuse chrono::{Datelike as _, NaiveDate, Weekday};\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::{DateRange, HistoryDay};\nuse crate::errors::{AppError, AppResult};\n\n/// 专注分析结果（用于前端图表渲染）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct FocusAnalysis {\n    /// 24 小时分布（按 `startTime` 的小时计数）。\n    pub hourly_counts: Vec\u003cu32\u003e,\n    /// 时段分布：`[0-6, 6-12, 12-18, 18-24]`。\n    pub period_counts: Vec\u003cu32\u003e,\n    /// 星期分布：`[周一..周日]`。\n    pub weekday_counts: Vec\u003cu32\u003e,\n    /// 交叉热力：`weekday_hour_counts[weekday][hour]`（7x24）。\n    pub weekday_hour_counts: Vec\u003cVec\u003cu32\u003e\u003e,\n    /// 标签效率：各标签平均专注时长（分钟）。\n    pub tag_efficiency: Vec\u003cTagEfficiency\u003e,\n    /// 文字总结（示例：「你在上午 9-11 点专注效率最高」）。\n    pub summary: String,\n}\n\n/// 标签效率条目。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TagEfficiency {\n    /// 标签名。\n    pub tag: String,\n    /// 平均时长（分钟）。\n    pub avg_duration: f64,\n    /// 样本数（番茄数量）。\n    pub count: u32,\n}\n\n/// 生成指定日期范围的专注分析（输入为按日分组的历史数据切片）。\npub fn get_focus_analysis(days: \u0026[HistoryDay], range: \u0026DateRange) -\u003e AppResult\u003cFocusAnalysis\u003e {\n    let (from, to) = parse_range(range)?;\n\n    let mut hourly = vec![0u32; 24];\n    let mut periods = vec![0u32; 4];\n    let mut weekday_counts = vec![0u32; 7];\n    let mut matrix = vec![vec![0u32; 24]; 7];\n\n    let mut tag_total: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n    let mut tag_count: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n\n    for day in days {\n        let day_date = match NaiveDate::parse_from_str(\u0026day.date, \"%Y-%m-%d\") {\n            Ok(d) =\u003e d,\n            Err(_) =\u003e continue,\n        };\n        if day_date \u003c from || day_date \u003e to {\n            continue;\n        }\n\n        let weekday_index = weekday_to_index(day_date.weekday());\n        for r in \u0026day.records {\n            let hour = parse_hour(\u0026r.start_time).unwrap_or(0);\n            hourly[hour] += 1;\n            periods[period_index(hour)] += 1;\n            weekday_counts[weekday_index] += 1;\n            matrix[weekday_index][hour] += 1;\n\n            *tag_total.entry(r.tag.clone()).or_insert(0) += r.duration;\n            *tag_count.entry(r.tag.clone()).or_insert(0) += 1;\n        }\n    }\n\n    let mut tag_efficiency: Vec\u003cTagEfficiency\u003e = tag_total\n        .into_iter()\n        .map(|(tag, total)| {\n            let count = tag_count.get(\u0026tag).copied().unwrap_or(0);\n            let avg = if count == 0 {\n                0.0\n            } else {\n                total as f64 / count as f64\n            };\n            TagEfficiency {\n                tag,\n                avg_duration: avg,\n                count,\n            }\n        })\n        .collect();\n\n    // 让“标签效率”更直观：按样本数/平均时长排序。\n    tag_efficiency.sort_by(|a, b| {\n        b.count\n            .cmp(\u0026a.count)\n            .then_with(|| b.avg_duration.total_cmp(\u0026a.avg_duration))\n    });\n\n    let summary = build_summary(\u0026hourly);\n\n    Ok(FocusAnalysis {\n        hourly_counts: hourly,\n        period_counts: periods,\n        weekday_counts,\n        weekday_hour_counts: matrix,\n        tag_efficiency,\n        summary,\n    })\n}\n\n/// 解析日期范围，并确保 `from \u003c= to`。\nfn parse_range(range: \u0026DateRange) -\u003e AppResult\u003c(NaiveDate, NaiveDate)\u003e {\n    let from = NaiveDate::parse_from_str(range.from.trim(), \"%Y-%m-%d\")\n        .map_err(|_| AppError::Validation(\"range.from 必须为 YYYY-MM-DD\".to_string()))?;\n    let to = NaiveDate::parse_from_str(range.to.trim(), \"%Y-%m-%d\")\n        .map_err(|_| AppError::Validation(\"range.to 必须为 YYYY-MM-DD\".to_string()))?;\n    if from \u003e to {\n        return Err(AppError::Validation(\n            \"日期范围不合法：from 不能晚于 to\".to_string(),\n        ));\n    }\n    Ok((from, to))\n}\n\n/// 从 `HH:mm` 中解析小时（0-23）。\nfn parse_hour(hhmm: \u0026str) -\u003e Option\u003cusize\u003e {\n    let hh = hhmm.split(':').next()?.trim();\n    let hour: usize = hh.parse().ok()?;\n    if hour \u003c 24 {\n        Some(hour)\n    } else {\n        None\n    }\n}\n\n/// 将小时映射到 4 个时段桶：0-6 / 6-12 / 12-18 / 18-24。\nfn period_index(hour: usize) -\u003e usize {\n    match hour {\n        0..=5 =\u003e 0,\n        6..=11 =\u003e 1,\n        12..=17 =\u003e 2,\n        _ =\u003e 3,\n    }\n}\n\n/// 将 chrono `Weekday` 转为 `[周一..周日]` 索引。\nfn weekday_to_index(weekday: Weekday) -\u003e usize {\n    match weekday {\n        Weekday::Mon =\u003e 0,\n        Weekday::Tue =\u003e 1,\n        Weekday::Wed =\u003e 2,\n        Weekday::Thu =\u003e 3,\n        Weekday::Fri =\u003e 4,\n        Weekday::Sat =\u003e 5,\n        Weekday::Sun =\u003e 6,\n    }\n}\n\n/// 生成摘要：取番茄数量最多的连续 2 小时窗口。\nfn build_summary(hourly: \u0026[u32]) -\u003e String {\n    if hourly.len() != 24 {\n        return \"暂无分析数据\".to_string();\n    }\n    let total: u32 = hourly.iter().sum();\n    if total == 0 {\n        return \"暂无分析数据\".to_string();\n    }\n\n    let mut best_start = 0usize;\n    let mut best_sum = 0u32;\n    for start in 0..23 {\n        let sum = hourly[start] + hourly[start + 1];\n        if sum \u003e best_sum {\n            best_sum = sum;\n            best_start = start;\n        }\n    }\n\n    let label = time_range_label(best_start, best_start + 2);\n    format!(\"你在{}专注效率最高\", label)\n}\n\n/// 将小时范围格式化为更自然的中文时段描述（例如“上午 9-11 点”）。\nfn time_range_label(from_hour: usize, to_hour: usize) -\u003e String {\n    let (prefix, display_from, display_to) = if from_hour \u003c 6 {\n        (\"凌晨\", from_hour, to_hour)\n    } else if from_hour \u003c 12 {\n        (\"上午\", from_hour, to_hour)\n    } else if from_hour \u003c 18 {\n        (\"下午\", from_hour - 12, to_hour - 12)\n    } else {\n        (\"晚上\", from_hour - 12, to_hour - 12)\n    };\n\n    // 处理 12/24 的显示：避免出现 “下午 0 点”。\n    let normalize = |h: usize, is_pm: bool| -\u003e usize {\n        if is_pm \u0026\u0026 h == 0 {\n            12\n        } else {\n            h\n        }\n    };\n    let is_pm = prefix == \"下午\" || prefix == \"晚上\";\n    let f = normalize(display_from, is_pm);\n    let t = normalize(display_to, is_pm);\n    format!(\"{prefix} {f}-{t} 点\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{HistoryRecord, Phase};\n\n    /// 构造一条最小的历史记录（用于专注分析测试）。\n    fn record(tag: \u0026str, start_time: \u0026str, duration: u32) -\u003e HistoryRecord {\n        HistoryRecord {\n            tag: tag.to_string(),\n            start_time: start_time.to_string(),\n            end_time: None,\n            duration,\n            phase: Phase::Work,\n            remark: String::new(),\n        }\n    }\n\n    /// `parse_range`：合法范围应通过，并返回正确的 NaiveDate。\n    #[test]\n    fn parse_range_accepts_valid_range() {\n        let (from, to) = parse_range(\u0026DateRange {\n            from: \"2025-01-01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .unwrap();\n        assert_eq!(from, NaiveDate::from_ymd_opt(2025, 1, 1).unwrap());\n        assert_eq!(to, NaiveDate::from_ymd_opt(2025, 1, 7).unwrap());\n    }\n\n    /// `parse_range`：当 from \u003e to 时应返回校验错误。\n    #[test]\n    fn parse_range_rejects_from_after_to() {\n        let err = parse_range(\u0026DateRange {\n            from: \"2025-01-08\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `parse_range`：日期格式错误应返回校验错误。\n    #[test]\n    fn parse_range_rejects_invalid_format() {\n        let err = parse_range(\u0026DateRange {\n            from: \"2025/01/01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `parse_hour`：应支持边界值（00:00/23:59）与常见格式。\n    #[test]\n    fn parse_hour_supports_boundaries() {\n        assert_eq!(parse_hour(\"00:00\"), Some(0));\n        assert_eq!(parse_hour(\"23:59\"), Some(23));\n        assert_eq!(parse_hour(\" 9:01 \"), Some(9));\n    }\n\n    /// `parse_hour`：非法格式应返回 None。\n    #[test]\n    fn parse_hour_rejects_invalid_format() {\n        assert_eq!(parse_hour(\"\"), None);\n        assert_eq!(parse_hour(\"xx:yy\"), None);\n        assert_eq!(parse_hour(\"24:00\"), None);\n        assert_eq!(parse_hour(\"12\"), Some(12));\n    }\n\n    /// `period_index`：应按 0/6/12/18 边界映射到 4 个时段桶。\n    #[test]\n    fn period_index_respects_boundaries() {\n        assert_eq!(period_index(0), 0);\n        assert_eq!(period_index(5), 0);\n        assert_eq!(period_index(6), 1);\n        assert_eq!(period_index(11), 1);\n        assert_eq!(period_index(12), 2);\n        assert_eq!(period_index(17), 2);\n        assert_eq!(period_index(18), 3);\n        assert_eq!(period_index(23), 3);\n    }\n\n    /// `weekday_to_index`：应将周一到周日映射为 0..=6。\n    #[test]\n    fn weekday_to_index_maps_mon_to_sun() {\n        assert_eq!(weekday_to_index(Weekday::Mon), 0);\n        assert_eq!(weekday_to_index(Weekday::Tue), 1);\n        assert_eq!(weekday_to_index(Weekday::Wed), 2);\n        assert_eq!(weekday_to_index(Weekday::Thu), 3);\n        assert_eq!(weekday_to_index(Weekday::Fri), 4);\n        assert_eq!(weekday_to_index(Weekday::Sat), 5);\n        assert_eq!(weekday_to_index(Weekday::Sun), 6);\n    }\n\n    /// `build_summary`：空数据应返回“暂无分析数据”。\n    #[test]\n    fn build_summary_returns_no_data_when_empty() {\n        assert_eq!(build_summary(\u0026vec![0u32; 24]), \"暂无分析数据\");\n    }\n\n    /// `build_summary`：应选择番茄数量最多的连续 2 小时窗口。\n    #[test]\n    fn build_summary_picks_best_two_hour_window() {\n        let mut hourly = vec![0u32; 24];\n        hourly[8] = 1;\n        hourly[9] = 3;\n        hourly[10] = 3; // 9-11 窗口合计 6，为最大\n        hourly[11] = 1;\n        let summary = build_summary(\u0026hourly);\n        assert!(summary.contains(\"专注效率最高\"));\n        assert!(summary.contains(\"上午 9-11 点\"));\n    }\n\n    /// `time_range_label`：应按凌晨/上午/下午/晚上输出，并处理 12 点边界。\n    #[test]\n    fn time_range_label_formats_periods_and_12_boundary() {\n        assert_eq!(time_range_label(0, 2), \"凌晨 0-2 点\");\n        assert_eq!(time_range_label(6, 8), \"上午 6-8 点\");\n        assert_eq!(time_range_label(12, 14), \"下午 12-2 点\");\n        assert_eq!(time_range_label(18, 20), \"晚上 6-8 点\");\n    }\n\n    /// `get_focus_analysis`：空历史应返回全 0 分布与“暂无分析数据”摘要。\n    #[test]\n    fn get_focus_analysis_handles_empty_days() {\n        let out = get_focus_analysis(\n            \u0026[],\n            \u0026DateRange {\n                from: \"2025-01-01\".to_string(),\n                to: \"2025-01-07\".to_string(),\n            },\n        )\n        .unwrap();\n        assert_eq!(out.hourly_counts, vec![0u32; 24]);\n        assert_eq!(out.period_counts, vec![0u32; 4]);\n        assert_eq!(out.weekday_counts, vec![0u32; 7]);\n        assert_eq!(out.weekday_hour_counts.len(), 7);\n        assert_eq!(out.weekday_hour_counts[0].len(), 24);\n        assert_eq!(out.tag_efficiency.len(), 0);\n        assert_eq!(out.summary, \"暂无分析数据\");\n    }\n\n    /// `get_focus_analysis`：单日数据应正确累计小时/时段/星期与标签效率。\n    #[test]\n    fn get_focus_analysis_handles_single_day() {\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(), // 2025-01-01 是周三\n            records: vec![\n                record(\"学习\", \"09:10\", 25),\n                record(\"学习\", \"09:40\", 30),\n                record(\"工作\", \"10:00\", 15),\n            ],\n        }];\n\n        let out = get_focus_analysis(\n            \u0026days,\n            \u0026DateRange {\n                from: \"2025-01-01\".to_string(),\n                to: \"2025-01-01\".to_string(),\n            },\n        )\n        .unwrap();\n\n        assert_eq!(out.hourly_counts[9], 2);\n        assert_eq!(out.hourly_counts[10], 1);\n        assert_eq!(out.period_counts[1], 3); // 6-12\n\n        // 周三 -\u003e index 2\n        assert_eq!(out.weekday_counts[2], 3);\n        assert_eq!(out.weekday_hour_counts[2][9], 2);\n        assert_eq!(out.weekday_hour_counts[2][10], 1);\n\n        // 标签效率按样本数排序：学习(2) 在前\n        assert_eq!(out.tag_efficiency[0].tag, \"学习\");\n        assert_eq!(out.tag_efficiency[0].count, 2);\n        assert!((out.tag_efficiency[0].avg_duration - 27.5).abs() \u003c 1e-9);\n        assert_eq!(out.tag_efficiency[1].tag, \"工作\");\n        assert_eq!(out.tag_efficiency[1].count, 1);\n        assert!((out.tag_efficiency[1].avg_duration - 15.0).abs() \u003c 1e-9);\n    }\n\n    /// `get_focus_analysis`：日期范围应为闭区间，并忽略范围外数据与非法日期。\n    #[test]\n    fn get_focus_analysis_respects_inclusive_range_and_skips_invalid_dates() {\n        let days = vec![\n            HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![record(\"A\", \"08:00\", 25)],\n            },\n            HistoryDay {\n                date: \"2025-01-02\".to_string(),\n                records: vec![record(\"B\", \"09:00\", 25)],\n            },\n            HistoryDay {\n                date: \"2025-01-03\".to_string(),\n                records: vec![record(\"C\", \"10:00\", 25)],\n            },\n            HistoryDay {\n                date: \"bad-date\".to_string(),\n                records: vec![record(\"D\", \"11:00\", 25)],\n            },\n        ];\n\n        let out = get_focus_analysis(\n            \u0026days,\n            \u0026DateRange {\n                from: \"2025-01-02\".to_string(),\n                to: \"2025-01-03\".to_string(),\n            },\n        )\n        .unwrap();\n\n        assert_eq!(out.hourly_counts[8], 0);\n        assert_eq!(out.hourly_counts[9], 1);\n        assert_eq!(out.hourly_counts[10], 1);\n        assert_eq!(out.tag_efficiency.len(), 2);\n        assert_eq!(out.tag_efficiency[0].tag, \"B\");\n        assert_eq!(out.tag_efficiency[1].tag, \"C\");\n    }\n}\n","traces":[{"line":45,"address":[33103673,33104996,33101984],"length":1,"stats":{"Line":1}},{"line":46,"address":[65727985],"length":1,"stats":{"Line":1}},{"line":48,"address":[33102269],"length":1,"stats":{"Line":1}},{"line":49,"address":[33102344],"length":1,"stats":{"Line":1}},{"line":50,"address":[33102389],"length":1,"stats":{"Line":1}},{"line":51,"address":[33102461,33102554],"length":1,"stats":{"Line":2}},{"line":53,"address":[33102577],"length":1,"stats":{"Line":1}},{"line":54,"address":[33102622],"length":1,"stats":{"Line":1}},{"line":56,"address":[65729395],"length":1,"stats":{"Line":2}},{"line":57,"address":[33102885,33103695],"length":1,"stats":{"Line":2}},{"line":58,"address":[33103782],"length":1,"stats":{"Line":1}},{"line":59,"address":[65729676],"length":1,"stats":{"Line":0}},{"line":61,"address":[33103803],"length":1,"stats":{"Line":1}},{"line":65,"address":[33103913],"length":1,"stats":{"Line":1}},{"line":66,"address":[33104890,33103976],"length":1,"stats":{"Line":2}},{"line":67,"address":[33104133],"length":1,"stats":{"Line":1}},{"line":68,"address":[33104242,33104321],"length":1,"stats":{"Line":1}},{"line":69,"address":[33104447,33104346,33104309],"length":1,"stats":{"Line":2}},{"line":70,"address":[33104470,33104531,33104416],"length":1,"stats":{"Line":2}},{"line":71,"address":[33104504,33104650,33104562],"length":1,"stats":{"Line":2}},{"line":73,"address":[33104695,33104624,33104785],"length":1,"stats":{"Line":2}},{"line":74,"address":[33104895,33104830,33104766],"length":1,"stats":{"Line":2}},{"line":78,"address":[33102911],"length":1,"stats":{"Line":1}},{"line":80,"address":[27686515,27686230,27686208],"length":1,"stats":{"Line":3}},{"line":81,"address":[27686258,27686324],"length":1,"stats":{"Line":2}},{"line":82,"address":[27686389,27686375],"length":1,"stats":{"Line":1}},{"line":83,"address":[27686380],"length":1,"stats":{"Line":0}},{"line":85,"address":[27686399],"length":1,"stats":{"Line":1}},{"line":87,"address":[27686473],"length":1,"stats":{"Line":1}},{"line":88,"address":[27686437],"length":1,"stats":{"Line":1}},{"line":89,"address":[27686467],"length":1,"stats":{"Line":1}},{"line":96,"address":[27686128],"length":1,"stats":{"Line":3}},{"line":97,"address":[27686170],"length":1,"stats":{"Line":1}},{"line":98,"address":[27686174],"length":1,"stats":{"Line":1}},{"line":99,"address":[27686558,27686193,27686544],"length":1,"stats":{"Line":3}},{"line":102,"address":[33103122],"length":1,"stats":{"Line":1}},{"line":104,"address":[33103388],"length":1,"stats":{"Line":1}},{"line":105,"address":[33103196],"length":1,"stats":{"Line":1}},{"line":106,"address":[33103236],"length":1,"stats":{"Line":1}},{"line":107,"address":[33103276],"length":1,"stats":{"Line":1}},{"line":108,"address":[33103316],"length":1,"stats":{"Line":1}},{"line":109,"address":[33103356],"length":1,"stats":{"Line":1}},{"line":115,"address":[33099488],"length":1,"stats":{"Line":1}},{"line":116,"address":[33099692,33099526,33099624],"length":1,"stats":{"Line":3}},{"line":117,"address":[33099614,33099664],"length":1,"stats":{"Line":4}},{"line":118,"address":[33099737,33099842,33099922],"length":1,"stats":{"Line":2}},{"line":119,"address":[33099829,33099891],"length":1,"stats":{"Line":1}},{"line":120,"address":[33099968],"length":1,"stats":{"Line":1}},{"line":121,"address":[33100053],"length":1,"stats":{"Line":1}},{"line":122,"address":[33100022],"length":1,"stats":{"Line":1}},{"line":125,"address":[33099996],"length":1,"stats":{"Line":1}},{"line":129,"address":[33099152],"length":1,"stats":{"Line":1}},{"line":130,"address":[33099181],"length":1,"stats":{"Line":1}},{"line":131,"address":[33099329],"length":1,"stats":{"Line":1}},{"line":132,"address":[33099447,33099432],"length":1,"stats":{"Line":2}},{"line":133,"address":[33099454],"length":1,"stats":{"Line":1}},{"line":135,"address":[33099438],"length":1,"stats":{"Line":1}},{"line":140,"address":[33100144],"length":1,"stats":{"Line":1}},{"line":142,"address":[33100154,33100183],"length":1,"stats":{"Line":2}},{"line":143,"address":[33100166,33100222],"length":1,"stats":{"Line":2}},{"line":144,"address":[33100255,33100205],"length":1,"stats":{"Line":2}},{"line":145,"address":[33100239],"length":1,"stats":{"Line":1}},{"line":150,"address":[33101968],"length":1,"stats":{"Line":1}},{"line":151,"address":[33101975],"length":1,"stats":{"Line":1}},{"line":163,"address":[33100825,33100288,33100819],"length":1,"stats":{"Line":1}},{"line":164,"address":[33100331],"length":1,"stats":{"Line":1}},{"line":165,"address":[33100383],"length":1,"stats":{"Line":0}},{"line":167,"address":[33100347],"length":1,"stats":{"Line":1}},{"line":168,"address":[33100371],"length":1,"stats":{"Line":1}},{"line":169,"address":[33100408],"length":1,"stats":{"Line":1}},{"line":172,"address":[33100428],"length":1,"stats":{"Line":1}},{"line":173,"address":[33100437],"length":1,"stats":{"Line":1}},{"line":174,"address":[33100445,33100485],"length":1,"stats":{"Line":2}},{"line":175,"address":[33100540,33100848,33100999],"length":1,"stats":{"Line":2}},{"line":176,"address":[33100988,33101029],"length":1,"stats":{"Line":2}},{"line":177,"address":[33101020],"length":1,"stats":{"Line":1}},{"line":178,"address":[33101024],"length":1,"stats":{"Line":1}},{"line":182,"address":[33100554,33100646],"length":1,"stats":{"Line":1}},{"line":183,"address":[33100703,33100619],"length":1,"stats":{"Line":2}},{"line":187,"address":[33101040],"length":1,"stats":{"Line":1}},{"line":188,"address":[33101367,33101146,33101083],"length":1,"stats":{"Line":3}},{"line":189,"address":[33101112],"length":1,"stats":{"Line":1}},{"line":190,"address":[33101208,33101094],"length":1,"stats":{"Line":2}},{"line":191,"address":[33101174],"length":1,"stats":{"Line":1}},{"line":192,"address":[33101536,33101352,33101156],"length":1,"stats":{"Line":3}},{"line":193,"address":[33101243,33101459,33101541],"length":1,"stats":{"Line":2}},{"line":195,"address":[33101354,33101275,33101218],"length":1,"stats":{"Line":2}},{"line":199,"address":[27686048],"length":1,"stats":{"Line":1}},{"line":200,"address":[27686074,27686088],"length":1,"stats":{"Line":2}},{"line":201,"address":[27686101],"length":1,"stats":{"Line":1}},{"line":203,"address":[27686083],"length":1,"stats":{"Line":1}},{"line":206,"address":[33101426,33101554],"length":1,"stats":{"Line":2}},{"line":207,"address":[33101596],"length":1,"stats":{"Line":1}},{"line":208,"address":[33101634],"length":1,"stats":{"Line":1}},{"line":209,"address":[33101667],"length":1,"stats":{"Line":1}}],"covered":92,"coverable":95},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","app_data.rs"],"content":"//! PRD 约定的数据结构（settings / blacklist / tags / history）。\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\n/// Store 文件名（最终路径由后端根据平台解析到统一的数据根目录下）。\npub const STORE_FILE_NAME: \u0026str = \"pomodoro-data.json\";\n\n/// Store 内部主键（保存整棵 `AppData`）。\npub const STORE_KEY: \u0026str = \"appData\";\n\n/// 计时器/历史记录阶段（与前端 `Phase` 类型对齐）。\n#[derive(Debug, Copy, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub enum Phase {\n    /// 工作（番茄）。\n    Work,\n    /// 短休息。\n    ShortBreak,\n    /// 长休息。\n    LongBreak,\n}\n\nimpl Default for Phase {\n    /// 默认阶段：工作（用于旧数据缺失字段时的兼容回填）。\n    fn default() -\u003e Self {\n        Self::Work\n    }\n}\n\n/// 番茄钟设置。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct Settings {\n    /// 工作时长（分钟）。\n    pub pomodoro: u32,\n    /// 短休息时长（分钟）。\n    pub short_break: u32,\n    /// 长休息时长（分钟）。\n    pub long_break: u32,\n    /// 长休息间隔（每 N 个番茄触发）。\n    pub long_break_interval: u32,\n    /// 是否启用“休息结束后自动进入工作倒计时”（连续番茄模式）。\n    #[serde(default)]\n    pub auto_continue_enabled: bool,\n    /// 连续番茄数量：在该次数内，休息结束后自动开始下一次工作倒计时。\n    #[serde(default = \"default_auto_continue_pomodoros\")]\n    pub auto_continue_pomodoros: u32,\n    /// 每日目标番茄数量（0 表示不设目标）。\n    #[serde(default = \"default_daily_goal\")]\n    pub daily_goal: u32,\n    /// 每周目标番茄数量（0 表示不设目标）。\n    #[serde(default = \"default_weekly_goal\")]\n    pub weekly_goal: u32,\n    /// 窗口是否置顶（主窗口）。\n    #[serde(default)]\n    pub always_on_top: bool,\n}\n\n/// 默认连续番茄数量（用于旧版本数据缺失字段时的兼容回填）。\nfn default_auto_continue_pomodoros() -\u003e u32 {\n    4\n}\n\n/// 默认每日目标（PRD v2：8）。\nfn default_daily_goal() -\u003e u32 {\n    8\n}\n\n/// 默认每周目标（PRD v2：40）。\nfn default_weekly_goal() -\u003e u32 {\n    40\n}\n\nimpl Default for Settings {\n    /// PRD 默认设置：25/5/15/4。\n    fn default() -\u003e Self {\n        Self {\n            pomodoro: 25,\n            short_break: 5,\n            long_break: 15,\n            long_break_interval: 4,\n            auto_continue_enabled: false,\n            auto_continue_pomodoros: 4,\n            daily_goal: default_daily_goal(),\n            weekly_goal: default_weekly_goal(),\n            always_on_top: false,\n        }\n    }\n}\n\n/// 黑名单条目（以进程名为主键）。\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct BlacklistItem {\n    /// 进程名（例如 `WeChat.exe`）。\n    pub name: String,\n    /// 展示名（例如 `微信`）。\n    pub display_name: String,\n}\n\n/// 黑名单模板（可内置/可自定义）。\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct BlacklistTemplate {\n    /// 模板 id（内置模板为固定值，自定义模板可为 uuid/自定义字符串）。\n    pub id: String,\n    /// 模板名称。\n    pub name: String,\n    /// 是否为内置模板（内置模板不可删除）。\n    pub builtin: bool,\n    /// 模板包含的黑名单进程集合。\n    pub processes: Vec\u003cBlacklistItem\u003e,\n}\n\n/// 单条历史记录（仅记录完成的“工作”阶段）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct HistoryRecord {\n    /// 任务标签。\n    pub tag: String,\n    /// 开始时间（HH:mm）。\n    pub start_time: String,\n    /// 结束时间（HH:mm；旧数据可能缺失，前端可按 `start_time + duration` 推导展示）。\n    #[serde(default)]\n    pub end_time: Option\u003cString\u003e,\n    /// 本次番茄时长（分钟）。\n    pub duration: u32,\n    /// 阶段类型（用于导出/分析；当前仅记录工作阶段）。\n    #[serde(default)]\n    pub phase: Phase,\n    /// 备注（完成后可填写，也可在历史中编辑）。\n    #[serde(default)]\n    pub remark: String,\n}\n\n/// 某一天的历史集合。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct HistoryDay {\n    /// 日期（YYYY-MM-DD）。\n    pub date: String,\n    /// 当日记录。\n    pub records: Vec\u003cHistoryRecord\u003e,\n}\n\n/// 日期范围（闭区间）：`from \u003c= date \u003c= to`。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct DateRange {\n    /// 起始日期（YYYY-MM-DD）。\n    pub from: String,\n    /// 结束日期（YYYY-MM-DD）。\n    pub to: String,\n}\n\n/// 应用持久化数据根对象。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct AppData {\n    /// 用户设置。\n    pub settings: Settings,\n    /// 进程黑名单。\n    pub blacklist: Vec\u003cBlacklistItem\u003e,\n    /// 黑名单模板列表（包含内置模板与自定义模板）。\n    #[serde(default)]\n    pub blacklist_templates: Vec\u003cBlacklistTemplate\u003e,\n    /// 当前启用的模板 id 列表（支持同时启用多套模板）。\n    #[serde(default)]\n    pub active_template_ids: Vec\u003cString\u003e,\n    /// 兼容字段：旧/示例数据中的单一激活模板（用于自动迁移到 `active_template_ids`）。\n    #[serde(default)]\n    pub active_template_id: Option\u003cString\u003e,\n    /// 历史标签。\n    pub tags: Vec\u003cString\u003e,\n    /// 历史记录（按日分组）。\n    pub history: Vec\u003cHistoryDay\u003e,\n    /// 调试历史记录（仅开发环境使用，与正式数据隔离）。\n    #[serde(default)]\n    pub history_dev: Vec\u003cHistoryDay\u003e,\n}\n\nimpl Default for AppData {\n    /// PRD 初始数据：默认 settings + 默认 tags + 空 blacklist/history。\n    fn default() -\u003e Self {\n        let templates = builtin_templates();\n        let active = vec![\"work\".to_string()];\n        let blacklist = templates\n            .iter()\n            .find(|t| t.id == \"work\")\n            .map(|t| t.processes.clone())\n            .unwrap_or_default();\n\n        Self {\n            settings: Settings::default(),\n            blacklist,\n            blacklist_templates: templates,\n            active_template_ids: active.clone(),\n            active_template_id: active.first().cloned(),\n            tags: vec![\n                \"工作\".to_string(),\n                \"学习\".to_string(),\n                \"阅读\".to_string(),\n                \"写作\".to_string(),\n            ],\n            history: Vec::new(),\n            history_dev: Vec::new(),\n        }\n    }\n}\n\nimpl AppData {\n    /// 将旧版本数据迁移到 v2 结构（回填缺失字段、补齐内置模板、兼容单模板字段）。\n    pub fn migrate_v2(\u0026mut self) -\u003e bool {\n        let mut changed = false;\n\n        if self.blacklist_templates.is_empty() {\n            self.blacklist_templates = builtin_templates();\n            changed = true;\n        }\n\n        if self.active_template_ids.is_empty() {\n            if let Some(id) = self.active_template_id.clone() {\n                self.active_template_ids = vec![id];\n                changed = true;\n            }\n        }\n\n        // 保持 `active_template_id` 与数组一致，便于示例/兼容。\n        let first = self.active_template_ids.first().cloned();\n        if self.active_template_id != first {\n            self.active_template_id = first;\n            changed = true;\n        }\n\n        changed\n    }\n}\n\n/// 构建 PRD v2 内置黑名单模板列表。\nfn builtin_templates() -\u003e Vec\u003cBlacklistTemplate\u003e {\n    vec![\n        BlacklistTemplate {\n            id: \"work\".to_string(),\n            name: \"工作模式\".to_string(),\n            builtin: true,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Douyin.exe\".to_string(),\n                    display_name: \"抖音\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Bilibili.exe\".to_string(),\n                    display_name: \"B站\".to_string(),\n                },\n            ],\n        },\n        BlacklistTemplate {\n            id: \"study\".to_string(),\n            name: \"学习模式\".to_string(),\n            builtin: true,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Steam.exe\".to_string(),\n                    display_name: \"游戏平台\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Bilibili.exe\".to_string(),\n                    display_name: \"视频网站\".to_string(),\n                },\n            ],\n        },\n        BlacklistTemplate {\n            id: \"deep\".to_string(),\n            name: \"深度专注\".to_string(),\n            builtin: true,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Douyin.exe\".to_string(),\n                    display_name: \"抖音\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"Bilibili.exe\".to_string(),\n                    display_name: \"B站\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"chrome.exe\".to_string(),\n                    display_name: \"浏览器（Chrome）\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"msedge.exe\".to_string(),\n                    display_name: \"浏览器（Edge）\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"firefox.exe\".to_string(),\n                    display_name: \"浏览器（Firefox）\".to_string(),\n                },\n            ],\n        },\n    ]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// v2 迁移：当模板列表缺失时应补齐内置模板，并修复激活模板字段。\n    #[test]\n    fn migrate_v2_fills_templates_and_active_ids() {\n        let mut data = AppData {\n            blacklist_templates: Vec::new(),\n            active_template_ids: Vec::new(),\n            active_template_id: Some(\"work\".to_string()),\n            ..AppData::default()\n        };\n\n        let changed = data.migrate_v2();\n        assert!(changed);\n        assert!(!data.blacklist_templates.is_empty());\n        assert!(!data.active_template_ids.is_empty());\n        assert_eq!(data.active_template_ids[0], \"work\");\n        assert_eq!(data.active_template_id.as_deref(), Some(\"work\"));\n    }\n\n    /// v2 迁移：应保证 `active_template_id` 与数组首项一致，便于兼容读取。\n    #[test]\n    fn migrate_v2_keeps_active_template_id_in_sync() {\n        let mut data = AppData {\n            active_template_ids: vec![\"deep\".to_string()],\n            active_template_id: Some(\"work\".to_string()),\n            ..AppData::default()\n        };\n\n        let changed = data.migrate_v2();\n        assert!(changed);\n        assert_eq!(data.active_template_id.as_deref(), Some(\"deep\"));\n    }\n\n    /// `Settings::default`：默认值应符合 PRD 约定（25/5/15/4 + 目标值）。\n    #[test]\n    fn settings_default_matches_prd() {\n        let s = Settings::default();\n        assert_eq!(s.pomodoro, 25);\n        assert_eq!(s.short_break, 5);\n        assert_eq!(s.long_break, 15);\n        assert_eq!(s.long_break_interval, 4);\n        assert_eq!(s.auto_continue_enabled, false);\n        assert_eq!(s.auto_continue_pomodoros, 4);\n        assert_eq!(s.daily_goal, 8);\n        assert_eq!(s.weekly_goal, 40);\n        assert_eq!(s.always_on_top, false);\n    }\n\n    /// `builtin_templates`：应包含固定的内置模板集合，且均标记为 builtin。\n    #[test]\n    fn builtin_templates_have_expected_ids_and_flags() {\n        let templates = builtin_templates();\n        assert!(templates.len() \u003e= 3);\n        assert!(templates.iter().all(|t| t.builtin));\n\n        let ids: std::collections::BTreeSet\u003cString\u003e =\n            templates.iter().map(|t| t.id.clone()).collect();\n        assert_eq!(ids.len(), templates.len());\n        assert!(ids.contains(\"work\"));\n        assert!(ids.contains(\"study\"));\n        assert!(ids.contains(\"deep\"));\n    }\n\n    /// `AppData::default`：应填充默认模板/默认激活模板，并回填默认黑名单与标签。\n    #[test]\n    fn app_data_default_initializes_templates_blacklist_and_tags() {\n        let data = AppData::default();\n\n        assert!(!data.blacklist_templates.is_empty());\n        assert_eq!(data.active_template_ids.first().map(|s| s.as_str()), Some(\"work\"));\n        assert_eq!(data.active_template_id.as_deref(), Some(\"work\"));\n\n        let work_template = data\n            .blacklist_templates\n            .iter()\n            .find(|t| t.id == \"work\")\n            .expect(\"work 模板必须存在\");\n        assert_eq!(data.blacklist, work_template.processes);\n\n        assert_eq!(\n            data.tags,\n            vec![\"工作\".to_string(), \"学习\".to_string(), \"阅读\".to_string(), \"写作\".to_string()]\n        );\n        assert!(data.history.is_empty());\n    }\n}\n","traces":[{"line":79,"address":[32995248],"length":1,"stats":{"Line":1}},{"line":87,"address":[32995262],"length":1,"stats":{"Line":1}},{"line":88,"address":[32995271],"length":1,"stats":{"Line":1}},{"line":193,"address":[32994774,32992944,32994722],"length":1,"stats":{"Line":1}},{"line":194,"address":[32992961],"length":1,"stats":{"Line":1}},{"line":195,"address":[32993063,32994769,32993005],"length":1,"stats":{"Line":2}},{"line":196,"address":[32993284,32993382],"length":1,"stats":{"Line":2}},{"line":198,"address":[32120670,32120656],"length":1,"stats":{"Line":3}},{"line":199,"address":[32120704,32120720],"length":1,"stats":{"Line":3}},{"line":203,"address":[32993477],"length":1,"stats":{"Line":1}},{"line":206,"address":[32993602],"length":1,"stats":{"Line":1}},{"line":207,"address":[32993669,32993749],"length":1,"stats":{"Line":2}},{"line":208,"address":[32994103,32994031,32993896,32994144,32993959,32994728,32993849,32993791],"length":1,"stats":{"Line":3}},{"line":214,"address":[32994360],"length":1,"stats":{"Line":1}},{"line":215,"address":[32994419],"length":1,"stats":{"Line":1}},{"line":222,"address":[32957008,32957790,32957761],"length":1,"stats":{"Line":1}},{"line":223,"address":[32957028],"length":1,"stats":{"Line":1}},{"line":225,"address":[32957049,32957209],"length":1,"stats":{"Line":2}},{"line":226,"address":[32957118,32957092],"length":1,"stats":{"Line":1}},{"line":227,"address":[32957204],"length":1,"stats":{"Line":1}},{"line":230,"address":[32957067],"length":1,"stats":{"Line":1}},{"line":231,"address":[32957756,32957308],"length":1,"stats":{"Line":2}},{"line":232,"address":[32957645,32957402,32957460],"length":1,"stats":{"Line":2}},{"line":233,"address":[32957743],"length":1,"stats":{"Line":1}},{"line":238,"address":[32957219],"length":1,"stats":{"Line":1}},{"line":239,"address":[32958066,32957282,32957838],"length":1,"stats":{"Line":3}},{"line":240,"address":[32957876,32957939],"length":1,"stats":{"Line":1}},{"line":241,"address":[32958061],"length":1,"stats":{"Line":1}},{"line":244,"address":[32957844],"length":1,"stats":{"Line":1}},{"line":249,"address":[32956925,32951552,32956946],"length":1,"stats":{"Line":1}},{"line":250,"address":[32951579,32954520,32956740,32956912,32953065,32951625],"length":1,"stats":{"Line":2}},{"line":251,"address":[32952937],"length":1,"stats":{"Line":1}},{"line":252,"address":[32951589],"length":1,"stats":{"Line":1}},{"line":253,"address":[32951657],"length":1,"stats":{"Line":1}},{"line":255,"address":[32952258,32952665,32951739,32956941,32952051,32952465,32951797,32951844],"length":1,"stats":{"Line":3}},{"line":256,"address":[32951948],"length":1,"stats":{"Line":1}},{"line":257,"address":[32951805],"length":1,"stats":{"Line":1}},{"line":258,"address":[32951876],"length":1,"stats":{"Line":1}},{"line":260,"address":[32952155],"length":1,"stats":{"Line":1}},{"line":261,"address":[32952012],"length":1,"stats":{"Line":1}},{"line":262,"address":[32952083],"length":1,"stats":{"Line":1}},{"line":264,"address":[32952362],"length":1,"stats":{"Line":1}},{"line":265,"address":[32952219],"length":1,"stats":{"Line":1}},{"line":266,"address":[32952290],"length":1,"stats":{"Line":1}},{"line":268,"address":[32952569],"length":1,"stats":{"Line":1}},{"line":269,"address":[32952426],"length":1,"stats":{"Line":1}},{"line":270,"address":[32952497],"length":1,"stats":{"Line":1}},{"line":274,"address":[32954377],"length":1,"stats":{"Line":1}},{"line":275,"address":[32953029],"length":1,"stats":{"Line":1}},{"line":276,"address":[32953097],"length":1,"stats":{"Line":1}},{"line":278,"address":[32956936,32953237,32953698,32953284,32953905,32954105,32953179,32953491],"length":1,"stats":{"Line":3}},{"line":279,"address":[32953388],"length":1,"stats":{"Line":1}},{"line":280,"address":[32953245],"length":1,"stats":{"Line":1}},{"line":281,"address":[32953316],"length":1,"stats":{"Line":1}},{"line":283,"address":[32953595],"length":1,"stats":{"Line":1}},{"line":284,"address":[32953452],"length":1,"stats":{"Line":1}},{"line":285,"address":[32953523],"length":1,"stats":{"Line":1}},{"line":287,"address":[32953802],"length":1,"stats":{"Line":1}},{"line":288,"address":[32953659],"length":1,"stats":{"Line":1}},{"line":289,"address":[32953730],"length":1,"stats":{"Line":1}},{"line":291,"address":[32954009],"length":1,"stats":{"Line":1}},{"line":292,"address":[32953866],"length":1,"stats":{"Line":1}},{"line":293,"address":[32953937],"length":1,"stats":{"Line":1}},{"line":297,"address":[32956588],"length":1,"stats":{"Line":1}},{"line":298,"address":[32954481],"length":1,"stats":{"Line":1}},{"line":299,"address":[32954552],"length":1,"stats":{"Line":1}},{"line":301,"address":[32955567,32954946,32955981,32955774,32956181,32954692,32954634,32954739,32955153,32956931,32955360],"length":1,"stats":{"Line":3}},{"line":302,"address":[32954843],"length":1,"stats":{"Line":1}},{"line":303,"address":[32954700],"length":1,"stats":{"Line":1}},{"line":304,"address":[32954771],"length":1,"stats":{"Line":1}},{"line":306,"address":[32955050],"length":1,"stats":{"Line":1}},{"line":307,"address":[32954907],"length":1,"stats":{"Line":1}},{"line":308,"address":[32954978],"length":1,"stats":{"Line":1}},{"line":310,"address":[32955257],"length":1,"stats":{"Line":1}},{"line":311,"address":[32955114],"length":1,"stats":{"Line":1}},{"line":312,"address":[32955185],"length":1,"stats":{"Line":1}},{"line":314,"address":[32955464],"length":1,"stats":{"Line":1}},{"line":315,"address":[32955321],"length":1,"stats":{"Line":1}},{"line":316,"address":[32955392],"length":1,"stats":{"Line":1}},{"line":318,"address":[32955671],"length":1,"stats":{"Line":1}},{"line":319,"address":[32955528],"length":1,"stats":{"Line":1}},{"line":320,"address":[32955599],"length":1,"stats":{"Line":1}},{"line":322,"address":[32955878],"length":1,"stats":{"Line":1}},{"line":323,"address":[32955735],"length":1,"stats":{"Line":1}},{"line":324,"address":[32955806],"length":1,"stats":{"Line":1}},{"line":326,"address":[32956085],"length":1,"stats":{"Line":1}},{"line":327,"address":[32955942],"length":1,"stats":{"Line":1}},{"line":328,"address":[32956013],"length":1,"stats":{"Line":1}}],"covered":88,"coverable":88},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","app_paths.rs"],"content":"//! 应用路径解析：提供“统一入口”的根目录、数据目录与文件路径工具。\n\nuse std::path::PathBuf;\n\n#[cfg(not(windows))]\nuse tauri::Manager as _;\n\nuse crate::app_data::STORE_FILE_NAME;\nuse crate::errors::{AppError, AppResult};\n\n/// 获取统一入口的根目录。\n///\n/// - Windows：`%APPDATA%/pomodoro-technique/`\n/// - 其他平台：`app_data_dir/`（Tauri 标准应用数据目录）\npub fn app_root_dir(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cPathBuf\u003e {\n    #[cfg(windows)]\n    {\n        let _ = app;\n        let appdata = std::env::var(\"APPDATA\")\n            .map_err(|_| AppError::Invariant(\"无法读取环境变量 APPDATA\".to_string()))?;\n        return Ok(PathBuf::from(appdata).join(\"pomodoro-technique\"));\n    }\n\n    #[cfg(not(windows))]\n    {\n        app.path()\n            .app_data_dir()\n            .map_err(|_| AppError::Invariant(\"无法解析应用数据目录（app_data_dir）\".to_string()))\n    }\n}\n\n/// 获取应用数据目录（位于统一入口根目录下的 `data/`）。\npub fn app_data_dir(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cPathBuf\u003e {\n    Ok(app_root_dir(app)?.join(\"data\"))\n}\n\n/// 获取 store 文件的最终落盘路径（完整路径）。\npub fn store_file_path(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cPathBuf\u003e {\n    Ok(app_data_dir(app)?.join(STORE_FILE_NAME))\n}\n\n/// 获取应用日志目录（位于统一入口根目录下的 `logs/`）。\npub fn app_log_dir(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cPathBuf\u003e {\n    Ok(app_root_dir(app)?.join(\"logs\"))\n}\n","traces":[{"line":15,"address":[28960032],"length":1,"stats":{"Line":0}},{"line":26,"address":[28960064],"length":1,"stats":{"Line":0}},{"line":28,"address":[28960087],"length":1,"stats":{"Line":0}},{"line":33,"address":[28960005,28959999,28959648],"length":1,"stats":{"Line":0}},{"line":34,"address":[28959673,28959907],"length":1,"stats":{"Line":0}},{"line":38,"address":[28960112,28960469,28960463],"length":1,"stats":{"Line":0}},{"line":39,"address":[28960371,28960137],"length":1,"stats":{"Line":0}},{"line":43,"address":[28959621,28959615,28959264],"length":1,"stats":{"Line":0}},{"line":44,"address":[28959523,28959289],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":9},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","bin","gen_ts_types.rs"],"content":"//! 生成前端共享 TypeScript 类型定义文件（基于 `ts-rs`）。\n\nuse std::path::PathBuf;\n\nuse ts_rs::TS as _;\n\nuse tauri_app_lib::typegen::{\n    AppData, AppSnapshot, BlacklistItem, BlacklistTemplate, DateRange, ExportField, ExportFormat,\n    ExportRequest, FocusAnalysis, GoalProgress, HistoryDay, HistoryRecord, KillSummary, Phase,\n    KillItem, ProcessInfo, Settings, StorePaths, TagCount, TagEfficiency, TimerSnapshot, TodayStats,\n    WeekStats, WorkCompletedEvent,\n};\n\n/// 解析输出路径参数：支持 `--out \u003cpath\u003e`，否则写入默认位置。\nfn resolve_out_path(args: \u0026[String]) -\u003e PathBuf {\n    if let Some(pos) = args.iter().position(|a| a == \"--out\") {\n        if let Some(p) = args.get(pos + 1) {\n            return PathBuf::from(p);\n        }\n    }\n\n    let manifest_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\"));\n    manifest_dir\n        .parent()\n        .unwrap_or(\u0026manifest_dir)\n        .join(\"src/lib/shared/types.generated.ts\")\n}\n\n/// 生成 `types.generated.ts` 的完整内容（包含所有需要的共享类型声明）。\nfn build_types_file() -\u003e String {\n    let mut out = String::new();\n    out.push_str(\"/**\\n\");\n    out.push_str(\" * 本文件由 `cargo run --bin gen_ts_types` 自动生成，请勿手动编辑。\\n\");\n    out.push_str(\" *\\n\");\n    out.push_str(\" * 生成来源：Rust 端 `ts-rs` derive（序列化字段名与前端保持 camelCase 一致）。\\n\");\n    out.push_str(\" */\\n\\n\");\n\n    // PRD 数据结构（AppData + TimerSnapshot + 进程/分析/导出等命令类型）。\n    out.push_str(\u0026exported_decl(\u0026Phase::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026Settings::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026BlacklistItem::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026BlacklistTemplate::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026HistoryRecord::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026HistoryDay::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026AppData::decl()));\n    out.push('\\n');\n\n    out.push_str(\u0026exported_decl(\u0026TagCount::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026TodayStats::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026WeekStats::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026GoalProgress::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026TimerSnapshot::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026WorkCompletedEvent::decl()));\n    out.push('\\n');\n\n    out.push_str(\u0026exported_decl(\u0026AppSnapshot::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026StorePaths::decl()));\n    out.push('\\n');\n\n    out.push_str(\u0026exported_decl(\u0026ProcessInfo::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026KillItem::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026KillSummary::decl()));\n    out.push('\\n');\n\n    out.push_str(\u0026exported_decl(\u0026DateRange::decl()));\n    out.push('\\n');\n\n    out.push_str(\u0026exported_decl(\u0026TagEfficiency::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026FocusAnalysis::decl()));\n    out.push('\\n');\n\n    out.push_str(\u0026exported_decl(\u0026ExportFormat::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026ExportField::decl()));\n    out.push('\\n');\n    out.push_str(\u0026exported_decl(\u0026ExportRequest::decl()));\n    out.push('\\n');\n\n    out\n}\n\n/// 将 `ts-rs` 的声明文本转换为可被 TS 模块导出的形式（补齐 `export` 关键字）。\nfn exported_decl(decl: \u0026str) -\u003e String {\n    let trimmed = decl.trim_start();\n    if trimmed.starts_with(\"type \") {\n        return decl.replacen(\"type \", \"export type \", 1);\n    }\n    if trimmed.starts_with(\"interface \") {\n        return decl.replacen(\"interface \", \"export interface \", 1);\n    }\n    if trimmed.starts_with(\"enum \") {\n        return decl.replacen(\"enum \", \"export enum \", 1);\n    }\n    format!(\"export {decl}\")\n}\n\n/// 程序入口：生成并写入类型文件。\nfn main() {\n    let args: Vec\u003cString\u003e = std::env::args().collect();\n    let out_path = resolve_out_path(\u0026args);\n    let content = build_types_file();\n\n    if let Some(parent) = out_path.parent() {\n        let _ = std::fs::create_dir_all(parent);\n    }\n\n    std::fs::write(\u0026out_path, content).expect(\"写入 TypeScript 类型文件失败\");\n    println!(\"已生成：{}\", out_path.to_string_lossy());\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","analysis.rs"],"content":"//! 分析相关命令：专注时段分析。\n\nuse crate::analysis::FocusAnalysis;\nuse crate::app_data::DateRange;\nuse crate::errors::AppResult;\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{history_for_ui, validate_date_range};\n\n/// 获取指定范围的专注分析数据（用于“专注时段分析”图表/摘要）。\n#[tauri::command]\npub fn get_focus_analysis(\n    state: tauri::State\u003c'_, AppState\u003e,\n    range: DateRange,\n) -\u003e Result\u003cFocusAnalysis, String\u003e {\n    to_ipc_result(get_focus_analysis_impl(\u0026*state, \u0026range))\n}\n\n/// 获取专注分析的内部实现。\nfn get_focus_analysis_impl\u003cS: CommandState\u003e(state: \u0026S, range: \u0026DateRange) -\u003e AppResult\u003cFocusAnalysis\u003e {\n    validate_date_range(range)?;\n    let data = state.data_snapshot();\n    crate::analysis::get_focus_analysis(history_for_ui(\u0026data), range)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{AppData, HistoryDay, HistoryRecord, Phase};\n    use crate::commands::state_like::TestState;\n\n    /// `get_focus_analysis_impl`：应校验日期范围，并在开发环境优先使用 `history_dev`。\n    #[test]\n    fn get_focus_analysis_prefers_history_dev_and_validates_range() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![HistoryRecord {\n                    tag: \"A\".to_string(),\n                    start_time: \"09:00\".to_string(),\n                    end_time: None,\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                }],\n            }],\n            history_dev: vec![HistoryDay {\n                date: \"2025-01-02\".to_string(),\n                records: vec![HistoryRecord {\n                    tag: \"B\".to_string(),\n                    start_time: \"10:00\".to_string(),\n                    end_time: None,\n                    duration: 30,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                }],\n            }],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n\n        let out = get_focus_analysis_impl(\n            \u0026state,\n            \u0026DateRange {\n                from: \"2025-01-02\".to_string(),\n                to: \"2025-01-02\".to_string(),\n            },\n        )\n        .unwrap();\n        assert_eq!(out.hourly_counts[10], 1);\n        assert!(out.tag_efficiency.iter().any(|t| t.tag == \"B\"));\n\n        let err = get_focus_analysis_impl(\n            \u0026state,\n            \u0026DateRange {\n                from: \"2025-01-03\".to_string(),\n                to: \"2025-01-01\".to_string(),\n            },\n        )\n        .unwrap_err();\n        assert!(matches!(err, crate::errors::AppError::Validation(_)));\n    }\n}\n","traces":[{"line":14,"address":[33084552,33084416],"length":1,"stats":{"Line":0}},{"line":18,"address":[33084506,33084447],"length":1,"stats":{"Line":0}},{"line":22,"address":[34924790,34925126,34925120,34924480,34924784,34924816],"length":1,"stats":{"Line":1}},{"line":23,"address":[34924531,34924867],"length":1,"stats":{"Line":1}},{"line":24,"address":[34924988,34924652],"length":1,"stats":{"Line":1}},{"line":25,"address":[34924716,34924998,34925052,34924662],"length":1,"stats":{"Line":2}}],"covered":4,"coverable":6},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","app.rs"],"content":"//! 应用级命令：快照、数据目录等。\n\n#[cfg(not(windows))]\nuse tauri_plugin_opener::OpenerExt as _;\n\nuse crate::app_paths;\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::types::{AppSnapshot, StorePaths};\n\n/// 获取应用完整快照（用于前端首屏渲染与恢复）。\n#[tauri::command]\npub fn get_app_snapshot(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cAppSnapshot, String\u003e {\n    to_ipc_result(Ok(AppSnapshot {\n        data: state.data_snapshot(),\n        timer: state.timer_snapshot(),\n    }))\n}\n\n/// 获取应用数据根目录路径（统一入口，便于用户一处查看与备份）。\n#[tauri::command]\npub fn get_store_paths(app: tauri::AppHandle) -\u003e Result\u003cStorePaths, String\u003e {\n    to_ipc_result(get_store_paths_impl(\u0026app))\n}\n\n/// 打开应用数据根目录（文件管理器，统一入口）。\n#[tauri::command]\npub fn open_store_dir(app: tauri::AppHandle) -\u003e Result\u003c(), String\u003e {\n    to_ipc_result(open_store_dir_impl(\u0026app))\n}\n\n/// 获取应用数据根目录路径的内部实现（统一入口）。\nfn get_store_paths_impl(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cStorePaths\u003e {\n    let store_dir = app_paths::app_root_dir(app)?;\n    Ok(StorePaths {\n        store_dir_path: store_dir.to_string_lossy().to_string(),\n    })\n}\n\n/// 打开应用数据根目录的内部实现：确保目录存在后再请求系统打开（统一入口）。\nfn open_store_dir_impl(app: \u0026tauri::AppHandle) -\u003e AppResult\u003c()\u003e {\n    let store_dir = app_paths::app_root_dir(app)?;\n\n    std::fs::create_dir_all(\u0026store_dir)\n        .map_err(|e| AppError::Invariant(format!(\"创建根目录失败：{e}\")))?;\n\n    #[cfg(windows)]\n    {\n        std::process::Command::new(\"explorer\")\n            .arg(\u0026store_dir)\n            .spawn()\n            .map_err(|e| AppError::Invariant(format!(\"打开文件夹失败：{e}\")))?;\n        Ok(())\n    }\n\n    #[cfg(not(windows))]\n    {\n        app.opener()\n            .open_path(store_dir.to_string_lossy().to_string(), None::\u003c\u0026str\u003e)\n            .map_err(|e| AppError::Invariant(format!(\"打开文件夹失败：{e}\")))?;\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[30788260,30788016,30788254],"length":1,"stats":{"Line":0}},{"line":16,"address":[30788145],"length":1,"stats":{"Line":0}},{"line":17,"address":[30788047],"length":1,"stats":{"Line":0}},{"line":18,"address":[30788138,30788073],"length":1,"stats":{"Line":0}},{"line":24,"address":[30787888,30787989],"length":1,"stats":{"Line":0}},{"line":25,"address":[30787961,30787912],"length":1,"stats":{"Line":0}},{"line":30,"address":[30787760,30787861],"length":1,"stats":{"Line":0}},{"line":31,"address":[30787833,30787784],"length":1,"stats":{"Line":0}},{"line":35,"address":[30789635,30789152,30789641],"length":1,"stats":{"Line":0}},{"line":36,"address":[30789177],"length":1,"stats":{"Line":0}},{"line":37,"address":[30789488],"length":1,"stats":{"Line":0}},{"line":38,"address":[30789337,30789411],"length":1,"stats":{"Line":0}},{"line":43,"address":[30788288,30789125,30789133],"length":1,"stats":{"Line":0}},{"line":44,"address":[30788318],"length":1,"stats":{"Line":0}},{"line":46,"address":[30788681,30789131,30788577,30788479],"length":1,"stats":{"Line":0}},{"line":47,"address":[30788554,30788617],"length":1,"stats":{"Line":0}},{"line":60,"address":[30789016,30788711,30788912],"length":1,"stats":{"Line":0}},{"line":61,"address":[30788866,30788728],"length":1,"stats":{"Line":0}},{"line":62,"address":[30789038,30788797,30789093,30788889,30788952],"length":1,"stats":{"Line":0}},{"line":63,"address":[30789062],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","blacklist.rs"],"content":"//! 黑名单相关命令：设置黑名单、专注期锁定校验等。\n\nuse crate::app_data::BlacklistItem;\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{normalize_name, validate_blacklist_items};\n\n/// 设置黑名单（专注期内仅允许“新增”，不允许移除）。\n#[tauri::command]\npub fn set_blacklist(\n    state: tauri::State\u003c'_, AppState\u003e,\n    blacklist: Vec\u003cBlacklistItem\u003e,\n) -\u003e Result\u003cVec\u003cBlacklistItem\u003e, String\u003e {\n    to_ipc_result(set_blacklist_impl(\u0026*state, blacklist))\n}\n\n/// 设置黑名单的内部实现（便于统一错误处理）。\nfn set_blacklist_impl\u003cS: CommandState\u003e(state: \u0026S, blacklist: Vec\u003cBlacklistItem\u003e) -\u003e AppResult\u003cVec\u003cBlacklistItem\u003e\u003e {\n    set_blacklist_impl_with_killer(state, blacklist, |names| crate::processes::kill_names_best_effort(names))\n}\n\n/// 设置黑名单的可注入实现：用于在测试中 mock 进程终止逻辑。\nfn set_blacklist_impl_with_killer\u003cS: CommandState\u003e(\n    state: \u0026S,\n    blacklist: Vec\u003cBlacklistItem\u003e,\n    kill_names: impl FnOnce(\u0026[String]) -\u003e crate::processes::KillSummary,\n) -\u003e AppResult\u003cVec\u003cBlacklistItem\u003e\u003e {\n    validate_blacklist_items(\u0026blacklist)?;\n\n    let (added_names, should_kill_added) = state.update_data_and_timer(\n        |data, timer_runtime| {\n            let locked = timer_runtime.blacklist_locked();\n\n            if locked {\n                let old_names: std::collections::BTreeSet\u003cString\u003e = data\n                    .blacklist\n                    .iter()\n                    .map(|b| normalize_name(\u0026b.name))\n                    .collect();\n                let new_names: std::collections::BTreeSet\u003cString\u003e =\n                    blacklist.iter().map(|b| normalize_name(\u0026b.name)).collect();\n\n                if !old_names.is_subset(\u0026new_names) {\n                    return Err(AppError::BlacklistLocked);\n                }\n            }\n\n            let old_names: std::collections::BTreeSet\u003cString\u003e = data\n                .blacklist\n                .iter()\n                .map(|b| normalize_name(\u0026b.name))\n                .collect();\n\n            let added: Vec\u003cString\u003e = blacklist\n                .iter()\n                .filter(|b| !old_names.contains(\u0026normalize_name(\u0026b.name)))\n                .map(|b| b.name.clone())\n                .collect();\n\n            data.blacklist = blacklist.clone();\n\n            // PRD：番茄周期内可动态添加并立即终止。\n            let should_kill = locked \u0026\u0026 !added.is_empty();\n\n            Ok((added, should_kill))\n        },\n        true,\n    )?;\n\n    if should_kill_added {\n        tracing::info!(target: \"blacklist\", \"专注期新增黑名单条目，立即尝试终止：{:?}\", added_names);\n        let payload = kill_names(\u0026added_names);\n        let _ = state.emit_kill_result(payload);\n    }\n\n    Ok(state.data_snapshot().blacklist)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `set_blacklist_impl_with_killer`：非锁定状态下允许增删，且不触发终止逻辑。\n    #[test]\n    fn set_blacklist_allows_replace_when_not_locked() {\n        let state = TestState::new(crate::app_data::AppData::default());\n        let blacklist = vec![BlacklistItem {\n            name: \"a.exe\".to_string(),\n            display_name: \"A\".to_string(),\n        }];\n\n        let out = set_blacklist_impl_with_killer(\u0026state, blacklist.clone(), |_names| crate::processes::KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        })\n        .unwrap();\n\n        assert_eq!(out, blacklist);\n        assert_eq!(state.data_snapshot().blacklist, blacklist);\n        assert!(state.take_kill_results().is_empty());\n    }\n\n    /// `set_blacklist_impl_with_killer`：锁定状态下禁止移除旧条目，但允许新增并触发 best-effort 终止。\n    #[test]\n    fn set_blacklist_enforces_lock_and_kills_added_items() {\n        let state = TestState::new(crate::app_data::AppData::default());\n\n        // 先设置一个旧黑名单。\n        let old = vec![BlacklistItem {\n            name: \"old.exe\".to_string(),\n            display_name: \"Old\".to_string(),\n        }];\n        set_blacklist_impl_with_killer(\u0026state, old.clone(), |_names| crate::processes::KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        })\n        .unwrap();\n\n        // 进入“工作阶段锁定”态：让 timer_runtime.blacklist_locked() 为 true。\n        state\n            .update_data_and_timer(\n                |data, timer_runtime| {\n                    let clock = crate::timer::SystemClock;\n                    timer_runtime.start(\u0026data.settings, \u0026clock);\n                    Ok(())\n                },\n                false,\n            )\n            .unwrap();\n        assert!(state.timer_snapshot().blacklist_locked);\n\n        // 尝试移除 old：应失败。\n        let err = set_blacklist_impl_with_killer(\u0026state, vec![], |_names| crate::processes::KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        })\n        .unwrap_err();\n        assert!(matches!(err, AppError::BlacklistLocked));\n\n        // 新增一条：允许，并应触发 kill。\n        let next = vec![\n            old[0].clone(),\n            BlacklistItem {\n                name: \"new.exe\".to_string(),\n                display_name: \"New\".to_string(),\n            },\n        ];\n        let out = set_blacklist_impl_with_killer(\u0026state, next.clone(), |names| {\n            crate::processes::KillSummary {\n                items: vec![crate::processes::termination::KillItem {\n                    name: names[0].clone(),\n                    pids: vec![1],\n                    killed: 1,\n                    failed: 0,\n                    requires_admin: false,\n                }],\n                requires_admin: false,\n            }\n        })\n        .unwrap();\n\n        assert_eq!(out, next);\n        let kills = state.take_kill_results();\n        assert_eq!(kills.len(), 1);\n        assert_eq!(kills[0].items[0].name, \"new.exe\");\n    }\n}\n","traces":[{"line":13,"address":[30042022,30041824,30041998],"length":1,"stats":{"Line":0}},{"line":17,"address":[30041850,30041926],"length":1,"stats":{"Line":0}},{"line":21,"address":[31657360],"length":1,"stats":{"Line":0}},{"line":22,"address":[31657392,31657414,31657377],"length":1,"stats":{"Line":0}},{"line":26,"address":[31663184,31667120,31665312,31665152,31667256,31661376,31659248,31659408,31657440,31665288,31659384,31661216,31661352,31663344,31663320],"length":1,"stats":{"Line":4}},{"line":31,"address":[31661419,31659353,31657583,31661321,31667225,31657483,31661519,31663289,31663487,31665257,31659551,31665455,31665355,31663387,31659451],"length":1,"stats":{"Line":8}},{"line":33,"address":[31663662,31661821,31663789,31657885,31663285,31667221,31657758,31659726,31665253,31659349,31661694,31659853,31665757,31665630,31661317],"length":1,"stats":{"Line":6}},{"line":34,"address":[31668448,31673494,31669798,31667280,31671046,31669872,31672294,31671040,31671120,31672320,31672288,31669792,31668454,31673488,31668624],"length":1,"stats":{"Line":4}},{"line":35,"address":[31672390,31669942,31667350,31668694,31671190],"length":1,"stats":{"Line":4}},{"line":37,"address":[31667374,31669966,31671214,31672414,31668718],"length":1,"stats":{"Line":4}},{"line":38,"address":[31672496,31671296,31668800,31670048,31667456],"length":1,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[31668811,31667467,31672507,31670059,31671307],"length":1,"stats":{"Line":2}},{"line":41,"address":[31673584,31668822,31673712,31675155,31673619,31671318,31673811,31667478,31670070,31673747,31673648,31672518,31675120,31673683,31673776],"length":1,"stats":{"Line":6}},{"line":42,"address":[31672534,31667494,31671334,31668838,31670086],"length":1,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[31675312,31670163,31675091,31674736,31671411,31672611,31675347,31667571,31674195,31673520,31671344,31668848,31672544,31674160,31673555,31674771,31675056,31667504,31670096,31668915],"length":1,"stats":{"Line":6}},{"line":46,"address":[31671551,31667711,31670248,31672696,31670303,31669055,31672751,31669000,31667656,31671496],"length":1,"stats":{"Line":4}},{"line":47,"address":[31669069,31667725,31670317,31672765,31671565],"length":1,"stats":{"Line":1}},{"line":51,"address":[31669975,31672423,31668727,31667383,31671223],"length":1,"stats":{"Line":3}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[31672434,31668738,31667394,31671234,31669986],"length":1,"stats":{"Line":3}},{"line":54,"address":[31674800,31674483,31674224,31668749,31675027,31674448,31674672,31674707,31669997,31674835,31667405,31672445,31674992,31674259,31671245],"length":1,"stats":{"Line":9}},{"line":55,"address":[31671261,31670013,31667421,31668765,31672461],"length":1,"stats":{"Line":3}},{"line":57,"address":[31670023,31671271,31668775,31672471,31667431],"length":1,"stats":{"Line":3}},{"line":58,"address":[31671751,31672951,31670503,31667911,31669255],"length":1,"stats":{"Line":3}},{"line":59,"address":[31673840,31667954,31675440,31673854,31670546,31675454,31671794,31674302,31674288,31674512,31674000,31674014,31674526,31669298,31672994],"length":1,"stats":{"Line":9}},{"line":60,"address":[31674963,31674928,31675283,31674899,31675411,31673017,31675184,31670569,31671817,31674864,31675376,31669321,31667977,31675248,31675219],"length":1,"stats":{"Line":9}},{"line":61,"address":[31669344,31673040,31671840,31670592,31668000],"length":1,"stats":{"Line":3}},{"line":63,"address":[31671916,31673060,31670680,31673128,31673116,31669364,31668020,31671860,31669420,31670612,31670668,31668076,31671928,31668088,31669432],"length":1,"stats":{"Line":6}},{"line":66,"address":[31672272,31673234,31671024,31673472,31672034,31669538,31668432,31668194,31670786,31669776],"length":1,"stats":{"Line":4}},{"line":68,"address":[31670834,31673282,31668242,31669586,31672082],"length":1,"stats":{"Line":3}},{"line":73,"address":[31658041,31665913,31661977,31663945,31660009],"length":1,"stats":{"Line":3}},{"line":74,"address":[31662348,31666013,31658068,31658412,31662004,31663972,31664045,31660036,31664316,31660380,31658141,31666284,31660109,31662077,31665940],"length":1,"stats":{"Line":2}},{"line":75,"address":[31664558,31660622,31662590,31665248,31658364,31666236,31663280,31662300,31667216,31658654,31659344,31666526,31660332,31661312,31664268],"length":1,"stats":{"Line":1}},{"line":76,"address":[31662693,31660725,31666629,31658757,31664661],"length":1,"stats":{"Line":1}},{"line":79,"address":[31665930,31661994,31660026,31663962,31658058,31660755,31658787,31664691,31666659,31662723],"length":1,"stats":{"Line":6}}],"covered":30,"coverable":37},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","common.rs"],"content":"//! 命令模块通用工具：错误转换与 IPC 适配。\n\nuse crate::errors::{AppError, AppResult};\n\n/// 将内部 `AppResult\u003cT\u003e` 转为可被 Tauri IPC 接受的 `Result\u003cT, String\u003e`。\npub(crate) fn to_ipc_result\u003cT\u003e(result: AppResult\u003cT\u003e) -\u003e Result\u003cT, String\u003e {\n    result.map_err(app_error_to_string)\n}\n\n/// 将 `AppError` 转为前端可展示的错误字符串。\nfn app_error_to_string(err: AppError) -\u003e String {\n    match err {\n        AppError::BlacklistLocked =\u003e \"专注期内禁止移除黑名单进程\".to_string(),\n        AppError::Validation(msg) =\u003e msg,\n        AppError::UnsupportedPlatform(msg) =\u003e msg,\n        other =\u003e other.to_string(),\n    }\n}\n","traces":[{"line":6,"address":[33881120,33880864,33880960,33880832,33880640,33880928,33881024,33880992,33880672,33880736,33880704,33880800,33881088,33880768,33880896,33881056],"length":1,"stats":{"Line":0}},{"line":7,"address":[33881032,33880936,33881064,33880872,33880808,33880840,33880712,33881128,33880744,33881000,33880904,33881096,33880680,33880968,33880776,33880648],"length":1,"stats":{"Line":0}},{"line":11,"address":[28196432,28196892],"length":1,"stats":{"Line":0}},{"line":12,"address":[28196453],"length":1,"stats":{"Line":0}},{"line":13,"address":[28196658,28196793],"length":1,"stats":{"Line":0}},{"line":14,"address":[28196598],"length":1,"stats":{"Line":0}},{"line":15,"address":[28196690],"length":1,"stats":{"Line":0}},{"line":16,"address":[28196528,28196800],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","debug.rs"],"content":"//! 调试相关命令：生成/清除测试历史数据（PRD v3）。\n\nuse crate::app_data::{HistoryDay, HistoryRecord, Phase, Settings};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\n\n/// 向前端广播“调试历史数据变更”的事件名（用于自动刷新历史页面）。\npub const EVENT_HISTORY_DEV_CHANGED: \u0026str = \"pomodoro://history_dev_changed\";\n\n/// 开发者命令：一键生成测试历史数据并写入 `history_dev`（仅开发环境可用）。\n#[tauri::command]\npub fn debug_generate_history(state: tauri::State\u003c'_, AppState\u003e, days: u32) -\u003e Result\u003cu32, String\u003e {\n    to_ipc_result(debug_generate_history_impl(\u0026state, days))\n}\n\n/// 开发者命令：清空 `history_dev`（仅开发环境可用）。\n#[tauri::command]\npub fn debug_clear_history(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(debug_clear_history_impl(\u0026state))\n}\n\n/// 生成调试历史数据的内部实现：校验参数、写入 store、并通知前端刷新。\nfn debug_generate_history_impl(state: \u0026AppState, days: u32) -\u003e AppResult\u003cu32\u003e {\n    if !cfg!(debug_assertions) {\n        return Err(AppError::Validation(\"仅开发环境可使用调试模式\".to_string()));\n    }\n    if !(1..=365).contains(\u0026days) {\n        return Err(AppError::Validation(\"天数需在 1-365\".to_string()));\n    }\n\n    let mut generated = 0u32;\n\n    state.update_data(|data| {\n        let settings = data.settings.clone();\n        let tags = if data.tags.is_empty() {\n            vec![\"工作\".to_string()]\n        } else {\n            data.tags.clone()\n        };\n\n        let (history, count) = generate_history_dev(days, \u0026settings, \u0026tags);\n        data.history_dev = history;\n        generated = count;\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"storage\", \"生成测试历史数据：days={} records={}\", days, generated);\n    let _ = state.emit_simple_event(EVENT_HISTORY_DEV_CHANGED);\n    Ok(generated)\n}\n\n/// 清除调试历史数据的内部实现：清空 `history_dev` 并通知前端刷新。\nfn debug_clear_history_impl(state: \u0026AppState) -\u003e AppResult\u003cbool\u003e {\n    if !cfg!(debug_assertions) {\n        return Err(AppError::Validation(\"仅开发环境可使用调试模式\".to_string()));\n    }\n\n    state.update_data(|data| {\n        data.history_dev = Vec::new();\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"storage\", \"已清除测试历史数据（history_dev）\");\n    let _ = state.emit_simple_event(EVENT_HISTORY_DEV_CHANGED);\n    Ok(true)\n}\n\n/// 生成 `history_dev`：返回按日分组的历史与生成的记录总数。\nfn generate_history_dev(days: u32, settings: \u0026Settings, tags: \u0026[String]) -\u003e (Vec\u003cHistoryDay\u003e, u32) {\n    use chrono::{Datelike as _, Duration as ChronoDuration, Local, NaiveDate, Weekday};\n    use rand::Rng as _;\n\n    let mut rng = rand::thread_rng();\n    let today: NaiveDate = Local::now().date_naive();\n    let start = today - ChronoDuration::days((days as i64).saturating_sub(1));\n\n    let mut out: Vec\u003cHistoryDay\u003e = Vec::new();\n    let mut total = 0u32;\n\n    for offset in 0..days {\n        let date = start + ChronoDuration::days(offset as i64);\n        let weekday = date.weekday();\n        let base = rng.gen_range(4..=8);\n        let daily_count = if weekday == Weekday::Sat || weekday == Weekday::Sun {\n            (base / 2).max(1)\n        } else {\n            base\n        };\n\n        let mut records: Vec\u003cHistoryRecord\u003e = Vec::new();\n        for _ in 0..daily_count {\n            let phase_roll: u8 = rng.gen_range(0..=99);\n            let phase = if phase_roll \u003c 80 {\n                Phase::Work\n            } else if phase_roll \u003c 90 {\n                Phase::ShortBreak\n            } else {\n                Phase::LongBreak\n            };\n\n            let duration = match phase {\n                Phase::Work =\u003e {\n                    let base = settings.pomodoro as i32;\n                    let varied = base + rng.gen_range(-5..=5);\n                    varied.clamp(1, 60) as u32\n                }\n                Phase::ShortBreak =\u003e settings.short_break.clamp(1, 30),\n                Phase::LongBreak =\u003e settings.long_break.clamp(1, 60),\n            };\n\n            let (start_time, end_time) = random_time_in_windows(\u0026mut rng, duration);\n            let tag = pick_random_tag(\u0026mut rng, tags);\n\n            records.push(HistoryRecord {\n                tag,\n                start_time,\n                end_time: Some(end_time),\n                duration,\n                phase,\n                remark: String::new(),\n            });\n        }\n\n        records.sort_by(|a, b| a.start_time.cmp(\u0026b.start_time));\n        total += records.len() as u32;\n\n        out.push(HistoryDay {\n            date: date.format(\"%Y-%m-%d\").to_string(),\n            records,\n        });\n    }\n\n    (out, total)\n}\n\n/// 从现有标签列表中随机挑选一个标签（列表为空时回退为“工作”）。\nfn pick_random_tag(rng: \u0026mut impl rand::Rng, tags: \u0026[String]) -\u003e String {\n    if tags.is_empty() {\n        return \"工作\".to_string();\n    }\n    let idx = rng.gen_range(0..tags.len());\n    tags[idx].clone()\n}\n\n/// 在规定时间窗内随机生成开始/结束时间（HH:mm），并保证结束时间不超过窗末尾。\nfn random_time_in_windows(rng: \u0026mut impl rand::Rng, duration_minutes: u32) -\u003e (String, String) {\n    // 规则：9:00-12:00, 14:00-18:00\n    let windows: \u0026[(u32, u32)] = \u0026[(9 * 60, 12 * 60), (14 * 60, 18 * 60)];\n    let (start_min, end_min) = windows[rng.gen_range(0..windows.len())];\n    let latest_start = end_min.saturating_sub(duration_minutes).max(start_min);\n    let start = rng.gen_range(start_min..=latest_start);\n    let end = start + duration_minutes;\n    (minutes_to_hhmm(start), minutes_to_hhmm(end))\n}\n\n/// 将分钟数（0-1440）格式化为 `HH:mm`。\nfn minutes_to_hhmm(total_minutes: u32) -\u003e String {\n    let hh = (total_minutes / 60) % 24;\n    let mm = total_minutes % 60;\n    format!(\"{:02}:{:02}\", hh, mm)\n}\n","traces":[{"line":14,"address":[28930656],"length":1,"stats":{"Line":0}},{"line":15,"address":[28930683],"length":1,"stats":{"Line":0}},{"line":20,"address":[28927792],"length":1,"stats":{"Line":0}},{"line":21,"address":[28927811],"length":1,"stats":{"Line":0}},{"line":25,"address":[28931312],"length":1,"stats":{"Line":0}},{"line":29,"address":[28931346],"length":1,"stats":{"Line":0}},{"line":30,"address":[28931367],"length":1,"stats":{"Line":0}},{"line":33,"address":[28931456],"length":1,"stats":{"Line":0}},{"line":35,"address":[28931582,28931464],"length":1,"stats":{"Line":0}},{"line":36,"address":[30035840],"length":1,"stats":{"Line":0}},{"line":37,"address":[30035870],"length":1,"stats":{"Line":0}},{"line":38,"address":[30035916,30036008,30036605],"length":1,"stats":{"Line":0}},{"line":40,"address":[30035889],"length":1,"stats":{"Line":0}},{"line":43,"address":[30036257,30035965],"length":1,"stats":{"Line":0}},{"line":44,"address":[30036485,30036327,30036383],"length":1,"stats":{"Line":0}},{"line":45,"address":[30036527],"length":1,"stats":{"Line":0}},{"line":46,"address":[30036529],"length":1,"stats":{"Line":0}},{"line":49,"address":[28931604,28931843],"length":1,"stats":{"Line":0}},{"line":50,"address":[28931781],"length":1,"stats":{"Line":0}},{"line":51,"address":[28931824],"length":1,"stats":{"Line":0}},{"line":55,"address":[28930736],"length":1,"stats":{"Line":0}},{"line":60,"address":[28930766,28930844],"length":1,"stats":{"Line":0}},{"line":61,"address":[30035559,30035533,30035633],"length":1,"stats":{"Line":0}},{"line":62,"address":[30035666],"length":1,"stats":{"Line":0}},{"line":65,"address":[28930869,28931105],"length":1,"stats":{"Line":0}},{"line":66,"address":[28931046],"length":1,"stats":{"Line":0}},{"line":67,"address":[28931089],"length":1,"stats":{"Line":0}},{"line":71,"address":[28929429,28930640,28927872],"length":1,"stats":{"Line":0}},{"line":75,"address":[28927957],"length":1,"stats":{"Line":0}},{"line":76,"address":[28927998,28928069],"length":1,"stats":{"Line":0}},{"line":77,"address":[28928104],"length":1,"stats":{"Line":0}},{"line":79,"address":[28928216],"length":1,"stats":{"Line":0}},{"line":80,"address":[28928230],"length":1,"stats":{"Line":0}},{"line":82,"address":[28928241,28928322,28929424],"length":1,"stats":{"Line":0}},{"line":83,"address":[28928418,28928584],"length":1,"stats":{"Line":0}},{"line":84,"address":[28928614],"length":1,"stats":{"Line":0}},{"line":85,"address":[28928636],"length":1,"stats":{"Line":0}},{"line":86,"address":[28928771,28928703],"length":1,"stats":{"Line":0}},{"line":87,"address":[28928807,28928765],"length":1,"stats":{"Line":0}},{"line":89,"address":[28928781],"length":1,"stats":{"Line":0}},{"line":92,"address":[28928796],"length":1,"stats":{"Line":0}},{"line":93,"address":[28928972,28928887,28930520],"length":1,"stats":{"Line":0}},{"line":94,"address":[28929023,28929439],"length":1,"stats":{"Line":0}},{"line":95,"address":[28929571,28929593],"length":1,"stats":{"Line":0}},{"line":96,"address":[28929585],"length":1,"stats":{"Line":0}},{"line":97,"address":[28929603,28929579],"length":1,"stats":{"Line":0}},{"line":98,"address":[28929605],"length":1,"stats":{"Line":0}},{"line":100,"address":[28929595],"length":1,"stats":{"Line":0}},{"line":103,"address":[28929613],"length":1,"stats":{"Line":0}},{"line":105,"address":[28929658],"length":1,"stats":{"Line":0}},{"line":106,"address":[28929794,28929671,28929860],"length":1,"stats":{"Line":0}},{"line":107,"address":[28929835,28929885],"length":1,"stats":{"Line":0}},{"line":109,"address":[28929708,28929926],"length":1,"stats":{"Line":0}},{"line":110,"address":[28929939,28929747],"length":1,"stats":{"Line":0}},{"line":113,"address":[28929892,28929964],"length":1,"stats":{"Line":0}},{"line":114,"address":[28930060],"length":1,"stats":{"Line":0}},{"line":116,"address":[28930339],"length":1,"stats":{"Line":0}},{"line":117,"address":[28930108],"length":1,"stats":{"Line":0}},{"line":118,"address":[28930140],"length":1,"stats":{"Line":0}},{"line":119,"address":[28930180],"length":1,"stats":{"Line":0}},{"line":120,"address":[28930252],"length":1,"stats":{"Line":0}},{"line":121,"address":[28930262],"length":1,"stats":{"Line":0}},{"line":122,"address":[28930281],"length":1,"stats":{"Line":0}},{"line":126,"address":[30034907,30034864],"length":1,"stats":{"Line":0}},{"line":127,"address":[28929098,28929182],"length":1,"stats":{"Line":0}},{"line":129,"address":[28929310],"length":1,"stats":{"Line":0}},{"line":130,"address":[28929219,28929147],"length":1,"stats":{"Line":0}},{"line":131,"address":[28929270],"length":1,"stats":{"Line":0}},{"line":135,"address":[28928445],"length":1,"stats":{"Line":0}},{"line":139,"address":[30034656],"length":1,"stats":{"Line":0}},{"line":140,"address":[30034716],"length":1,"stats":{"Line":0}},{"line":141,"address":[30034772],"length":1,"stats":{"Line":0}},{"line":143,"address":[30034736],"length":1,"stats":{"Line":0}},{"line":144,"address":[30034760,30034807],"length":1,"stats":{"Line":0}},{"line":148,"address":[30035478,30035484,30034928],"length":1,"stats":{"Line":0}},{"line":150,"address":[30035144,30034969],"length":1,"stats":{"Line":0}},{"line":151,"address":[30035297,30035114,30035166],"length":1,"stats":{"Line":0}},{"line":152,"address":[30035205],"length":1,"stats":{"Line":0}},{"line":153,"address":[30035235],"length":1,"stats":{"Line":0}},{"line":154,"address":[30035323,30035278,30035356],"length":1,"stats":{"Line":0}},{"line":155,"address":[30035335,30035369],"length":1,"stats":{"Line":0}},{"line":159,"address":[28927504],"length":1,"stats":{"Line":0}},{"line":160,"address":[28927534],"length":1,"stats":{"Line":0}},{"line":161,"address":[28927560],"length":1,"stats":{"Line":0}},{"line":162,"address":[28927573],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":85},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","export.rs"],"content":"//! 导出相关命令：将历史记录导出为 CSV/JSON。\n\nuse serde::Serialize;\nuse tauri_plugin_dialog::DialogExt as _;\n\nuse crate::app_data::{DateRange, HistoryDay, HistoryRecord, Phase};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::history::get_history_impl;\nuse super::types::{ExportField, ExportFormat, ExportRequest};\nuse super::validation::validate_date_range;\n\n/// 导出历史记录：弹出保存对话框并写入 CSV/JSON，返回保存的文件路径。\n#[tauri::command]\npub async fn export_history(\n    app: tauri::AppHandle,\n    state: tauri::State\u003c'_, AppState\u003e,\n    request: ExportRequest,\n) -\u003e Result\u003cString, String\u003e {\n    to_ipc_result(export_history_impl(\u0026app, \u0026state, request))\n}\n\n/// 导出历史的内部实现：校验范围、弹出保存对话框、写入文件。\nfn export_history_impl(\n    app: \u0026tauri::AppHandle,\n    state: \u0026AppState,\n    request: ExportRequest,\n) -\u003e AppResult\u003cString\u003e {\n    validate_date_range(\u0026request.range)?;\n\n    let mut fields = request.fields;\n    if fields.is_empty() {\n        fields = vec![\n            ExportField::Date,\n            ExportField::StartTime,\n            ExportField::EndTime,\n            ExportField::Duration,\n            ExportField::Tag,\n            ExportField::Phase,\n        ];\n    }\n\n    let ext = match request.format {\n        ExportFormat::Csv =\u003e \"csv\",\n        ExportFormat::Json =\u003e \"json\",\n    };\n\n    let default_name = format!(\n        \"pomodoro-history-{}-{}.{}\",\n        request.range.from, request.range.to, ext\n    );\n\n    // 后端弹出系统保存对话框（PRD v2）。\n    let Some(path) = app\n        .dialog()\n        .file()\n        .set_file_name(\u0026default_name)\n        .blocking_save_file()\n    else {\n        return Err(AppError::Validation(\"已取消导出\".to_string()));\n    };\n\n    let path = path\n        .into_path()\n        .map_err(|_| AppError::Invariant(\"导出路径解析失败\".to_string()))?;\n\n    let days = get_history_impl(state, \u0026request.range)?;\n    let export_rows = flatten_days_to_rows(\u0026days);\n\n    match request.format {\n        ExportFormat::Csv =\u003e export_csv(\u0026path, \u0026fields, \u0026export_rows)?,\n        ExportFormat::Json =\u003e export_json(\u0026path, \u0026request.range, \u0026export_rows)?,\n    }\n\n    tracing::info!(target: \"storage\", \"导出历史成功：path={}\", path.to_string_lossy());\n    Ok(path.to_string_lossy().to_string())\n}\n\n/// 将按日分组的历史拉平成导出行（每条记录一行）。\nfn flatten_days_to_rows(days: \u0026[HistoryDay]) -\u003e Vec\u003cExportRow\u003e {\n    let mut out = Vec::new();\n    for day in days {\n        for r in \u0026day.records {\n            out.push(ExportRow {\n                date: day.date.clone(),\n                record: r.clone(),\n            });\n        }\n    }\n    out\n}\n\n/// 单条导出行：`date + record`。\n#[derive(Debug, Clone)]\nstruct ExportRow {\n    date: String,\n    record: HistoryRecord,\n}\n\n/// 将 `startTime + duration` 推导出 `endTime`（用于旧数据缺失 `end_time` 的兼容）。\nfn derive_end_time_hhmm(start_time: \u0026str, duration_minutes: u32) -\u003e Option\u003cString\u003e {\n    let parts: Vec\u003c\u0026str\u003e = start_time.split(':').collect();\n    if parts.len() != 2 {\n        return None;\n    }\n    let h: i32 = parts[0].parse().ok()?;\n    let m: i32 = parts[1].parse().ok()?;\n    if !(0..=23).contains(\u0026h) || !(0..=59).contains(\u0026m) {\n        return None;\n    }\n    let total = h * 60 + m + duration_minutes as i32;\n    let hh = ((total / 60) % 24 + 24) % 24;\n    let mm = ((total % 60) + 60) % 60;\n    Some(format!(\"{:02}:{:02}\", hh, mm))\n}\n\n/// 导出 CSV 文件（字段可配置）。\nfn export_csv(path: \u0026std::path::Path, fields: \u0026[ExportField], rows: \u0026[ExportRow]) -\u003e AppResult\u003c()\u003e {\n    let file = std::fs::File::create(path)\n        .map_err(|e| AppError::Invariant(format!(\"创建导出文件失败：{e}\")))?;\n    let mut wtr = csv::Writer::from_writer(file);\n\n    let header: Vec\u003c\u0026str\u003e = fields\n        .iter()\n        .map(|f| match f {\n            ExportField::Date =\u003e \"date\",\n            ExportField::StartTime =\u003e \"start_time\",\n            ExportField::EndTime =\u003e \"end_time\",\n            ExportField::Duration =\u003e \"duration\",\n            ExportField::Tag =\u003e \"tag\",\n            ExportField::Phase =\u003e \"phase\",\n            ExportField::Remark =\u003e \"remark\",\n        })\n        .collect();\n    wtr.write_record(\u0026header)\n        .map_err(|e| AppError::Invariant(format!(\"写入 CSV 头失败：{e}\")))?;\n\n    for row in rows {\n        let mut record: Vec\u003cString\u003e = Vec::new();\n        for f in fields {\n            let v = match f {\n                ExportField::Date =\u003e row.date.clone(),\n                ExportField::StartTime =\u003e row.record.start_time.clone(),\n                ExportField::EndTime =\u003e row\n                    .record\n                    .end_time\n                    .clone()\n                    .or_else(|| derive_end_time_hhmm(\u0026row.record.start_time, row.record.duration))\n                    .unwrap_or_default(),\n                ExportField::Duration =\u003e row.record.duration.to_string(),\n                ExportField::Tag =\u003e row.record.tag.clone(),\n                ExportField::Phase =\u003e match row.record.phase {\n                    Phase::Work =\u003e \"work\".to_string(),\n                    Phase::ShortBreak =\u003e \"shortBreak\".to_string(),\n                    Phase::LongBreak =\u003e \"longBreak\".to_string(),\n                },\n                ExportField::Remark =\u003e row.record.remark.clone(),\n            };\n            record.push(v);\n        }\n        wtr.write_record(\u0026record)\n            .map_err(|e| AppError::Invariant(format!(\"写入 CSV 行失败：{e}\")))?;\n    }\n    wtr.flush()\n        .map_err(|e| AppError::Invariant(format!(\"写入 CSV 失败：{e}\")))?;\n    Ok(())\n}\n\n/// JSON 导出文件顶层结构。\n#[derive(Debug, Clone, Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct JsonExport {\n    export_date: String,\n    range: DateRange,\n    records: Vec\u003cJsonExportRecord\u003e,\n}\n\n/// JSON 导出单条记录结构。\n#[derive(Debug, Clone, Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct JsonExportRecord {\n    date: String,\n    start_time: String,\n    end_time: String,\n    duration: u32,\n    tag: String,\n    phase: String,\n    remark: String,\n}\n\n/// 导出 JSON 文件（字段固定为 PRD v2 示例的 superset）。\nfn export_json(path: \u0026std::path::Path, range: \u0026DateRange, rows: \u0026[ExportRow]) -\u003e AppResult\u003c()\u003e {\n    let today = chrono::Local::now().format(\"%Y-%m-%d\").to_string();\n    let mut records: Vec\u003cJsonExportRecord\u003e = Vec::new();\n    for row in rows {\n        let end_time = row\n            .record\n            .end_time\n            .clone()\n            .or_else(|| derive_end_time_hhmm(\u0026row.record.start_time, row.record.duration))\n            .unwrap_or_default();\n        let phase = match row.record.phase {\n            Phase::Work =\u003e \"work\",\n            Phase::ShortBreak =\u003e \"shortBreak\",\n            Phase::LongBreak =\u003e \"longBreak\",\n        }\n        .to_string();\n        records.push(JsonExportRecord {\n            date: row.date.clone(),\n            start_time: row.record.start_time.clone(),\n            end_time,\n            duration: row.record.duration,\n            tag: row.record.tag.clone(),\n            phase,\n            remark: row.record.remark.clone(),\n        });\n    }\n\n    let out = JsonExport {\n        export_date: today,\n        range: range.clone(),\n        records,\n    };\n\n    let json = serde_json::to_string_pretty(\u0026out)?;\n    std::fs::write(path, json).map_err(|e| AppError::Invariant(format!(\"写入 JSON 失败：{e}\")))?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `derive_end_time_hhmm`：应支持合法时间与跨日回绕。\n    #[test]\n    fn derive_end_time_handles_wrap() {\n        assert_eq!(derive_end_time_hhmm(\"09:00\", 25).as_deref(), Some(\"09:25\"));\n        assert_eq!(derive_end_time_hhmm(\"23:50\", 20).as_deref(), Some(\"00:10\"));\n    }\n\n    /// `derive_end_time_hhmm`：非法输入应返回 None。\n    #[test]\n    fn derive_end_time_rejects_invalid_input() {\n        assert_eq!(derive_end_time_hhmm(\"bad\", 25), None);\n        assert_eq!(derive_end_time_hhmm(\"24:00\", 25), None);\n        assert_eq!(derive_end_time_hhmm(\"23:99\", 25), None);\n    }\n\n    /// `flatten_days_to_rows`：应按记录数拉平为导出行。\n    #[test]\n    fn flatten_days_to_rows_flattens() {\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![\n                HistoryRecord {\n                    tag: \"A\".to_string(),\n                    start_time: \"09:00\".to_string(),\n                    end_time: None,\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                },\n                HistoryRecord {\n                    tag: \"B\".to_string(),\n                    start_time: \"10:00\".to_string(),\n                    end_time: None,\n                    duration: 5,\n                    phase: Phase::ShortBreak,\n                    remark: String::new(),\n                },\n            ],\n        }];\n\n        let rows = flatten_days_to_rows(\u0026days);\n        assert_eq!(rows.len(), 2);\n        assert_eq!(rows[0].date, \"2025-01-01\");\n        assert_eq!(rows[0].record.tag, \"A\");\n        assert_eq!(rows[1].record.tag, \"B\");\n    }\n\n    /// `export_csv`：应按字段顺序写入表头与行，并在缺失 end_time 时推导。\n    #[test]\n    fn export_csv_writes_expected_content() {\n        let dir = tempfile::tempdir().unwrap();\n        let path = dir.path().join(\"out.csv\");\n\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"A\".to_string(),\n                start_time: \"09:00\".to_string(),\n                end_time: None,\n                duration: 25,\n                phase: Phase::Work,\n                remark: \"hi\".to_string(),\n            }],\n        }];\n        let rows = flatten_days_to_rows(\u0026days);\n\n        export_csv(\n            \u0026path,\n            \u0026[\n                ExportField::Date,\n                ExportField::StartTime,\n                ExportField::EndTime,\n                ExportField::Duration,\n                ExportField::Tag,\n                ExportField::Phase,\n                ExportField::Remark,\n            ],\n            \u0026rows,\n        )\n        .unwrap();\n\n        let content = std::fs::read_to_string(\u0026path).unwrap();\n        let lines: Vec\u003c\u0026str\u003e = content.lines().collect();\n        assert_eq!(lines[0], \"date,start_time,end_time,duration,tag,phase,remark\");\n        assert_eq!(lines[1], \"2025-01-01,09:00,09:25,25,A,work,hi\");\n    }\n\n    /// `export_json`：应写入可解析 JSON，且包含 range 与 records。\n    #[test]\n    fn export_json_writes_parseable_json() {\n        let dir = tempfile::tempdir().unwrap();\n        let path = dir.path().join(\"out.json\");\n\n        let range = DateRange {\n            from: \"2025-01-01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        };\n        let days = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"A\".to_string(),\n                start_time: \"09:00\".to_string(),\n                end_time: None,\n                duration: 25,\n                phase: Phase::Work,\n                remark: String::new(),\n            }],\n        }];\n        let rows = flatten_days_to_rows(\u0026days);\n\n        export_json(\u0026path, \u0026range, \u0026rows).unwrap();\n        let content = std::fs::read_to_string(\u0026path).unwrap();\n        let v: serde_json::Value = serde_json::from_str(\u0026content).unwrap();\n        assert_eq!(v[\"range\"][\"from\"], \"2025-01-01\");\n        assert_eq!(v[\"range\"][\"to\"], \"2025-01-07\");\n        assert_eq!(v[\"records\"].as_array().unwrap().len(), 1);\n        assert_eq!(v[\"records\"][0][\"date\"], \"2025-01-01\");\n        assert_eq!(v[\"records\"][0][\"endTime\"], \"09:25\");\n    }\n}\n","traces":[{"line":17,"address":[31580384],"length":1,"stats":{"Line":0}},{"line":22,"address":[29772714,29772636],"length":1,"stats":{"Line":0}},{"line":26,"address":[31584812,31584519,31580496],"length":1,"stats":{"Line":0}},{"line":31,"address":[31580570,31584740,31580665],"length":1,"stats":{"Line":0}},{"line":33,"address":[31580805],"length":1,"stats":{"Line":0}},{"line":34,"address":[31580845,31581241,31580906],"length":1,"stats":{"Line":0}},{"line":35,"address":[31581193,31580955],"length":1,"stats":{"Line":0}},{"line":45,"address":[31580920],"length":1,"stats":{"Line":0}},{"line":46,"address":[31581275],"length":1,"stats":{"Line":0}},{"line":47,"address":[31581246],"length":1,"stats":{"Line":0}},{"line":50,"address":[31581310],"length":1,"stats":{"Line":0}},{"line":56,"address":[31581706],"length":1,"stats":{"Line":0}},{"line":59,"address":[31581676],"length":1,"stats":{"Line":0}},{"line":62,"address":[31584627,31581978],"length":1,"stats":{"Line":0}},{"line":65,"address":[31582199,31584576,31582092,31581851],"length":1,"stats":{"Line":0}},{"line":67,"address":[31582069,31582135],"length":1,"stats":{"Line":0}},{"line":69,"address":[31584564,31582379,31582312],"length":1,"stats":{"Line":0}},{"line":70,"address":[31582670,31582583],"length":1,"stats":{"Line":0}},{"line":72,"address":[31582685],"length":1,"stats":{"Line":0}},{"line":73,"address":[31582846,31582743,31583174],"length":1,"stats":{"Line":0}},{"line":74,"address":[31584525,31583228,31582709],"length":1,"stats":{"Line":0}},{"line":77,"address":[31583695,31583444,31583146],"length":1,"stats":{"Line":0}},{"line":78,"address":[31584149,31584070,31583675],"length":1,"stats":{"Line":0}},{"line":82,"address":[31587183,31586512,31587177],"length":1,"stats":{"Line":1}},{"line":83,"address":[31586560],"length":1,"stats":{"Line":1}},{"line":84,"address":[31586575,31586639],"length":1,"stats":{"Line":2}},{"line":85,"address":[31586740,31586815],"length":1,"stats":{"Line":2}},{"line":86,"address":[31587008],"length":1,"stats":{"Line":1}},{"line":87,"address":[31586925],"length":1,"stats":{"Line":1}},{"line":88,"address":[31586957],"length":1,"stats":{"Line":1}},{"line":92,"address":[31586771],"length":1,"stats":{"Line":1}},{"line":103,"address":[31584880,31586499,31586493],"length":1,"stats":{"Line":1}},{"line":104,"address":[31584924],"length":1,"stats":{"Line":1}},{"line":105,"address":[31585066,31584995],"length":1,"stats":{"Line":2}},{"line":106,"address":[31585112],"length":1,"stats":{"Line":1}},{"line":108,"address":[31586488,31585135,31585072],"length":1,"stats":{"Line":2}},{"line":109,"address":[31586483,31585334],"length":1,"stats":{"Line":1}},{"line":110,"address":[31585574,31585634],"length":1,"stats":{"Line":2}},{"line":111,"address":[31585619],"length":1,"stats":{"Line":1}},{"line":113,"address":[31585721,31585674,31585811],"length":1,"stats":{"Line":2}},{"line":114,"address":[31586010,31585809,31585833],"length":1,"stats":{"Line":2}},{"line":115,"address":[31586035,31586230,31586008],"length":1,"stats":{"Line":2}},{"line":116,"address":[31586251,31586187],"length":1,"stats":{"Line":2}},{"line":120,"address":[31577838,31575744,31577877],"length":1,"stats":{"Line":1}},{"line":121,"address":[31575855,31575897,31575980],"length":1,"stats":{"Line":2}},{"line":122,"address":[29771168,29771195],"length":1,"stats":{"Line":1}},{"line":123,"address":[31576034],"length":1,"stats":{"Line":1}},{"line":127,"address":[29770944,29770954],"length":1,"stats":{"Line":3}},{"line":128,"address":[29770985],"length":1,"stats":{"Line":1}},{"line":129,"address":[29771011],"length":1,"stats":{"Line":1}},{"line":130,"address":[29771034],"length":1,"stats":{"Line":1}},{"line":131,"address":[29771057],"length":1,"stats":{"Line":1}},{"line":132,"address":[29771080],"length":1,"stats":{"Line":1}},{"line":133,"address":[29771103],"length":1,"stats":{"Line":1}},{"line":134,"address":[29771126],"length":1,"stats":{"Line":1}},{"line":137,"address":[31576335,31576243,31576442,31577844],"length":1,"stats":{"Line":2}},{"line":138,"address":[31576312,31576378],"length":1,"stats":{"Line":1}},{"line":140,"address":[31576483],"length":1,"stats":{"Line":1}},{"line":141,"address":[31576611],"length":1,"stats":{"Line":1}},{"line":142,"address":[31577002,31576931],"length":1,"stats":{"Line":2}},{"line":143,"address":[31577098],"length":1,"stats":{"Line":1}},{"line":144,"address":[31577371,31577593],"length":1,"stats":{"Line":2}},{"line":145,"address":[31577398,31577657],"length":1,"stats":{"Line":2}},{"line":146,"address":[31577429,31577714],"length":1,"stats":{"Line":2}},{"line":150,"address":[31577680],"length":1,"stats":{"Line":3}},{"line":152,"address":[31577716,31577460],"length":1,"stats":{"Line":2}},{"line":153,"address":[31577718,31577491],"length":1,"stats":{"Line":2}},{"line":154,"address":[31577522],"length":1,"stats":{"Line":1}},{"line":155,"address":[31577813,31577720],"length":1,"stats":{"Line":2}},{"line":156,"address":[31577751,31577818],"length":1,"stats":{"Line":0}},{"line":157,"address":[31577782,31577823],"length":1,"stats":{"Line":0}},{"line":159,"address":[31577828,31577567],"length":1,"stats":{"Line":2}},{"line":161,"address":[31577833,31577595],"length":1,"stats":{"Line":2}},{"line":163,"address":[31577143,31577191,31577298],"length":1,"stats":{"Line":2}},{"line":164,"address":[29771739,29771712],"length":1,"stats":{"Line":1}},{"line":166,"address":[31576891,31576796,31576641,31576689],"length":1,"stats":{"Line":2}},{"line":167,"address":[31576732,31576666],"length":1,"stats":{"Line":1}},{"line":168,"address":[31576826],"length":1,"stats":{"Line":1}},{"line":194,"address":[31579337,31580351,31577920],"length":1,"stats":{"Line":1}},{"line":195,"address":[31578002],"length":1,"stats":{"Line":1}},{"line":196,"address":[31578243],"length":1,"stats":{"Line":1}},{"line":197,"address":[31578333,31578260,31580240],"length":1,"stats":{"Line":3}},{"line":198,"address":[31578434],"length":1,"stats":{"Line":1}},{"line":202,"address":[29772064,29772096],"length":1,"stats":{"Line":3}},{"line":204,"address":[31579431,31579549],"length":1,"stats":{"Line":2}},{"line":205,"address":[31579464],"length":1,"stats":{"Line":1}},{"line":206,"address":[31579493],"length":1,"stats":{"Line":0}},{"line":207,"address":[31579522],"length":1,"stats":{"Line":0}},{"line":210,"address":[31580002],"length":1,"stats":{"Line":1}},{"line":211,"address":[31579638],"length":1,"stats":{"Line":1}},{"line":212,"address":[31579700],"length":1,"stats":{"Line":1}},{"line":213,"address":[31579769],"length":1,"stats":{"Line":1}},{"line":214,"address":[31579809],"length":1,"stats":{"Line":1}},{"line":215,"address":[31579823],"length":1,"stats":{"Line":1}},{"line":216,"address":[31579891],"length":1,"stats":{"Line":1}},{"line":217,"address":[31579931],"length":1,"stats":{"Line":1}},{"line":223,"address":[31578513],"length":1,"stats":{"Line":1}},{"line":227,"address":[31578779,31578732,31579343],"length":1,"stats":{"Line":2}},{"line":228,"address":[29772171,29772144],"length":1,"stats":{"Line":2}},{"line":229,"address":[31579231],"length":1,"stats":{"Line":1}}],"covered":73,"coverable":100},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","history.rs"],"content":"//! 历史相关命令：查询历史、编辑备注等。\n\nuse crate::app_data::{DateRange, HistoryDay, HistoryRecord};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{history_for_ui, history_for_ui_mut, validate_date_range, validate_ymd};\n\n/// 获取指定日期范围内的历史记录（按日分组）。\n#[tauri::command]\npub fn get_history(\n    state: tauri::State\u003c'_, AppState\u003e,\n    range: DateRange,\n) -\u003e Result\u003cVec\u003cHistoryDay\u003e, String\u003e {\n    to_ipc_result(get_history_impl(\u0026*state, \u0026range))\n}\n\n/// 获取历史的内部实现：校验日期范围后按 `YYYY-MM-DD` 字符串过滤（闭区间）。\npub(crate) fn get_history_impl\u003cS: CommandState\u003e(state: \u0026S, range: \u0026DateRange) -\u003e AppResult\u003cVec\u003cHistoryDay\u003e\u003e {\n    validate_date_range(range)?;\n\n    let data = state.data_snapshot();\n    let mut out: Vec\u003cHistoryDay\u003e = history_for_ui(\u0026data)\n        .iter()\n        .filter(|d| d.date \u003e= range.from \u0026\u0026 d.date \u003c= range.to)\n        .cloned()\n        .collect();\n\n    // 让 UI 的“默认本周”更自然：按日期倒序展示。\n    out.sort_by(|a, b| b.date.cmp(\u0026a.date));\n    Ok(out)\n}\n\n/// 设置某条历史记录的备注（用于“完成后填写”与“历史中编辑”）。\n#[tauri::command]\npub fn set_history_remark(\n    state: tauri::State\u003c'_, AppState\u003e,\n    date: String,\n    record_index: usize,\n    remark: String,\n) -\u003e Result\u003cHistoryRecord, String\u003e {\n    to_ipc_result(set_history_remark_impl(\u0026*state, date, record_index, remark))\n}\n\n/// 设置备注的内部实现：按日期 + 索引定位并持久化。\nfn set_history_remark_impl\u003cS: CommandState\u003e(\n    state: \u0026S,\n    date: String,\n    record_index: usize,\n    remark: String,\n) -\u003e AppResult\u003cHistoryRecord\u003e {\n    let date = date.trim().to_string();\n    validate_ymd(\u0026date)?;\n\n    let remark = remark.trim().to_string();\n    state.update_data(|data| {\n        let list = history_for_ui_mut(data);\n        let Some(day) = list.iter_mut().find(|d| d.date == date) else {\n            return Err(AppError::Validation(\"找不到指定日期的历史记录\".to_string()));\n        };\n        if record_index \u003e= day.records.len() {\n            return Err(AppError::Validation(\"历史记录索引超出范围\".to_string()));\n        }\n        day.records[record_index].remark = remark.clone();\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"storage\", \"更新历史备注：date={} index={}\", date, record_index);\n    let data = state.data_snapshot();\n    let day = history_for_ui(\u0026data)\n        .iter()\n        .find(|d| d.date == date)\n        .ok_or_else(|| AppError::Invariant(\"写入后读取历史失败\".to_string()))?;\n    Ok(day.records[record_index].clone())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{AppData, Phase};\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `get_history_impl`：应按闭区间筛选，并按日期倒序返回。\n    #[test]\n    fn get_history_filters_and_sorts_desc() {\n        let data = AppData {\n            history: vec![\n                HistoryDay {\n                    date: \"2025-01-01\".to_string(),\n                    records: Vec::new(),\n                },\n                HistoryDay {\n                    date: \"2025-01-03\".to_string(),\n                    records: Vec::new(),\n                },\n            ],\n            history_dev: vec![\n                HistoryDay {\n                    date: \"2025-01-02\".to_string(),\n                    records: Vec::new(),\n                },\n                HistoryDay {\n                    date: \"2025-01-04\".to_string(),\n                    records: Vec::new(),\n                },\n            ],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n\n        let out = get_history_impl(\n            \u0026state,\n            \u0026DateRange {\n                from: \"2025-01-02\".to_string(),\n                to: \"2025-01-04\".to_string(),\n            },\n        )\n        .unwrap();\n        assert_eq!(out.len(), 2);\n        assert_eq!(out[0].date, \"2025-01-04\");\n        assert_eq!(out[1].date, \"2025-01-02\");\n    }\n\n    /// `set_history_remark_impl`：应更新指定记录的备注并返回更新后的记录。\n    #[test]\n    fn set_history_remark_updates_record() {\n        let data = AppData {\n            history_dev: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![HistoryRecord {\n                    tag: \"学习\".to_string(),\n                    start_time: \"09:00\".to_string(),\n                    end_time: Some(\"09:25\".to_string()),\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                }],\n            }],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n\n        let updated =\n            set_history_remark_impl(\u0026state, \"2025-01-01\".to_string(), 0, \" OK \".to_string())\n                .unwrap();\n        assert_eq!(updated.remark, \"OK\");\n\n        let snapshot = state.data_snapshot();\n        let day = snapshot\n            .history_dev\n            .iter()\n            .find(|d| d.date == \"2025-01-01\")\n            .unwrap();\n        assert_eq!(day.records[0].remark, \"OK\");\n    }\n\n    /// `set_history_remark_impl`：不存在日期或索引越界应返回校验错误。\n    #[test]\n    fn set_history_remark_rejects_missing_day_or_out_of_range() {\n        let state = TestState::new(AppData::default());\n\n        let err = set_history_remark_impl(\u0026state, \"2025-01-01\".to_string(), 0, \"x\".to_string())\n            .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let data = AppData {\n            history_dev: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            ..AppData::default()\n        };\n        let state = TestState::new(data);\n        let err = set_history_remark_impl(\u0026state, \"2025-01-01\".to_string(), 1, \"x\".to_string())\n            .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n}\n","traces":[{"line":13,"address":[29782160,29782032],"length":1,"stats":{"Line":0}},{"line":17,"address":[29782061,29782116],"length":1,"stats":{"Line":0}},{"line":21,"address":[29488279,29488877,29488285,29488304,29488871,29487712],"length":1,"stats":{"Line":1}},{"line":22,"address":[29487763,29488355],"length":1,"stats":{"Line":1}},{"line":24,"address":[29488482,29487890],"length":1,"stats":{"Line":1}},{"line":25,"address":[29487900,29488549,29487957,29488492],"length":1,"stats":{"Line":2}},{"line":27,"address":[29488944,29488024,29488970,29489066,29489040,29488616],"length":1,"stats":{"Line":3}},{"line":32,"address":[29488928,29488896,29488677,29488150,29488085,29488742,29489136,29489168],"length":1,"stats":{"Line":4}},{"line":33,"address":[29488162,29488754],"length":1,"stats":{"Line":1}},{"line":38,"address":[29782476,29782176],"length":1,"stats":{"Line":0}},{"line":44,"address":[29782220,29782329],"length":1,"stats":{"Line":0}},{"line":48,"address":[29491275,29493451,29491339,29493515,29491360,29489184],"length":1,"stats":{"Line":1}},{"line":54,"address":[29489341,29489258,29491517,29491434],"length":1,"stats":{"Line":2}},{"line":55,"address":[29489498,29489407,29491583,29491302,29493478,29491674],"length":1,"stats":{"Line":2}},{"line":57,"address":[29489661,29491837],"length":1,"stats":{"Line":1}},{"line":58,"address":[29492067,29491281,29495118,29491944,29494286,29489891,29492174,29494400,29493536,29494254,29495150,29489768,29489998,29493457],"length":1,"stats":{"Line":5}},{"line":59,"address":[29494443,29493579],"length":1,"stats":{"Line":1}},{"line":60,"address":[29495456,29495521,29495504,29493603,29495473,29494467],"length":1,"stats":{"Line":3}},{"line":61,"address":[29494625,29493761],"length":1,"stats":{"Line":1}},{"line":63,"address":[29493721,29494585],"length":1,"stats":{"Line":1}},{"line":64,"address":[29494791,29493927],"length":1,"stats":{"Line":1}},{"line":66,"address":[29494905,29494267,29494720,29494041,29495131,29493856],"length":1,"stats":{"Line":1}},{"line":67,"address":[29494234,29495098],"length":1,"stats":{"Line":1}},{"line":70,"address":[29492199,29492477,29490023,29490301],"length":1,"stats":{"Line":1}},{"line":71,"address":[29490291,29492467],"length":1,"stats":{"Line":1}},{"line":72,"address":[29492981,29492790,29492847,29490725,29490614,29490671,29490912,29490805,29492901,29493088],"length":1,"stats":{"Line":4}},{"line":74,"address":[29495168,29490757,29495185,29494352,29494369,29492933],"length":1,"stats":{"Line":3}},{"line":75,"address":[29492958,29495230,29495360,29495216,29490848,29493024,29495374,29490782],"length":1,"stats":{"Line":1}},{"line":76,"address":[29490953,29493129],"length":1,"stats":{"Line":1}}],"covered":25,"coverable":29},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","logging.rs"],"content":"//! 日志相关命令：打开日志目录、前端诊断日志桥接等。\n\n#[cfg(not(windows))]\nuse tauri_plugin_opener::OpenerExt as _;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::logging;\n\nuse super::common::to_ipc_result;\n\n/// 打开日志目录（文件管理器）。\n#[tauri::command]\npub fn open_log_dir(app: tauri::AppHandle) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(open_log_dir_impl(\u0026app))\n}\n\n/// 前端日志桥接：将前端诊断信息写入后端文件日志（用于定位 WebView/布局问题）。\n#[tauri::command]\npub fn frontend_log(level: String, message: String) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(frontend_log_impl(\u0026level, \u0026message))\n}\n\n/// 前端日志桥接的内部实现：按 level 写入 tracing。\nfn frontend_log_impl(level: \u0026str, message: \u0026str) -\u003e AppResult\u003cbool\u003e {\n    if !cfg!(debug_assertions) {\n        return Err(AppError::Validation(\n            \"仅开发环境可使用前端诊断日志（frontend_log）\".to_string(),\n        ));\n    }\n\n    let lvl = level.trim().to_lowercase();\n    match lvl.as_str() {\n        \"debug\" =\u003e tracing::debug!(target: \"frontend\", \"{message}\"),\n        \"warn\" | \"warning\" =\u003e tracing::warn!(target: \"frontend\", \"{message}\"),\n        \"error\" =\u003e tracing::error!(target: \"frontend\", \"{message}\"),\n        _ =\u003e tracing::info!(target: \"frontend\", \"{message}\"),\n    }\n    Ok(true)\n}\n\n/// 打开日志目录的内部实现。\nfn open_log_dir_impl(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cbool\u003e {\n    let dir = logging::log_dir(app)?;\n    std::fs::create_dir_all(\u0026dir)\n        .map_err(|e| AppError::Invariant(format!(\"创建日志目录失败：{e}\")))?;\n\n    #[cfg(windows)]\n    {\n        std::process::Command::new(\"explorer\")\n            .arg(\u0026dir)\n            .spawn()\n            .map_err(|e| AppError::Invariant(format!(\"打开日志目录失败：{e}\")))?;\n        return Ok(true);\n    }\n\n    #[cfg(not(windows))]\n    {\n        app.opener()\n            .open_path(dir.to_string_lossy().to_string(), None::\u003c\u0026str\u003e)\n            .map_err(|e| AppError::Invariant(format!(\"打开日志目录失败：{e}\")))?;\n        Ok(true)\n    }\n}\n","traces":[{"line":13,"address":[33187936,33188037],"length":1,"stats":{"Line":0}},{"line":14,"address":[33187960,33188009],"length":1,"stats":{"Line":0}},{"line":19,"address":[33187905,33187648],"length":1,"stats":{"Line":0}},{"line":20,"address":[33187683,33187762],"length":1,"stats":{"Line":0}},{"line":24,"address":[33190669,33188064,33190675],"length":1,"stats":{"Line":0}},{"line":31,"address":[33188157],"length":1,"stats":{"Line":0}},{"line":32,"address":[33188281,33188198],"length":1,"stats":{"Line":0}},{"line":33,"address":[33190201,33188384,33188303],"length":1,"stats":{"Line":0}},{"line":34,"address":[33189726,33188422,33188358],"length":1,"stats":{"Line":0}},{"line":35,"address":[33188597,33188530,33189214],"length":1,"stats":{"Line":0}},{"line":36,"address":[33188635,33188569,33188949],"length":1,"stats":{"Line":0}},{"line":38,"address":[33188908],"length":1,"stats":{"Line":0}},{"line":42,"address":[33191537,33191529,33190688],"length":1,"stats":{"Line":0}},{"line":43,"address":[33190718],"length":1,"stats":{"Line":0}},{"line":44,"address":[33190879,33191081,33191535,33190977],"length":1,"stats":{"Line":0}},{"line":45,"address":[31563760,31563787],"length":1,"stats":{"Line":0}},{"line":58,"address":[33191416,33191312,33191111],"length":1,"stats":{"Line":0}},{"line":59,"address":[33191266,33191128],"length":1,"stats":{"Line":0}},{"line":60,"address":[31564032,31564054],"length":1,"stats":{"Line":0}},{"line":61,"address":[33191462],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","processes.rs"],"content":"//! 进程相关命令：列举进程、提权重启等。\n\nuse crate::errors::{AppError, AppResult};\nuse crate::processes::{self, ProcessInfo};\n\nuse super::common::to_ipc_result;\n\n/// 获取当前运行的进程列表（进程名 + 图标）。\n#[tauri::command]\npub fn list_processes() -\u003e Result\u003cVec\u003cProcessInfo\u003e, String\u003e {\n    to_ipc_result(processes::list_processes())\n}\n\n/// Windows：以管理员身份重启（用于终止需要提权的进程）。\n#[tauri::command]\npub fn restart_as_admin() -\u003e Result\u003c(), String\u003e {\n    to_ipc_result(restart_as_admin_impl())\n}\n\n/// 提权重启的内部实现（便于统一错误处理）。\nfn restart_as_admin_impl() -\u003e AppResult\u003c()\u003e {\n    #[cfg(windows)]\n    {\n        restart_as_admin_windows()\n    }\n    #[cfg(not(windows))]\n    {\n        Err(AppError::UnsupportedPlatform(\n            \"仅 Windows 支持“以管理员身份重启”\".to_string(),\n        ))\n    }\n}\n\n/// Windows：通过 `ShellExecuteW` 使用 `runas` 重新启动自身并退出。\n#[cfg(windows)]\nfn restart_as_admin_windows() -\u003e AppResult\u003c()\u003e {\n    use windows::core::PCWSTR;\n    use windows::Win32::Foundation::HWND;\n    use windows::Win32::UI::Shell::ShellExecuteW;\n    use windows::Win32::UI::WindowsAndMessaging::SW_SHOWNORMAL;\n\n    let exe = std::env::current_exe()\n        .map_err(|e| AppError::Invariant(format!(\"获取当前可执行文件失败：{e}\")))?;\n    let args = std::env::args().skip(1).collect::\u003cVec\u003c_\u003e\u003e().join(\" \");\n\n    let exe_w = to_wide_null(exe.to_string_lossy().as_ref());\n    let verb_w = to_wide_null(\"runas\");\n    let args_w = to_wide_null(\u0026args);\n\n    unsafe {\n        let result = ShellExecuteW(\n            HWND(std::ptr::null_mut()),\n            PCWSTR(verb_w.as_ptr()),\n            PCWSTR(exe_w.as_ptr()),\n            if args.is_empty() {\n                PCWSTR::null()\n            } else {\n                PCWSTR(args_w.as_ptr())\n            },\n            PCWSTR::null(),\n            SW_SHOWNORMAL,\n        );\n\n        let code = result.0 as isize;\n        if code \u003c= 32 {\n            return Err(AppError::Invariant(format!(\n                \"提权重启失败（ShellExecute 返回 {code:?}）\",\n            )));\n        }\n    }\n\n    std::process::exit(0);\n}\n\n/// Windows：将 `\u0026str` 转为以 `\\\\0` 结尾的 UTF-16。\n#[cfg(windows)]\nfn to_wide_null(s: \u0026str) -\u003e Vec\u003cu16\u003e {\n    use std::os::windows::ffi::OsStrExt;\n    std::ffi::OsStr::new(s)\n        .encode_wide()\n        .chain(Some(0))\n        .collect()\n}\n","traces":[{"line":10,"address":[33194496],"length":1,"stats":{"Line":0}},{"line":11,"address":[33194509],"length":1,"stats":{"Line":0}},{"line":16,"address":[33194544],"length":1,"stats":{"Line":0}},{"line":17,"address":[33194557],"length":1,"stats":{"Line":0}},{"line":21,"address":[33194592],"length":1,"stats":{"Line":0}},{"line":28,"address":[33194634],"length":1,"stats":{"Line":0}},{"line":29,"address":[33194606],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","settings.rs"],"content":"//! 设置相关命令：更新 settings、设置目标等。\n\nuse crate::app_data::{Phase, Settings};\nuse crate::errors::AppResult;\nuse crate::state::AppState;\nuse crate::timer;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::types::AppSnapshot;\n\n/// 更新设置（带范围校验），并在必要时重置当前阶段的剩余时间。\n#[tauri::command]\npub fn update_settings(\n    state: tauri::State\u003c'_, AppState\u003e,\n    settings: Settings,\n) -\u003e Result\u003cAppSnapshot, String\u003e {\n    to_ipc_result((|| -\u003e AppResult\u003cAppSnapshot\u003e {\n        let out = update_settings_impl(\u0026*state, settings)?;\n        let _ = crate::tray::refresh_tray(\u0026*state);\n        Ok(out)\n    })())\n}\n\n/// 更新设置的内部实现（便于统一错误处理与托盘复用）。\nfn update_settings_impl\u003cS: CommandState\u003e(state: \u0026S, settings: Settings) -\u003e AppResult\u003cAppSnapshot\u003e {\n    timer::validate_settings(\u0026settings)?;\n\n    tracing::info!(\n        target: \"storage\",\n        \"更新设置：pomodoro={} shortBreak={} longBreak={} longBreakInterval={} dailyGoal={} weeklyGoal={} alwaysOnTop={}\",\n        settings.pomodoro,\n        settings.short_break,\n        settings.long_break,\n        settings.long_break_interval,\n        settings.daily_goal,\n        settings.weekly_goal,\n        settings.always_on_top\n    );\n\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            data.settings = settings.clone();\n\n            // 若当前未运行，则根据阶段同步剩余时间，以保证 UI 与设置一致。\n            if !timer_runtime.is_running {\n                match timer_runtime.phase {\n                    Phase::Work =\u003e {\n                        timer_runtime.remaining_seconds = settings.pomodoro as u64 * 60;\n                    }\n                    Phase::ShortBreak =\u003e {\n                        timer_runtime.remaining_seconds = settings.short_break as u64 * 60;\n                    }\n                    Phase::LongBreak =\u003e {\n                        timer_runtime.remaining_seconds = settings.long_break as u64 * 60;\n                    }\n                }\n            }\n            Ok(())\n        },\n        true,\n    )?;\n\n    let _ = state.emit_timer_snapshot();\n\n    Ok(AppSnapshot {\n        data: state.data_snapshot(),\n        timer: state.timer_snapshot(),\n    })\n}\n\n/// 设置每日/每周目标（0 表示不设目标），并持久化到 settings。\n#[tauri::command]\npub fn set_goals(\n    state: tauri::State\u003c'_, AppState\u003e,\n    daily: u32,\n    weekly: u32,\n) -\u003e Result\u003cSettings, String\u003e {\n    to_ipc_result(set_goals_impl(\u0026*state, daily, weekly))\n}\n\n/// 设置目标的内部实现（便于统一错误处理）。\nfn set_goals_impl\u003cS: CommandState\u003e(state: \u0026S, daily: u32, weekly: u32) -\u003e AppResult\u003cSettings\u003e {\n    let mut next = state.data_snapshot().settings;\n    next.daily_goal = daily;\n    next.weekly_goal = weekly;\n    timer::validate_settings(\u0026next)?;\n\n    state.update_data(|data| {\n        data.settings.daily_goal = daily;\n        data.settings.weekly_goal = weekly;\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"timer\", \"设置目标：dailyGoal={} weeklyGoal={}\", daily, weekly);\n    let _ = state.emit_timer_snapshot();\n\n    Ok(state.data_snapshot().settings)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `update_settings_impl`：应校验设置参数，并在未运行时同步当前阶段剩余时间。\n    #[test]\n    fn update_settings_updates_data_and_remaining_when_not_running() {\n        let state = TestState::new(AppData::default());\n\n        // 默认 phase=Work 且未运行，更新 pomodoro 后应同步 remaining_seconds。\n        let mut next = state.data_snapshot().settings;\n        next.pomodoro = 10;\n        let snapshot = update_settings_impl(\u0026state, next.clone()).unwrap();\n        assert_eq!(snapshot.data.settings.pomodoro, 10);\n        assert_eq!(snapshot.timer.remaining_seconds, 10 * 60);\n\n        // 切到短休息阶段且未运行，更新 short_break 后应同步 remaining_seconds。\n        state\n            .update_timer(|t, _d| {\n                t.phase = Phase::ShortBreak;\n                t.is_running = false;\n                Ok(())\n            })\n            .unwrap();\n        let mut next2 = state.data_snapshot().settings;\n        next2.short_break = 7;\n        let snapshot2 = update_settings_impl(\u0026state, next2.clone()).unwrap();\n        assert_eq!(snapshot2.timer.phase, Phase::ShortBreak);\n        assert_eq!(snapshot2.timer.remaining_seconds, 7 * 60);\n    }\n\n    /// `update_settings_impl`：运行中不应强制改写 remaining_seconds（避免打断当前倒计时）。\n    #[test]\n    fn update_settings_does_not_override_remaining_when_running() {\n        let state = TestState::new(AppData::default());\n        state\n            .update_timer(|t, _d| {\n                t.phase = Phase::Work;\n                t.is_running = true;\n                t.remaining_seconds = 3;\n                Ok(())\n            })\n            .unwrap();\n\n        let mut next = state.data_snapshot().settings;\n        next.pomodoro = 50;\n        let snapshot = update_settings_impl(\u0026state, next).unwrap();\n        assert_eq!(snapshot.timer.remaining_seconds, 3);\n    }\n\n    /// `update_settings_impl`：非法设置应返回校验错误。\n    #[test]\n    fn update_settings_rejects_invalid_settings() {\n        let state = TestState::new(AppData::default());\n        let mut next = state.data_snapshot().settings;\n        next.pomodoro = 0;\n        let err = update_settings_impl(\u0026state, next).unwrap_err();\n        assert!(matches!(err, crate::errors::AppError::Validation(_)));\n    }\n\n    /// `set_goals_impl`：应写入 daily/weekly 目标并返回最新 settings。\n    #[test]\n    fn set_goals_updates_settings() {\n        let state = TestState::new(AppData::default());\n        let out = set_goals_impl(\u0026state, 3, 7).unwrap();\n        assert_eq!(out.daily_goal, 3);\n        assert_eq!(out.weekly_goal, 7);\n        assert_eq!(state.data_snapshot().settings.daily_goal, 3);\n        assert_eq!(state.data_snapshot().settings.weekly_goal, 7);\n    }\n}\n","traces":[{"line":14,"address":[30814624],"length":1,"stats":{"Line":0}},{"line":18,"address":[30917264,30917702],"length":1,"stats":{"Line":0}},{"line":19,"address":[30917286],"length":1,"stats":{"Line":0}},{"line":20,"address":[30917559,30917621],"length":1,"stats":{"Line":0}},{"line":21,"address":[30917643],"length":1,"stats":{"Line":0}},{"line":26,"address":[30920454,30919078,30917728,30919104],"length":1,"stats":{"Line":1}},{"line":27,"address":[30917771,30919147],"length":1,"stats":{"Line":1}},{"line":29,"address":[30919250,30919512,30918136,30917874],"length":1,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[30918852,30918060,30920228,30919436],"length":1,"stats":{"Line":1}},{"line":42,"address":[30920944,30920480],"length":1,"stats":{"Line":1}},{"line":43,"address":[30920530,30920994],"length":1,"stats":{"Line":1}},{"line":46,"address":[30920598,30921062],"length":1,"stats":{"Line":1}},{"line":47,"address":[30921129,30921073,30920609,30920665],"length":1,"stats":{"Line":1}},{"line":48,"address":[30921228,30920764],"length":1,"stats":{"Line":1}},{"line":49,"address":[30921224,30920760,30921230,30920672,30920766,30921136],"length":1,"stats":{"Line":2}},{"line":51,"address":[30921257,30920793],"length":1,"stats":{"Line":1}},{"line":52,"address":[30921253,30921163,30920789,30920699,30921262,30920798],"length":1,"stats":{"Line":2}},{"line":54,"address":[30920825,30921289],"length":1,"stats":{"Line":0}},{"line":55,"address":[30920727,30921191,30920821,30920830,30921285,30921294],"length":1,"stats":{"Line":0}},{"line":59,"address":[30920650,30921114],"length":1,"stats":{"Line":1}},{"line":64,"address":[30918894,30920270],"length":1,"stats":{"Line":1}},{"line":66,"address":[30918983,30920359],"length":1,"stats":{"Line":1}},{"line":67,"address":[30918921,30920297],"length":1,"stats":{"Line":1}},{"line":68,"address":[30918939,30920315],"length":1,"stats":{"Line":1}},{"line":74,"address":[30814752],"length":1,"stats":{"Line":0}},{"line":79,"address":[30814787],"length":1,"stats":{"Line":0}},{"line":83,"address":[30915968,30914864],"length":1,"stats":{"Line":1}},{"line":84,"address":[30914902,30916006],"length":1,"stats":{"Line":1}},{"line":85,"address":[30916078,30914974],"length":1,"stats":{"Line":1}},{"line":86,"address":[30916086,30914982],"length":1,"stats":{"Line":1}},{"line":87,"address":[30914990,30916094],"length":1,"stats":{"Line":1}},{"line":89,"address":[30917120,30917216,30916222,30916325,30915118,30915221],"length":1,"stats":{"Line":2}},{"line":90,"address":[30917138,30917234],"length":1,"stats":{"Line":1}},{"line":91,"address":[30917242,30917146],"length":1,"stats":{"Line":1}},{"line":92,"address":[30917250,30917154],"length":1,"stats":{"Line":1}},{"line":95,"address":[30916350,30915246,30915613,30916717],"length":1,"stats":{"Line":1}},{"line":96,"address":[30915427,30916531],"length":1,"stats":{"Line":1}},{"line":98,"address":[30916562,30915458],"length":1,"stats":{"Line":1}}],"covered":29,"coverable":47},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","state_like.rs"],"content":"//! 命令层可测试状态抽象：用 trait 解耦 `AppState`，便于单元测试 commands/\\*.rs。\n\nuse crate::app_data::AppData;\nuse crate::errors::AppResult;\nuse crate::processes::KillSummary;\nuse crate::state::AppState;\nuse crate::timer::{TimerRuntime, TimerSnapshot};\n\n#[cfg(test)]\nuse std::sync::{atomic::AtomicUsize, atomic::Ordering, Mutex};\n\n/// 命令层依赖的最小状态接口（用于将 `commands/*` 的业务逻辑与 Tauri 运行时解耦）。\npub(crate) trait CommandState {\n    /// 获取一份 `AppData` 快照（只读）。\n    fn data_snapshot(\u0026self) -\u003e AppData;\n\n    /// 获取计时器快照（只读，包含统计/目标进度等派生字段）。\n    fn timer_snapshot(\u0026self) -\u003e TimerSnapshot;\n\n    /// 原子更新：修改数据并持久化（测试实现可忽略持久化）。\n    fn update_data(\u0026self, f: impl FnOnce(\u0026mut AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e;\n\n    /// 修改计时器运行态（测试实现可直接更新内存）。\n    fn update_timer(\u0026self, f: impl FnOnce(\u0026mut TimerRuntime, \u0026AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e;\n\n    /// 同时修改 `AppData` 与 `TimerRuntime`（并可控制是否持久化）。\n    fn update_data_and_timer\u003cT\u003e(\n        \u0026self,\n        f: impl FnOnce(\u0026mut AppData, \u0026mut TimerRuntime) -\u003e AppResult\u003cT\u003e,\n        persist: bool,\n    ) -\u003e AppResult\u003cT\u003e;\n\n    /// 推送当前计时器快照事件给前端（测试实现可记录调用）。\n    fn emit_timer_snapshot(\u0026self) -\u003e AppResult\u003c()\u003e;\n\n    /// 推送进程终止结果事件给前端（测试实现可记录 payload）。\n    fn emit_kill_result(\u0026self, payload: KillSummary) -\u003e AppResult\u003c()\u003e;\n\n    /// 推送一个“无结构负载”的简单事件给前端（测试实现可记录 event）。\n    fn emit_simple_event(\u0026self, event: \u0026str) -\u003e AppResult\u003c()\u003e;\n}\n\nimpl CommandState for AppState {\n    /// 读取一份 `AppData` 的快照（用于命令层返回）。\n    fn data_snapshot(\u0026self) -\u003e AppData {\n        AppState::data_snapshot(self)\n    }\n\n    /// 获取计时器运行态快照（用于命令层返回）。\n    fn timer_snapshot(\u0026self) -\u003e TimerSnapshot {\n        AppState::timer_snapshot(self)\n    }\n\n    /// 原子更新：修改数据并持久化到 store。\n    fn update_data(\u0026self, f: impl FnOnce(\u0026mut AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e {\n        AppState::update_data(self, f)\n    }\n\n    /// 修改计时器运行态（不会持久化）。\n    fn update_timer(\u0026self, f: impl FnOnce(\u0026mut TimerRuntime, \u0026AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e {\n        AppState::update_timer(self, f)\n    }\n\n    /// 同时修改 `AppData` 与 `TimerRuntime`（需要时可持久化）。\n    fn update_data_and_timer\u003cT\u003e(\n        \u0026self,\n        f: impl FnOnce(\u0026mut AppData, \u0026mut TimerRuntime) -\u003e AppResult\u003cT\u003e,\n        persist: bool,\n    ) -\u003e AppResult\u003cT\u003e {\n        AppState::update_data_and_timer(self, f, persist)\n    }\n\n    /// 向前端广播计时器快照事件。\n    fn emit_timer_snapshot(\u0026self) -\u003e AppResult\u003c()\u003e {\n        AppState::emit_timer_snapshot(self)\n    }\n\n    /// 向前端广播进程终止结果事件。\n    fn emit_kill_result(\u0026self, payload: KillSummary) -\u003e AppResult\u003c()\u003e {\n        AppState::emit_kill_result(self, payload)\n    }\n\n    /// 向前端广播简单事件（用于提示刷新）。\n    fn emit_simple_event(\u0026self, event: \u0026str) -\u003e AppResult\u003c()\u003e {\n        AppState::emit_simple_event(self, event)\n    }\n}\n\n/// 测试用状态：以内存模拟 `AppState`（不依赖 Tauri runtime / store / AppHandle）。\n#[cfg(test)]\npub(crate) struct TestState {\n    /// 内存中的持久化数据。\n    data: Mutex\u003cAppData\u003e,\n    /// 内存中的计时器运行态。\n    timer: Mutex\u003cTimerRuntime\u003e,\n    /// “计时器快照事件”触发次数。\n    emitted_timer_snapshots: AtomicUsize,\n    /// 记录所有 kill 结果 payload。\n    emitted_kill_results: Mutex\u003cVec\u003cKillSummary\u003e\u003e,\n    /// 记录所有简单事件名。\n    emitted_events: Mutex\u003cVec\u003cString\u003e\u003e,\n}\n\n#[cfg(test)]\nimpl TestState {\n    /// 创建一个测试状态（计时器用 `SystemClock` 初始化即可满足命令层测试）。\n    pub(crate) fn new(data: AppData) -\u003e Self {\n        let clock = crate::timer::SystemClock;\n        let timer = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        Self {\n            data: Mutex::new(data),\n            timer: Mutex::new(timer),\n            emitted_timer_snapshots: AtomicUsize::new(0),\n            emitted_kill_results: Mutex::new(Vec::new()),\n            emitted_events: Mutex::new(Vec::new()),\n        }\n    }\n\n    /// 读取已记录的“计时器快照事件”触发次数。\n    pub(crate) fn emitted_timer_snapshot_count(\u0026self) -\u003e usize {\n        self.emitted_timer_snapshots.load(Ordering::Relaxed)\n    }\n\n    /// 取出已记录的 kill 结果（按调用顺序）。\n    pub(crate) fn take_kill_results(\u0026self) -\u003e Vec\u003cKillSummary\u003e {\n        std::mem::take(\u0026mut *self.emitted_kill_results.lock().unwrap())\n    }\n\n    /// 取出已记录的简单事件名（按调用顺序）。\n    pub(crate) fn take_events(\u0026self) -\u003e Vec\u003cString\u003e {\n        std::mem::take(\u0026mut *self.emitted_events.lock().unwrap())\n    }\n}\n\n#[cfg(test)]\nimpl CommandState for TestState {\n    /// 读取一份 `AppData` 的快照（用于断言）。\n    fn data_snapshot(\u0026self) -\u003e AppData {\n        self.data.lock().unwrap().clone()\n    }\n\n    /// 获取计时器快照（用于断言）。\n    fn timer_snapshot(\u0026self) -\u003e TimerSnapshot {\n        let data = self.data.lock().unwrap();\n        let timer = self.timer.lock().unwrap();\n        timer.snapshot(\u0026data)\n    }\n\n    /// 原子更新：修改数据（测试实现不做持久化）。\n    fn update_data(\u0026self, f: impl FnOnce(\u0026mut AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e {\n        let mut data = self.data.lock().unwrap();\n        f(\u0026mut data)\n    }\n\n    /// 修改计时器运行态（测试实现直接更新内存）。\n    fn update_timer(\u0026self, f: impl FnOnce(\u0026mut TimerRuntime, \u0026AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e {\n        let data = self.data.lock().unwrap();\n        let mut timer = self.timer.lock().unwrap();\n        f(\u0026mut timer, \u0026data)\n    }\n\n    /// 同时修改 `AppData` 与 `TimerRuntime`（测试实现忽略 persist 参数）。\n    fn update_data_and_timer\u003cT\u003e(\n        \u0026self,\n        f: impl FnOnce(\u0026mut AppData, \u0026mut TimerRuntime) -\u003e AppResult\u003cT\u003e,\n        _persist: bool,\n    ) -\u003e AppResult\u003cT\u003e {\n        let mut data = self.data.lock().unwrap();\n        let mut timer = self.timer.lock().unwrap();\n        f(\u0026mut data, \u0026mut timer)\n    }\n\n    /// 记录一次“计时器快照事件”触发。\n    fn emit_timer_snapshot(\u0026self) -\u003e AppResult\u003c()\u003e {\n        self.emitted_timer_snapshots.fetch_add(1, Ordering::Relaxed);\n        Ok(())\n    }\n\n    /// 记录一次 kill 结果事件（保存 payload）。\n    fn emit_kill_result(\u0026self, payload: KillSummary) -\u003e AppResult\u003c()\u003e {\n        self.emitted_kill_results.lock().unwrap().push(payload);\n        Ok(())\n    }\n\n    /// 记录一个简单事件名（用于断言触发顺序）。\n    fn emit_simple_event(\u0026self, event: \u0026str) -\u003e AppResult\u003c()\u003e {\n        self.emitted_events.lock().unwrap().push(event.to_string());\n        Ok(())\n    }\n}\n","traces":[{"line":45,"address":[27761280],"length":1,"stats":{"Line":0}},{"line":46,"address":[27761297],"length":1,"stats":{"Line":0}},{"line":50,"address":[27761312],"length":1,"stats":{"Line":0}},{"line":51,"address":[27761329],"length":1,"stats":{"Line":0}},{"line":55,"address":[30015616,30015712,30015760,30015584,30015552,30015664],"length":1,"stats":{"Line":0}},{"line":56,"address":[30015643,30015569,30015787,30015733,30015685,30015601],"length":1,"stats":{"Line":0}},{"line":60,"address":[30015808],"length":1,"stats":{"Line":0}},{"line":61,"address":[30015824],"length":1,"stats":{"Line":0}},{"line":65,"address":[30015840,30015888,30016128,30015952,30016064,30016000],"length":1,"stats":{"Line":0}},{"line":70,"address":[30015867,30015979,30016033,30016105,30015929,30016161],"length":1,"stats":{"Line":0}},{"line":74,"address":[27761424],"length":1,"stats":{"Line":0}},{"line":75,"address":[27761441],"length":1,"stats":{"Line":0}},{"line":79,"address":[27761344],"length":1,"stats":{"Line":0}},{"line":80,"address":[27761361],"length":1,"stats":{"Line":0}},{"line":84,"address":[27761376],"length":1,"stats":{"Line":0}},{"line":85,"address":[27761403],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","tags.rs"],"content":"//! 标签相关命令：设置当前标签、管理标签列表。\n\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::types::AppSnapshot;\n\n/// 设置当前番茄的任务标签；若为新标签则追加到 tags 并持久化。\n#[tauri::command]\npub fn set_current_tag(\n    state: tauri::State\u003c'_, AppState\u003e,\n    tag: String,\n) -\u003e Result\u003cAppSnapshot, String\u003e {\n    to_ipc_result(set_current_tag_impl(\u0026*state, tag))\n}\n\n/// 设置当前标签的内部实现（便于统一错误处理）。\nfn set_current_tag_impl\u003cS: CommandState\u003e(state: \u0026S, tag: String) -\u003e AppResult\u003cAppSnapshot\u003e {\n    let clock = crate::timer::SystemClock;\n    let tag = tag.trim().to_string();\n    if tag.is_empty() {\n        return Err(AppError::Validation(\"标签不能为空\".to_string()));\n    }\n\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            timer_runtime.set_current_tag(tag.clone(), \u0026clock);\n            if !data.tags.iter().any(|t| t == \u0026tag) {\n                data.tags.push(tag);\n            }\n            Ok(())\n        },\n        true,\n    )?;\n\n    let _ = state.emit_timer_snapshot();\n\n    Ok(AppSnapshot {\n        data: state.data_snapshot(),\n        timer: state.timer_snapshot(),\n    })\n}\n\n/// 新增一个标签到历史标签列表（持久化）。\n#[tauri::command]\npub fn add_tag(state: tauri::State\u003c'_, AppState\u003e, tag: String) -\u003e Result\u003cVec\u003cString\u003e, String\u003e {\n    to_ipc_result(add_tag_impl(\u0026*state, tag))\n}\n\n/// 新增标签的内部实现（便于统一错误处理）。\nfn add_tag_impl\u003cS: CommandState\u003e(state: \u0026S, tag: String) -\u003e AppResult\u003cVec\u003cString\u003e\u003e {\n    let tag = tag.trim().to_string();\n    if tag.is_empty() {\n        return Err(AppError::Validation(\"标签不能为空\".to_string()));\n    }\n\n    state.update_data(|data| {\n        if !data.tags.iter().any(|t| t == \u0026tag) {\n            data.tags.push(tag);\n        }\n        Ok(())\n    })?;\n\n    Ok(state.data_snapshot().tags)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n    use crate::commands::state_like::TestState;\n\n    /// `set_current_tag_impl`：空白标签应被拒绝。\n    #[test]\n    fn set_current_tag_rejects_blank() {\n        let state = TestState::new(AppData::default());\n        let err = set_current_tag_impl(\u0026state, \"   \".to_string()).unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `set_current_tag_impl`：应更新计时器当前标签，并在必要时追加到 tags。\n    #[test]\n    fn set_current_tag_updates_timer_and_tags() {\n        let state = TestState::new(AppData::default());\n        let snapshot = set_current_tag_impl(\u0026state, \"新标签\".to_string()).unwrap();\n        assert_eq!(snapshot.timer.current_tag, \"新标签\");\n        assert!(snapshot.data.tags.iter().any(|t| t == \"新标签\"));\n        assert!(state.emitted_timer_snapshot_count() \u003e= 1);\n    }\n\n    /// `add_tag_impl`：应 trim 并去重追加到 tags。\n    #[test]\n    fn add_tag_trims_and_dedupes() {\n        let state = TestState::new(AppData::default());\n        let tags = add_tag_impl(\u0026state, \"  新标签  \".to_string()).unwrap();\n        assert!(tags.iter().any(|t| t == \"新标签\"));\n\n        let tags2 = add_tag_impl(\u0026state, \"新标签\".to_string()).unwrap();\n        let count = tags2.iter().filter(|t| *t == \"新标签\").count();\n        assert_eq!(count, 1);\n    }\n}\n","traces":[{"line":12,"address":[30029757,30029568,30029786],"length":1,"stats":{"Line":0}},{"line":16,"address":[30029595,30029676],"length":1,"stats":{"Line":0}},{"line":20,"address":[33412640,33413542,33411712,33413365,33412437,33412614],"length":1,"stats":{"Line":1}},{"line":21,"address":[33411755,33412683],"length":1,"stats":{"Line":1}},{"line":22,"address":[33411831,33411763,33412691,33412759],"length":1,"stats":{"Line":2}},{"line":23,"address":[33411943,33411887,33412871,33412815],"length":1,"stats":{"Line":2}},{"line":24,"address":[33413390,33412462,33412029,33412957],"length":1,"stats":{"Line":2}},{"line":27,"address":[33412079,33412183,33413007,33412443,33413111,33412022,33412950,33413371],"length":1,"stats":{"Line":2}},{"line":28,"address":[33413568,33414382,33414000,33414411,33413950,33413979,33412882,33411954],"length":1,"stats":{"Line":2}},{"line":29,"address":[33413616,33413699,33414131,33414048],"length":1,"stats":{"Line":2}},{"line":30,"address":[33414493,33414432,33413727,33414445,33414159,33414480],"length":1,"stats":{"Line":3}},{"line":31,"address":[33413922,33414354,33414276,33413844],"length":1,"stats":{"Line":2}},{"line":33,"address":[33413903,33414335],"length":1,"stats":{"Line":1}},{"line":38,"address":[33412221,33413149],"length":1,"stats":{"Line":1}},{"line":40,"address":[33412323,33413251],"length":1,"stats":{"Line":1}},{"line":41,"address":[33412256,33413184],"length":1,"stats":{"Line":1}},{"line":42,"address":[33413204,33412276],"length":1,"stats":{"Line":1}},{"line":48,"address":[30029994,30029792,30029966],"length":1,"stats":{"Line":0}},{"line":49,"address":[30029818,30029894],"length":1,"stats":{"Line":0}},{"line":53,"address":[33409888,33410926,33408832,33409870,33409724,33410780],"length":1,"stats":{"Line":1}},{"line":54,"address":[33408875,33408951,33409931,33410007],"length":1,"stats":{"Line":2}},{"line":55,"address":[33410119,33409007,33410063,33409063],"length":1,"stats":{"Line":2}},{"line":56,"address":[33410187,33409131,33409749,33410805],"length":1,"stats":{"Line":0}},{"line":59,"address":[33409181,33409074,33409285,33410944,33410130,33411608,33410237,33411579,33410786,33411272,33410341,33411243,33409730,33411280],"length":1,"stats":{"Line":3}},{"line":60,"address":[33411677,33411664,33411323,33411616,33411629,33411406,33411070,33410987],"length":1,"stats":{"Line":4}},{"line":61,"address":[33411551,33411488,33411215,33411152],"length":1,"stats":{"Line":2}},{"line":63,"address":[33411199,33411535],"length":1,"stats":{"Line":1}},{"line":66,"address":[33409323,33410379],"length":1,"stats":{"Line":1}}],"covered":23,"coverable":28},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","templates.rs"],"content":"//! 黑名单模板相关命令：查询/保存/删除/应用模板。\n\nuse crate::app_data::{BlacklistItem, BlacklistTemplate};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\nuse super::validation::{normalize_name, validate_blacklist_items};\n\n/// 获取全部黑名单模板（包含内置与自定义）。\n#[tauri::command]\npub fn get_templates(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cVec\u003cBlacklistTemplate\u003e, String\u003e {\n    to_ipc_result(get_templates_impl(\u0026*state))\n}\n\n/// 获取模板的内部实现。\nfn get_templates_impl\u003cS: CommandState\u003e(state: \u0026S) -\u003e AppResult\u003cVec\u003cBlacklistTemplate\u003e\u003e {\n    Ok(state.data_snapshot().blacklist_templates)\n}\n\n/// 保存模板：新增或更新自定义模板（内置模板不可覆盖）。\n#[tauri::command]\npub fn save_template(\n    state: tauri::State\u003c'_, AppState\u003e,\n    template: BlacklistTemplate,\n) -\u003e Result\u003cBlacklistTemplate, String\u003e {\n    to_ipc_result(save_template_impl(\u0026*state, template))\n}\n\n/// 保存模板的内部实现：校验字段并持久化。\nfn save_template_impl\u003cS: CommandState\u003e(state: \u0026S, mut template: BlacklistTemplate) -\u003e AppResult\u003cBlacklistTemplate\u003e {\n    template.name = template.name.trim().to_string();\n    if template.name.is_empty() {\n        return Err(AppError::Validation(\"模板名称不能为空\".to_string()));\n    }\n    if template.builtin {\n        return Err(AppError::Validation(\"内置模板不可保存覆盖\".to_string()));\n    }\n\n    if template.id.trim().is_empty() {\n        let ts = chrono::Utc::now().timestamp_millis();\n        template.id = format!(\"custom-{ts}\");\n    }\n\n    validate_blacklist_items(\u0026template.processes)?;\n\n    state.update_data(|data| {\n        if let Some(existing) = data\n            .blacklist_templates\n            .iter()\n            .find(|t| t.id == template.id)\n        {\n            if existing.builtin {\n                return Err(AppError::Validation(\"内置模板不可覆盖\".to_string()));\n            }\n        }\n\n        let mut next: Vec\u003cBlacklistTemplate\u003e = Vec::new();\n        let mut replaced = false;\n        for t in \u0026data.blacklist_templates {\n            if t.id == template.id {\n                next.push(template.clone());\n                replaced = true;\n            } else {\n                next.push(t.clone());\n            }\n        }\n        if !replaced {\n            next.push(template.clone());\n        }\n        data.blacklist_templates = next;\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"storage\", \"保存模板：id={} name={}\", template.id, template.name);\n    Ok(template)\n}\n\n/// 删除自定义模板（内置模板不可删除）。\n#[tauri::command]\npub fn delete_template(state: tauri::State\u003c'_, AppState\u003e, id: String) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(delete_template_impl(\u0026*state, id))\n}\n\n/// 删除模板的内部实现。\nfn delete_template_impl\u003cS: CommandState\u003e(state: \u0026S, id: String) -\u003e AppResult\u003cbool\u003e {\n    let id = id.trim().to_string();\n    if id.is_empty() {\n        return Err(AppError::Validation(\"模板 id 不能为空\".to_string()));\n    }\n\n    let mut deleted = false;\n    state.update_data(|data| {\n        let Some(existing) = data.blacklist_templates.iter().find(|t| t.id == id) else {\n            return Ok(());\n        };\n        if existing.builtin {\n            return Err(AppError::Validation(\"内置模板不可删除\".to_string()));\n        }\n\n        data.blacklist_templates = data\n            .blacklist_templates\n            .iter()\n            .filter(|t| t.id != id)\n            .cloned()\n            .collect();\n\n        data.active_template_ids.retain(|x| x != \u0026id);\n        data.active_template_id = data.active_template_ids.first().cloned();\n        deleted = true;\n        Ok(())\n    })?;\n\n    if deleted {\n        tracing::info!(target: \"storage\", \"删除模板：id={}\", id);\n    }\n\n    Ok(deleted)\n}\n\n/// 应用/切换模板：支持同时启用多套模板；返回应用后的黑名单。\n#[tauri::command]\npub fn apply_template(\n    state: tauri::State\u003c'_, AppState\u003e,\n    id: String,\n) -\u003e Result\u003cVec\u003cBlacklistItem\u003e, String\u003e {\n    to_ipc_result(apply_template_impl(\u0026*state, id))\n}\n\n/// 应用模板的内部实现：在专注期锁定时禁止切换模板。\nfn apply_template_impl\u003cS: CommandState\u003e(state: \u0026S, id: String) -\u003e AppResult\u003cVec\u003cBlacklistItem\u003e\u003e {\n    let id = id.trim().to_string();\n    if id.is_empty() {\n        return Err(AppError::Validation(\"模板 id 不能为空\".to_string()));\n    }\n\n    let locked = state.timer_snapshot().blacklist_locked;\n    if locked {\n        return Err(AppError::BlacklistLocked);\n    }\n\n    state.update_data(|data| {\n        let exists = data.blacklist_templates.iter().any(|t| t.id == id);\n        if !exists {\n            return Err(AppError::Validation(\"模板不存在\".to_string()));\n        }\n\n        if data.active_template_ids.iter().any(|x| x == \u0026id) {\n            data.active_template_ids.retain(|x| x != \u0026id);\n        } else {\n            data.active_template_ids.push(id.clone());\n        }\n\n        data.active_template_ids.sort();\n        data.active_template_id = data.active_template_ids.first().cloned();\n        data.blacklist = compute_blacklist_from_active_templates(data);\n        Ok(())\n    })?;\n\n    let out = state.data_snapshot().blacklist;\n    tracing::info!(target: \"blacklist\", \"应用模板后黑名单条目数={}\", out.len());\n    Ok(out)\n}\n\n/// 根据当前启用模板集合计算“有效黑名单”（按进程名去重，忽略大小写）。\nfn compute_blacklist_from_active_templates(data: \u0026crate::app_data::AppData) -\u003e Vec\u003cBlacklistItem\u003e {\n    let active: std::collections::BTreeSet\u003cString\u003e =\n        data.active_template_ids.iter().cloned().collect();\n    let mut out: Vec\u003cBlacklistItem\u003e = Vec::new();\n    let mut seen: std::collections::BTreeSet\u003cString\u003e = std::collections::BTreeSet::new();\n\n    for t in \u0026data.blacklist_templates {\n        if !active.contains(\u0026t.id) {\n            continue;\n        }\n        for p in \u0026t.processes {\n            let key = normalize_name(\u0026p.name);\n            if seen.insert(key) {\n                out.push(p.clone());\n            }\n        }\n    }\n\n    out\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// `get_templates_impl`：应直接返回当前模板列表。\n    #[test]\n    fn get_templates_returns_templates() {\n        let data = AppData::default();\n        let state = TestState::new(data.clone());\n        let out = get_templates_impl(\u0026state).unwrap();\n        assert_eq!(out, data.blacklist_templates);\n    }\n\n    /// `save_template_impl`：应拒绝空名称或 builtin 模板覆盖。\n    #[test]\n    fn save_template_rejects_invalid_template() {\n        let state = TestState::new(AppData::default());\n\n        let err = save_template_impl(\n            \u0026state,\n            BlacklistTemplate {\n                id: \"\".to_string(),\n                name: \"   \".to_string(),\n                builtin: false,\n                processes: Vec::new(),\n            },\n        )\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let err = save_template_impl(\n            \u0026state,\n            BlacklistTemplate {\n                id: \"x\".to_string(),\n                name: \"X\".to_string(),\n                builtin: true,\n                processes: Vec::new(),\n            },\n        )\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `save_template_impl`：id 为空时应自动生成，且应新增/更新自定义模板。\n    #[test]\n    fn save_template_generates_id_and_upserts() {\n        let state = TestState::new(AppData::default());\n        let tpl = BlacklistTemplate {\n            id: \"\".to_string(),\n            name: \" 自定义 \".to_string(),\n            builtin: false,\n            processes: vec![BlacklistItem {\n                name: \"WeChat.exe\".to_string(),\n                display_name: \"微信\".to_string(),\n            }],\n        };\n\n        let saved = save_template_impl(\u0026state, tpl).unwrap();\n        assert!(saved.id.starts_with(\"custom-\"));\n        assert_eq!(saved.name, \"自定义\");\n\n        let templates = state.data_snapshot().blacklist_templates;\n        assert!(templates.iter().any(|t| t.id == saved.id));\n\n        let updated = save_template_impl(\n            \u0026state,\n            BlacklistTemplate {\n                id: saved.id.clone(),\n                name: \"自定义2\".to_string(),\n                builtin: false,\n                processes: vec![BlacklistItem {\n                    name: \"QQ.exe\".to_string(),\n                    display_name: \"QQ\".to_string(),\n                }],\n            },\n        )\n        .unwrap();\n        assert_eq!(updated.id, saved.id);\n        assert_eq!(updated.name, \"自定义2\");\n    }\n\n    /// `delete_template_impl`：应拒绝删除内置模板，并正确删除自定义模板与激活信息。\n    #[test]\n    fn delete_template_enforces_builtin_and_updates_active_ids() {\n        let mut data = AppData::default();\n        data.blacklist_templates.push(BlacklistTemplate {\n            id: \"custom-1\".to_string(),\n            name: \"自定义\".to_string(),\n            builtin: false,\n            processes: vec![BlacklistItem {\n                name: \"a.exe\".to_string(),\n                display_name: \"A\".to_string(),\n            }],\n        });\n        data.active_template_ids = vec![\"custom-1\".to_string(), \"work\".to_string()];\n        data.active_template_id = Some(\"custom-1\".to_string());\n        let state = TestState::new(data);\n\n        let err = delete_template_impl(\u0026state, \"work\".to_string()).unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let deleted = delete_template_impl(\u0026state, \"custom-1\".to_string()).unwrap();\n        assert!(deleted);\n        let snap = state.data_snapshot();\n        assert!(!snap.blacklist_templates.iter().any(|t| t.id == \"custom-1\"));\n        assert!(!snap.active_template_ids.iter().any(|x| x == \"custom-1\"));\n        assert_eq!(snap.active_template_id.as_deref(), snap.active_template_ids.first().map(|s| s.as_str()));\n    }\n\n    /// `apply_template_impl`：锁定时禁止切换；未锁定时应切换 active ids 并按进程名去重。\n    #[test]\n    fn apply_template_toggles_and_dedupes_blacklist() {\n        let mut data = AppData::default();\n        data.blacklist_templates.push(BlacklistTemplate {\n            id: \"custom-1\".to_string(),\n            name: \"自定义\".to_string(),\n            builtin: false,\n            processes: vec![\n                BlacklistItem {\n                    name: \"WeChat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n                BlacklistItem {\n                    name: \"wechat.exe\".to_string(),\n                    display_name: \"微信\".to_string(),\n                },\n            ],\n        });\n        let state = TestState::new(data);\n\n        // 锁定：模拟工作阶段开始。\n        state\n            .update_data_and_timer(\n                |d, t| {\n                    let clock = crate::timer::SystemClock;\n                    t.start(\u0026d.settings, \u0026clock);\n                    Ok(())\n                },\n                false,\n            )\n            .unwrap();\n        assert!(state.timer_snapshot().blacklist_locked);\n\n        let err = apply_template_impl(\u0026state, \"custom-1\".to_string()).unwrap_err();\n        assert!(matches!(err, AppError::BlacklistLocked));\n\n        // 解除锁定（跳到休息阶段即可）。\n        state\n            .update_timer(|t, d| {\n                t.skip(\u0026d.settings, 1);\n                Ok(())\n            })\n            .unwrap();\n        assert!(!state.timer_snapshot().blacklist_locked);\n\n        // 切换启用 custom-1：应生效，并去重 wechat。\n        let out = apply_template_impl(\u0026state, \"custom-1\".to_string()).unwrap();\n        let wechat_count = out.iter().filter(|x| normalize_name(\u0026x.name) == \"wechat.exe\").count();\n        assert_eq!(wechat_count, 1);\n        assert!(state\n            .data_snapshot()\n            .active_template_ids\n            .iter()\n            .any(|x| x == \"custom-1\"));\n    }\n}\n","traces":[{"line":13,"address":[31555120],"length":1,"stats":{"Line":0}},{"line":14,"address":[31555139],"length":1,"stats":{"Line":0}},{"line":18,"address":[31271566,31271168,31270752,31271560,31271150,31271144],"length":1,"stats":{"Line":1}},{"line":19,"address":[31270787,31271203],"length":1,"stats":{"Line":1}},{"line":24,"address":[31555200,31555428,31555453],"length":1,"stats":{"Line":0}},{"line":28,"address":[31555227,31555311],"length":1,"stats":{"Line":0}},{"line":32,"address":[31273744,31271584,31275870,31273710],"length":1,"stats":{"Line":1}},{"line":33,"address":[31273802,31271642,31271725,31273885],"length":1,"stats":{"Line":2}},{"line":34,"address":[31271916,31274076],"length":1,"stats":{"Line":1}},{"line":35,"address":[31271959,31273602,31275762,31274119],"length":1,"stats":{"Line":2}},{"line":37,"address":[31274111,31271951],"length":1,"stats":{"Line":1}},{"line":38,"address":[31275646,31274181,31273486,31272021],"length":1,"stats":{"Line":2}},{"line":41,"address":[31274161,31274631,31274228,31272068,31272471,31272001],"length":1,"stats":{"Line":3}},{"line":42,"address":[31274308,31272148],"length":1,"stats":{"Line":1}},{"line":43,"address":[31274372,31272212],"length":1,"stats":{"Line":1}},{"line":46,"address":[31272494,31274284,31273476,31274654,31275636,31272124],"length":1,"stats":{"Line":2}},{"line":48,"address":[31274833,31276758,31275904,31274963,31276786,31277702,31273459,31277730,31272803,31275619,31272673,31276848],"length":1,"stats":{"Line":2}},{"line":49,"address":[31275955,31276899,31276957,31276013],"length":1,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[31276922,31275978],"length":1,"stats":{"Line":1}},{"line":52,"address":[31277809,31275998,31277792,31276942,31277857,31277840],"length":1,"stats":{"Line":3}},{"line":54,"address":[31276054,31276998],"length":1,"stats":{"Line":1}},{"line":55,"address":[31277062,31276118],"length":1,"stats":{"Line":0}},{"line":59,"address":[31276060,31277004],"length":1,"stats":{"Line":1}},{"line":60,"address":[31276086,31277030],"length":1,"stats":{"Line":1}},{"line":61,"address":[31277223,31276279,31277038,31276094],"length":1,"stats":{"Line":2}},{"line":62,"address":[31276648,31277329,31276385,31277592,31277697,31276753],"length":1,"stats":{"Line":3}},{"line":63,"address":[31276738,31277682,31277631,31276687],"length":1,"stats":{"Line":2}},{"line":64,"address":[31277689,31276745],"length":1,"stats":{"Line":1}},{"line":66,"address":[31277611,31276710,31277654,31276667],"length":1,"stats":{"Line":2}},{"line":69,"address":[31276399,31277343],"length":1,"stats":{"Line":1}},{"line":70,"address":[31276501,31277366,31276422,31277445],"length":1,"stats":{"Line":2}},{"line":72,"address":[31276434,31276515,31277459,31277378],"length":1,"stats":{"Line":1}},{"line":73,"address":[31276624,31277568],"length":1,"stats":{"Line":1}},{"line":76,"address":[31274988,31272828,31275297,31273137],"length":1,"stats":{"Line":1}},{"line":77,"address":[31275248,31273088],"length":1,"stats":{"Line":1}},{"line":82,"address":[31555854,31555680,31555882],"length":1,"stats":{"Line":0}},{"line":83,"address":[31555782,31555706],"length":1,"stats":{"Line":0}},{"line":87,"address":[31284384,31283200,31284350,31285534],"length":1,"stats":{"Line":1}},{"line":88,"address":[31284495,31283243,31283311,31284427],"length":1,"stats":{"Line":2}},{"line":89,"address":[31283424,31283365,31284608,31284549],"length":1,"stats":{"Line":2}},{"line":90,"address":[31284658,31283474,31284254,31285438],"length":1,"stats":{"Line":0}},{"line":93,"address":[31283435,31284619],"length":1,"stats":{"Line":1}},{"line":94,"address":[31284651,31283628,31283524,31284228,31283467,31286368,31285616,31287103,31286351,31284708,31285412,31284812],"length":1,"stats":{"Line":5}},{"line":95,"address":[31287425,31287408,31285680,31286432,31287360,31287377],"length":1,"stats":{"Line":3}},{"line":96,"address":[31285788,31286540],"length":1,"stats":{"Line":0}},{"line":98,"address":[31285771,31286523],"length":1,"stats":{"Line":1}},{"line":99,"address":[31285912,31286664],"length":1,"stats":{"Line":1}},{"line":102,"address":[31286019,31286557,31286654,31286092,31285805,31285902,31286844,31286771],"length":1,"stats":{"Line":3}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[31286577,31285825],"length":1,"stats":{"Line":1}},{"line":105,"address":[31287312,31286603,31287168,31287329,31287185,31285851],"length":1,"stats":{"Line":3}},{"line":106,"address":[31285874,31286626],"length":1,"stats":{"Line":1}},{"line":107,"address":[31286055,31286807,31286644,31285892],"length":1,"stats":{"Line":1}},{"line":109,"address":[31287264,31286868,31287216,31286116,31287229,31287277],"length":1,"stats":{"Line":3}},{"line":110,"address":[31286135,31286951,31286199,31286887],"length":1,"stats":{"Line":1}},{"line":111,"address":[31286328,31287080],"length":1,"stats":{"Line":1}},{"line":112,"address":[31286331,31287083],"length":1,"stats":{"Line":1}},{"line":115,"address":[31283653,31284837],"length":1,"stats":{"Line":1}},{"line":116,"address":[31283707,31284891],"length":1,"stats":{"Line":1}},{"line":119,"address":[31284852,31283668],"length":1,"stats":{"Line":1}},{"line":124,"address":[31555646,31555674,31555472],"length":1,"stats":{"Line":0}},{"line":128,"address":[31555498,31555574],"length":1,"stats":{"Line":0}},{"line":132,"address":[31279598,31281198,31279616,31279470,31281326,31277888],"length":1,"stats":{"Line":1}},{"line":133,"address":[31278005,31279659,31277931,31279733],"length":1,"stats":{"Line":2}},{"line":134,"address":[31278118,31278059,31279846,31279787],"length":1,"stats":{"Line":2}},{"line":135,"address":[31278144,31281230,31279502,31279872],"length":1,"stats":{"Line":0}},{"line":138,"address":[31278178,31278137,31279906,31279865],"length":1,"stats":{"Line":2}},{"line":139,"address":[31279943,31278215],"length":1,"stats":{"Line":1}},{"line":140,"address":[31278254,31279982],"length":1,"stats":{"Line":1}},{"line":143,"address":[31280033,31279970,31278305,31282897,31279476,31278242,31282176,31281392,31282113,31280137,31281204,31278409],"length":1,"stats":{"Line":3}},{"line":144,"address":[31281443,31283056,31283081,31282227,31282912,31282937],"length":1,"stats":{"Line":3}},{"line":145,"address":[31282284,31281500],"length":1,"stats":{"Line":1}},{"line":146,"address":[31281504,31282288],"length":1,"stats":{"Line":0}},{"line":149,"address":[31282960,31282973,31283008,31281605,31283021,31282389],"length":1,"stats":{"Line":3}},{"line":150,"address":[31283152,31283104,31283165,31282528,31281744,31283117],"length":1,"stats":{"Line":0}},{"line":152,"address":[31282474,31281690],"length":1,"stats":{"Line":1}},{"line":155,"address":[31282542,31281758],"length":1,"stats":{"Line":1}},{"line":156,"address":[31281796,31281860,31282644,31282580],"length":1,"stats":{"Line":1}},{"line":157,"address":[31282781,31281997,31282759,31281975],"length":1,"stats":{"Line":1}},{"line":158,"address":[31282885,31282101],"length":1,"stats":{"Line":1}},{"line":161,"address":[31280175,31278447],"length":1,"stats":{"Line":1}},{"line":162,"address":[31280895,31280553,31279167,31278825],"length":1,"stats":{"Line":1}},{"line":163,"address":[31279082,31280810],"length":1,"stats":{"Line":1}},{"line":167,"address":[31555888,31556679,31556655],"length":1,"stats":{"Line":1}},{"line":168,"address":[31555926],"length":1,"stats":{"Line":1}},{"line":170,"address":[31555994],"length":1,"stats":{"Line":1}},{"line":171,"address":[31556038],"length":1,"stats":{"Line":1}},{"line":173,"address":[31556104,31556172],"length":1,"stats":{"Line":2}},{"line":174,"address":[31556278,31556375],"length":1,"stats":{"Line":2}},{"line":177,"address":[31556389],"length":1,"stats":{"Line":1}},{"line":178,"address":[31556525],"length":1,"stats":{"Line":1}},{"line":179,"address":[31556583],"length":1,"stats":{"Line":1}},{"line":180,"address":[31556620],"length":1,"stats":{"Line":1}},{"line":185,"address":[31556294],"length":1,"stats":{"Line":1}}],"covered":79,"coverable":95},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","timer.rs"],"content":"//! 计时器相关命令：开始/暂停/重置/跳过（供前端与托盘复用）。\n\nuse crate::app_data::Phase;\nuse crate::errors::AppResult;\nuse crate::state::AppState;\nuse crate::timer::{compute_today_stats, TimerClock, TimerSnapshot};\n\nuse super::common::to_ipc_result;\nuse super::state_like::CommandState;\n\n/// 开始计时（若处于工作阶段首次开始，则终止黑名单进程）。\n#[tauri::command]\npub fn timer_start(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_start_impl(\u0026state))\n}\n\n/// 托盘复用：开始计时的内部实现（不暴露给前端）。\npub fn timer_start_inner(state: \u0026AppState) -\u003e AppResult\u003c()\u003e {\n    timer_start_transition_with_deps(\n        state,\n        \u0026crate::timer::SystemClock,\n        |names| crate::processes::kill_names_best_effort(names),\n    )?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(())\n}\n\n/// 开始计时的 IPC 入口实现：先执行内部逻辑，再返回快照。\nfn timer_start_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_start_inner(state)?;\n    Ok(state.timer_snapshot())\n}\n\n/// 开始计时的可测试实现：可注入 clock 与 kill 函数（避免测试中触发系统调用）。\nfn timer_start_transition_with_deps\u003cS: CommandState\u003e(\n    state: \u0026S,\n    clock: \u0026dyn TimerClock,\n    kill_names: impl FnOnce(\u0026[String]) -\u003e crate::processes::KillSummary,\n) -\u003e AppResult\u003c()\u003e {\n    let (names_to_kill, should_kill) = state.update_data_and_timer(\n        |data, timer_runtime| {\n            let should_kill = timer_runtime.phase == Phase::Work\n                \u0026\u0026 !timer_runtime.blacklist_locked()\n                \u0026\u0026 !timer_runtime.is_running;\n            let names: Vec\u003cString\u003e = data.blacklist.iter().map(|b| b.name.clone()).collect();\n            timer_runtime.start(\u0026data.settings, clock);\n            Ok((names, should_kill))\n        },\n        false,\n    )?;\n\n    tracing::info!(\n        target: \"timer\",\n        \"开始计时：phase={:?} tag={} remaining={}s\",\n        state.timer_snapshot().phase,\n        state.timer_snapshot().current_tag,\n        state.timer_snapshot().remaining_seconds\n    );\n\n    if should_kill {\n        tracing::info!(target: \"blacklist\", \"工作阶段首次开始，尝试终止黑名单进程：{:?}\", names_to_kill);\n        let payload = kill_names(\u0026names_to_kill);\n        let _ = state.emit_kill_result(payload);\n    }\n\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n/// 暂停计时。\n#[tauri::command]\npub fn timer_pause(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_pause_impl(\u0026state))\n}\n\n/// 托盘复用：暂停计时的内部实现（不暴露给前端）。\npub fn timer_pause_inner(state: \u0026AppState) -\u003e AppResult\u003c()\u003e {\n    timer_pause_transition(state)?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(())\n}\n\n/// 暂停计时的 IPC 入口实现：先执行内部逻辑，再返回快照。\nfn timer_pause_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_pause_inner(state)?;\n    Ok(state.timer_snapshot())\n}\n\n/// 暂停计时的可测试实现：不依赖托盘与系统资源。\nfn timer_pause_transition\u003cS: CommandState\u003e(state: \u0026S) -\u003e AppResult\u003c()\u003e {\n    state.update_timer(|timer_runtime, _data| {\n        timer_runtime.pause();\n        Ok(())\n    })?;\n\n    tracing::info!(\n        target: \"timer\",\n        \"暂停计时：phase={:?} remaining={}s\",\n        state.timer_snapshot().phase,\n        state.timer_snapshot().remaining_seconds\n    );\n\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n/// 重置计时（回到工作阶段初始状态）。\n#[tauri::command]\npub fn timer_reset(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_reset_impl(\u0026state))\n}\n\n/// 重置计时的内部实现（便于统一错误处理）。\nfn timer_reset_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_reset_transition(state)?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(state.timer_snapshot())\n}\n\n/// 重置计时的可测试实现：不依赖托盘与系统资源。\nfn timer_reset_transition\u003cS: CommandState\u003e(state: \u0026S) -\u003e AppResult\u003c()\u003e {\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            timer_runtime.reset(\u0026data.settings);\n            Ok(())\n        },\n        false,\n    )?;\n\n    tracing::info!(target: \"timer\", \"重置计时器：回到工作阶段\");\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n/// 跳过当前阶段（不写入历史）。\n#[tauri::command]\npub fn timer_skip(state: tauri::State\u003c'_, AppState\u003e) -\u003e Result\u003cTimerSnapshot, String\u003e {\n    to_ipc_result(timer_skip_impl(\u0026state))\n}\n\n/// 跳过阶段的内部实现（便于统一错误处理）。\nfn timer_skip_impl(state: \u0026AppState) -\u003e AppResult\u003cTimerSnapshot\u003e {\n    timer_skip_transition_with_clock(state, \u0026crate::timer::SystemClock)?;\n    let _ = crate::tray::refresh_tray(state);\n    Ok(state.timer_snapshot())\n}\n\n/// 跳过阶段的可测试实现：可注入 `clock`，避免依赖真实日期。\nfn timer_skip_transition_with_clock\u003cS: CommandState\u003e(state: \u0026S, clock: \u0026dyn TimerClock) -\u003e AppResult\u003c()\u003e {\n    state.update_data_and_timer(\n        |data, timer_runtime| {\n            let today = clock.today_date();\n            let completed_today = compute_today_stats(data, \u0026today).total;\n            timer_runtime.skip(\u0026data.settings, completed_today);\n            Ok(())\n        },\n        false,\n    )?;\n\n    tracing::info!(target: \"timer\", \"跳过阶段：phase={:?}\", state.timer_snapshot().phase);\n    let _ = state.emit_timer_snapshot();\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::{AppData, BlacklistItem, HistoryDay, HistoryRecord, Phase, Settings};\n    use crate::commands::state_like::CommandState;\n    use crate::commands::state_like::TestState;\n\n    /// 固定时钟：用于让命令层测试稳定可复现。\n    struct FixedClock {\n        today: String,\n        now: String,\n        week_from: String,\n        week_to: String,\n    }\n\n    impl FixedClock {\n        /// 构造一个固定时钟（weekRange 默认覆盖 today）。\n        fn new(today: \u0026str, now: \u0026str) -\u003e Self {\n            Self {\n                today: today.to_string(),\n                now: now.to_string(),\n                week_from: today.to_string(),\n                week_to: today.to_string(),\n            }\n        }\n    }\n\n    impl TimerClock for FixedClock {\n        /// 返回固定日期。\n        fn today_date(\u0026self) -\u003e String {\n            self.today.clone()\n        }\n\n        /// 返回固定时间。\n        fn now_hhmm(\u0026self) -\u003e String {\n            self.now.clone()\n        }\n\n        /// 返回固定周范围。\n        fn current_week_range(\u0026self) -\u003e (String, String) {\n            (self.week_from.clone(), self.week_to.clone())\n        }\n    }\n\n    /// `timer_start_transition_with_deps`：工作阶段首次开始应触发 kill，并广播快照。\n    #[test]\n    fn timer_start_kills_on_first_work_start() {\n        let mut data = AppData::default();\n        data.blacklist = vec![BlacklistItem {\n            name: \"a.exe\".to_string(),\n            display_name: \"A\".to_string(),\n        }];\n        data.settings = Settings {\n            pomodoro: 1,\n            ..data.settings\n        };\n        let state = TestState::new(data);\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n\n        timer_start_transition_with_deps(\u0026state, \u0026clock, |names| crate::processes::KillSummary {\n            items: vec![crate::processes::termination::KillItem {\n                name: names[0].clone(),\n                pids: vec![1],\n                killed: 1,\n                failed: 0,\n                requires_admin: false,\n            }],\n            requires_admin: false,\n        })\n        .unwrap();\n\n        assert!(state.timer_snapshot().is_running);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n        let kills = state.take_kill_results();\n        assert_eq!(kills.len(), 1);\n        assert_eq!(kills[0].items[0].name, \"a.exe\");\n\n        // 再次开始：不应重复 kill。\n        timer_start_transition_with_deps(\u0026state, \u0026clock, |_names| unreachable!(\"不应再触发 kill\")).unwrap();\n        assert_eq!(state.take_kill_results().len(), 0);\n        assert_eq!(state.emitted_timer_snapshot_count(), 2);\n    }\n\n    /// `timer_pause_transition`：暂停应设置 is_running=false 并广播快照。\n    #[test]\n    fn timer_pause_pauses_and_emits() {\n        let state = TestState::new(AppData::default());\n        state\n            .update_timer(|t, _d| {\n                t.is_running = true;\n                Ok(())\n            })\n            .unwrap();\n\n        timer_pause_transition(\u0026state).unwrap();\n        assert!(!state.timer_snapshot().is_running);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n    }\n\n    /// `timer_reset_transition`：应回到工作阶段初始剩余时间并广播快照。\n    #[test]\n    fn timer_reset_resets_and_emits() {\n        let mut data = AppData::default();\n        data.settings.pomodoro = 2;\n        let state = TestState::new(data);\n        state\n            .update_timer(|t, _d| {\n                t.phase = Phase::LongBreak;\n                t.remaining_seconds = 1;\n                t.is_running = true;\n                Ok(())\n            })\n            .unwrap();\n\n        timer_reset_transition(\u0026state).unwrap();\n        let snap = state.timer_snapshot();\n        assert_eq!(snap.phase, Phase::Work);\n        assert_eq!(snap.remaining_seconds, 2 * 60);\n        assert!(!snap.is_running);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n    }\n\n    /// `timer_skip_transition_with_clock`：应按 completed_today 与 long_break_interval 切换阶段并广播快照。\n    #[test]\n    fn timer_skip_switches_phase_and_emits() {\n        let mut data = AppData::default();\n        data.settings.short_break = 1;\n        data.settings.long_break = 2;\n        data.settings.long_break_interval = 2;\n        data.history = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"学习\".to_string(),\n                start_time: \"08:00\".to_string(),\n                end_time: Some(\"08:25\".to_string()),\n                duration: 25,\n                phase: Phase::Work,\n                remark: String::new(),\n            }],\n        }];\n        let state = TestState::new(data);\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n\n        // completed_today=1，跳过工作阶段后 completed_today_after=1，不是 2 的倍数 -\u003e 短休息。\n        timer_skip_transition_with_clock(\u0026state, \u0026clock).unwrap();\n        assert_eq!(state.timer_snapshot().phase, Phase::ShortBreak);\n        assert_eq!(state.emitted_timer_snapshot_count(), 1);\n    }\n}\n","traces":[{"line":13,"address":[30885840],"length":1,"stats":{"Line":0}},{"line":14,"address":[30885862],"length":1,"stats":{"Line":0}},{"line":18,"address":[30886960],"length":1,"stats":{"Line":0}},{"line":22,"address":[33085664,33085686],"length":1,"stats":{"Line":0}},{"line":24,"address":[30887105],"length":1,"stats":{"Line":0}},{"line":25,"address":[30887136],"length":1,"stats":{"Line":0}},{"line":29,"address":[30886576],"length":1,"stats":{"Line":0}},{"line":30,"address":[30886605],"length":1,"stats":{"Line":0}},{"line":31,"address":[30886709],"length":1,"stats":{"Line":0}},{"line":35,"address":[33095276,33093164,33097396,33091088,33097388,33095284,33093200,33095312,33093172],"length":1,"stats":{"Line":2}},{"line":40,"address":[33091242,33093255,33095573,33095367,33095466,33091349,33093461,33093354,33091143],"length":1,"stats":{"Line":4}},{"line":41,"address":[33097813,33097424,33098229,33098693,33098699,33098304,33097840,33098235,33097819],"length":1,"stats":{"Line":2}},{"line":42,"address":[33098380,33097916,33097936,33097500,33098400,33097520],"length":1,"stats":{"Line":3}},{"line":43,"address":[33098412,33097532,33097948],"length":1,"stats":{"Line":2}},{"line":44,"address":[33097546,33098426,33097962],"length":1,"stats":{"Line":1}},{"line":45,"address":[33098441,33099123,33099088,33097977,33099024,33098960,33097561,33098995,33099059],"length":1,"stats":{"Line":6}},{"line":46,"address":[33097620,33098500,33098036],"length":1,"stats":{"Line":2}},{"line":47,"address":[33097685,33098565,33098101],"length":1,"stats":{"Line":2}},{"line":52,"address":[33091932,33094044,33096156],"length":1,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[33093880,33095992,33091768],"length":1,"stats":{"Line":2}},{"line":61,"address":[33094823,33094523,33096635,33092711,33092411,33096935],"length":1,"stats":{"Line":1}},{"line":62,"address":[33097383,33094775,33096887,33097175,33092951,33093159,33095063,33095271,33092663],"length":1,"stats":{"Line":1}},{"line":63,"address":[33095169,33097281,33093057],"length":1,"stats":{"Line":1}},{"line":66,"address":[33094513,33095202,33097314,33096625,33092401,33093090],"length":1,"stats":{"Line":4}},{"line":67,"address":[33093105,33095217,33097329],"length":1,"stats":{"Line":2}},{"line":72,"address":[30885680],"length":1,"stats":{"Line":0}},{"line":73,"address":[30885702],"length":1,"stats":{"Line":0}},{"line":77,"address":[30886768],"length":1,"stats":{"Line":0}},{"line":78,"address":[30886797],"length":1,"stats":{"Line":0}},{"line":79,"address":[30886901],"length":1,"stats":{"Line":0}},{"line":80,"address":[30886932],"length":1,"stats":{"Line":0}},{"line":84,"address":[30886160],"length":1,"stats":{"Line":0}},{"line":85,"address":[30886189],"length":1,"stats":{"Line":0}},{"line":86,"address":[30886293],"length":1,"stats":{"Line":0}},{"line":90,"address":[33087353,33086527,33086544,33086521,33085712,33087359],"length":1,"stats":{"Line":1}},{"line":91,"address":[33086652,33087536,33086574,33085742,33087376,33085820],"length":1,"stats":{"Line":2}},{"line":92,"address":[33087413,33087573],"length":1,"stats":{"Line":1}},{"line":93,"address":[33087588,33087428],"length":1,"stats":{"Line":1}},{"line":96,"address":[33086935,33086103],"length":1,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[33086022,33086854],"length":1,"stats":{"Line":1}},{"line":104,"address":[33086053,33086885],"length":1,"stats":{"Line":1}},{"line":109,"address":[30885760],"length":1,"stats":{"Line":0}},{"line":110,"address":[30885782],"length":1,"stats":{"Line":0}},{"line":114,"address":[30886352],"length":1,"stats":{"Line":0}},{"line":115,"address":[30886382],"length":1,"stats":{"Line":0}},{"line":116,"address":[30886487],"length":1,"stats":{"Line":0}},{"line":117,"address":[30886518],"length":1,"stats":{"Line":0}},{"line":121,"address":[33087600,33088176],"length":1,"stats":{"Line":1}},{"line":122,"address":[33087710,33088286,33088206,33087630],"length":1,"stats":{"Line":1}},{"line":123,"address":[33088800,33088880],"length":1,"stats":{"Line":1}},{"line":124,"address":[33088917,33088837],"length":1,"stats":{"Line":1}},{"line":125,"address":[33088939,33088859],"length":1,"stats":{"Line":1}},{"line":130,"address":[33087955,33088311,33088531,33087735],"length":1,"stats":{"Line":1}},{"line":131,"address":[33087912,33088488],"length":1,"stats":{"Line":1}},{"line":132,"address":[33087943,33088519],"length":1,"stats":{"Line":1}},{"line":137,"address":[30885600],"length":1,"stats":{"Line":0}},{"line":138,"address":[30885622],"length":1,"stats":{"Line":0}},{"line":142,"address":[30885920],"length":1,"stats":{"Line":0}},{"line":143,"address":[30885950],"length":1,"stats":{"Line":0}},{"line":144,"address":[30886067],"length":1,"stats":{"Line":0}},{"line":145,"address":[30886098],"length":1,"stats":{"Line":0}},{"line":149,"address":[33090403,33089699,33089693,33090397,33089008,33089712],"length":1,"stats":{"Line":1}},{"line":150,"address":[33089135,33089839,33089054,33089758],"length":1,"stats":{"Line":1}},{"line":151,"address":[33090800,33090464,33090720,33090726,33091056,33091062],"length":1,"stats":{"Line":1}},{"line":152,"address":[33090523,33090859],"length":1,"stats":{"Line":1}},{"line":153,"address":[33090880,33090958,33090544,33090622],"length":1,"stats":{"Line":2}},{"line":154,"address":[33090670,33091006],"length":1,"stats":{"Line":1}},{"line":155,"address":[33090689,33091025],"length":1,"stats":{"Line":1}},{"line":160,"address":[33089864,33089380,33090084,33089160],"length":1,"stats":{"Line":1}},{"line":161,"address":[33089337,33090041],"length":1,"stats":{"Line":1}},{"line":162,"address":[33089368,33090072],"length":1,"stats":{"Line":1}}],"covered":39,"coverable":80},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","types.rs"],"content":"//! 前端命令入参/出参类型（用于 IPC 序列化）。\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::DateRange;\nuse crate::timer::TimerSnapshot;\n\n/// 前端初始化所需的完整快照（持久化数据 + 计时器状态）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct AppSnapshot {\n    /// 持久化数据（settings/blacklist/tags/history）。\n    pub data: crate::app_data::AppData,\n    /// 计时器状态快照。\n    pub timer: TimerSnapshot,\n}\n\n/// 应用数据根目录路径信息（用于设置页展示与“打开文件夹”入口）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct StorePaths {\n    /// 数据根目录路径（统一入口，可用于打开文件夹）。\n    pub store_dir_path: String,\n}\n\n/// 导出格式（CSV/JSON）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub enum ExportFormat {\n    /// CSV（逗号分隔）。\n    Csv,\n    /// JSON（结构化）。\n    Json,\n}\n\n/// 导出字段（用于“自选导出字段”）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub enum ExportField {\n    /// 日期（YYYY-MM-DD）。\n    Date,\n    /// 开始时间（HH:mm）。\n    StartTime,\n    /// 结束时间（HH:mm）。\n    EndTime,\n    /// 时长（分钟）。\n    Duration,\n    /// 标签。\n    Tag,\n    /// 阶段类型（work/shortBreak/longBreak）。\n    Phase,\n    /// 备注（PRD v2 新增，可选导出）。\n    Remark,\n}\n\n/// 导出请求参数。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct ExportRequest {\n    /// 导出范围。\n    pub range: DateRange,\n    /// 导出格式。\n    pub format: ExportFormat,\n    /// 导出字段（为空则导出默认字段集）。\n    #[serde(default)]\n    pub fields: Vec\u003cExportField\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","validation.rs"],"content":"//! 命令层输入校验与通用数据选择逻辑（避免散落在各个模块中）。\n\nuse crate::app_data::{BlacklistItem, DateRange, HistoryDay};\nuse crate::errors::{AppError, AppResult};\n\n/// 校验黑名单条目：名称不能为空、不得重复（忽略大小写）。\npub(crate) fn validate_blacklist_items(items: \u0026[BlacklistItem]) -\u003e AppResult\u003c()\u003e {\n    let mut seen = std::collections::BTreeSet::\u003cString\u003e::new();\n    for it in items {\n        if it.name.trim().is_empty() {\n            return Err(AppError::Validation(\"黑名单进程名不能为空\".to_string()));\n        }\n        if it.display_name.trim().is_empty() {\n            return Err(AppError::Validation(\"黑名单显示名不能为空\".to_string()));\n        }\n        let key = normalize_name(\u0026it.name);\n        if !seen.insert(key) {\n            return Err(AppError::Validation(\"黑名单存在重复进程名\".to_string()));\n        }\n    }\n    Ok(())\n}\n\n/// 规范化进程名用于比较（Windows 下大小写不敏感）。\npub(crate) fn normalize_name(name: \u0026str) -\u003e String {\n    name.trim().to_ascii_lowercase()\n}\n\n/// 校验日期字符串是否符合 `YYYY-MM-DD`。\npub(crate) fn validate_ymd(date: \u0026str) -\u003e AppResult\u003c()\u003e {\n    chrono::NaiveDate::parse_from_str(date, \"%Y-%m-%d\")\n        .map_err(|_| AppError::Validation(\"日期格式必须为 YYYY-MM-DD\".to_string()))?;\n    Ok(())\n}\n\n/// 校验日期范围：格式正确且 `from \u003c= to`。\npub(crate) fn validate_date_range(range: \u0026DateRange) -\u003e AppResult\u003c()\u003e {\n    validate_ymd(range.from.trim())?;\n    validate_ymd(range.to.trim())?;\n    if range.from.trim() \u003e range.to.trim() {\n        return Err(AppError::Validation(\n            \"日期范围不合法：from 不能晚于 to\".to_string(),\n        ));\n    }\n    Ok(())\n}\n\n/// 选择供“历史页面/导出/分析”使用的历史数据源（开发环境：优先 `history_dev`）。\npub(crate) fn history_for_ui(data: \u0026crate::app_data::AppData) -\u003e \u0026Vec\u003cHistoryDay\u003e {\n    if cfg!(debug_assertions) \u0026\u0026 !data.history_dev.is_empty() {\n        \u0026data.history_dev\n    } else {\n        \u0026data.history\n    }\n}\n\n/// 选择供“历史备注编辑”使用的可变历史数据源（开发环境：优先 `history_dev`）。\npub(crate) fn history_for_ui_mut(data: \u0026mut crate::app_data::AppData) -\u003e \u0026mut Vec\u003cHistoryDay\u003e {\n    if cfg!(debug_assertions) \u0026\u0026 !data.history_dev.is_empty() {\n        \u0026mut data.history_dev\n    } else {\n        \u0026mut data.history\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use crate::app_data::AppData;\n\n    /// `normalize_name`：应 trim 并转为小写，用于忽略大小写比较。\n    #[test]\n    fn normalize_name_trims_and_lowercases() {\n        assert_eq!(normalize_name(\" WeChat.EXE \"), \"wechat.exe\");\n    }\n\n    /// `validate_blacklist_items`：空列表应通过。\n    #[test]\n    fn validate_blacklist_items_accepts_empty() {\n        assert!(validate_blacklist_items(\u0026[]).is_ok());\n    }\n\n    /// `validate_blacklist_items`：名称与显示名不能为空。\n    #[test]\n    fn validate_blacklist_items_rejects_blank_fields() {\n        let err = validate_blacklist_items(\u0026[BlacklistItem {\n            name: \"   \".to_string(),\n            display_name: \"微信\".to_string(),\n        }])\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n\n        let err = validate_blacklist_items(\u0026[BlacklistItem {\n            name: \"WeChat.exe\".to_string(),\n            display_name: \"   \".to_string(),\n        }])\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `validate_blacklist_items`：应拒绝重复进程名（忽略大小写）。\n    #[test]\n    fn validate_blacklist_items_rejects_duplicates_case_insensitive() {\n        let err = validate_blacklist_items(\u0026[\n            BlacklistItem {\n                name: \"WeChat.exe\".to_string(),\n                display_name: \"微信\".to_string(),\n            },\n            BlacklistItem {\n                name: \"wechat.exe\".to_string(),\n                display_name: \"微信\".to_string(),\n            },\n        ])\n        .unwrap_err();\n        assert!(matches!(err, AppError::Validation(_)));\n    }\n\n    /// `validate_ymd`：合法日期应通过，非法格式应失败。\n    #[test]\n    fn validate_ymd_accepts_and_rejects() {\n        assert!(validate_ymd(\"2025-01-01\").is_ok());\n        assert!(matches!(validate_ymd(\"2025/01/01\"), Err(AppError::Validation(_))));\n    }\n\n    /// `validate_date_range`：应校验格式并确保 from \u003c= to。\n    #[test]\n    fn validate_date_range_validates_order_and_format() {\n        assert!(validate_date_range(\u0026DateRange {\n            from: \"2025-01-01\".to_string(),\n            to: \"2025-01-07\".to_string(),\n        })\n        .is_ok());\n\n        assert!(matches!(\n            validate_date_range(\u0026DateRange {\n                from: \"2025-01-08\".to_string(),\n                to: \"2025-01-07\".to_string(),\n            }),\n            Err(AppError::Validation(_))\n        ));\n\n        assert!(matches!(\n            validate_date_range(\u0026DateRange {\n                from: \"bad\".to_string(),\n                to: \"2025-01-07\".to_string(),\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n\n    /// `history_for_ui`：开发环境下若存在 `history_dev`，应优先返回它。\n    #[test]\n    fn history_for_ui_prefers_history_dev_in_debug() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            history_dev: vec![HistoryDay {\n                date: \"2099-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            ..AppData::default()\n        };\n\n        let out = history_for_ui(\u0026data);\n        assert_eq!(out[0].date, \"2099-01-01\");\n    }\n\n    /// `history_for_ui_mut`：当 `history_dev` 为空时应回退到 `history`。\n    #[test]\n    fn history_for_ui_mut_falls_back_to_history() {\n        let mut data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: Vec::new(),\n            }],\n            history_dev: Vec::new(),\n            ..AppData::default()\n        };\n\n        history_for_ui_mut(\u0026mut data).push(HistoryDay {\n            date: \"2025-01-02\".to_string(),\n            records: Vec::new(),\n        });\n        assert_eq!(data.history.len(), 2);\n        assert!(data.history_dev.is_empty());\n    }\n}\n","traces":[{"line":7,"address":[33121024,33121946,33121952],"length":1,"stats":{"Line":1}},{"line":8,"address":[33121084],"length":1,"stats":{"Line":1}},{"line":9,"address":[33121184,33121105],"length":1,"stats":{"Line":2}},{"line":10,"address":[33121353,33121285],"length":1,"stats":{"Line":2}},{"line":11,"address":[33121863,33121427],"length":1,"stats":{"Line":2}},{"line":13,"address":[33121471,33121406],"length":1,"stats":{"Line":2}},{"line":14,"address":[33121541,33121778],"length":1,"stats":{"Line":2}},{"line":16,"address":[33121593,33121524],"length":1,"stats":{"Line":2}},{"line":17,"address":[33121616],"length":1,"stats":{"Line":1}},{"line":18,"address":[33121641],"length":1,"stats":{"Line":1}},{"line":21,"address":[33121307],"length":1,"stats":{"Line":1}},{"line":25,"address":[33120336],"length":1,"stats":{"Line":1}},{"line":26,"address":[33120386],"length":1,"stats":{"Line":1}},{"line":30,"address":[33120000],"length":1,"stats":{"Line":1}},{"line":31,"address":[33120201,33120057,33120133],"length":1,"stats":{"Line":3}},{"line":32,"address":[28669237,28669216],"length":1,"stats":{"Line":4}},{"line":33,"address":[33120239],"length":1,"stats":{"Line":1}},{"line":37,"address":[33120480],"length":1,"stats":{"Line":1}},{"line":38,"address":[33120516],"length":1,"stats":{"Line":1}},{"line":39,"address":[33120642],"length":1,"stats":{"Line":1}},{"line":40,"address":[33120787],"length":1,"stats":{"Line":1}},{"line":41,"address":[33120930],"length":1,"stats":{"Line":1}},{"line":42,"address":[33120899],"length":1,"stats":{"Line":1}},{"line":45,"address":[33120890],"length":1,"stats":{"Line":1}},{"line":49,"address":[33120272],"length":1,"stats":{"Line":1}},{"line":50,"address":[33120311,33120285],"length":1,"stats":{"Line":2}},{"line":51,"address":[33120302],"length":1,"stats":{"Line":1}},{"line":53,"address":[33120317],"length":1,"stats":{"Line":0}},{"line":58,"address":[33120416],"length":1,"stats":{"Line":1}},{"line":59,"address":[33120429,33120455,33120470],"length":1,"stats":{"Line":3}},{"line":60,"address":[33120446],"length":1,"stats":{"Line":1}},{"line":62,"address":[33120461],"length":1,"stats":{"Line":1}}],"covered":31,"coverable":32},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands","window.rs"],"content":"//! 窗口相关命令：置顶、迷你模式、退出等。\n\nuse tauri::{LogicalPosition, LogicalSize, Manager as _};\n\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\nuse super::common::to_ipc_result;\n\n/// 设置主窗口置顶状态（并持久化到 settings）。\n#[tauri::command]\npub fn set_always_on_top(\n    app: tauri::AppHandle,\n    state: tauri::State\u003c'_, AppState\u003e,\n    enabled: bool,\n) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(set_always_on_top_impl(\u0026app, \u0026state, enabled))\n}\n\n/// 设置置顶的内部实现：修改窗口并写入 settings。\nfn set_always_on_top_impl(\n    app: \u0026tauri::AppHandle,\n    state: \u0026AppState,\n    enabled: bool,\n) -\u003e AppResult\u003cbool\u003e {\n    let window = app\n        .get_webview_window(\"main\")\n        .ok_or_else(|| AppError::Invariant(\"主窗口 `main` 不存在\".to_string()))?;\n    window.set_always_on_top(enabled)?;\n\n    state.update_data(|data| {\n        data.settings.always_on_top = enabled;\n        Ok(())\n    })?;\n\n    tracing::info!(target: \"window\", \"设置置顶：enabled={}\", enabled);\n    Ok(true)\n}\n\n/// 切换迷你模式：窗口调整为 200x80，仅显示倒计时；再次关闭恢复原尺寸。\n#[tauri::command]\npub fn set_mini_mode(\n    app: tauri::AppHandle,\n    state: tauri::State\u003c'_, AppState\u003e,\n    enabled: bool,\n) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(set_mini_mode_impl(\u0026app, \u0026state, enabled))\n}\n\n/// 迷你模式内部实现：记录进入前的尺寸/位置，便于恢复。\nfn set_mini_mode_impl(app: \u0026tauri::AppHandle, state: \u0026AppState, enabled: bool) -\u003e AppResult\u003cbool\u003e {\n    let window = app\n        .get_webview_window(\"main\")\n        .ok_or_else(|| AppError::Invariant(\"主窗口 `main` 不存在\".to_string()))?;\n\n    let snapshot = state.window_mode_snapshot();\n    if enabled \u0026\u0026 !snapshot.mini_mode {\n        if let Ok(size) = window.outer_size() {\n            let _ = state.update_window_mode(|m| {\n                m.prev_size = Some((size.width, size.height));\n                Ok(())\n            });\n        }\n        if let Ok(pos) = window.outer_position() {\n            let _ = state.update_window_mode(|m| {\n                m.prev_position = Some((pos.x, pos.y));\n                Ok(())\n            });\n        }\n    }\n\n    if enabled {\n        window.set_resizable(false)?;\n        window.set_size(LogicalSize::new(200.0, 80.0))?;\n        let _ = state.update_window_mode(|m| {\n            m.mini_mode = true;\n            Ok(())\n        });\n    } else {\n        let snapshot = state.window_mode_snapshot();\n        window.set_resizable(false)?;\n        if let Some((w, h)) = snapshot.prev_size {\n            window.set_size(LogicalSize::new(w as f64, h as f64))?;\n        } else {\n            window.set_size(LogicalSize::new(420.0, 720.0))?;\n        }\n        if let Some((x, y)) = snapshot.prev_position {\n            window.set_position(LogicalPosition::new(x as f64, y as f64))?;\n        }\n        let _ = state.update_window_mode(|m| {\n            m.mini_mode = false;\n            Ok(())\n        });\n    }\n\n    tracing::info!(target: \"window\", \"切换迷你模式：enabled={}\", enabled);\n    Ok(true)\n}\n\n/// 退出应用（用于迷你模式右键菜单）。\n#[tauri::command]\npub fn exit_app(app: tauri::AppHandle) -\u003e Result\u003cbool, String\u003e {\n    to_ipc_result(exit_app_impl(\u0026app))\n}\n\n/// 退出应用的内部实现：请求 Tauri 退出。\nfn exit_app_impl(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cbool\u003e {\n    tracing::info!(target: \"system\", \"请求退出应用\");\n    app.exit(0);\n    Ok(true)\n}\n","traces":[{"line":12,"address":[29740532,29740368],"length":1,"stats":{"Line":0}},{"line":17,"address":[29740473,29740412],"length":1,"stats":{"Line":0}},{"line":21,"address":[29744659,29743424,29744653],"length":1,"stats":{"Line":0}},{"line":26,"address":[29743615,29743531],"length":1,"stats":{"Line":0}},{"line":28,"address":[29743510,29743580],"length":1,"stats":{"Line":0}},{"line":29,"address":[29743720,29744651,29743780],"length":1,"stats":{"Line":0}},{"line":31,"address":[29743940,29744634,29744067],"length":1,"stats":{"Line":0}},{"line":32,"address":[31025821],"length":1,"stats":{"Line":0}},{"line":33,"address":[31025832],"length":1,"stats":{"Line":0}},{"line":36,"address":[29744378,29744092],"length":1,"stats":{"Line":0}},{"line":37,"address":[29744349],"length":1,"stats":{"Line":0}},{"line":42,"address":[29740340,29740176],"length":1,"stats":{"Line":0}},{"line":47,"address":[29740281,29740220],"length":1,"stats":{"Line":0}},{"line":51,"address":[29741178,29743396,29740560],"length":1,"stats":{"Line":0}},{"line":52,"address":[29740766,29740679],"length":1,"stats":{"Line":0}},{"line":54,"address":[29740728,29740658],"length":1,"stats":{"Line":0}},{"line":56,"address":[29740889],"length":1,"stats":{"Line":0}},{"line":57,"address":[29740936,29740965],"length":1,"stats":{"Line":0}},{"line":58,"address":[29741061,29740991],"length":1,"stats":{"Line":0}},{"line":59,"address":[29741113],"length":1,"stats":{"Line":0}},{"line":60,"address":[31025490],"length":1,"stats":{"Line":0}},{"line":61,"address":[31025525],"length":1,"stats":{"Line":0}},{"line":64,"address":[29741200,29741270],"length":1,"stats":{"Line":0}},{"line":65,"address":[29741322],"length":1,"stats":{"Line":0}},{"line":66,"address":[31025426],"length":1,"stats":{"Line":0}},{"line":67,"address":[31025462],"length":1,"stats":{"Line":0}},{"line":72,"address":[29740946],"length":1,"stats":{"Line":0}},{"line":73,"address":[29742457,29743391,29741428],"length":1,"stats":{"Line":0}},{"line":74,"address":[29743386,29742602],"length":1,"stats":{"Line":0}},{"line":75,"address":[29742837],"length":1,"stats":{"Line":0}},{"line":76,"address":[31025688],"length":1,"stats":{"Line":0}},{"line":77,"address":[31025692],"length":1,"stats":{"Line":0}},{"line":80,"address":[29741403],"length":1,"stats":{"Line":0}},{"line":81,"address":[29742452,29741456],"length":1,"stats":{"Line":0}},{"line":82,"address":[29741608],"length":1,"stats":{"Line":0}},{"line":83,"address":[29741933,29741760,29741657],"length":1,"stats":{"Line":0}},{"line":85,"address":[29742447,29741981,29741690],"length":1,"stats":{"Line":0}},{"line":87,"address":[29741909,29742137],"length":1,"stats":{"Line":0}},{"line":88,"address":[29742165,29742250],"length":1,"stats":{"Line":0}},{"line":90,"address":[29742212],"length":1,"stats":{"Line":0}},{"line":91,"address":[31025384],"length":1,"stats":{"Line":0}},{"line":92,"address":[31025388],"length":1,"stats":{"Line":0}},{"line":96,"address":[29742866,29742419,29743126],"length":1,"stats":{"Line":0}},{"line":97,"address":[29743097],"length":1,"stats":{"Line":0}},{"line":102,"address":[29744672,29744773],"length":1,"stats":{"Line":0}},{"line":103,"address":[29744745,29744696],"length":1,"stats":{"Line":0}},{"line":107,"address":[29739792],"length":1,"stats":{"Line":0}},{"line":108,"address":[29740008,29739822],"length":1,"stats":{"Line":0}},{"line":109,"address":[29739972],"length":1,"stats":{"Line":0}},{"line":110,"address":[29739989],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":50},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","commands.rs"],"content":"//! 前端可调用的 Tauri 命令集合（按领域拆分，避免单文件过大）。\n\npub mod analysis;\npub mod app;\npub mod blacklist;\nmod common;\npub mod debug;\npub mod export;\npub mod history;\npub mod logging;\npub mod processes;\npub mod settings;\npub mod tags;\npub mod templates;\npub mod timer;\nmod state_like;\nmod validation;\npub mod window;\n\npub mod types;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","errors.rs"],"content":"//! 统一错误类型与 `Result` 别名。\n\nuse thiserror::Error;\n\n/// 应用内部通用错误。\n#[derive(Debug, Error)]\npub enum AppError {\n    /// JSON 序列化/反序列化失败。\n    #[error(\"JSON 处理失败：{0}\")]\n    Json(#[from] serde_json::Error),\n\n    /// Store 插件失败。\n    #[error(\"Store 失败：{0}\")]\n    Store(#[from] tauri_plugin_store::Error),\n\n    /// Tauri 框架错误。\n    #[error(\"Tauri 运行失败：{0}\")]\n    Tauri(#[from] tauri::Error),\n\n    /// 系统通知失败。\n    #[error(\"通知失败：{0}\")]\n    Notification(#[from] tauri_plugin_notification::Error),\n\n    /// 参数校验失败。\n    #[error(\"参数不合法：{0}\")]\n    Validation(String),\n\n    /// 黑名单在专注期被锁定，禁止移除。\n    #[error(\"专注期内禁止移除黑名单进程\")]\n    BlacklistLocked,\n\n    /// 平台不支持。\n    #[error(\"当前平台不支持：{0}\")]\n    #[cfg_attr(windows, allow(dead_code))]\n    UnsupportedPlatform(String),\n\n    /// 内部不变量被破坏（逻辑错误）。\n    #[error(\"内部错误：{0}\")]\n    Invariant(String),\n\n    /// 终止进程失败（通常是权限不足，仅 Windows 使用）。\n    #[error(\"终止进程失败：{0}\")]\n    #[cfg(windows)]\n    KillFailed(String),\n}\n\n/// 应用内部 `Result` 统一别名。\npub type AppResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `AppError::Json`：Display 应包含“JSON 处理失败”前缀。\n    #[test]\n    fn app_error_display_json() {\n        let err = serde_json::from_str::\u003cserde_json::Value\u003e(\"{\").unwrap_err();\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"JSON 处理失败：\"));\n    }\n\n    /// `AppError::Store`：Display 应包含“Store 失败”前缀。\n    #[test]\n    fn app_error_display_store() {\n        let err = tauri_plugin_store::Error::Io(std::io::Error::new(\n            std::io::ErrorKind::Other,\n            \"boom\",\n        ));\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"Store 失败：\"));\n        assert!(app_err.to_string().contains(\"boom\"));\n    }\n\n    /// `AppError::Tauri`：Display 应包含“Tauri 运行失败”前缀。\n    #[test]\n    fn app_error_display_tauri() {\n        let err = tauri::Error::AssetNotFound(\"missing\".to_string());\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"Tauri 运行失败：\"));\n        assert!(app_err.to_string().contains(\"asset not found\"));\n    }\n\n    /// `AppError::Notification`：Display 应包含“通知失败”前缀。\n    #[test]\n    fn app_error_display_notification() {\n        let err = tauri_plugin_notification::Error::Io(std::io::Error::new(\n            std::io::ErrorKind::Other,\n            \"notify\",\n        ));\n        let app_err = AppError::from(err);\n        assert!(app_err.to_string().contains(\"通知失败：\"));\n        assert!(app_err.to_string().contains(\"notify\"));\n    }\n\n    /// `AppError::Validation`：Display 应包含“参数不合法”前缀与原始信息。\n    #[test]\n    fn app_error_display_validation() {\n        let app_err = AppError::Validation(\"bad\".to_string());\n        assert_eq!(app_err.to_string(), \"参数不合法：bad\");\n    }\n\n    /// `AppError::BlacklistLocked`：Display 应为固定文案。\n    #[test]\n    fn app_error_display_blacklist_locked() {\n        let app_err = AppError::BlacklistLocked;\n        assert_eq!(app_err.to_string(), \"专注期内禁止移除黑名单进程\");\n    }\n\n    /// `AppError::UnsupportedPlatform`：Display 应包含“不支持”与原因。\n    #[test]\n    fn app_error_display_unsupported_platform() {\n        let app_err = AppError::UnsupportedPlatform(\"x\".to_string());\n        assert_eq!(app_err.to_string(), \"当前平台不支持：x\");\n    }\n\n    /// `AppError::Invariant`：Display 应包含“内部错误”前缀。\n    #[test]\n    fn app_error_display_invariant() {\n        let app_err = AppError::Invariant(\"oops\".to_string());\n        assert_eq!(app_err.to_string(), \"内部错误：oops\");\n    }\n\n    /// `AppError::KillFailed`：Windows 下 Display 应包含“终止进程失败”前缀。\n    #[cfg(windows)]\n    #[test]\n    fn app_error_display_kill_failed_on_windows() {\n        let app_err = AppError::KillFailed(\"ACCESS_DENIED\".to_string());\n        assert!(app_err.to_string().contains(\"终止进程失败：\"));\n        assert!(app_err.to_string().contains(\"ACCESS_DENIED\"));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","lib.rs"],"content":"//! 番茄钟应用（Tauri 2）后端入口与命令注册。\n\nmod analysis;\nmod app_data;\nmod app_paths;\nmod commands;\nmod errors;\nmod logging;\nmod processes;\nmod state;\nmod timer;\nmod tray;\npub mod typegen;\n\nuse std::time::Duration;\n\nuse tauri::Manager as _;\nuse tauri_plugin_store::StoreExt;\n\nuse crate::app_data::{AppData, STORE_FILE_NAME, STORE_KEY};\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\nuse crate::timer::spawn_timer_task;\nuse crate::tray::setup_tray;\n\n/// 应用运行入口（由 `src-tauri/src/main.rs` 调用）。\n#[cfg_attr(mobile, tauri::mobile_entry_point)]\npub fn run() {\n    tauri::Builder::default()\n        .plugin(tauri_plugin_opener::init())\n        .plugin(tauri_plugin_notification::init())\n        .plugin(tauri_plugin_dialog::init())\n        .plugin(tauri_plugin_store::Builder::default().build())\n        .setup(|app| {\n            logging::init_logging(app.handle())?;\n            migrate_legacy_store_file(app.handle())?;\n\n            let store_path = app_paths::store_file_path(app.handle())?;\n            let store = app\n                .store_builder(store_path)\n                .auto_save(Duration::from_millis(0))\n                .build()?;\n\n            let data = load_or_init_app_data(\u0026store)?;\n\n            app.manage(AppState::new(app.handle().clone(), store, data));\n\n            setup_tray(app)?;\n            setup_window_close_to_tray(app)?;\n            spawn_timer_task(app.handle().clone());\n\n            // PRD v2：启动时应用“窗口置顶”设置。\n            if let Some(window) = app.get_webview_window(\"main\") {\n                let state = app.state::\u003cAppState\u003e();\n                let always_on_top = state.data_snapshot().settings.always_on_top;\n                let _ = window.set_always_on_top(always_on_top);\n            }\n\n            Ok(())\n        })\n        .invoke_handler(tauri::generate_handler![\n            commands::app::get_app_snapshot,\n            commands::app::get_store_paths,\n            commands::app::open_store_dir,\n            commands::settings::update_settings,\n            commands::settings::set_goals,\n            commands::tags::set_current_tag,\n            commands::tags::add_tag,\n            commands::blacklist::set_blacklist,\n            commands::history::get_history,\n            commands::history::set_history_remark,\n            commands::analysis::get_focus_analysis,\n            commands::templates::get_templates,\n            commands::templates::save_template,\n            commands::templates::delete_template,\n            commands::templates::apply_template,\n            commands::window::set_always_on_top,\n            commands::window::set_mini_mode,\n            commands::export::export_history,\n            commands::logging::open_log_dir,\n            commands::logging::frontend_log,\n            commands::debug::debug_generate_history,\n            commands::debug::debug_clear_history,\n            commands::window::exit_app,\n            commands::processes::list_processes,\n            commands::timer::timer_start,\n            commands::timer::timer_pause,\n            commands::timer::timer_reset,\n            commands::timer::timer_skip,\n            commands::processes::restart_as_admin\n        ])\n        .run(tauri::generate_context!())\n        .expect(\"error while running tauri application\");\n}\n\n/// 将相对 `BaseDirectory::AppData` 的路径解析为真实磁盘路径（用于兼容迁移）。\nfn resolve_path_in_app_data(app: \u0026tauri::AppHandle, path: \u0026str) -\u003e AppResult\u003cstd::path::PathBuf\u003e {\n    use tauri::path::BaseDirectory;\n    use tauri::Manager as _;\n\n    app.path()\n        .resolve(path, BaseDirectory::AppData)\n        .map_err(|_| AppError::Invariant(format!(\"无法解析路径（BaseDirectory::AppData）：{path}\")))\n}\n\n/// 启动迁移：将旧位置/误位置的 store 文件搬到“统一入口”根目录下的 `data/`（仅在新文件不存在时执行）。\nfn migrate_legacy_store_file(app: \u0026tauri::AppHandle) -\u003e AppResult\u003c()\u003e {\n    let target = app_paths::store_file_path(app)?;\n    if target.exists() {\n        return Ok(());\n    }\n\n    let legacy_in_app_data_root = resolve_path_in_app_data(app, STORE_FILE_NAME)?;\n    let misplaced_in_app_data_logs =\n        resolve_path_in_app_data(app, \u0026format!(\"logs/{STORE_FILE_NAME}\"))?;\n    let misplaced_in_root_logs = app_paths::app_log_dir(app)?.join(STORE_FILE_NAME);\n\n    let candidates = [\n        legacy_in_app_data_root,\n        misplaced_in_app_data_logs,\n        misplaced_in_root_logs,\n    ];\n\n    let Some(source) = candidates\n        .into_iter()\n        .find(|path| path.exists() \u0026\u0026 path.is_file())\n    else {\n        return Ok(());\n    };\n\n    if let Some(parent) = target.parent() {\n        std::fs::create_dir_all(parent)\n            .map_err(|e| AppError::Invariant(format!(\"创建数据目录失败：{e}\")))?;\n    }\n\n    // 优先使用 rename（同盘移动更快）；失败时回退到 copy + remove。\n    match std::fs::rename(\u0026source, \u0026target) {\n        Ok(()) =\u003e {\n            tracing::info!(\n                target: \"storage\",\n                \"已迁移 store 文件：{} -\u003e {}\",\n                source.to_string_lossy(),\n                target.to_string_lossy()\n            );\n            Ok(())\n        }\n        Err(rename_err) =\u003e {\n            std::fs::copy(\u0026source, \u0026target).map_err(|e| {\n                AppError::Invariant(format!(\n                    \"迁移 store 失败（rename={rename_err}；copy 也失败）：{e}\"\n                ))\n            })?;\n            let _ = std::fs::remove_file(\u0026source);\n            tracing::info!(\n                target: \"storage\",\n                \"已迁移 store 文件（copy fallback）：{} -\u003e {}\",\n                source.to_string_lossy(),\n                target.to_string_lossy()\n            );\n            Ok(())\n        }\n    }\n}\n\n/// 从 store 中加载 `AppData`；若为空则写入默认值并返回。\nfn load_or_init_app_data(store: \u0026tauri_plugin_store::Store\u003ctauri::Wry\u003e) -\u003e AppResult\u003cAppData\u003e {\n    if let Some(value) = store.get(STORE_KEY) {\n        let mut data: AppData = serde_json::from_value(value)?;\n        tracing::info!(target: \"storage\", \"已从 store 加载 AppData\");\n        if data.migrate_v2() {\n            store.set(STORE_KEY, serde_json::to_value(\u0026data)?);\n            store.save()?;\n            tracing::info!(target: \"storage\", \"已完成 AppData v2 迁移并写回 store\");\n        }\n        return Ok(data);\n    }\n\n    let data = AppData::default();\n    store.set(STORE_KEY, serde_json::to_value(\u0026data)?);\n    store.save()?;\n    tracing::info!(target: \"storage\", \"首次启动：已写入默认 AppData\");\n    Ok(data)\n}\n\n/// 将窗口关闭行为改为“隐藏到托盘”（满足 PRD 的“最小化到托盘”）。\nfn setup_window_close_to_tray(app: \u0026mut tauri::App) -\u003e AppResult\u003c()\u003e {\n    use tauri::Manager as _;\n    use tauri::WindowEvent;\n\n    let window = app\n        .get_webview_window(\"main\")\n        .ok_or_else(|| errors::AppError::Invariant(\"主窗口 `main` 不存在\".to_string()))?;\n\n    let window_for_event = window.clone();\n    window.on_window_event(move |event| {\n        if let WindowEvent::CloseRequested { api, .. } = event {\n            api.prevent_close();\n            let _ = window_for_event.hide();\n        }\n    });\n\n    Ok(())\n}\n","traces":[{"line":28,"address":[56293385,56293424,56293449,56293360],"length":1,"stats":{"Line":0}},{"line":29,"address":[43076734,43076740,43076320],"length":1,"stats":{"Line":0}},{"line":30,"address":[85496374],"length":1,"stats":{"Line":0}},{"line":31,"address":[85496401],"length":1,"stats":{"Line":0}},{"line":32,"address":[43076384],"length":1,"stats":{"Line":0}},{"line":33,"address":[55728129],"length":1,"stats":{"Line":0}},{"line":34,"address":[34593146],"length":1,"stats":{"Line":0}},{"line":35,"address":[55050848,55050788,55050875],"length":1,"stats":{"Line":0}},{"line":36,"address":[30056743],"length":1,"stats":{"Line":0}},{"line":38,"address":[30056888],"length":1,"stats":{"Line":0}},{"line":39,"address":[30057296,30059024,30057374,30057466],"length":1,"stats":{"Line":0}},{"line":40,"address":[80144625,80143527,80142110],"length":1,"stats":{"Line":0}},{"line":41,"address":[55728864,55728916,55728643,55728752],"length":1,"stats":{"Line":0}},{"line":42,"address":[30057351,30057418],"length":1,"stats":{"Line":0}},{"line":44,"address":[30058947,30057619,30057547],"length":1,"stats":{"Line":0}},{"line":46,"address":[35841857],"length":1,"stats":{"Line":0}},{"line":48,"address":[80143780,80143537,80141786,80142603,80145044],"length":1,"stats":{"Line":0}},{"line":49,"address":[66395497],"length":1,"stats":{"Line":0}},{"line":50,"address":[30058418],"length":1,"stats":{"Line":0}},{"line":53,"address":[78656355,78662500],"length":1,"stats":{"Line":0}},{"line":54,"address":[52873151,52872611],"length":1,"stats":{"Line":0}},{"line":55,"address":[66376982],"length":1,"stats":{"Line":0}},{"line":56,"address":[78947456,78947470,78947377],"length":1,"stats":{"Line":0}},{"line":59,"address":[30058578],"length":1,"stats":{"Line":0}},{"line":61,"address":[55051518],"length":1,"stats":{"Line":0}},{"line":62,"address":[88069308,88069786,88069776],"length":1,"stats":{"Line":0}},{"line":63,"address":[88069340],"length":1,"stats":{"Line":0}},{"line":64,"address":[43076176],"length":1,"stats":{"Line":0}},{"line":65,"address":[43075831,43076255,43076279],"length":1,"stats":{"Line":0}},{"line":66,"address":[66279106,66279015],"length":1,"stats":{"Line":0}},{"line":67,"address":[55553526,55553495,55553425],"length":1,"stats":{"Line":0}},{"line":68,"address":[57794016,57805088,57793824,57793849,57805141,57794041],"length":1,"stats":{"Line":0}},{"line":69,"address":[66338852,66338942,66340262,66340382,66338822,66340292],"length":1,"stats":{"Line":0}},{"line":70,"address":[55051271,55051741],"length":1,"stats":{"Line":0}},{"line":71,"address":[55742832,55742864,55743077,55743072],"length":1,"stats":{"Line":0}},{"line":72,"address":[55481600],"length":1,"stats":{"Line":0}},{"line":73,"address":[75585792,75585952,75585992,75585824],"length":1,"stats":{"Line":0}},{"line":74,"address":[75585971,75585819],"length":1,"stats":{"Line":0}},{"line":75,"address":[66278451,66278288,66278457],"length":1,"stats":{"Line":0}},{"line":76,"address":[57805129],"length":1,"stats":{"Line":0}},{"line":77,"address":[66296074],"length":1,"stats":{"Line":0}},{"line":78,"address":[69981744,70010128,70009376,69973104],"length":1,"stats":{"Line":0}},{"line":79,"address":[85221168],"length":1,"stats":{"Line":0}},{"line":80,"address":[70079972,70081204,70082676,70075604,70077156,70078196,70061252,70075140,70083028,70076820,70078532,70081604,70077764,70059748,70080356,70081972,70076100,70083348,70074772,70082324,70076468,70074388,70079572,70080772,70073908],"length":1,"stats":{"Line":0}},{"line":81,"address":[70008795,70009547,69981371],"length":1,"stats":{"Line":0}},{"line":82,"address":[70732748],"length":1,"stats":{"Line":0}},{"line":83,"address":[90008639],"length":1,"stats":{"Line":0}},{"line":84,"address":[66296171],"length":1,"stats":{"Line":0}},{"line":85,"address":[88052481],"length":1,"stats":{"Line":0}},{"line":86,"address":[55685967,55685961,55685712],"length":1,"stats":{"Line":0}},{"line":87,"address":[90008656],"length":1,"stats":{"Line":0}},{"line":88,"address":[66338272,66339408],"length":1,"stats":{"Line":0}},{"line":89,"address":[55491264,55491283],"length":1,"stats":{"Line":0}},{"line":90,"address":[66339418,66338282],"length":1,"stats":{"Line":0}},{"line":92,"address":[75580467],"length":1,"stats":{"Line":0}},{"line":97,"address":[89989344],"length":1,"stats":{"Line":0}},{"line":101,"address":[87020112],"length":1,"stats":{"Line":0}},{"line":102,"address":[76974023],"length":1,"stats":{"Line":0}},{"line":103,"address":[34587009],"length":1,"stats":{"Line":0}},{"line":107,"address":[34590598,34591901,34587040],"length":1,"stats":{"Line":0}},{"line":108,"address":[79228588,79228436,79228474],"length":1,"stats":{"Line":0}},{"line":109,"address":[66279529,66279523,66279360],"length":1,"stats":{"Line":0}},{"line":110,"address":[87020384],"length":1,"stats":{"Line":0}},{"line":113,"address":[36917719],"length":1,"stats":{"Line":0}},{"line":114,"address":[86943836],"length":1,"stats":{"Line":0}},{"line":116,"address":[39818152],"length":1,"stats":{"Line":0}},{"line":118,"address":[88074626],"length":1,"stats":{"Line":0}},{"line":119,"address":[34588676],"length":1,"stats":{"Line":0}},{"line":120,"address":[49015552],"length":1,"stats":{"Line":0}},{"line":121,"address":[79234670,79234611],"length":1,"stats":{"Line":0}},{"line":124,"address":[76974573],"length":1,"stats":{"Line":0}},{"line":126,"address":[49015149],"length":1,"stats":{"Line":0}},{"line":127,"address":[75554338],"length":1,"stats":{"Line":0}},{"line":128,"address":[79234705],"length":1,"stats":{"Line":0}},{"line":131,"address":[47197744,47198762,47198800,47197856,47197733,47197728,47197822,47197896,47198704,47198283,47198899,47198272],"length":1,"stats":{"Line":0}},{"line":132,"address":[73486433],"length":1,"stats":{"Line":0}},{"line":133,"address":[49015466],"length":1,"stats":{"Line":0}},{"line":137,"address":[66295179,66295214],"length":1,"stats":{"Line":0}},{"line":138,"address":[49015487,49015498],"length":1,"stats":{"Line":0}},{"line":139,"address":[88070440],"length":1,"stats":{"Line":0}},{"line":145,"address":[34590017],"length":1,"stats":{"Line":1}},{"line":147,"address":[66317440],"length":1,"stats":{"Line":0}},{"line":148,"address":[55659102],"length":1,"stats":{"Line":0}},{"line":149,"address":[66317449],"length":1,"stats":{"Line":0}},{"line":150,"address":[49198928],"length":1,"stats":{"Line":1}},{"line":153,"address":[75599029,75601597],"length":1,"stats":{"Line":0}},{"line":154,"address":[54984336],"length":1,"stats":{"Line":1}},{"line":160,"address":[79227832,79227785],"length":1,"stats":{"Line":1}},{"line":166,"address":[55677112],"length":1,"stats":{"Line":0}},{"line":167,"address":[55346353],"length":1,"stats":{"Line":0}},{"line":168,"address":[88100114],"length":1,"stats":{"Line":0}},{"line":169,"address":[49015584],"length":1,"stats":{"Line":0}},{"line":170,"address":[66360385],"length":1,"stats":{"Line":0}},{"line":171,"address":[74270758],"length":1,"stats":{"Line":0}},{"line":172,"address":[84932603],"length":1,"stats":{"Line":0}},{"line":173,"address":[66316944],"length":1,"stats":{"Line":0}},{"line":175,"address":[66316954],"length":1,"stats":{"Line":0}},{"line":178,"address":[49015819,49015973],"length":1,"stats":{"Line":0}},{"line":179,"address":[57801623],"length":1,"stats":{"Line":0}},{"line":180,"address":[66360902],"length":1,"stats":{"Line":0}},{"line":181,"address":[55923328,55923504,55923352,55923548,55923457,55923410,55923592],"length":1,"stats":{"Line":0}},{"line":182,"address":[75581550,75581603],"length":1,"stats":{"Line":0}},{"line":186,"address":[52912152,52912234],"length":1,"stats":{"Line":0}},{"line":190,"address":[73481606],"length":1,"stats":{"Line":1}},{"line":192,"address":[75599455,75602060],"length":1,"stats":{"Line":1}},{"line":194,"address":[55915984],"length":1,"stats":{"Line":0}},{"line":195,"address":[73481829,73481261],"length":1,"stats":{"Line":0}},{"line":196,"address":[55916036],"length":1,"stats":{"Line":0}},{"line":197,"address":[66361122],"length":1,"stats":{"Line":0}},{"line":198,"address":[56164752],"length":1,"stats":{"Line":0}},{"line":202,"address":[46863119,46865920],"length":1,"stats":{"Line":1}}],"covered":7,"coverable":111},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","logging.rs"],"content":"//! 应用日志系统：基于 `tracing` 将日志写入文件，并提供日志目录解析工具。\n\nuse std::path::{Path, PathBuf};\n\nuse tracing_subscriber::prelude::*;\n\nuse crate::app_paths;\nuse crate::errors::{AppError, AppResult};\n\n/// 日志文件名前缀（配合 `tracing_appender` 生成 `pomodoro-YYYY-MM-DD.log`）。\nconst LOG_PREFIX: \u0026str = \"pomodoro-\";\n\n/// 日志文件名后缀。\nconst LOG_SUFFIX: \u0026str = \".log\";\n\n/// 单日志文件建议上限（字节；PRD v2：10MB）。\npub const MAX_LOG_FILE_BYTES: u64 = 10 * 1024 * 1024;\n\n/// 日志文件保留数量（PRD v2：保留最近 7 个）。\npub const MAX_LOG_FILES: usize = 7;\n\n/// 获取日志目录（统一入口：`root/logs/`）。\npub fn log_dir(app: \u0026tauri::AppHandle) -\u003e AppResult\u003cPathBuf\u003e {\n    app_paths::app_log_dir(app)\n}\n\n/// 初始化文件日志（daily rolling + 保留最近若干文件）。\npub fn init_logging(app: \u0026tauri::AppHandle) -\u003e AppResult\u003c()\u003e {\n    let dir = log_dir(app)?;\n    std::fs::create_dir_all(\u0026dir)\n        .map_err(|e| AppError::Invariant(format!(\"创建日志目录失败：{e}\")))?;\n\n    cleanup_old_logs(\u0026dir, MAX_LOG_FILES)?;\n\n    let file_appender = tracing_appender::rolling::Builder::new()\n        .rotation(tracing_appender::rolling::Rotation::DAILY)\n        .filename_prefix(LOG_PREFIX)\n        .filename_suffix(LOG_SUFFIX)\n        .max_log_files(MAX_LOG_FILES)\n        .build(\u0026dir)\n        .map_err(|e| AppError::Invariant(format!(\"初始化日志写入器失败：{e}\")))?;\n\n    let (non_blocking, _guard) = tracing_appender::non_blocking(file_appender);\n\n    // 将 guard 泄漏为全局生命周期：保证应用运行期间日志线程不被提前 drop。\n    // 该 guard 仅在进程退出时回收，符合桌面应用预期。\n    std::mem::forget(_guard);\n\n    let filter = tracing_subscriber::EnvFilter::try_from_default_env()\n        .unwrap_or_else(|_| tracing_subscriber::EnvFilter::new(\"info\"));\n\n    tracing_subscriber::registry()\n        .with(filter)\n        .with(\n            tracing_subscriber::fmt::layer()\n                .with_ansi(false)\n                .with_target(true)\n                .with_writer(non_blocking)\n                .with_timer(tracing_subscriber::fmt::time::ChronoLocal::new(\n                    \"%Y-%m-%d %H:%M:%S%.3f\".to_string(),\n                )),\n        )\n        .init();\n\n    tracing::info!(target: \"system\", \"日志系统已初始化，目录={}\", dir.to_string_lossy());\n    Ok(())\n}\n\n/// 清理旧日志：按文件名排序保留最近 `max_files` 个。\nfn cleanup_old_logs(dir: \u0026Path, max_files: usize) -\u003e AppResult\u003c()\u003e {\n    let mut files: Vec\u003cPathBuf\u003e = Vec::new();\n    for entry in\n        std::fs::read_dir(dir).map_err(|e| AppError::Invariant(format!(\"读取日志目录失败：{e}\")))?\n    {\n        let entry = entry.map_err(|e| AppError::Invariant(format!(\"读取日志目录条目失败：{e}\")))?;\n        let path = entry.path();\n        if !path.is_file() {\n            continue;\n        }\n        let Some(name) = path.file_name().and_then(|n| n.to_str()) else {\n            continue;\n        };\n        if name.starts_with(LOG_PREFIX) \u0026\u0026 name.ends_with(LOG_SUFFIX) {\n            // PRD v2：单文件上限 10MB（这里在启动时对历史日志做一次截断，避免无限增长）。\n            if let Ok(meta) = std::fs::metadata(\u0026path) {\n                if meta.len() \u003e MAX_LOG_FILE_BYTES {\n                    let _ = std::fs::OpenOptions::new()\n                        .write(true)\n                        .open(\u0026path)\n                        .and_then(|f| f.set_len(MAX_LOG_FILE_BYTES));\n                }\n            }\n            files.push(path);\n        }\n    }\n\n    files.sort();\n    if files.len() \u003c= max_files {\n        return Ok(());\n    }\n\n    let remove_count = files.len() - max_files;\n    for path in files.into_iter().take(remove_count) {\n        let _ = std::fs::remove_file(\u0026path);\n    }\n    Ok(())\n}\n","traces":[{"line":23,"address":[29830128],"length":1,"stats":{"Line":0}},{"line":24,"address":[29830145],"length":1,"stats":{"Line":0}},{"line":28,"address":[29827435,29824368,29827243],"length":1,"stats":{"Line":0}},{"line":29,"address":[29824444],"length":1,"stats":{"Line":0}},{"line":30,"address":[29824894,29824787,29824677,29827433],"length":1,"stats":{"Line":0}},{"line":31,"address":[29824764,29824830],"length":1,"stats":{"Line":0}},{"line":33,"address":[29824927,29827431],"length":1,"stats":{"Line":0}},{"line":35,"address":[29825502,29825128,29825395],"length":1,"stats":{"Line":0}},{"line":36,"address":[29825147],"length":1,"stats":{"Line":0}},{"line":37,"address":[29825179],"length":1,"stats":{"Line":0}},{"line":38,"address":[29825214],"length":1,"stats":{"Line":0}},{"line":39,"address":[29825249],"length":1,"stats":{"Line":0}},{"line":40,"address":[29825305],"length":1,"stats":{"Line":0}},{"line":41,"address":[30813638,30813616],"length":1,"stats":{"Line":0}},{"line":43,"address":[29825665],"length":1,"stats":{"Line":0}},{"line":47,"address":[29825840],"length":1,"stats":{"Line":0}},{"line":49,"address":[29825968],"length":1,"stats":{"Line":0}},{"line":50,"address":[29825987],"length":1,"stats":{"Line":0}},{"line":52,"address":[29826025,29826492],"length":1,"stats":{"Line":0}},{"line":53,"address":[29826085],"length":1,"stats":{"Line":0}},{"line":55,"address":[29826453,29826172],"length":1,"stats":{"Line":0}},{"line":56,"address":[29826238],"length":1,"stats":{"Line":0}},{"line":57,"address":[29826266],"length":1,"stats":{"Line":0}},{"line":58,"address":[29826273],"length":1,"stats":{"Line":0}},{"line":59,"address":[29826477,29826424],"length":1,"stats":{"Line":0}},{"line":60,"address":[29826352],"length":1,"stats":{"Line":0}},{"line":65,"address":[29826554,29826872],"length":1,"stats":{"Line":0}},{"line":66,"address":[29826814],"length":1,"stats":{"Line":0}},{"line":70,"address":[29830086,29827456,29828758],"length":1,"stats":{"Line":0}},{"line":71,"address":[29827527],"length":1,"stats":{"Line":0}},{"line":72,"address":[29827992],"length":1,"stats":{"Line":0}},{"line":73,"address":[29827978,29830081,29827660,29827584],"length":1,"stats":{"Line":0}},{"line":75,"address":[29828807,29828056],"length":1,"stats":{"Line":0}},{"line":76,"address":[29829106,29829035],"length":1,"stats":{"Line":0}},{"line":77,"address":[29829199,29829122],"length":1,"stats":{"Line":0}},{"line":80,"address":[30814606,30814592],"length":1,"stats":{"Line":0}},{"line":83,"address":[29829498,29829432],"length":1,"stats":{"Line":0}},{"line":85,"address":[29829660,29829535],"length":1,"stats":{"Line":0}},{"line":86,"address":[29829667,29829728],"length":1,"stats":{"Line":0}},{"line":87,"address":[29829837,29829748],"length":1,"stats":{"Line":0}},{"line":89,"address":[29829785],"length":1,"stats":{"Line":0}},{"line":90,"address":[29829845,29829820],"length":1,"stats":{"Line":0}},{"line":93,"address":[29829886],"length":1,"stats":{"Line":0}},{"line":97,"address":[29828093],"length":1,"stats":{"Line":0}},{"line":98,"address":[29828147],"length":1,"stats":{"Line":0}},{"line":99,"address":[29828214],"length":1,"stats":{"Line":0}},{"line":102,"address":[29828191,29828242,29828344],"length":1,"stats":{"Line":0}},{"line":103,"address":[29828388,29828507,29828277],"length":1,"stats":{"Line":0}},{"line":104,"address":[29828576,29828709],"length":1,"stats":{"Line":0}},{"line":106,"address":[29828626],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":50},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","main.rs"],"content":"// Prevents additional console window on Windows in release, DO NOT REMOVE!!\n#![cfg_attr(not(debug_assertions), windows_subsystem = \"windows\")]\n\n/// 应用二进制入口：转交给库入口 `tauri_app_lib::run()`。\nfn main() {\n    tauri_app_lib::run()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","processes","enumeration.rs"],"content":"//! 进程枚举与图标提取（用于黑名单管理 UI）。\n\nuse std::collections::BTreeMap;\n\nuse serde::{Deserialize, Serialize};\nuse sysinfo::System;\nuse ts_rs::TS;\n\n#[cfg(windows)]\nuse crate::errors::AppError;\nuse crate::errors::AppResult;\n\n/// 前端展示用的进程信息。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct ProcessInfo {\n    /// 进程名（例如 `WeChat.exe`）。\n    pub name: String,\n    /// 代表性 PID（用于展示）。\n    pub pid: u32,\n    /// 可执行文件路径（若可获取）。\n    pub exe_path: Option\u003cString\u003e,\n    /// 进程图标（data URL：`data:image/png;base64,...`）。\n    pub icon_data_url: Option\u003cString\u003e,\n}\n\n/// 内部用的“进程快照”条目（用于将 sysinfo 结果转为可测试的纯数据流）。\n#[derive(Debug, Clone)]\nstruct ProcessEntry {\n    /// 进程名。\n    name: String,\n    /// PID。\n    pid: u32,\n    /// 可执行文件路径。\n    exe_path: Option\u003cString\u003e,\n}\n\n/// 获取当前运行进程列表（按进程名去重并按名称排序）。\npub fn list_processes() -\u003e AppResult\u003cVec\u003cProcessInfo\u003e\u003e {\n    let mut system = System::new_all();\n    system.refresh_all();\n\n    let entries = system.processes().iter().map(|(pid, process)| {\n        let exe_path = process.exe().and_then(|p| {\n            if p.as_os_str().is_empty() {\n                None\n            } else {\n                Some(p.to_string_lossy().to_string())\n            }\n        });\n        ProcessEntry {\n            name: process.name().to_string(),\n            pid: pid.as_u32(),\n            exe_path,\n        }\n    });\n\n    Ok(list_processes_from_entries(entries))\n}\n\n/// 将“进程快照”条目列表转为前端展示用 `ProcessInfo`（去重、排序、图标 best-effort）。\nfn list_processes_from_entries(entries: impl IntoIterator\u003cItem = ProcessEntry\u003e) -\u003e Vec\u003cProcessInfo\u003e {\n    let mut by_name: BTreeMap\u003cString, ProcessInfo\u003e = BTreeMap::new();\n\n    for entry in entries {\n        let exe_path = entry.exe_path.and_then(|p| {\n            if p.trim().is_empty() {\n                None\n            } else {\n                Some(p)\n            }\n        });\n\n        by_name.entry(entry.name.clone()).or_insert_with(|| ProcessInfo {\n            name: entry.name,\n            pid: entry.pid,\n            exe_path: exe_path.clone(),\n            icon_data_url: exe_path\n                .as_deref()\n                .and_then(|p| icon_data_url_best_effort(p).ok().flatten()),\n        });\n    }\n\n    by_name.into_values().collect()\n}\n\n/// 将可执行文件路径转为图标 data URL（失败时返回 `Ok(None)`）。\nfn icon_data_url_best_effort(exe_path: \u0026str) -\u003e AppResult\u003cOption\u003cString\u003e\u003e {\n    #[cfg(windows)]\n    {\n        use base64::Engine as _;\n        use std::path::Path;\n        let png = extract_exe_icon_png(Path::new(exe_path), 32)?;\n        Ok(Some(format!(\n            \"data:image/png;base64,{}\",\n            base64::engine::general_purpose::STANDARD.encode(png)\n        )))\n    }\n\n    #[cfg(not(windows))]\n    {\n        let _ = exe_path;\n        Ok(None)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `list_processes_from_entries`：应按名称去重并按名称排序。\n    #[test]\n    fn list_processes_dedupes_and_sorts_by_name() {\n        let entries = vec![\n            ProcessEntry {\n                name: \"b.exe\".to_string(),\n                pid: 2,\n                exe_path: Some(\"/bin/b\".to_string()),\n            },\n            ProcessEntry {\n                name: \"a.exe\".to_string(),\n                pid: 1,\n                exe_path: Some(\"/bin/a\".to_string()),\n            },\n            // 重复名称：应保留第一次插入的 pid/exe_path\n            ProcessEntry {\n                name: \"a.exe\".to_string(),\n                pid: 999,\n                exe_path: Some(\"/bin/a2\".to_string()),\n            },\n        ];\n\n        let out = list_processes_from_entries(entries);\n        assert_eq!(out.len(), 2);\n        assert_eq!(out[0].name, \"a.exe\");\n        assert_eq!(out[0].pid, 1);\n        assert_eq!(out[0].exe_path.as_deref(), Some(\"/bin/a\"));\n        assert_eq!(out[1].name, \"b.exe\");\n    }\n\n    /// `list_processes_from_entries`：空 exe_path 应规范化为 None，避免 UI 展示异常。\n    #[test]\n    fn list_processes_normalizes_empty_exe_path() {\n        let entries = vec![ProcessEntry {\n            name: \"a.exe\".to_string(),\n            pid: 1,\n            exe_path: Some(\"\".to_string()),\n        }];\n\n        let out = list_processes_from_entries(entries);\n        assert_eq!(out.len(), 1);\n        assert!(out[0].exe_path.is_none());\n        #[cfg(not(windows))]\n        assert!(out[0].icon_data_url.is_none());\n    }\n}\n\n/// Windows：从 exe 路径提取小图标并编码为 PNG（32x32）。\n#[cfg(windows)]\nfn extract_exe_icon_png(exe_path: \u0026std::path::Path, size: i32) -\u003e AppResult\u003cVec\u003cu8\u003e\u003e {\n    use image::{ImageBuffer, Rgba};\n    use windows::core::PCWSTR;\n    use windows::Win32::Foundation::HANDLE;\n    use windows::Win32::Graphics::Gdi::{\n        CreateCompatibleDC, CreateDIBSection, DeleteDC, DeleteObject, GetDIBits, SelectObject,\n        BITMAPINFO, BITMAPINFOHEADER, BI_RGB, DIB_RGB_COLORS, HBITMAP, HBRUSH, HDC, HGDIOBJ,\n        RGBQUAD,\n    };\n    use windows::Win32::Storage::FileSystem::FILE_FLAGS_AND_ATTRIBUTES;\n    use windows::Win32::UI::Shell::{SHGetFileInfoW, SHFILEINFOW, SHGFI_ICON, SHGFI_SMALLICON};\n    use windows::Win32::UI::WindowsAndMessaging::{DestroyIcon, DrawIconEx, DI_NORMAL};\n\n    /// 图标句柄守卫：确保 `DestroyIcon` 被调用。\n    struct IconGuard(windows::Win32::UI::WindowsAndMessaging::HICON);\n    impl Drop for IconGuard {\n        /// 释放图标句柄。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = DestroyIcon(self.0);\n            }\n        }\n    }\n\n    /// DC 句柄守卫：确保 `DeleteDC` 被调用。\n    struct DcGuard(HDC);\n    impl Drop for DcGuard {\n        /// 释放 DC。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = DeleteDC(self.0);\n            }\n        }\n    }\n\n    /// 位图句柄守卫：确保 `DeleteObject` 被调用。\n    struct BitmapGuard(HBITMAP);\n    impl Drop for BitmapGuard {\n        /// 释放位图句柄。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = DeleteObject(self.0);\n            }\n        }\n    }\n\n    let wide = to_wide_null(exe_path.to_string_lossy().as_ref());\n    let mut shfi = SHFILEINFOW::default();\n\n    unsafe {\n        let ok = SHGetFileInfoW(\n            PCWSTR(wide.as_ptr()),\n            FILE_FLAGS_AND_ATTRIBUTES(0),\n            Some(\u0026mut shfi as *mut SHFILEINFOW),\n            std::mem::size_of::\u003cSHFILEINFOW\u003e() as u32,\n            SHGFI_ICON | SHGFI_SMALLICON,\n        );\n        if ok == 0 {\n            return Err(AppError::Invariant(\"提取图标失败（SHGetFileInfoW 返回 0）\".to_string()));\n        }\n\n        let hicon = shfi.hIcon;\n        if hicon.0.is_null() {\n            return Err(AppError::Invariant(\"提取图标失败（HICON 为空）\".to_string()));\n        }\n        let icon = IconGuard(hicon);\n\n        let dc: HDC = CreateCompatibleDC(HDC(std::ptr::null_mut()));\n        if dc.0.is_null() {\n            return Err(AppError::Invariant(\"CreateCompatibleDC 失败\".to_string()));\n        }\n        let dc = DcGuard(dc);\n\n        let mut bmi = BITMAPINFO {\n            bmiHeader: BITMAPINFOHEADER {\n                biSize: std::mem::size_of::\u003cBITMAPINFOHEADER\u003e() as u32,\n                biWidth: size,\n                biHeight: -size,\n                biPlanes: 1,\n                biBitCount: 32,\n                biCompression: BI_RGB.0 as u32,\n                biSizeImage: 0,\n                biXPelsPerMeter: 0,\n                biYPelsPerMeter: 0,\n                biClrUsed: 0,\n                biClrImportant: 0,\n            },\n            bmiColors: [RGBQUAD::default(); 1],\n        };\n\n        let mut bits: *mut core::ffi::c_void = std::ptr::null_mut();\n        let hbmp: HBITMAP = CreateDIBSection(\n            dc.0,\n            \u0026bmi,\n            DIB_RGB_COLORS,\n            \u0026mut bits,\n            HANDLE(std::ptr::null_mut()),\n            0,\n        )\n        .map_err(|e| AppError::Invariant(format!(\"CreateDIBSection 失败（{e:?}）\")))?;\n\n        if hbmp.0.is_null() || bits.is_null() {\n            return Err(AppError::Invariant(\"CreateDIBSection 失败（句柄/像素指针为空）\".to_string()));\n        }\n        let hbmp = BitmapGuard(hbmp);\n\n        let old: HGDIOBJ = SelectObject(dc.0, hbmp.0);\n        let _ = DrawIconEx(\n            dc.0,\n            0,\n            0,\n            icon.0,\n            size,\n            size,\n            0,\n            HBRUSH(std::ptr::null_mut()),\n            DI_NORMAL,\n        );\n\n        let mut buf = vec![0u8; (size * size * 4) as usize];\n        let scanlines = GetDIBits(\n            dc.0,\n            hbmp.0,\n            0,\n            size as u32,\n            Some(buf.as_mut_ptr() as *mut core::ffi::c_void),\n            \u0026mut bmi,\n            DIB_RGB_COLORS,\n        );\n\n        // 恢复旧对象，避免 DC 状态污染。\n        let _ = SelectObject(dc.0, old);\n\n        if scanlines == 0 {\n            return Err(AppError::Invariant(\"GetDIBits 失败\".to_string()));\n        }\n\n        // Windows DIB 为 BGRA，这里转为 RGBA。\n        for px in buf.chunks_exact_mut(4) {\n            px.swap(0, 2);\n        }\n\n        let img: ImageBuffer\u003cRgba\u003cu8\u003e, _\u003e = ImageBuffer::from_raw(size as u32, size as u32, buf)\n            .ok_or_else(|| AppError::Invariant(\"从像素缓冲构建图像失败\".to_string()))?;\n\n        let mut png: Vec\u003cu8\u003e = Vec::new();\n        img.write_to(\u0026mut std::io::Cursor::new(\u0026mut png), image::ImageFormat::Png)\n            .map_err(|e| AppError::Invariant(format!(\"PNG 编码失败：{e}\")))?;\n\n        // 通过 Drop 自动清理：hbmp/dc/icon。\n        let _ = (hbmp, dc, icon);\n\n        Ok(png)\n    }\n}\n\n/// Windows：将 `\u0026str` 转为以 `\\\\0` 结尾的 UTF-16。\n#[cfg(windows)]\nfn to_wide_null(s: \u0026str) -\u003e Vec\u003cu16\u003e {\n    use std::os::windows::ffi::OsStrExt;\n    std::ffi::OsStr::new(s)\n        .encode_wide()\n        .chain(Some(0))\n        .collect()\n}\n","traces":[{"line":40,"address":[27798736,27798988,27798994],"length":1,"stats":{"Line":0}},{"line":41,"address":[27798753],"length":1,"stats":{"Line":0}},{"line":42,"address":[27798777],"length":1,"stats":{"Line":0}},{"line":44,"address":[27798829],"length":1,"stats":{"Line":0}},{"line":45,"address":[28344096,28343787,28344331,28344325],"length":1,"stats":{"Line":0}},{"line":46,"address":[28344149,28344233],"length":1,"stats":{"Line":0}},{"line":47,"address":[28344220],"length":1,"stats":{"Line":0}},{"line":49,"address":[28344275,28344189],"length":1,"stats":{"Line":0}},{"line":52,"address":[28344006],"length":1,"stats":{"Line":0}},{"line":53,"address":[28343814,28343886],"length":1,"stats":{"Line":0}},{"line":54,"address":[28343907],"length":1,"stats":{"Line":0}},{"line":55,"address":[28343976],"length":1,"stats":{"Line":0}},{"line":59,"address":[27798909],"length":1,"stats":{"Line":0}},{"line":63,"address":[28347187,28347144,28346284,28345424,28346241,28346304],"length":1,"stats":{"Line":1}},{"line":64,"address":[28346325,28345446],"length":1,"stats":{"Line":1}},{"line":66,"address":[28347139,28346502,28346414,28346599,28346236,28345536,28345706,28345636],"length":1,"stats":{"Line":4}},{"line":67,"address":[28348408,28345819,28346712,28348144,28347216,28347480],"length":1,"stats":{"Line":2}},{"line":68,"address":[28347243,28348171,28347430,28348243,28347315,28348358],"length":1,"stats":{"Line":3}},{"line":69,"address":[28348365,28347437],"length":1,"stats":{"Line":1}},{"line":71,"address":[28347373,28348301],"length":1,"stats":{"Line":1}},{"line":75,"address":[28347010,28347801,28346921,28347504,28348121,28346107,28347710,28348030,28346018,28347824],"length":1,"stats":{"Line":4}},{"line":76,"address":[28347846,28347526],"length":1,"stats":{"Line":1}},{"line":77,"address":[28347543,28347551,28347863,28347871],"length":1,"stats":{"Line":2}},{"line":78,"address":[28347547,28347877,28347557,28347867],"length":1,"stats":{"Line":2}},{"line":79,"address":[28347936,28347616],"length":1,"stats":{"Line":1}},{"line":80,"address":[28347940,28347620],"length":1,"stats":{"Line":1}},{"line":81,"address":[28347689,28348512,28348009,28348432,28348535,28348455],"length":1,"stats":{"Line":3}},{"line":85,"address":[28346782,28345879],"length":1,"stats":{"Line":1}},{"line":89,"address":[27799008],"length":1,"stats":{"Line":1}},{"line":104,"address":[27799021],"length":1,"stats":{"Line":1}}],"covered":17,"coverable":30},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","processes","mod.rs"],"content":"//! Windows 进程列表与终止逻辑（专注模式核心能力）。\n\nmod enumeration;\npub(crate) mod termination;\n\npub use enumeration::{list_processes, ProcessInfo};\npub use termination::{kill_names_best_effort, KillSummary};\n\n/// 向前端广播“终止黑名单进程结果”的事件名。\npub const EVENT_KILL_RESULT: \u0026str = \"pomodoro://kill_result\";\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","processes","termination.rs"],"content":"//! 进程终止与权限检测（用于专注模式自动清理干扰程序）。\n\nuse serde::{Deserialize, Serialize};\nuse sysinfo::System;\nuse ts_rs::TS;\n\n#[cfg(windows)]\nuse crate::errors::AppError;\nuse crate::errors::AppResult;\n\n/// 单个进程名的终止结果。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct KillItem {\n    /// 进程名。\n    pub name: String,\n    /// 尝试终止的 PID 列表。\n    pub pids: Vec\u003cu32\u003e,\n    /// 成功数量。\n    pub killed: u32,\n    /// 失败数量。\n    pub failed: u32,\n    /// 是否存在“需要管理员权限”导致的失败。\n    pub requires_admin: bool,\n}\n\n/// 一次批量终止的汇总结果。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct KillSummary {\n    /// 各进程名的明细。\n    pub items: Vec\u003cKillItem\u003e,\n    /// 是否有任何条目需要管理员权限。\n    pub requires_admin: bool,\n}\n\n/// 终止所有匹配 `process_name` 的进程（返回可用于 UI 展示的汇总结果）。\nfn kill_by_name(process_name: \u0026str) -\u003e AppResult\u003cKillSummary\u003e {\n    tracing::debug!(target: \"blacklist\", \"尝试终止进程：{}\", process_name);\n    let mut system = System::new_all();\n    system.refresh_all();\n\n    let mut items: Vec\u003cKillItem\u003e = Vec::new();\n    let mut any_requires_admin = false;\n\n    let mut pids: Vec\u003cu32\u003e = system\n        .processes()\n        .iter()\n        .filter_map(|(pid, p)| {\n            if eq_process_name(p.name(), process_name) {\n                Some(pid.as_u32())\n            } else {\n                None\n            }\n        })\n        .collect();\n\n    pids.sort_unstable();\n\n    if pids.is_empty() {\n        tracing::debug!(target: \"blacklist\", \"未找到匹配进程：{}\", process_name);\n        return Ok(KillSummary {\n            items: vec![KillItem {\n                name: process_name.to_string(),\n                pids,\n                killed: 0,\n                failed: 0,\n                requires_admin: false,\n            }],\n            requires_admin: false,\n        });\n    }\n\n    let mut killed = 0u32;\n    let mut failed = 0u32;\n    #[cfg(windows)]\n    let mut requires_admin = false;\n    #[cfg(not(windows))]\n    let requires_admin = false;\n\n    for pid in \u0026pids {\n        match kill_pid(*pid) {\n            Ok(true) =\u003e killed += 1,\n            Ok(false) =\u003e {\n                failed += 1;\n            }\n            #[cfg(windows)]\n            Err(AppError::KillFailed(msg)) =\u003e {\n                failed += 1;\n                if msg.contains(\"ACCESS_DENIED\") || msg.contains(\"权限\") {\n                    requires_admin = true;\n                }\n            }\n            Err(e) =\u003e return Err(e),\n        }\n    }\n\n    any_requires_admin |= requires_admin;\n    items.push(KillItem {\n        name: process_name.to_string(),\n        pids,\n        killed,\n        failed,\n        requires_admin,\n    });\n\n    if failed \u003e 0 {\n        tracing::warn!(\n            target: \"blacklist\",\n            \"终止进程存在失败：name={} killed={} failed={} requiresAdmin={}\",\n            process_name,\n            killed,\n            failed,\n            requires_admin\n        );\n    } else {\n        tracing::info!(\n            target: \"blacklist\",\n            \"终止进程成功：name={} killed={}\",\n            process_name,\n            killed\n        );\n    }\n\n    Ok(KillSummary {\n        items,\n        requires_admin: any_requires_admin,\n    })\n}\n\n/// 批量终止若干进程名（best-effort）：忽略单个名称的错误并合并为一次汇总结果。\npub fn kill_names_best_effort(names: \u0026[String]) -\u003e KillSummary {\n    kill_names_best_effort_with(names, |name| kill_by_name(name))\n}\n\n/// `kill_names_best_effort` 的可注入实现：便于在单元测试中 mock `kill_by_name`。\nfn kill_names_best_effort_with(\n    names: \u0026[String],\n    mut kill_by_name_fn: impl FnMut(\u0026str) -\u003e AppResult\u003cKillSummary\u003e,\n) -\u003e KillSummary {\n    if names.is_empty() {\n        return KillSummary {\n            items: Vec::new(),\n            requires_admin: false,\n        };\n    }\n\n    let mut all_items = Vec::new();\n    let mut requires_admin = false;\n\n    for name in names {\n        if let Ok(summary) = kill_by_name_fn(name) {\n            requires_admin |= summary.requires_admin;\n            all_items.extend(summary.items);\n        }\n    }\n\n    KillSummary {\n        items: all_items,\n        requires_admin,\n    }\n}\n\n/// 以 PID 终止进程（返回是否成功）。\nfn kill_pid(pid: u32) -\u003e AppResult\u003cbool\u003e {\n    #[cfg(windows)]\n    {\n        kill_pid_windows(pid)\n    }\n\n    #[cfg(not(windows))]\n    {\n        kill_pid_fallback(pid)\n    }\n}\n\n/// 非 Windows 平台的兜底终止实现（用于开发环境）。\n#[cfg(not(windows))]\nfn kill_pid_fallback(pid: u32) -\u003e AppResult\u003cbool\u003e {\n    let mut system = System::new_all();\n    system.refresh_all();\n    let Some(process) = system.process(sysinfo::Pid::from_u32(pid)) else {\n        return Ok(false);\n    };\n    Ok(process.kill())\n}\n\n/// Windows 平台：通过 Win32 API 强制终止指定 PID。\n#[cfg(windows)]\nfn kill_pid_windows(pid: u32) -\u003e AppResult\u003cbool\u003e {\n    use windows::Win32::Foundation::CloseHandle;\n    use windows::Win32::System::Threading::{OpenProcess, TerminateProcess, PROCESS_TERMINATE};\n\n    /// 进程句柄守卫：确保 `CloseHandle` 被调用。\n    struct HandleGuard(windows::Win32::Foundation::HANDLE);\n    impl Drop for HandleGuard {\n        /// 释放进程句柄。\n        fn drop(\u0026mut self) {\n            unsafe {\n                let _ = CloseHandle(self.0);\n            }\n        }\n    }\n\n    unsafe {\n        let handle = OpenProcess(PROCESS_TERMINATE, false, pid).map_err(|e| {\n            AppError::KillFailed(format!(\n                \"OpenProcess 失败（{e:?}）ACCESS_DENIED 可能需要管理员权限\"\n            ))\n        })?;\n        let handle = HandleGuard(handle);\n\n        let result = TerminateProcess(handle.0, 1).map(|_| true).map_err(|e| {\n            AppError::KillFailed(format!(\n                \"TerminateProcess 失败（{e:?}）ACCESS_DENIED 可能需要管理员权限\"\n            ))\n        });\n\n        result\n    }\n}\n\n/// 进程名对比（Windows 下不区分大小写）。\nfn eq_process_name(a: \u0026str, b: \u0026str) -\u003e bool {\n    if cfg!(windows) {\n        a.eq_ignore_ascii_case(b)\n    } else {\n        a == b\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// `kill_names_best_effort_with`：空列表应返回空结果。\n    #[test]\n    fn kill_names_best_effort_handles_empty_list() {\n        let out = kill_names_best_effort_with(\u0026[], |_name| unreachable!(\"不应被调用\"));\n        assert!(out.items.is_empty());\n        assert!(!out.requires_admin);\n    }\n\n    /// `kill_names_best_effort_with`：应合并多个名称的汇总结果，并忽略单个名称的错误。\n    #[test]\n    fn kill_names_best_effort_merges_and_ignores_errors() {\n        let names = vec![\"a.exe\".to_string(), \"b.exe\".to_string(), \"bad.exe\".to_string()];\n        let out = kill_names_best_effort_with(\u0026names, |name| {\n            if name == \"bad.exe\" {\n                return Err(crate::errors::AppError::Invariant(\"boom\".to_string()));\n            }\n            Ok(KillSummary {\n                items: vec![KillItem {\n                    name: name.to_string(),\n                    pids: vec![1],\n                    killed: 1,\n                    failed: 0,\n                    requires_admin: name == \"b.exe\",\n                }],\n                requires_admin: name == \"b.exe\",\n            })\n        });\n\n        assert_eq!(out.items.len(), 2);\n        assert!(out.items.iter().any(|it| it.name == \"a.exe\"));\n        assert!(out.items.iter().any(|it| it.name == \"b.exe\"));\n        assert!(out.requires_admin);\n    }\n\n    /// `eq_process_name`：非 Windows 下应大小写敏感；Windows 下应忽略大小写。\n    #[test]\n    #[cfg(not(windows))]\n    fn eq_process_name_is_case_sensitive_on_non_windows() {\n        assert!(eq_process_name(\"WeChat.exe\", \"WeChat.exe\"));\n        assert!(!eq_process_name(\"WeChat.exe\", \"wechat.exe\"));\n    }\n\n    /// `eq_process_name`：Windows 下应忽略 ASCII 大小写。\n    #[test]\n    #[cfg(windows)]\n    fn eq_process_name_is_case_insensitive_on_windows() {\n        assert!(eq_process_name(\"WeChat.exe\", \"wechat.exe\"));\n        assert!(eq_process_name(\"WECHAT.EXE\", \"wechat.exe\"));\n    }\n}\n","traces":[{"line":40,"address":[32386464,32386497,32382224],"length":1,"stats":{"Line":0}},{"line":41,"address":[32382490,32382263],"length":1,"stats":{"Line":0}},{"line":42,"address":[32382443],"length":1,"stats":{"Line":0}},{"line":43,"address":[32382476],"length":1,"stats":{"Line":0}},{"line":45,"address":[32382822],"length":1,"stats":{"Line":0}},{"line":46,"address":[32382829],"length":1,"stats":{"Line":0}},{"line":51,"address":[31046344,31046304],"length":1,"stats":{"Line":0}},{"line":52,"address":[31046354,31046395],"length":1,"stats":{"Line":0}},{"line":53,"address":[31046402],"length":1,"stats":{"Line":0}},{"line":55,"address":[31046387],"length":1,"stats":{"Line":0}},{"line":60,"address":[32383086,32382994],"length":1,"stats":{"Line":0}},{"line":62,"address":[32383093],"length":1,"stats":{"Line":0}},{"line":63,"address":[32385358,32385606,32383193],"length":1,"stats":{"Line":0}},{"line":64,"address":[32386287],"length":1,"stats":{"Line":0}},{"line":65,"address":[32385908,32385591,32386470,32385857,32385996],"length":1,"stats":{"Line":0}},{"line":66,"address":[32385865],"length":1,"stats":{"Line":0}},{"line":67,"address":[32385940],"length":1,"stats":{"Line":0}},{"line":76,"address":[32383132],"length":1,"stats":{"Line":0}},{"line":77,"address":[32383143],"length":1,"stats":{"Line":0}},{"line":81,"address":[32383154],"length":1,"stats":{"Line":0}},{"line":83,"address":[32383170,32383240],"length":1,"stats":{"Line":0}},{"line":84,"address":[32385208,32383346,32385126],"length":1,"stats":{"Line":0}},{"line":85,"address":[32385302,32385240],"length":1,"stats":{"Line":0}},{"line":86,"address":[32385273],"length":1,"stats":{"Line":0}},{"line":87,"address":[32385278,32385266,32385218],"length":1,"stats":{"Line":0}},{"line":96,"address":[32385154],"length":1,"stats":{"Line":0}},{"line":100,"address":[32383366],"length":1,"stats":{"Line":0}},{"line":101,"address":[32383480],"length":1,"stats":{"Line":0}},{"line":102,"address":[32383391],"length":1,"stats":{"Line":0}},{"line":103,"address":[32383426],"length":1,"stats":{"Line":0}},{"line":104,"address":[32383466],"length":1,"stats":{"Line":0}},{"line":105,"address":[32383473],"length":1,"stats":{"Line":0}},{"line":109,"address":[32383595],"length":1,"stats":{"Line":0}},{"line":110,"address":[32383633,32384457],"length":1,"stats":{"Line":0}},{"line":119,"address":[32383605,32384139,32383671],"length":1,"stats":{"Line":0}},{"line":127,"address":[32383999],"length":1,"stats":{"Line":0}},{"line":128,"address":[32383944],"length":1,"stats":{"Line":0}},{"line":129,"address":[32383992],"length":1,"stats":{"Line":0}},{"line":134,"address":[32386880],"length":1,"stats":{"Line":0}},{"line":135,"address":[31048608,31048661],"length":1,"stats":{"Line":0}},{"line":139,"address":[31050223,31049488,31048762,31050362,31050288,31048688,31049562,31051023,31049423],"length":1,"stats":{"Line":2}},{"line":143,"address":[31050401,31048747,31048801,31049547,31049601,31050347],"length":1,"stats":{"Line":4}},{"line":144,"address":[31051052,31049452,31050252],"length":1,"stats":{"Line":1}},{"line":145,"address":[31050424,31048824,31049624],"length":1,"stats":{"Line":1}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[31050412,31048812,31049612],"length":1,"stats":{"Line":1}},{"line":151,"address":[31048844,31049644,31050444],"length":1,"stats":{"Line":1}},{"line":153,"address":[31049652,31050517,31048917,31050452,31049717,31048852],"length":1,"stats":{"Line":2}},{"line":154,"address":[31049165,31050837,31050037,31049237,31049017,31049817,31049965,31050765,31050617],"length":1,"stats":{"Line":3}},{"line":155,"address":[31049269,31050069,31050869],"length":1,"stats":{"Line":1}},{"line":156,"address":[31050200,31049400,31051000,31050094,31050894,31049294],"length":1,"stats":{"Line":2}},{"line":167,"address":[32386928],"length":1,"stats":{"Line":0}},{"line":175,"address":[32386944],"length":1,"stats":{"Line":0}},{"line":181,"address":[32386858,32386560,32386864],"length":1,"stats":{"Line":0}},{"line":182,"address":[32386588],"length":1,"stats":{"Line":0}},{"line":183,"address":[32386612],"length":1,"stats":{"Line":0}},{"line":184,"address":[32386668],"length":1,"stats":{"Line":0}},{"line":185,"address":[32386788],"length":1,"stats":{"Line":0}},{"line":187,"address":[32386821,32386768],"length":1,"stats":{"Line":0}},{"line":226,"address":[32386512],"length":1,"stats":{"Line":1}},{"line":230,"address":[32386536],"length":1,"stats":{"Line":1}}],"covered":12,"coverable":61},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","state.rs"],"content":"//! 应用后端全局状态（持久化数据 + 计时器运行态 + 托盘句柄）。\n\nuse std::sync::Mutex;\n\nuse tauri::Emitter as _;\n\nuse crate::app_data::{AppData, STORE_KEY};\nuse crate::errors::{AppError, AppResult};\nuse crate::timer::{TickResult, TimerRuntime, TimerSnapshot, WorkCompletedEvent};\nuse crate::tray::TrayHandles;\n\n/// 后端全局状态（通过 `app.manage(...)` 注入 Tauri State）。\npub struct AppState {\n    app: tauri::AppHandle,\n    store: std::sync::Arc\u003ctauri_plugin_store::Store\u003ctauri::Wry\u003e\u003e,\n    data: Mutex\u003cAppData\u003e,\n    timer: Mutex\u003cTimerRuntime\u003e,\n    tray: Mutex\u003cOption\u003cTrayHandles\u003e\u003e,\n    window_mode: Mutex\u003cWindowModeState\u003e,\n}\n\n/// 窗口模式运行态（用于迷你模式恢复窗口大小/位置）。\n#[derive(Debug, Clone, Default)]\npub struct WindowModeState {\n    /// 是否处于迷你模式。\n    pub mini_mode: bool,\n    /// 进入迷你模式前的窗口尺寸（逻辑像素）。\n    pub prev_size: Option\u003c(u32, u32)\u003e,\n    /// 进入迷你模式前的窗口位置（逻辑像素）。\n    pub prev_position: Option\u003c(i32, i32)\u003e,\n}\n\nimpl AppState {\n    /// 创建应用状态并初始化计时器为“工作阶段 + 默认时长”。\n    pub fn new(\n        app: tauri::AppHandle,\n        store: std::sync::Arc\u003ctauri_plugin_store::Store\u003ctauri::Wry\u003e\u003e,\n        data: AppData,\n    ) -\u003e Self {\n        let clock = crate::timer::SystemClock;\n        let timer = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        Self {\n            app,\n            store,\n            data: Mutex::new(data),\n            timer: Mutex::new(timer),\n            tray: Mutex::new(None),\n            window_mode: Mutex::new(WindowModeState::default()),\n        }\n    }\n\n    /// 读取一份 `AppData` 的快照（用于向前端返回）。\n    pub fn data_snapshot(\u0026self) -\u003e AppData {\n        self.data.lock().unwrap().clone()\n    }\n\n    /// 获取计时器运行态快照（用于前端渲染/托盘刷新）。\n    pub fn timer_snapshot(\u0026self) -\u003e TimerSnapshot {\n        let data = self.data.lock().unwrap();\n        let timer = self.timer.lock().unwrap();\n        timer.snapshot(\u0026data)\n    }\n\n    /// 设置托盘句柄，供后续更新图标/菜单。\n    pub fn set_tray(\u0026self, tray: TrayHandles) {\n        *self.tray.lock().unwrap() = Some(tray);\n    }\n\n    /// 获取托盘句柄（若未创建则为 `None`）。\n    pub fn tray(\u0026self) -\u003e Option\u003cTrayHandles\u003e {\n        self.tray.lock().unwrap().clone()\n    }\n\n    /// 获取窗口模式状态快照（用于命令内部决策）。\n    pub fn window_mode_snapshot(\u0026self) -\u003e WindowModeState {\n        self.window_mode.lock().unwrap().clone()\n    }\n\n    /// 原子更新窗口模式状态（不持久化）。\n    pub fn update_window_mode(\n        \u0026self,\n        f: impl FnOnce(\u0026mut WindowModeState) -\u003e AppResult\u003c()\u003e,\n    ) -\u003e AppResult\u003c()\u003e {\n        let mut mode = self.window_mode.lock().unwrap();\n        f(\u0026mut mode)\n    }\n\n    /// 原子更新：修改数据并持久化到 store。\n    pub fn update_data(\u0026self, f: impl FnOnce(\u0026mut AppData) -\u003e AppResult\u003c()\u003e) -\u003e AppResult\u003c()\u003e {\n        let mut data = self.data.lock().unwrap();\n        f(\u0026mut data)?;\n        self.persist_locked(\u0026data)\n    }\n\n    /// 修改计时器运行态（不会持久化）。\n    pub fn update_timer(\n        \u0026self,\n        f: impl FnOnce(\u0026mut TimerRuntime, \u0026AppData) -\u003e AppResult\u003c()\u003e,\n    ) -\u003e AppResult\u003c()\u003e {\n        let data = self.data.lock().unwrap();\n        let mut timer = self.timer.lock().unwrap();\n        f(\u0026mut timer, \u0026data)\n    }\n\n    /// 同时修改 `AppData` 与 `TimerRuntime`（需要时可持久化）。\n    pub fn update_data_and_timer\u003cT\u003e(\n        \u0026self,\n        f: impl FnOnce(\u0026mut AppData, \u0026mut TimerRuntime) -\u003e AppResult\u003cT\u003e,\n        persist: bool,\n    ) -\u003e AppResult\u003cT\u003e {\n        let mut data = self.data.lock().unwrap();\n        let mut timer = self.timer.lock().unwrap();\n        let out = f(\u0026mut data, \u0026mut timer)?;\n        if persist {\n            self.persist_locked(\u0026data)?;\n        }\n        Ok(out)\n    }\n\n    /// 推送当前计时器快照事件给前端。\n    pub fn emit_timer_snapshot(\u0026self) -\u003e AppResult\u003c()\u003e {\n        self.app\n            .emit(crate::timer::EVENT_SNAPSHOT, self.timer_snapshot())?;\n        Ok(())\n    }\n\n    /// 推送进程终止结果事件给前端。\n    pub fn emit_kill_result(\u0026self, payload: crate::processes::KillSummary) -\u003e AppResult\u003c()\u003e {\n        self.app\n            .emit(crate::processes::EVENT_KILL_RESULT, payload)?;\n        Ok(())\n    }\n\n    /// 推送“工作阶段完成并写入历史”的事件给前端。\n    pub fn emit_work_completed(\u0026self, payload: WorkCompletedEvent) -\u003e AppResult\u003c()\u003e {\n        self.app.emit(crate::timer::EVENT_WORK_COMPLETED, payload)?;\n        Ok(())\n    }\n\n    /// 推送一个“无结构负载”的简单事件给前端（用于提示 UI 刷新）。\n    pub fn emit_simple_event(\u0026self, event: \u0026str) -\u003e AppResult\u003c()\u003e {\n        self.app.emit(event, true)?;\n        Ok(())\n    }\n\n    /// 执行一次 tick：若计时器运行中则可能写入历史并持久化。\n    pub fn tick(\u0026self) -\u003e AppResult\u003cTickResult\u003e {\n        let mut data = self.data.lock().unwrap();\n        let mut timer = self.timer.lock().unwrap();\n        let clock = crate::timer::SystemClock;\n        let notifier = crate::timer::TauriNotifier::new(\u0026self.app);\n        let result = timer.tick(\u0026mut data, \u0026clock, \u0026notifier)?;\n        if result.history_changed {\n            self.persist_locked(\u0026data)?;\n        }\n        if let Some(payload) = result.work_completed_event.clone() {\n            let _ = self.emit_work_completed(payload);\n        }\n        Ok(result)\n    }\n\n    /// 持久化 `AppData` 到 store（要求调用方已持有锁，避免重复锁）。\n    fn persist_locked(\u0026self, data: \u0026AppData) -\u003e AppResult\u003c()\u003e {\n        self.store.set(\n            STORE_KEY,\n            serde_json::to_value(data).map_err(AppError::from)?,\n        );\n        self.store.save()?;\n        tracing::debug!(target: \"storage\", \"数据已持久化到 store\");\n        Ok(())\n    }\n\n    /// 判断计时器是否运行中（给托盘菜单逻辑使用）。\n    pub fn is_running(\u0026self) -\u003e bool {\n        self.timer.lock().unwrap().is_running\n    }\n}\n","traces":[{"line":35,"address":[27764839,27764737,27763872],"length":1,"stats":{"Line":0}},{"line":40,"address":[27763912],"length":1,"stats":{"Line":0}},{"line":41,"address":[27763968,27764064],"length":1,"stats":{"Line":0}},{"line":45,"address":[27764165],"length":1,"stats":{"Line":0}},{"line":46,"address":[27764253],"length":1,"stats":{"Line":0}},{"line":47,"address":[27764411],"length":1,"stats":{"Line":0}},{"line":48,"address":[27764551,27764491],"length":1,"stats":{"Line":0}},{"line":53,"address":[27761768,27761774,27761616],"length":1,"stats":{"Line":0}},{"line":54,"address":[27761635,27761741],"length":1,"stats":{"Line":0}},{"line":58,"address":[27762943,27762624,27762937],"length":1,"stats":{"Line":0}},{"line":59,"address":[27762654],"length":1,"stats":{"Line":0}},{"line":60,"address":[27762766,27762710],"length":1,"stats":{"Line":0}},{"line":61,"address":[27762870,27762819],"length":1,"stats":{"Line":0}},{"line":65,"address":[27766593,27766208],"length":1,"stats":{"Line":0}},{"line":66,"address":[27766228,27766574],"length":1,"stats":{"Line":0}},{"line":70,"address":[27766190,27766032,27766184],"length":1,"stats":{"Line":0}},{"line":71,"address":[27766157,27766051],"length":1,"stats":{"Line":0}},{"line":75,"address":[27763848,27763696,27763854],"length":1,"stats":{"Line":0}},{"line":76,"address":[27763821,27763715],"length":1,"stats":{"Line":0}},{"line":80,"address":[30022544,30022799,30022516,30022510,30022208,30023065,30021872,30022180,30022793,30023071,30022816,30022174],"length":1,"stats":{"Line":0}},{"line":84,"address":[30022629,30021917,30021989,30022253,30022325,30022835,30022901,30022563],"length":1,"stats":{"Line":0}},{"line":85,"address":[30022037,30022400,30022975,30022172,30022791,30022508,30023063,30022064,30022703,30022373,30022677,30022949],"length":1,"stats":{"Line":0}},{"line":89,"address":[52369224],"length":1,"stats":{"Line":0}},{"line":90,"address":[30020911,30019202,30020264,30016311,30018011,30018655,30019772,30019688,30020827,30019118,30016940,30018095,30016856,30017411,30020348,30017495,30016227,30018571],"length":1,"stats":{"Line":0}},{"line":91,"address":[30017933,30017021,30019853,30020429,30020992,30018736,30019994,30019414,30021317,30017549,30019061,30020396,30017162,30016757,30018176,30018312,30017349,30016560,30018703,30019250,30018872,30017744,30016988,30019820,30016365,30019283,30020757,30020181,30018143,30020959,30019598,30021128,30018501,30020570],"length":1,"stats":{"Line":0}},{"line":92,"address":[30018990,30020112,30016678,30017862,30019529,30020688,30017280,30018430,30021246],"length":1,"stats":{"Line":0}},{"line":96,"address":[30021801,30021344,30021807],"length":1,"stats":{"Line":0}},{"line":100,"address":[30021374,30021458],"length":1,"stats":{"Line":0}},{"line":101,"address":[30021567,30021511],"length":1,"stats":{"Line":0}},{"line":102,"address":[30021654,30021621,30021799],"length":1,"stats":{"Line":0}},{"line":106,"address":[30029403,30027229,30027254,30027280,30026096,30024112,30024069,30025088,30026068,30028240,30028208,30029428,30025056,30026062,30023088,30025062,30028214],"length":1,"stats":{"Line":0}},{"line":111,"address":[30028399,30025247,30023138,30024170,30025160,30027325,30023222,30024254,30027409,30026154,30028312,30026238],"length":1,"stats":{"Line":0}},{"line":112,"address":[30026291,30027518,30025362,30023275,30024307,30024363,30023331,30026347,30028455,30025303,30028514,30027462],"length":1,"stats":{"Line":0}},{"line":113,"address":[30024420,30026604,30029409,30024059,30026043,30023620,30028203,30025452,30027249,30026437,30023394,30026057,30029423,30028776,30028604,30024037,30027235,30025037,30024620,30027608,30026404,30028189,30028571,30025624,30025419,30024453,30025051,30027770,30027575],"length":1,"stats":{"Line":0}},{"line":114,"address":[30024746,30025750,30023746,30029030,30026858,30027896],"length":1,"stats":{"Line":0}},{"line":115,"address":[30024842,30027021,30029195,30023787,30025791,30027937,30025848,30024787,30023842,30029125,30027994,30026953],"length":1,"stats":{"Line":0}},{"line":117,"address":[30029039,30024757,30026867,30027907,30025761,30023757],"length":1,"stats":{"Line":0}},{"line":121,"address":[27763312],"length":1,"stats":{"Line":0}},{"line":122,"address":[27763468,27763390],"length":1,"stats":{"Line":0}},{"line":123,"address":[27763440,27763342],"length":1,"stats":{"Line":0}},{"line":124,"address":[27763495],"length":1,"stats":{"Line":0}},{"line":128,"address":[27762960],"length":1,"stats":{"Line":0}},{"line":129,"address":[27763010,27763085],"length":1,"stats":{"Line":0}},{"line":130,"address":[27763060,27762988],"length":1,"stats":{"Line":0}},{"line":131,"address":[27763109],"length":1,"stats":{"Line":0}},{"line":135,"address":[27763520],"length":1,"stats":{"Line":0}},{"line":136,"address":[27763548],"length":1,"stats":{"Line":0}},{"line":137,"address":[27763669],"length":1,"stats":{"Line":0}},{"line":141,"address":[27763136],"length":1,"stats":{"Line":0}},{"line":142,"address":[27763177],"length":1,"stats":{"Line":0}},{"line":143,"address":[27763292],"length":1,"stats":{"Line":0}},{"line":147,"address":[27765991,27766014,27764880],"length":1,"stats":{"Line":0}},{"line":148,"address":[27764910],"length":1,"stats":{"Line":0}},{"line":149,"address":[27765037,27764975],"length":1,"stats":{"Line":0}},{"line":151,"address":[27765156,27765099],"length":1,"stats":{"Line":0}},{"line":152,"address":[27765997,27765172],"length":1,"stats":{"Line":0}},{"line":153,"address":[27765471],"length":1,"stats":{"Line":0}},{"line":154,"address":[27765515,27765585],"length":1,"stats":{"Line":0}},{"line":156,"address":[27765497,27765741],"length":1,"stats":{"Line":0}},{"line":157,"address":[27765928,27765831],"length":1,"stats":{"Line":0}},{"line":159,"address":[27765881],"length":1,"stats":{"Line":0}},{"line":163,"address":[27761792],"length":1,"stats":{"Line":0}},{"line":164,"address":[27761843,27762046],"length":1,"stats":{"Line":0}},{"line":166,"address":[27761865],"length":1,"stats":{"Line":0}},{"line":168,"address":[27762076],"length":1,"stats":{"Line":0}},{"line":169,"address":[27762407,27762218],"length":1,"stats":{"Line":0}},{"line":170,"address":[27762395],"length":1,"stats":{"Line":0}},{"line":174,"address":[27761456,27761597,27761603],"length":1,"stats":{"Line":0}},{"line":175,"address":[27761468,27761569],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":69},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","mod.rs"],"content":"//! 计时器引擎：阶段切换、倒计时、历史记录与通知触发。\n\npub(crate) mod notification;\nmod runtime;\npub(crate) mod stats;\nmod validation;\n\npub use notification::TauriNotifier;\npub use runtime::{SystemClock, TickResult, TimerClock, TimerRuntime, TimerSnapshot, WorkCompletedEvent};\npub use stats::compute_today_stats;\npub use validation::validate_settings;\n\nuse std::time::Duration;\n\nuse tokio::time::sleep;\n\nuse tauri::Manager as _;\n\nuse crate::state::AppState;\n\n/// 向前端广播计时器状态的事件名。\npub const EVENT_SNAPSHOT: \u0026str = \"pomodoro://snapshot\";\n\n/// 向前端广播“工作阶段自然完成”的事件名。\npub const EVENT_WORK_COMPLETED: \u0026str = \"pomodoro://work_completed\";\n\n/// 启动后台 tick 任务：每秒更新计时器、推送事件与刷新托盘。\npub fn spawn_timer_task(app: tauri::AppHandle) {\n    tauri::async_runtime::spawn(async move {\n        loop {\n            sleep(Duration::from_secs(1)).await;\n            let state = app.state::\u003cAppState\u003e();\n            let was_running = state.is_running();\n            if let Ok(result) = state.tick() {\n                if result.work_auto_started {\n                    let names: Vec\u003cString\u003e = state\n                        .data_snapshot()\n                        .blacklist\n                        .into_iter()\n                        .map(|b| b.name)\n                        .collect();\n                    let payload = crate::processes::kill_names_best_effort(\u0026names);\n                    let _ = state.emit_kill_result(payload);\n                }\n                if was_running || result.phase_ended {\n                    let _ = state.emit_timer_snapshot();\n                    let _ = crate::tray::refresh_tray(\u0026state);\n                }\n            }\n        }\n    });\n}\n","traces":[{"line":28,"address":[31037248],"length":1,"stats":{"Line":0}},{"line":29,"address":[29500720,29502378,29500840,29500748,29500790,29502608],"length":1,"stats":{"Line":0}},{"line":30,"address":[29500780],"length":1,"stats":{"Line":0}},{"line":31,"address":[29502519,29500858,29500882,29500806],"length":1,"stats":{"Line":0}},{"line":32,"address":[29501079],"length":1,"stats":{"Line":0}},{"line":33,"address":[29501112],"length":1,"stats":{"Line":0}},{"line":34,"address":[29501161,29501276],"length":1,"stats":{"Line":0}},{"line":35,"address":[29501302],"length":1,"stats":{"Line":0}},{"line":36,"address":[29501409,29501337],"length":1,"stats":{"Line":0}},{"line":37,"address":[29501402],"length":1,"stats":{"Line":0}},{"line":39,"address":[29501457],"length":1,"stats":{"Line":0}},{"line":40,"address":[29501520,29502640,29502668],"length":1,"stats":{"Line":0}},{"line":41,"address":[29501565,29501625,29501543,29501464,29501745,29502384,29501797,29501685],"length":1,"stats":{"Line":0}},{"line":42,"address":[29501893,29501972],"length":1,"stats":{"Line":0}},{"line":43,"address":[29502050,29501995],"length":1,"stats":{"Line":0}},{"line":45,"address":[29501316,29502158],"length":1,"stats":{"Line":0}},{"line":46,"address":[29502219,29502176],"length":1,"stats":{"Line":0}},{"line":47,"address":[29502249],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":18},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","notification.rs"],"content":"//! 阶段结束通知与目标达成提醒（通过可注入 Notifier 实现，便于测试）。\n\nuse crate::app_data::{Phase, Settings};\nuse crate::errors::AppResult;\n\n/// 通知发送抽象：用于将“通知内容生成”与“通知实现（Tauri/其它）”解耦。\npub trait Notifier {\n    /// 发送一条系统通知。\n    fn notify(\u0026self, title: \u0026str, body: \u0026str) -\u003e AppResult\u003c()\u003e;\n}\n\n/// Tauri 通知实现（基于 `tauri-plugin-notification`）。\npub struct TauriNotifier\u003c'a\u003e {\n    app: \u0026'a tauri::AppHandle,\n}\n\nimpl\u003c'a\u003e TauriNotifier\u003c'a\u003e {\n    /// 创建一个基于 `AppHandle` 的通知器。\n    pub fn new(app: \u0026'a tauri::AppHandle) -\u003e Self {\n        Self { app }\n    }\n}\n\nimpl Notifier for TauriNotifier\u003c'_\u003e {\n    /// 发送系统通知（失败时返回 `AppError::Notification`）。\n    fn notify(\u0026self, title: \u0026str, body: \u0026str) -\u003e AppResult\u003c()\u003e {\n        use tauri_plugin_notification::NotificationExt as _;\n        self.app.notification().builder().title(title).body(body).show()?;\n        Ok(())\n    }\n}\n\n/// 发送阶段结束通知，并给出下一阶段预告。\npub fn notify_phase_end(\n    notifier: \u0026dyn Notifier,\n    ended: Phase,\n    next: Phase,\n    next_auto_started: bool,\n    settings: \u0026Settings,\n) -\u003e AppResult\u003c()\u003e {\n    let preview = phase_preview(next, next_auto_started, settings);\n    let (title, body) = match ended {\n        Phase::Work =\u003e (\"专注完成\".to_string(), format!(\"{}。{}\", \"本阶段已结束\", preview)),\n        Phase::ShortBreak =\u003e (\"短休息结束\".to_string(), preview),\n        Phase::LongBreak =\u003e (\"长休息结束\".to_string(), preview),\n    };\n\n    notifier.notify(\u0026title, \u0026body)?;\n    Ok(())\n}\n\n/// 在工作阶段完成后，根据每日/每周目标的阈值触发提醒。\npub fn notify_goal_progress_if_needed(\n    notifier: \u0026dyn Notifier,\n    settings: \u0026Settings,\n    daily_before: u32,\n    daily_after: u32,\n    weekly_before: u32,\n    weekly_after: u32,\n) -\u003e AppResult\u003c()\u003e {\n    let daily_goal = settings.daily_goal;\n    if daily_goal \u003e 0 {\n        let half = daily_goal.div_ceil(2);\n        if daily_before \u003c half \u0026\u0026 daily_after \u003e= half {\n            notifier.notify(\"今日目标进度\", \u0026format!(\"已完成今日目标 50%（{daily_after}/{daily_goal}）\"))?;\n        }\n        if daily_before \u003c daily_goal \u0026\u0026 daily_after \u003e= daily_goal {\n            notifier.notify(\"今日目标达成\", \u0026format!(\"恭喜！已完成今日目标（{daily_after}/{daily_goal}）\"))?;\n        }\n    }\n\n    let weekly_goal = settings.weekly_goal;\n    if weekly_goal \u003e 0 {\n        let half = weekly_goal.div_ceil(2);\n        if weekly_before \u003c half \u0026\u0026 weekly_after \u003e= half {\n            notifier.notify(\"本周目标进度\", \u0026format!(\"已完成本周目标 50%（{weekly_after}/{weekly_goal}）\"))?;\n        }\n        if weekly_before \u003c weekly_goal \u0026\u0026 weekly_after \u003e= weekly_goal {\n            notifier.notify(\"本周目标达成\", \u0026format!(\"恭喜！已完成本周目标（{weekly_after}/{weekly_goal}）\"))?;\n        }\n    }\n\n    Ok(())\n}\n\n/// 生成“下一阶段预告”文案（区分是否已自动开始）。\nfn phase_preview(next: Phase, next_auto_started: bool, settings: \u0026Settings) -\u003e String {\n    let prefix = if next_auto_started { \"已自动开始\" } else { \"即将开始\" };\n    match next {\n        Phase::Work =\u003e format!(\"{prefix}工作 {} 分钟\", settings.pomodoro),\n        Phase::ShortBreak =\u003e format!(\"{prefix}短休息 {} 分钟\", settings.short_break),\n        Phase::LongBreak =\u003e format!(\"{prefix}长休息 {} 分钟\", settings.long_break),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    use std::cell::RefCell;\n\n    /// 记录型通知器：将所有通知内容收集起来，便于断言。\n    struct RecordingNotifier {\n        calls: RefCell\u003cVec\u003c(String, String)\u003e\u003e,\n    }\n\n    impl RecordingNotifier {\n        /// 创建一个空的记录型通知器。\n        fn new() -\u003e Self {\n            Self {\n                calls: RefCell::new(Vec::new()),\n            }\n        }\n\n        /// 取出已记录的通知（按调用顺序）。\n        fn take(\u0026self) -\u003e Vec\u003c(String, String)\u003e {\n            std::mem::take(\u0026mut *self.calls.borrow_mut())\n        }\n    }\n\n    impl Notifier for RecordingNotifier {\n        /// 记录通知内容并返回成功。\n        fn notify(\u0026self, title: \u0026str, body: \u0026str) -\u003e AppResult\u003c()\u003e {\n            self.calls\n                .borrow_mut()\n                .push((title.to_string(), body.to_string()));\n            Ok(())\n        }\n    }\n\n    /// `phase_preview`：应按阶段输出时长，并区分“自动开始/即将开始”前缀。\n    #[test]\n    fn phase_preview_formats_for_all_phases() {\n        let settings = Settings {\n            pomodoro: 25,\n            short_break: 5,\n            long_break: 15,\n            ..Settings::default()\n        };\n\n        assert_eq!(\n            phase_preview(Phase::Work, false, \u0026settings),\n            \"即将开始工作 25 分钟\"\n        );\n        assert_eq!(\n            phase_preview(Phase::ShortBreak, false, \u0026settings),\n            \"即将开始短休息 5 分钟\"\n        );\n        assert_eq!(\n            phase_preview(Phase::LongBreak, true, \u0026settings),\n            \"已自动开始长休息 15 分钟\"\n        );\n    }\n\n    /// `notify_phase_end`：工作/短休息/长休息结束应发送对应标题与预告文案。\n    #[test]\n    fn notify_phase_end_sends_expected_titles_and_bodies() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            pomodoro: 25,\n            short_break: 5,\n            long_break: 15,\n            ..Settings::default()\n        };\n\n        notify_phase_end(\n            \u0026notifier,\n            Phase::Work,\n            Phase::ShortBreak,\n            false,\n            \u0026settings,\n        )\n        .unwrap();\n        notify_phase_end(\n            \u0026notifier,\n            Phase::ShortBreak,\n            Phase::Work,\n            true,\n            \u0026settings,\n        )\n        .unwrap();\n        notify_phase_end(\n            \u0026notifier,\n            Phase::LongBreak,\n            Phase::Work,\n            false,\n            \u0026settings,\n        )\n        .unwrap();\n\n        let calls = notifier.take();\n        assert_eq!(calls.len(), 3);\n        assert_eq!(calls[0].0, \"专注完成\");\n        assert_eq!(calls[0].1, \"本阶段已结束。即将开始短休息 5 分钟\");\n        assert_eq!(calls[1].0, \"短休息结束\");\n        assert_eq!(calls[1].1, \"已自动开始工作 25 分钟\");\n        assert_eq!(calls[2].0, \"长休息结束\");\n        assert_eq!(calls[2].1, \"即将开始工作 25 分钟\");\n    }\n\n    /// `notify_goal_progress_if_needed`：当目标为 0 时不应发送任何通知。\n    #[test]\n    fn notify_goal_progress_skips_when_goals_are_zero() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            daily_goal: 0,\n            weekly_goal: 0,\n            ..Settings::default()\n        };\n\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 0, 100, 0, 100).unwrap();\n        assert!(notifier.take().is_empty());\n    }\n\n    /// `notify_goal_progress_if_needed`：应在跨过 50% 与 100% 阈值时发送提醒（含一次跨多个阈值）。\n    #[test]\n    fn notify_goal_progress_sends_threshold_notifications() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            daily_goal: 5,  // half = 3\n            weekly_goal: 4, // half = 2\n            ..Settings::default()\n        };\n\n        // 日目标：2 -\u003e 5 同时跨过 50% 与 100%；周目标：1 -\u003e 4 同时跨过 50% 与 100%。\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 2, 5, 1, 4).unwrap();\n\n        let calls = notifier.take();\n        assert_eq!(calls.len(), 4);\n        assert_eq!(calls[0].0, \"今日目标进度\");\n        assert!(calls[0].1.contains(\"50%（5/5）\"));\n        assert_eq!(calls[1].0, \"今日目标达成\");\n        assert!(calls[1].1.contains(\"（5/5）\"));\n        assert_eq!(calls[2].0, \"本周目标进度\");\n        assert!(calls[2].1.contains(\"50%（4/4）\"));\n        assert_eq!(calls[3].0, \"本周目标达成\");\n        assert!(calls[3].1.contains(\"（4/4）\"));\n    }\n\n    /// `notify_goal_progress_if_needed`：未跨过阈值时不应重复提醒（幂等）。\n    #[test]\n    fn notify_goal_progress_is_idempotent_when_not_crossing() {\n        let notifier = RecordingNotifier::new();\n        let settings = Settings {\n            daily_goal: 4, // half = 2\n            weekly_goal: 0,\n            ..Settings::default()\n        };\n\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 2, 2, 0, 0).unwrap();\n        assert!(notifier.take().is_empty());\n\n        notify_goal_progress_if_needed(\u0026notifier, \u0026settings, 3, 3, 0, 0).unwrap();\n        assert!(notifier.take().is_empty());\n    }\n}\n","traces":[{"line":19,"address":[33720352],"length":1,"stats":{"Line":0}},{"line":26,"address":[33720080],"length":1,"stats":{"Line":0}},{"line":28,"address":[33720156],"length":1,"stats":{"Line":0}},{"line":29,"address":[33720325],"length":1,"stats":{"Line":0}},{"line":34,"address":[33721827,33722618,33721136],"length":1,"stats":{"Line":1}},{"line":41,"address":[33721256],"length":1,"stats":{"Line":1}},{"line":42,"address":[33721295,33721735],"length":1,"stats":{"Line":2}},{"line":43,"address":[33721471,33721326],"length":1,"stats":{"Line":2}},{"line":44,"address":[33721833,33721357],"length":1,"stats":{"Line":2}},{"line":45,"address":[33721981,33721391],"length":1,"stats":{"Line":2}},{"line":48,"address":[33722200,33721807],"length":1,"stats":{"Line":2}},{"line":49,"address":[33722412],"length":1,"stats":{"Line":1}},{"line":53,"address":[33725120,33722656,33725114],"length":1,"stats":{"Line":1}},{"line":61,"address":[33722772],"length":1,"stats":{"Line":1}},{"line":62,"address":[33722782],"length":1,"stats":{"Line":1}},{"line":63,"address":[33722829],"length":1,"stats":{"Line":1}},{"line":64,"address":[33722909,33722876],"length":1,"stats":{"Line":2}},{"line":65,"address":[33725165,33722926],"length":1,"stats":{"Line":1}},{"line":67,"address":[33722887,33723445],"length":1,"stats":{"Line":2}},{"line":68,"address":[33725149,33723473],"length":1,"stats":{"Line":1}},{"line":72,"address":[33722800],"length":1,"stats":{"Line":1}},{"line":73,"address":[33722810],"length":1,"stats":{"Line":1}},{"line":74,"address":[33724012],"length":1,"stats":{"Line":1}},{"line":75,"address":[33724056,33724086],"length":1,"stats":{"Line":2}},{"line":76,"address":[33725133,33724103],"length":1,"stats":{"Line":1}},{"line":78,"address":[33724580,33724067],"length":1,"stats":{"Line":2}},{"line":79,"address":[33724608,33725098],"length":1,"stats":{"Line":1}},{"line":83,"address":[33724000],"length":1,"stats":{"Line":1}},{"line":87,"address":[33720368],"length":1,"stats":{"Line":1}},{"line":88,"address":[33720426],"length":1,"stats":{"Line":1}},{"line":89,"address":[33720478],"length":1,"stats":{"Line":1}},{"line":90,"address":[33720521],"length":1,"stats":{"Line":1}},{"line":91,"address":[33720711],"length":1,"stats":{"Line":1}},{"line":92,"address":[33720922],"length":1,"stats":{"Line":1}}],"covered":30,"coverable":34},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","runtime.rs"],"content":"//! 计时器运行态与核心状态机（tick、阶段切换、写入历史）。\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::{AppData, HistoryDay, HistoryRecord, Phase, Settings};\nuse crate::errors::AppResult;\nuse crate::timer::notification;\nuse crate::timer::stats;\n\n/// 时间来源：用于将状态机与系统时间解耦，便于单元测试。\npub trait TimerClock {\n    /// 获取今天日期字符串（YYYY-MM-DD）。\n    fn today_date(\u0026self) -\u003e String;\n    /// 获取当前时间字符串（HH:mm）。\n    fn now_hhmm(\u0026self) -\u003e String;\n    /// 获取本周日期范围（周一为起始），返回 `(from, to)`（YYYY-MM-DD）。\n    fn current_week_range(\u0026self) -\u003e (String, String);\n}\n\n/// 默认时间来源：使用本机时钟（`chrono::Local`）。\npub struct SystemClock;\n\nimpl TimerClock for SystemClock {\n    /// 获取今天日期字符串（YYYY-MM-DD）。\n    fn today_date(\u0026self) -\u003e String {\n        chrono::Local::now().format(\"%Y-%m-%d\").to_string()\n    }\n\n    /// 获取当前时间字符串（HH:mm）。\n    fn now_hhmm(\u0026self) -\u003e String {\n        chrono::Local::now().format(\"%H:%M\").to_string()\n    }\n\n    /// 获取本周日期范围（周一为起始），返回 `(from, to)`（YYYY-MM-DD）。\n    fn current_week_range(\u0026self) -\u003e (String, String) {\n        use chrono::{Datelike as _, Duration as ChronoDuration, Weekday};\n        let today = chrono::Local::now().date_naive();\n        let weekday = today.weekday();\n        let offset_days = match weekday {\n            Weekday::Mon =\u003e 0,\n            Weekday::Tue =\u003e 1,\n            Weekday::Wed =\u003e 2,\n            Weekday::Thu =\u003e 3,\n            Weekday::Fri =\u003e 4,\n            Weekday::Sat =\u003e 5,\n            Weekday::Sun =\u003e 6,\n        };\n        let from = today - ChronoDuration::days(offset_days);\n        let to = from + ChronoDuration::days(6);\n        (\n            from.format(\"%Y-%m-%d\").to_string(),\n            to.format(\"%Y-%m-%d\").to_string(),\n        )\n    }\n}\n\n/// 前端渲染/托盘展示所需的计时器快照。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TimerSnapshot {\n    /// 当前阶段。\n    pub phase: Phase,\n    /// 剩余秒数。\n    pub remaining_seconds: u64,\n    /// 是否运行中。\n    pub is_running: bool,\n    /// 当前任务标签。\n    pub current_tag: String,\n    /// 专注期内黑名单是否锁定（只能增不能减）。\n    pub blacklist_locked: bool,\n    /// 当前设置（用于前端展示/校验）。\n    pub settings: Settings,\n    /// 今日统计（用于主界面展示）。\n    pub today_stats: stats::TodayStats,\n    /// 本周统计（用于主界面展示）。\n    pub week_stats: stats::WeekStats,\n    /// 目标进度（用于主界面展示与提醒判断）。\n    pub goal_progress: stats::GoalProgress,\n}\n\n/// tick 结果：用于决定是否需要持久化与是否发生阶段切换。\npub struct TickResult {\n    /// 是否写入了历史（需要持久化）。\n    pub history_changed: bool,\n    /// 是否发生阶段结束切换（用于托盘/通知刷新）。\n    pub phase_ended: bool,\n    /// 是否在“休息结束”后自动开始了工作阶段（用于触发黑名单终止逻辑）。\n    pub work_auto_started: bool,\n    /// 若本次 tick 完成了工作阶段，则携带“新记录已写入”的事件负载。\n    pub work_completed_event: Option\u003cWorkCompletedEvent\u003e,\n}\n\n/// 工作阶段完成事件：用于前端弹出“备注填写”并定位到对应记录。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct WorkCompletedEvent {\n    /// 记录日期（YYYY-MM-DD）。\n    pub date: String,\n    /// 当日记录索引（从 0 开始）。\n    pub record_index: usize,\n    /// 写入的记录内容。\n    pub record: HistoryRecord,\n}\n\n/// 计时器运行态（不持久化；重启后回到默认工作阶段）。\npub struct TimerRuntime {\n    /// 当前阶段。\n    pub phase: Phase,\n    /// 剩余秒数。\n    pub remaining_seconds: u64,\n    /// 是否运行中。\n    pub is_running: bool,\n    /// 当前任务标签（用于下一次完成记录）。\n    pub current_tag: String,\n    /// 工作阶段首次开始时的日期（YYYY-MM-DD）。\n    work_started_date: Option\u003cString\u003e,\n    /// 工作阶段首次开始时的时间（HH:mm）。\n    work_started_time: Option\u003cString\u003e,\n    /// 专注期黑名单锁定标记：一旦工作阶段开始，就禁止移除黑名单条目。\n    work_lock_active: bool,\n    /// 连续番茄“自动推进”剩余工作次数（仅影响：休息结束后是否自动开始工作）。\n    auto_work_remaining: u32,\n}\n\nimpl TimerRuntime {\n    /// 构造新的计时器运行态：工作阶段 + `settings.pomodoro`。\n    pub fn new(settings: \u0026Settings, tags: \u0026[String], clock: \u0026dyn TimerClock) -\u003e Self {\n        Self {\n            phase: Phase::Work,\n            remaining_seconds: settings.pomodoro as u64 * 60,\n            is_running: false,\n            current_tag: tags\n                .first()\n                .cloned()\n                .unwrap_or_else(|| \"工作\".to_string()),\n            work_started_date: None,\n            work_started_time: None,\n            work_lock_active: false,\n            auto_work_remaining: 0,\n        }\n        .with_normalized_tag(clock)\n    }\n\n    /// 基于当前数据生成快照（使用系统时钟计算今日/本周统计）。\n    pub fn snapshot(\u0026self, data: \u0026AppData) -\u003e TimerSnapshot {\n        self.snapshot_with_clock(data, \u0026SystemClock)\n    }\n\n    /// 基于当前数据生成快照（可注入 `clock`，用于测试与边界场景）。\n    pub fn snapshot_with_clock(\u0026self, data: \u0026AppData, clock: \u0026dyn TimerClock) -\u003e TimerSnapshot {\n        let today = clock.today_date();\n        let (from, to) = clock.current_week_range();\n        let today_stats = stats::compute_today_stats(data, \u0026today);\n        let week_stats = stats::compute_week_stats(data, \u0026from, \u0026to);\n\n        TimerSnapshot {\n            phase: self.phase,\n            remaining_seconds: self.remaining_seconds,\n            is_running: self.is_running,\n            current_tag: self.current_tag.clone(),\n            blacklist_locked: self.blacklist_locked(),\n            settings: data.settings.clone(),\n            today_stats: today_stats.clone(),\n            week_stats: week_stats.clone(),\n            goal_progress: stats::GoalProgress {\n                daily_goal: data.settings.daily_goal,\n                daily_completed: today_stats.total,\n                weekly_goal: data.settings.weekly_goal,\n                weekly_completed: week_stats.total,\n            },\n        }\n    }\n\n    /// 专注期内黑名单锁定判断。\n    pub fn blacklist_locked(\u0026self) -\u003e bool {\n        self.phase == Phase::Work \u0026\u0026 self.work_lock_active\n    }\n\n    /// 更新当前标签。\n    pub fn set_current_tag(\u0026mut self, tag: String, clock: \u0026dyn TimerClock) {\n        self.current_tag = tag;\n        *self = std::mem::take(self).with_normalized_tag(clock);\n    }\n\n    /// 启动计时；若为工作阶段首次开始则记录开始时间并锁定黑名单。\n    pub fn start(\u0026mut self, settings: \u0026Settings, clock: \u0026dyn TimerClock) {\n        if self.is_running {\n            return;\n        }\n        self.is_running = true;\n        if self.phase == Phase::Work \u0026\u0026 !self.work_lock_active {\n            self.work_lock_active = true;\n            self.work_started_date = Some(clock.today_date());\n            self.work_started_time = Some(clock.now_hhmm());\n            self.init_auto_work_remaining_if_needed(settings);\n        }\n    }\n\n    /// 暂停计时。\n    pub fn pause(\u0026mut self) {\n        self.is_running = false;\n    }\n\n    /// 重置为工作阶段初始状态（不会清空历史）。\n    pub fn reset(\u0026mut self, settings: \u0026Settings) {\n        self.phase = Phase::Work;\n        self.remaining_seconds = settings.pomodoro as u64 * 60;\n        self.is_running = false;\n        self.work_started_date = None;\n        self.work_started_time = None;\n        self.work_lock_active = false;\n        self.auto_work_remaining = 0;\n    }\n\n    /// 跳过当前阶段（工作阶段不会写入历史）。\n    pub fn skip(\u0026mut self, settings: \u0026Settings, completed_today: u32) {\n        let next = next_phase(self.phase, settings.long_break_interval, completed_today);\n        self.apply_phase(next, settings);\n        self.is_running = false;\n    }\n\n    /// 每秒 tick：递减剩余时间，并在归零时完成阶段切换与（必要时）写入历史。\n    pub fn tick(\n        \u0026mut self,\n        data: \u0026mut AppData,\n        clock: \u0026dyn TimerClock,\n        notifier: \u0026dyn notification::Notifier,\n    ) -\u003e AppResult\u003cTickResult\u003e {\n        if !self.is_running {\n            return Ok(TickResult {\n                history_changed: false,\n                phase_ended: false,\n                work_auto_started: false,\n                work_completed_event: None,\n            });\n        }\n        if self.remaining_seconds \u003e 0 {\n            self.remaining_seconds -= 1;\n        }\n        if self.remaining_seconds \u003e 0 {\n            return Ok(TickResult {\n                history_changed: false,\n                phase_ended: false,\n                work_auto_started: false,\n                work_completed_event: None,\n            });\n        }\n\n        let ended_phase = self.phase;\n        let mut history_changed = false;\n        let mut work_completed_event: Option\u003cWorkCompletedEvent\u003e = None;\n\n        let today = clock.today_date();\n        let (from, to) = clock.current_week_range();\n        let mut completed_today_after = stats::compute_today_stats(data, \u0026today).total;\n        let completed_today_before = completed_today_after;\n        let completed_week_before = stats::compute_week_stats(data, \u0026from, \u0026to).total;\n        let mut completed_week_after = completed_week_before;\n\n        if ended_phase == Phase::Work {\n            let created = self.append_work_record(data, clock)?;\n            history_changed = true;\n            completed_today_after += 1;\n            completed_week_after += 1;\n            self.decrease_auto_work_remaining_after_work_end(\u0026data.settings);\n            work_completed_event = Some(created);\n            tracing::info!(\n                target: \"timer\",\n                \"工作阶段完成：date={} tag={} duration={}m todayCompleted={} weekCompleted={}\",\n                self.work_started_date.clone().unwrap_or_else(|| today.clone()),\n                self.current_tag,\n                data.settings.pomodoro,\n                completed_today_after,\n                completed_week_after\n            );\n            notification::notify_goal_progress_if_needed(\n                notifier,\n                \u0026data.settings,\n                completed_today_before,\n                completed_today_after,\n                completed_week_before,\n                completed_week_after,\n            )?;\n        }\n\n        let next = next_phase(ended_phase, data.settings.long_break_interval, completed_today_after);\n        self.apply_phase(next, \u0026data.settings);\n        self.is_running = false;\n\n        let next_auto_started = self.start_next_phase_if_needed(next, \u0026data.settings, clock);\n\n        notification::notify_phase_end(notifier, ended_phase, next, next_auto_started, \u0026data.settings)?;\n\n        tracing::info!(\n            target: \"timer\",\n            \"阶段切换：ended={:?} next={:?} nextAutoStarted={}\",\n            ended_phase,\n            next,\n            next_auto_started\n        );\n\n        Ok(TickResult {\n            history_changed,\n            phase_ended: true,\n            work_auto_started: next == Phase::Work \u0026\u0026 next_auto_started,\n            work_completed_event,\n        })\n    }\n\n    /// 将当前工作阶段写入 `history`（仅在自然完成时调用）。\n    fn append_work_record(\u0026mut self, data: \u0026mut AppData, clock: \u0026dyn TimerClock) -\u003e AppResult\u003cWorkCompletedEvent\u003e {\n        let date = self\n            .work_started_date\n            .clone()\n            .unwrap_or_else(|| clock.today_date());\n        let start_time = self\n            .work_started_time\n            .clone()\n            .unwrap_or_else(|| clock.now_hhmm());\n        let end_time = clock.now_hhmm();\n\n        let record = HistoryRecord {\n            tag: self.current_tag.clone(),\n            start_time,\n            end_time: Some(end_time),\n            duration: data.settings.pomodoro,\n            phase: Phase::Work,\n            remark: String::new(),\n        };\n\n        let day = ensure_day(\u0026mut data.history, \u0026date);\n        day.records.push(record.clone());\n        let record_index = day.records.len().saturating_sub(1);\n        Ok(WorkCompletedEvent {\n            date,\n            record_index,\n            record,\n        })\n    }\n\n    /// 应用阶段切换：重置剩余时间与锁定标记。\n    fn apply_phase(\u0026mut self, phase: Phase, settings: \u0026Settings) {\n        self.phase = phase;\n        self.remaining_seconds = phase_seconds(phase, settings);\n        self.work_started_date = None;\n        self.work_started_time = None;\n        self.work_lock_active = false;\n    }\n\n    /// 初始化“连续番茄自动推进”的剩余工作次数（仅在工作阶段首次开始时触发）。\n    fn init_auto_work_remaining_if_needed(\u0026mut self, settings: \u0026Settings) {\n        if !settings.auto_continue_enabled {\n            return;\n        }\n        if self.auto_work_remaining \u003e 0 {\n            return;\n        }\n        self.auto_work_remaining = settings.auto_continue_pomodoros;\n    }\n\n    /// 在一个工作阶段自然结束后递减“自动推进”的剩余次数。\n    fn decrease_auto_work_remaining_after_work_end(\u0026mut self, settings: \u0026Settings) {\n        if !settings.auto_continue_enabled {\n            self.auto_work_remaining = 0;\n            return;\n        }\n        if self.auto_work_remaining \u003e 0 {\n            self.auto_work_remaining -= 1;\n        }\n    }\n\n    /// 按规则决定是否自动开始“下一阶段”的倒计时，并返回是否已自动开始。\n    fn start_next_phase_if_needed(\u0026mut self, next: Phase, settings: \u0026Settings, clock: \u0026dyn TimerClock) -\u003e bool {\n        match next {\n            Phase::ShortBreak | Phase::LongBreak =\u003e {\n                // 工作结束后始终自动进入休息倒计时。\n                self.start(settings, clock);\n                true\n            }\n            Phase::Work =\u003e {\n                // 休息结束后：仅在“连续番茄自动推进”开启且仍有剩余时自动开始工作。\n                if settings.auto_continue_enabled \u0026\u0026 self.auto_work_remaining \u003e 0 {\n                    self.start(settings, clock);\n                    true\n                } else {\n                    false\n                }\n            }\n        }\n    }\n\n    /// 规范化当前标签：用于防御性处理空白标签，保证 UI 与导出稳定。\n    fn with_normalized_tag(mut self, clock: \u0026dyn TimerClock) -\u003e Self {\n        if self.current_tag.trim().is_empty() {\n            self.current_tag = \"工作\".to_string();\n        }\n        // 若计时器已经在工作阶段运行中，且日期/时间缺失，则补齐（避免中途迁移导致的 None）。\n        if self.phase == Phase::Work \u0026\u0026 self.is_running {\n            if self.work_started_date.is_none() {\n                self.work_started_date = Some(clock.today_date());\n            }\n            if self.work_started_time.is_none() {\n                self.work_started_time = Some(clock.now_hhmm());\n            }\n        }\n        self\n    }\n}\n\nimpl Default for TimerRuntime {\n    /// 仅用于 `std::mem::take` 的内部占位默认值（不应被业务直接使用）。\n    fn default() -\u003e Self {\n        Self {\n            phase: Phase::Work,\n            remaining_seconds: 0,\n            is_running: false,\n            current_tag: \"工作\".to_string(),\n            work_started_date: None,\n            work_started_time: None,\n            work_lock_active: false,\n            auto_work_remaining: 0,\n        }\n    }\n}\n\n/// 计算某阶段的总秒数。\nfn phase_seconds(phase: Phase, settings: \u0026Settings) -\u003e u64 {\n    match phase {\n        Phase::Work =\u003e settings.pomodoro as u64 * 60,\n        Phase::ShortBreak =\u003e settings.short_break as u64 * 60,\n        Phase::LongBreak =\u003e settings.long_break as u64 * 60,\n    }\n}\n\n/// 基于“当前阶段 + 今日已完成番茄数 + 长休息间隔”推导下一阶段。\nfn next_phase(current: Phase, long_break_interval: u32, completed_today_after: u32) -\u003e Phase {\n    match current {\n        Phase::Work =\u003e {\n            if long_break_interval \u003e 0 \u0026\u0026 completed_today_after.is_multiple_of(long_break_interval) {\n                Phase::LongBreak\n            } else {\n                Phase::ShortBreak\n            }\n        }\n        Phase::ShortBreak | Phase::LongBreak =\u003e Phase::Work,\n    }\n}\n\n/// 在历史数组中确保存在指定日期的 `HistoryDay`，并返回可变引用。\nfn ensure_day\u003c'a\u003e(history: \u0026'a mut Vec\u003cHistoryDay\u003e, date: \u0026str) -\u003e \u0026'a mut HistoryDay {\n    if let Some(index) = history.iter().position(|d| d.date == date) {\n        return \u0026mut history[index];\n    }\n\n    history.push(HistoryDay {\n        date: date.to_string(),\n        records: Vec::new(),\n    });\n    let last_index = history.len().saturating_sub(1);\n    \u0026mut history[last_index]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// 固定时间源：用于让单元测试在任意时间运行都可复现。\n    struct FixedClock {\n        today: String,\n        now: String,\n        week_from: String,\n        week_to: String,\n    }\n\n    impl FixedClock {\n        /// 构造一个固定时钟（weekRange 默认覆盖 today）。\n        fn new(today: \u0026str, now: \u0026str) -\u003e Self {\n            Self {\n                today: today.to_string(),\n                now: now.to_string(),\n                week_from: today.to_string(),\n                week_to: today.to_string(),\n            }\n        }\n\n        /// 覆盖本周范围（闭区间）。\n        fn with_week_range(mut self, from: \u0026str, to: \u0026str) -\u003e Self {\n            self.week_from = from.to_string();\n            self.week_to = to.to_string();\n            self\n        }\n    }\n\n    impl TimerClock for FixedClock {\n        /// 返回固定的日期。\n        fn today_date(\u0026self) -\u003e String {\n            self.today.clone()\n        }\n\n        /// 返回固定的时间。\n        fn now_hhmm(\u0026self) -\u003e String {\n            self.now.clone()\n        }\n\n        /// 返回固定的周范围。\n        fn current_week_range(\u0026self) -\u003e (String, String) {\n            (self.week_from.clone(), self.week_to.clone())\n        }\n    }\n\n    /// 空通知器：测试时忽略通知副作用。\n    struct NoopNotifier;\n\n    impl notification::Notifier for NoopNotifier {\n        /// 忽略通知发送并返回成功。\n        fn notify(\u0026self, _title: \u0026str, _body: \u0026str) -\u003e AppResult\u003c()\u003e {\n            Ok(())\n        }\n    }\n\n    /// `tick` 在归零时会写入历史并切换到休息阶段。\n    #[test]\n    fn tick_completes_work_and_switches_to_break() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.pomodoro = 1;\n        data.settings.short_break = 1;\n        data.settings.long_break = 1;\n        data.settings.long_break_interval = 4;\n        data.tags = vec![\"学习\".to_string()];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n        runtime.remaining_seconds = 1;\n\n        let out = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert!(out.history_changed);\n        assert!(out.phase_ended);\n        assert!(out.work_completed_event.is_some());\n        assert_eq!(runtime.phase, Phase::ShortBreak);\n        assert!(runtime.is_running);\n        assert_eq!(runtime.remaining_seconds, (data.settings.short_break as u64) * 60);\n        assert_eq!(data.history.len(), 1);\n        assert_eq!(data.history[0].records.len(), 1);\n    }\n\n    /// 当今日完成数达到长休息间隔倍数时，应进入长休息阶段。\n    #[test]\n    fn tick_uses_long_break_interval() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.pomodoro = 1;\n        data.settings.short_break = 1;\n        data.settings.long_break = 2;\n        data.settings.long_break_interval = 2;\n        data.tags = vec![\"A\".to_string()];\n\n        // 预置 1 条工作记录：让本次完成后达到 2，从而触发长休息。\n        data.history.push(HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![HistoryRecord {\n                tag: \"A\".to_string(),\n                start_time: \"08:00\".to_string(),\n                end_time: Some(\"08:25\".to_string()),\n                duration: 25,\n                phase: Phase::Work,\n                remark: String::new(),\n            }],\n        });\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n        runtime.remaining_seconds = 1;\n\n        let _ = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert_eq!(runtime.phase, Phase::LongBreak);\n        assert!(runtime.is_running);\n        assert_eq!(runtime.remaining_seconds, (data.settings.long_break as u64) * 60);\n    }\n\n    /// 休息结束后：未开启连续番茄时不应自动开始工作倒计时。\n    #[test]\n    fn break_end_does_not_auto_start_work_when_disabled() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.short_break = 1;\n        data.settings.auto_continue_enabled = false;\n        data.tags = vec![\"A\".to_string()];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.phase = Phase::ShortBreak;\n        runtime.remaining_seconds = 1;\n        runtime.is_running = true;\n\n        let out = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert!(out.phase_ended);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert!(!runtime.is_running);\n    }\n\n    /// 休息结束后：开启连续番茄且仍有剩余时应自动开始工作倒计时。\n    #[test]\n    fn break_end_auto_starts_work_when_enabled_and_remaining() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let notifier = NoopNotifier;\n\n        let mut data = AppData::default();\n        data.settings.pomodoro = 1;\n        data.settings.short_break = 1;\n        data.settings.auto_continue_enabled = true;\n        data.settings.auto_continue_pomodoros = 2;\n        data.tags = vec![\"A\".to_string()];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n\n        // 快速完成一次工作 -\u003e 自动进入短休息并开始。\n        runtime.remaining_seconds = 1;\n        let _ = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert_eq!(runtime.phase, Phase::ShortBreak);\n        assert!(runtime.is_running);\n\n        // 快速结束短休息 -\u003e 自动开始下一次工作。\n        runtime.remaining_seconds = 1;\n        let out = runtime.tick(\u0026mut data, \u0026clock, \u0026notifier).unwrap();\n        assert!(out.phase_ended);\n        assert!(out.work_auto_started);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert!(runtime.is_running);\n    }\n\n    /// `TimerRuntime::new`：应初始化为工作阶段、剩余时间与默认标签（空标签列表回退为“工作”）。\n    #[test]\n    fn timer_runtime_new_initializes_with_defaults_and_tag_fallback() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let settings = Settings {\n            pomodoro: 25,\n            ..Settings::default()\n        };\n\n        let runtime = TimerRuntime::new(\u0026settings, \u0026[], \u0026clock);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert_eq!(runtime.remaining_seconds, 25 * 60);\n        assert!(!runtime.is_running);\n        assert_eq!(runtime.current_tag, \"工作\");\n        assert!(!runtime.blacklist_locked());\n    }\n\n    /// `start`：重复启动应幂等，并在工作阶段首次启动时锁定黑名单。\n    #[test]\n    fn start_is_idempotent_and_locks_blacklist_on_first_work_start() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut runtime = TimerRuntime::new(\u0026Settings::default(), \u0026[\"学习\".to_string()], \u0026clock);\n\n        runtime.start(\u0026Settings::default(), \u0026clock);\n        assert!(runtime.is_running);\n        assert!(runtime.blacklist_locked());\n\n        runtime.start(\u0026Settings::default(), \u0026clock);\n        assert!(runtime.is_running);\n        assert!(runtime.blacklist_locked());\n    }\n\n    /// `pause`：暂停后应处于非运行态。\n    #[test]\n    fn pause_stops_running() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut runtime = TimerRuntime::new(\u0026Settings::default(), \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.start(\u0026Settings::default(), \u0026clock);\n        runtime.pause();\n        assert!(!runtime.is_running);\n    }\n\n    /// `reset`：应回到工作阶段初始剩余时间，并解除锁定与运行态。\n    #[test]\n    fn reset_restores_initial_state() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut settings = Settings::default();\n        settings.pomodoro = 10;\n        settings.short_break = 1;\n        settings.long_break = 1;\n\n        let mut runtime = TimerRuntime::new(\u0026settings, \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.start(\u0026settings, \u0026clock);\n        runtime.remaining_seconds = 3;\n        assert!(runtime.blacklist_locked());\n\n        runtime.reset(\u0026settings);\n        assert_eq!(runtime.phase, Phase::Work);\n        assert_eq!(runtime.remaining_seconds, 10 * 60);\n        assert!(!runtime.is_running);\n        assert!(!runtime.blacklist_locked());\n    }\n\n    /// `skip`：跳过不会写入历史（不依赖 data），并应切换到下一阶段且解除锁定。\n    #[test]\n    fn skip_switches_phase_and_unlocks_blacklist() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut settings = Settings::default();\n        settings.pomodoro = 1;\n        settings.short_break = 2;\n        settings.long_break = 3;\n        settings.long_break_interval = 4;\n\n        let mut runtime = TimerRuntime::new(\u0026settings, \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.start(\u0026settings, \u0026clock);\n        assert!(runtime.blacklist_locked());\n\n        runtime.skip(\u0026settings, 1);\n        assert_eq!(runtime.phase, Phase::ShortBreak);\n        assert_eq!(runtime.remaining_seconds, 2 * 60);\n        assert!(!runtime.is_running);\n        assert!(!runtime.blacklist_locked());\n    }\n\n    /// `set_current_tag`：空白标签应规范化为“工作”。\n    #[test]\n    fn set_current_tag_normalizes_blank_tag() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\");\n        let mut runtime = TimerRuntime::new(\u0026Settings::default(), \u0026[\"学习\".to_string()], \u0026clock);\n        runtime.set_current_tag(\"   \".to_string(), \u0026clock);\n        assert_eq!(runtime.current_tag, \"工作\");\n    }\n\n    /// `snapshot_with_clock`：快照应包含目标进度与今日/本周统计，并保留运行态字段。\n    #[test]\n    fn snapshot_with_clock_includes_stats_and_goal_progress() {\n        let clock = FixedClock::new(\"2025-01-01\", \"09:00\").with_week_range(\"2025-01-01\", \"2025-01-07\");\n        let mut data = AppData::default();\n        data.settings.daily_goal = 3;\n        data.settings.weekly_goal = 10;\n        data.tags = vec![\"学习\".to_string()];\n        data.history = vec![HistoryDay {\n            date: \"2025-01-01\".to_string(),\n            records: vec![\n                HistoryRecord {\n                    tag: \"学习\".to_string(),\n                    start_time: \"08:00\".to_string(),\n                    end_time: Some(\"08:25\".to_string()),\n                    duration: 25,\n                    phase: Phase::Work,\n                    remark: String::new(),\n                },\n                HistoryRecord {\n                    tag: \"学习\".to_string(),\n                    start_time: \"08:30\".to_string(),\n                    end_time: Some(\"08:55\".to_string()),\n                    duration: 25,\n                    phase: Phase::ShortBreak,\n                    remark: String::new(),\n                },\n            ],\n        }];\n\n        let mut runtime = TimerRuntime::new(\u0026data.settings, \u0026data.tags, \u0026clock);\n        runtime.start(\u0026data.settings, \u0026clock);\n\n        let snapshot = runtime.snapshot_with_clock(\u0026data, \u0026clock);\n        assert_eq!(snapshot.phase, Phase::Work);\n        assert!(snapshot.is_running);\n        assert_eq!(snapshot.current_tag, \"学习\");\n        assert!(snapshot.blacklist_locked);\n        assert_eq!(snapshot.settings.daily_goal, 3);\n        assert_eq!(snapshot.today_stats.total, 1);\n        assert_eq!(snapshot.week_stats.total, 1);\n        assert_eq!(snapshot.goal_progress.daily_goal, 3);\n        assert_eq!(snapshot.goal_progress.daily_completed, 1);\n        assert_eq!(snapshot.goal_progress.weekly_goal, 10);\n        assert_eq!(snapshot.goal_progress.weekly_completed, 1);\n    }\n}\n","traces":[{"line":26,"address":[28202578,28202584,28202416],"length":1,"stats":{"Line":1}},{"line":27,"address":[28202441],"length":1,"stats":{"Line":1}},{"line":31,"address":[28203104,28203272,28203266],"length":1,"stats":{"Line":1}},{"line":32,"address":[28203129],"length":1,"stats":{"Line":1}},{"line":36,"address":[28203079,28203051,28202608],"length":1,"stats":{"Line":1}},{"line":38,"address":[28202632],"length":1,"stats":{"Line":1}},{"line":39,"address":[28202670],"length":1,"stats":{"Line":1}},{"line":40,"address":[28202682],"length":1,"stats":{"Line":1}},{"line":49,"address":[28202695],"length":1,"stats":{"Line":1}},{"line":50,"address":[28202721],"length":1,"stats":{"Line":1}},{"line":52,"address":[28202742],"length":1,"stats":{"Line":1}},{"line":53,"address":[28202918,28202832],"length":1,"stats":{"Line":2}},{"line":130,"address":[28207984],"length":1,"stats":{"Line":1}},{"line":133,"address":[28208060,28208381],"length":1,"stats":{"Line":1}},{"line":144,"address":[28208358],"length":1,"stats":{"Line":1}},{"line":148,"address":[28213856],"length":1,"stats":{"Line":1}},{"line":149,"address":[28213877],"length":1,"stats":{"Line":1}},{"line":153,"address":[28205744,28206855,28206849],"length":1,"stats":{"Line":1}},{"line":154,"address":[28205827],"length":1,"stats":{"Line":1}},{"line":155,"address":[28205914,28205854],"length":1,"stats":{"Line":2}},{"line":156,"address":[28206070,28205986],"length":1,"stats":{"Line":2}},{"line":157,"address":[28206167,28206085],"length":1,"stats":{"Line":2}},{"line":160,"address":[28206229],"length":1,"stats":{"Line":1}},{"line":161,"address":[28206236],"length":1,"stats":{"Line":1}},{"line":162,"address":[28206245],"length":1,"stats":{"Line":1}},{"line":163,"address":[28206252],"length":1,"stats":{"Line":1}},{"line":164,"address":[28206316],"length":1,"stats":{"Line":1}},{"line":165,"address":[28206373],"length":1,"stats":{"Line":1}},{"line":166,"address":[28206411],"length":1,"stats":{"Line":1}},{"line":167,"address":[28206434],"length":1,"stats":{"Line":1}},{"line":168,"address":[28206539],"length":1,"stats":{"Line":1}},{"line":178,"address":[28204384],"length":1,"stats":{"Line":1}},{"line":179,"address":[28204397],"length":1,"stats":{"Line":1}},{"line":183,"address":[28204368,28204096],"length":1,"stats":{"Line":1}},{"line":184,"address":[28204147],"length":1,"stats":{"Line":1}},{"line":185,"address":[28204254],"length":1,"stats":{"Line":1}},{"line":189,"address":[28213830,28213408],"length":1,"stats":{"Line":1}},{"line":190,"address":[28213466],"length":1,"stats":{"Line":1}},{"line":193,"address":[28213476],"length":1,"stats":{"Line":1}},{"line":194,"address":[28213512,28213480],"length":1,"stats":{"Line":2}},{"line":195,"address":[28213532],"length":1,"stats":{"Line":1}},{"line":196,"address":[28213536,28213590],"length":1,"stats":{"Line":1}},{"line":197,"address":[28213676,28213733],"length":1,"stats":{"Line":1}},{"line":198,"address":[28213820],"length":1,"stats":{"Line":1}},{"line":203,"address":[28213072],"length":1,"stats":{"Line":1}},{"line":204,"address":[28213077],"length":1,"stats":{"Line":1}},{"line":208,"address":[28213088,28213396],"length":1,"stats":{"Line":1}},{"line":209,"address":[28213107],"length":1,"stats":{"Line":1}},{"line":210,"address":[28213179,28213111],"length":1,"stats":{"Line":1}},{"line":211,"address":[28213145],"length":1,"stats":{"Line":1}},{"line":212,"address":[28213197,28213159],"length":1,"stats":{"Line":1}},{"line":213,"address":[28213278,28213303],"length":1,"stats":{"Line":1}},{"line":214,"address":[28213380],"length":1,"stats":{"Line":1}},{"line":215,"address":[28213384],"length":1,"stats":{"Line":1}},{"line":219,"address":[28208512],"length":1,"stats":{"Line":1}},{"line":220,"address":[28208539],"length":1,"stats":{"Line":1}},{"line":221,"address":[28208566],"length":1,"stats":{"Line":1}},{"line":222,"address":[28208579],"length":1,"stats":{"Line":1}},{"line":226,"address":[28213037,28208592,28212947],"length":1,"stats":{"Line":1}},{"line":232,"address":[28208719],"length":1,"stats":{"Line":1}},{"line":233,"address":[28208759],"length":1,"stats":{"Line":0}},{"line":237,"address":[28208741],"length":1,"stats":{"Line":0}},{"line":240,"address":[28208845,28208944],"length":1,"stats":{"Line":2}},{"line":241,"address":[28208899,28208946],"length":1,"stats":{"Line":1}},{"line":243,"address":[28208878],"length":1,"stats":{"Line":1}},{"line":244,"address":[28209064],"length":1,"stats":{"Line":0}},{"line":248,"address":[28209046],"length":1,"stats":{"Line":0}},{"line":252,"address":[28208983],"length":1,"stats":{"Line":1}},{"line":253,"address":[28208993],"length":1,"stats":{"Line":1}},{"line":254,"address":[28209001],"length":1,"stats":{"Line":1}},{"line":256,"address":[28209027],"length":1,"stats":{"Line":1}},{"line":257,"address":[28209259,28209202],"length":1,"stats":{"Line":2}},{"line":258,"address":[28209331,28209430],"length":1,"stats":{"Line":2}},{"line":259,"address":[28209466],"length":1,"stats":{"Line":1}},{"line":260,"address":[28209495],"length":1,"stats":{"Line":1}},{"line":261,"address":[28209679],"length":1,"stats":{"Line":1}},{"line":263,"address":[28211606,28209686],"length":1,"stats":{"Line":2}},{"line":264,"address":[28209814,28212971],"length":1,"stats":{"Line":1}},{"line":265,"address":[28210038],"length":1,"stats":{"Line":1}},{"line":266,"address":[28210108,28210046],"length":1,"stats":{"Line":1}},{"line":267,"address":[28210192,28210213,28210083],"length":1,"stats":{"Line":2}},{"line":268,"address":[28210199],"length":1,"stats":{"Line":1}},{"line":269,"address":[28210231,28210342],"length":1,"stats":{"Line":1}},{"line":270,"address":[28210868],"length":1,"stats":{"Line":0}},{"line":281,"address":[28210774],"length":1,"stats":{"Line":1}},{"line":283,"address":[28210781],"length":1,"stats":{"Line":1}},{"line":285,"address":[28210789],"length":1,"stats":{"Line":1}},{"line":289,"address":[28211634,28209736],"length":1,"stats":{"Line":2}},{"line":290,"address":[28211641],"length":1,"stats":{"Line":1}},{"line":291,"address":[28211695],"length":1,"stats":{"Line":1}},{"line":293,"address":[28211699],"length":1,"stats":{"Line":1}},{"line":295,"address":[28212914,28211762],"length":1,"stats":{"Line":1}},{"line":297,"address":[28212256,28211964],"length":1,"stats":{"Line":1}},{"line":305,"address":[28212728],"length":1,"stats":{"Line":1}},{"line":306,"address":[28212216],"length":1,"stats":{"Line":1}},{"line":308,"address":[28212227,28212624],"length":1,"stats":{"Line":2}},{"line":309,"address":[28212656],"length":1,"stats":{"Line":1}},{"line":314,"address":[28205637,28205728,28204448],"length":1,"stats":{"Line":1}},{"line":315,"address":[28204517],"length":1,"stats":{"Line":1}},{"line":318,"address":[27694048,27694069],"length":1,"stats":{"Line":1}},{"line":319,"address":[28204615],"length":1,"stats":{"Line":1}},{"line":322,"address":[27694117,27694096],"length":1,"stats":{"Line":1}},{"line":323,"address":[28204795,28204733],"length":1,"stats":{"Line":2}},{"line":326,"address":[28204803],"length":1,"stats":{"Line":1}},{"line":328,"address":[28204905],"length":1,"stats":{"Line":1}},{"line":329,"address":[28204977],"length":1,"stats":{"Line":1}},{"line":331,"address":[28204995],"length":1,"stats":{"Line":1}},{"line":334,"address":[28205198,28205287],"length":1,"stats":{"Line":2}},{"line":335,"address":[28205312],"length":1,"stats":{"Line":1}},{"line":336,"address":[28205369],"length":1,"stats":{"Line":1}},{"line":337,"address":[28205499],"length":1,"stats":{"Line":1}},{"line":338,"address":[28205420],"length":1,"stats":{"Line":1}},{"line":340,"address":[28205468],"length":1,"stats":{"Line":1}},{"line":345,"address":[28203792,28204072],"length":1,"stats":{"Line":1}},{"line":346,"address":[28203825],"length":1,"stats":{"Line":1}},{"line":347,"address":[28203828],"length":1,"stats":{"Line":1}},{"line":348,"address":[28203855,28203880],"length":1,"stats":{"Line":1}},{"line":349,"address":[28203986,28203961],"length":1,"stats":{"Line":1}},{"line":350,"address":[28204063],"length":1,"stats":{"Line":1}},{"line":354,"address":[28207920],"length":1,"stats":{"Line":1}},{"line":355,"address":[28207940],"length":1,"stats":{"Line":1}},{"line":358,"address":[28207952],"length":1,"stats":{"Line":1}},{"line":361,"address":[28207968],"length":1,"stats":{"Line":1}},{"line":365,"address":[28208400],"length":1,"stats":{"Line":1}},{"line":366,"address":[28208419],"length":1,"stats":{"Line":1}},{"line":367,"address":[28208430],"length":1,"stats":{"Line":1}},{"line":370,"address":[28208489,28208444],"length":1,"stats":{"Line":2}},{"line":371,"address":[28208460,28208491],"length":1,"stats":{"Line":1}},{"line":376,"address":[28207744],"length":1,"stats":{"Line":1}},{"line":377,"address":[28207795],"length":1,"stats":{"Line":1}},{"line":380,"address":[28207841],"length":1,"stats":{"Line":1}},{"line":381,"address":[28207846],"length":1,"stats":{"Line":1}},{"line":385,"address":[28207858,28207813],"length":1,"stats":{"Line":2}},{"line":386,"address":[28207891],"length":1,"stats":{"Line":1}},{"line":387,"address":[28207896],"length":1,"stats":{"Line":1}},{"line":389,"address":[28207853],"length":1,"stats":{"Line":1}},{"line":396,"address":[28207713,28206880],"length":1,"stats":{"Line":1}},{"line":397,"address":[28207000,28206936,28207211],"length":1,"stats":{"Line":3}},{"line":398,"address":[28207078],"length":1,"stats":{"Line":1}},{"line":401,"address":[28207053,28207220,28207264],"length":1,"stats":{"Line":3}},{"line":402,"address":[28207275,28207503],"length":1,"stats":{"Line":0}},{"line":403,"address":[28207341],"length":1,"stats":{"Line":0}},{"line":405,"address":[28207512,28207309,28207708],"length":1,"stats":{"Line":0}},{"line":406,"address":[28207531],"length":1,"stats":{"Line":0}},{"line":409,"address":[28207236],"length":1,"stats":{"Line":1}},{"line":415,"address":[28225200],"length":1,"stats":{"Line":1}},{"line":420,"address":[28225213],"length":1,"stats":{"Line":1}},{"line":430,"address":[28213904],"length":1,"stats":{"Line":1}},{"line":431,"address":[28213925],"length":1,"stats":{"Line":1}},{"line":432,"address":[28214044,28213961],"length":1,"stats":{"Line":2}},{"line":433,"address":[28213988,28214079],"length":1,"stats":{"Line":2}},{"line":434,"address":[28214016,28214104],"length":1,"stats":{"Line":2}},{"line":439,"address":[28203680],"length":1,"stats":{"Line":1}},{"line":440,"address":[28203707],"length":1,"stats":{"Line":1}},{"line":442,"address":[28203743,28203724],"length":1,"stats":{"Line":2}},{"line":443,"address":[28203764],"length":1,"stats":{"Line":1}},{"line":445,"address":[28203738],"length":1,"stats":{"Line":1}},{"line":448,"address":[28203731],"length":1,"stats":{"Line":1}},{"line":453,"address":[28203667,28203661,28203296],"length":1,"stats":{"Line":1}},{"line":454,"address":[27694025,27694000],"length":1,"stats":{"Line":3}},{"line":455,"address":[28203404],"length":1,"stats":{"Line":1}},{"line":458,"address":[28203520],"length":1,"stats":{"Line":1}},{"line":459,"address":[28203423],"length":1,"stats":{"Line":1}},{"line":460,"address":[28203455],"length":1,"stats":{"Line":1}},{"line":462,"address":[28203606],"length":1,"stats":{"Line":1}},{"line":463,"address":[28203639],"length":1,"stats":{"Line":1}}],"covered":157,"coverable":166},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","stats.rs"],"content":"//! 计时器统计计算：今日/本周数据与目标进度。\n\nuse std::collections::BTreeMap;\n\nuse serde::{Deserialize, Serialize};\nuse ts_rs::TS;\n\nuse crate::app_data::{AppData, Phase};\n\n/// 标签计数条目。\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TagCount {\n    /// 标签名。\n    pub tag: String,\n    /// 完成次数。\n    pub count: u32,\n}\n\n/// 今日统计（总数 + 按标签分组）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct TodayStats {\n    /// 今日完成的番茄总数。\n    pub total: u32,\n    /// 按标签统计。\n    pub by_tag: Vec\u003cTagCount\u003e,\n}\n\n/// 本周统计（总数 + 按标签分组）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct WeekStats {\n    /// 本周完成的番茄总数。\n    pub total: u32,\n    /// 按标签统计。\n    pub by_tag: Vec\u003cTagCount\u003e,\n}\n\n/// 目标进度（每日/每周）。\n#[derive(Debug, Clone, Serialize, Deserialize, TS)]\n#[serde(rename_all = \"camelCase\")]\n#[ts(rename_all = \"camelCase\")]\npub struct GoalProgress {\n    /// 每日目标（0 表示未设置）。\n    pub daily_goal: u32,\n    /// 今日已完成。\n    pub daily_completed: u32,\n    /// 每周目标（0 表示未设置）。\n    pub weekly_goal: u32,\n    /// 本周已完成。\n    pub weekly_completed: u32,\n}\n\n/// 计算指定日期（YYYY-MM-DD）的“今日统计”（仅统计工作阶段记录）。\npub fn compute_today_stats(data: \u0026AppData, today: \u0026str) -\u003e TodayStats {\n    let mut map: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n    let mut total = 0u32;\n\n    if let Some(day) = data.history.iter().find(|d| d.date == today) {\n        for r in \u0026day.records {\n            if r.phase != Phase::Work {\n                continue;\n            }\n            total += 1;\n            *map.entry(r.tag.clone()).or_insert(0) += 1;\n        }\n    }\n\n    TodayStats {\n        total,\n        by_tag: map\n            .into_iter()\n            .map(|(tag, count)| TagCount { tag, count })\n            .collect(),\n    }\n}\n\n/// 计算闭区间 `[from, to]`（YYYY-MM-DD）的“本周统计”（仅统计工作阶段记录）。\npub fn compute_week_stats(data: \u0026AppData, from: \u0026str, to: \u0026str) -\u003e WeekStats {\n    let mut map: BTreeMap\u003cString, u32\u003e = BTreeMap::new();\n    let mut total = 0u32;\n\n    for day in \u0026data.history {\n        if day.date.as_str() \u003c from || day.date.as_str() \u003e to {\n            continue;\n        }\n        for r in \u0026day.records {\n            if r.phase != Phase::Work {\n                continue;\n            }\n            total += 1;\n            *map.entry(r.tag.clone()).or_insert(0) += 1;\n        }\n    }\n\n    WeekStats {\n        total,\n        by_tag: map\n            .into_iter()\n            .map(|(tag, count)| TagCount { tag, count })\n            .collect(),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::app_data::{HistoryDay, HistoryRecord};\n\n    /// 构造一条测试用历史记录（默认仅填充必要字段）。\n    fn record(tag: \u0026str, phase: Phase) -\u003e HistoryRecord {\n        HistoryRecord {\n            tag: tag.to_string(),\n            start_time: \"09:00\".to_string(),\n            end_time: Some(\"09:25\".to_string()),\n            duration: 25,\n            phase,\n            remark: String::new(),\n        }\n    }\n\n    /// `compute_today_stats` 只统计工作阶段，并按标签汇总。\n    #[test]\n    fn compute_today_stats_counts_only_work() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![\n                    record(\"学习\", Phase::Work),\n                    record(\"工作\", Phase::Work),\n                    record(\"学习\", Phase::Work),\n                    record(\"短休息\", Phase::ShortBreak),\n                ],\n            }],\n            ..AppData::default()\n        };\n\n        let out = compute_today_stats(\u0026data, \"2025-01-01\");\n        assert_eq!(out.total, 3);\n        assert_eq!(\n            out.by_tag,\n            vec![\n                TagCount {\n                    tag: \"学习\".to_string(),\n                    count: 2\n                },\n                TagCount {\n                    tag: \"工作\".to_string(),\n                    count: 1\n                }\n            ]\n        );\n    }\n\n    /// `compute_week_stats` 按日期闭区间聚合，并忽略区间外的天。\n    #[test]\n    fn compute_week_stats_respects_range() {\n        let data = AppData {\n            history: vec![\n                HistoryDay {\n                    date: \"2025-01-01\".to_string(),\n                    records: vec![record(\"A\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-03\".to_string(),\n                    records: vec![record(\"A\", Phase::Work), record(\"B\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-10\".to_string(),\n                    records: vec![record(\"A\", Phase::Work)],\n                },\n            ],\n            ..AppData::default()\n        };\n\n        let out = compute_week_stats(\u0026data, \"2025-01-01\", \"2025-01-07\");\n        assert_eq!(out.total, 3);\n        assert_eq!(out.by_tag, vec![TagCount { tag: \"A\".to_string(), count: 2 }, TagCount { tag: \"B\".to_string(), count: 1 }]);\n    }\n\n    /// `compute_today_stats`：当指定日期不存在时应返回 0 与空分组。\n    #[test]\n    fn compute_today_stats_returns_zero_when_missing_day() {\n        let data = AppData {\n            history: vec![HistoryDay {\n                date: \"2025-01-01\".to_string(),\n                records: vec![record(\"A\", Phase::Work)],\n            }],\n            ..AppData::default()\n        };\n\n        let out = compute_today_stats(\u0026data, \"2025-01-02\");\n        assert_eq!(out.total, 0);\n        assert!(out.by_tag.is_empty());\n    }\n\n    /// `compute_week_stats`：应包含闭区间边界日期（from/to 当天）。\n    #[test]\n    fn compute_week_stats_includes_boundary_days() {\n        let data = AppData {\n            history: vec![\n                HistoryDay {\n                    date: \"2025-01-01\".to_string(),\n                    records: vec![record(\"A\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-07\".to_string(),\n                    records: vec![record(\"B\", Phase::Work)],\n                },\n                HistoryDay {\n                    date: \"2025-01-08\".to_string(),\n                    records: vec![record(\"C\", Phase::Work)],\n                },\n            ],\n            ..AppData::default()\n        };\n\n        let out = compute_week_stats(\u0026data, \"2025-01-01\", \"2025-01-07\");\n        assert_eq!(out.total, 2);\n        assert_eq!(\n            out.by_tag,\n            vec![\n                TagCount {\n                    tag: \"A\".to_string(),\n                    count: 1\n                },\n                TagCount {\n                    tag: \"B\".to_string(),\n                    count: 1\n                }\n            ]\n        );\n    }\n}\n","traces":[{"line":59,"address":[33768389,33768361,33767520],"length":1,"stats":{"Line":1}},{"line":60,"address":[33767566],"length":1,"stats":{"Line":1}},{"line":61,"address":[33767600],"length":1,"stats":{"Line":1}},{"line":63,"address":[31168721,31168704],"length":1,"stats":{"Line":4}},{"line":64,"address":[33767928,33767820,33768224],"length":1,"stats":{"Line":3}},{"line":65,"address":[33768033],"length":1,"stats":{"Line":1}},{"line":68,"address":[33768120,33768065],"length":1,"stats":{"Line":1}},{"line":69,"address":[33768164,33768101,33768229],"length":1,"stats":{"Line":2}},{"line":75,"address":[33767852],"length":1,"stats":{"Line":1}},{"line":83,"address":[33767485,33767513,33766448],"length":1,"stats":{"Line":1}},{"line":84,"address":[33766519],"length":1,"stats":{"Line":1}},{"line":85,"address":[33766556],"length":1,"stats":{"Line":1}},{"line":87,"address":[33766567,33766651],"length":1,"stats":{"Line":2}},{"line":88,"address":[33766752,33766976],"length":1,"stats":{"Line":2}},{"line":91,"address":[33767135,33767462],"length":1,"stats":{"Line":2}},{"line":92,"address":[33767271],"length":1,"stats":{"Line":1}},{"line":95,"address":[33767303,33767358],"length":1,"stats":{"Line":1}},{"line":96,"address":[33767467,33767339,33767402],"length":1,"stats":{"Line":2}},{"line":102,"address":[33766783],"length":1,"stats":{"Line":1}}],"covered":19,"coverable":19},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","timer","validation.rs"],"content":"//! 设置参数校验（用于后端命令统一验证）。\n\nuse crate::app_data::Settings;\nuse crate::errors::{AppError, AppResult};\n\n/// 校验并规范化设置参数（同时满足 PRD 的范围约束）。\npub fn validate_settings(settings: \u0026Settings) -\u003e AppResult\u003c()\u003e {\n    if !(1..=60).contains(\u0026settings.pomodoro) {\n        return Err(AppError::Validation(\"番茄时长需在 1-60 分钟\".to_string()));\n    }\n    if !(1..=30).contains(\u0026settings.short_break) {\n        return Err(AppError::Validation(\"短休息需在 1-30 分钟\".to_string()));\n    }\n    if !(1..=60).contains(\u0026settings.long_break) {\n        return Err(AppError::Validation(\"长休息需在 1-60 分钟\".to_string()));\n    }\n    if !(1..=10).contains(\u0026settings.long_break_interval) {\n        return Err(AppError::Validation(\"长休息间隔需在 1-10 个番茄\".to_string()));\n    }\n    if !(1..=20).contains(\u0026settings.auto_continue_pomodoros) {\n        return Err(AppError::Validation(\n            \"连续番茄数量需在 1-20 个番茄\".to_string(),\n        ));\n    }\n    if settings.daily_goal \u003e 1000 {\n        return Err(AppError::Validation(\"每日目标建议不超过 1000\".to_string()));\n    }\n    if settings.weekly_goal \u003e 10000 {\n        return Err(AppError::Validation(\"每周目标建议不超过 10000\".to_string()));\n    }\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// 校验：合法边界应通过。\n    #[test]\n    fn validate_settings_accepts_valid_ranges() {\n        let settings = Settings {\n            pomodoro: 1,\n            short_break: 1,\n            long_break: 1,\n            long_break_interval: 1,\n            auto_continue_enabled: true,\n            auto_continue_pomodoros: 1,\n            daily_goal: 0,\n            weekly_goal: 0,\n            always_on_top: false,\n        };\n        assert!(validate_settings(\u0026settings).is_ok());\n    }\n\n    /// 校验：非法范围应返回 `Validation` 错误。\n    #[test]\n    fn validate_settings_rejects_out_of_range() {\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                pomodoro: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                pomodoro: 61,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                short_break: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                short_break: 31,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                long_break_interval: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                long_break_interval: 11,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n\n    /// 校验：连续番茄数量超出范围应失败。\n    #[test]\n    fn validate_settings_rejects_auto_continue_pomodoros_out_of_range() {\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                auto_continue_pomodoros: 0,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                auto_continue_pomodoros: 21,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n\n    /// 校验：每日/每周目标过大应失败（用于防御性约束）。\n    #[test]\n    fn validate_settings_rejects_excessive_goals() {\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                daily_goal: 1001,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n        assert!(matches!(\n            validate_settings(\u0026Settings {\n                weekly_goal: 10001,\n                ..Settings::default()\n            }),\n            Err(AppError::Validation(_))\n        ));\n    }\n}\n","traces":[{"line":7,"address":[33879664],"length":1,"stats":{"Line":1}},{"line":8,"address":[33879694],"length":1,"stats":{"Line":1}},{"line":9,"address":[33879710],"length":1,"stats":{"Line":1}},{"line":11,"address":[33879799],"length":1,"stats":{"Line":1}},{"line":12,"address":[33879834],"length":1,"stats":{"Line":1}},{"line":14,"address":[33879941],"length":1,"stats":{"Line":1}},{"line":15,"address":[33879961],"length":1,"stats":{"Line":0}},{"line":17,"address":[33880080],"length":1,"stats":{"Line":1}},{"line":18,"address":[33880100],"length":1,"stats":{"Line":1}},{"line":20,"address":[33880219],"length":1,"stats":{"Line":1}},{"line":21,"address":[33880270],"length":1,"stats":{"Line":1}},{"line":22,"address":[33880239],"length":1,"stats":{"Line":1}},{"line":25,"address":[33880358],"length":1,"stats":{"Line":1}},{"line":26,"address":[33880387],"length":1,"stats":{"Line":1}},{"line":28,"address":[33880372],"length":1,"stats":{"Line":1}},{"line":29,"address":[33880518],"length":1,"stats":{"Line":1}},{"line":31,"address":[33880506],"length":1,"stats":{"Line":1}}],"covered":16,"coverable":17},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","tray.rs"],"content":"//! 系统托盘：最小化到托盘、托盘菜单、以及“剩余时间”动态图标。\nuse tauri::image::Image;\nuse tauri::menu::{Menu, MenuItem};\nuse tauri::tray::{TrayIcon, TrayIconBuilder};\nuse tauri::Manager as _;\n\nuse crate::app_data::Phase;\nuse crate::errors::{AppError, AppResult};\nuse crate::state::AppState;\n\n/// 托盘菜单项 id：开始。\nconst MENU_START_ID: \u0026str = \"tray.start\";\n/// 托盘菜单项 id：暂停。\nconst MENU_PAUSE_ID: \u0026str = \"tray.pause\";\n/// 托盘菜单项 id：显示窗口。\nconst MENU_SHOW_ID: \u0026str = \"tray.show\";\n/// 托盘菜单项 id：退出。\nconst MENU_QUIT_ID: \u0026str = \"tray.quit\";\n\n/// 托盘句柄集合（包含 `TrayIcon` 与需要动态更新的菜单项）。\n#[derive(Clone)]\npub struct TrayHandles {\n    /// 托盘图标句柄。\n    pub tray: TrayIcon\u003ctauri::Wry\u003e,\n    /// “开始”菜单项。\n    pub start_item: MenuItem\u003ctauri::Wry\u003e,\n    /// “暂停”菜单项。\n    pub pause_item: MenuItem\u003ctauri::Wry\u003e,\n}\n\n/// 创建托盘与菜单，并写入 `AppState`。\npub fn setup_tray(app: \u0026mut tauri::App) -\u003e AppResult\u003c()\u003e {\n    let state = app.state::\u003cAppState\u003e();\n    let snapshot = state.timer_snapshot();\n    let initial_text = format_mm_ss(snapshot.remaining_seconds);\n\n    let menu = Menu::new(app)?;\n    let start_item = MenuItem::with_id(app, MENU_START_ID, \"开始\", true, None::\u003c\u0026str\u003e)?;\n    let pause_item = MenuItem::with_id(app, MENU_PAUSE_ID, \"暂停\", true, None::\u003c\u0026str\u003e)?;\n    let show_item = MenuItem::with_id(app, MENU_SHOW_ID, \"显示窗口\", true, None::\u003c\u0026str\u003e)?;\n    let quit_item = MenuItem::with_id(app, MENU_QUIT_ID, \"退出\", true, None::\u003c\u0026str\u003e)?;\n    menu.append_items(\u0026[\u0026start_item, \u0026pause_item, \u0026show_item, \u0026quit_item])?;\n\n    let initial_icon = build_tray_icon_rgba(\u0026initial_text, snapshot.phase, snapshot.is_running)?;\n    let tray = TrayIconBuilder::new()\n        .menu(\u0026menu)\n        // 禁用“左键显示托盘菜单”：避免左键点击时系统菜单闪现（我们仅在左键时显示主窗口）。\n        .show_menu_on_left_click(false)\n        .icon(Image::new_owned(initial_icon, 32, 32))\n        .tooltip(\"番茄钟\")\n        .on_menu_event(|app_handle, event| {\n            let state = app_handle.state::\u003cAppState\u003e();\n            let id = event.id().as_ref();\n\n            match id {\n                MENU_START_ID =\u003e {\n                    let _ = crate::commands::timer::timer_start_inner(\u0026state);\n                }\n                MENU_PAUSE_ID =\u003e {\n                    let _ = crate::commands::timer::timer_pause_inner(\u0026state);\n                }\n                MENU_SHOW_ID =\u003e {\n                    if let Some(window) = app_handle.get_webview_window(\"main\") {\n                        let _ = window.show();\n                        let _ = window.set_focus();\n                    }\n                }\n                MENU_QUIT_ID =\u003e {\n                    app_handle.exit(0);\n                }\n                _ =\u003e {}\n            }\n        })\n        .on_tray_icon_event(|tray, event| {\n            // 仅在“左键单击”时显示窗口：避免右键弹出菜单时也触发显示，导致菜单与窗口同时出现。\n            if let tauri::tray::TrayIconEvent::Click {\n                button,\n                button_state,\n                ..\n            } = event\n            {\n                if button == tauri::tray::MouseButton::Left\n                    \u0026\u0026 button_state == tauri::tray::MouseButtonState::Up\n                {\n                    if let Some(window) = tray.app_handle().get_webview_window(\"main\") {\n                        let _ = window.show();\n                        let _ = window.set_focus();\n                    }\n                }\n            }\n        })\n        .build(app)?;\n\n    state.set_tray(TrayHandles {\n        tray: tray.clone(),\n        start_item: start_item.clone(),\n        pause_item: pause_item.clone(),\n    });\n\n    let _ = refresh_tray(\u0026state);\n    Ok(())\n}\n\n/// 刷新托盘显示（图标与菜单启用状态）。\npub fn refresh_tray(state: \u0026AppState) -\u003e AppResult\u003c()\u003e {\n    let Some(handles) = state.tray() else {\n        return Ok(());\n    };\n    let snapshot = state.timer_snapshot();\n\n    let text = format_mm_ss(snapshot.remaining_seconds);\n    let rgba = build_tray_icon_rgba(\u0026text, snapshot.phase, snapshot.is_running)?;\n    handles\n        .tray\n        .set_icon(Some(Image::new_owned(rgba, 32, 32)))?;\n\n    // 启用状态：运行中只能暂停；未运行只能开始。\n    let _ = handles.start_item.set_enabled(!snapshot.is_running);\n    let _ = handles.pause_item.set_enabled(snapshot.is_running);\n\n    Ok(())\n}\n\n/// 将秒数格式化为 `mm:ss`。\nfn format_mm_ss(seconds: u64) -\u003e String {\n    let m = seconds / 60;\n    let s = seconds % 60;\n    format!(\"{:02}:{:02}\", m.min(99), s)\n}\n\n/// 构建托盘图标 RGBA（32x32），用 7 段数码管样式绘制 `mm:ss`。\nfn build_tray_icon_rgba(text: \u0026str, phase: Phase, is_running: bool) -\u003e AppResult\u003cVec\u003cu8\u003e\u003e {\n    if text.len() != 5 || text.as_bytes()[2] != b':' {\n        return Err(AppError::Invariant(\"托盘时间文本必须为 mm:ss\".to_string()));\n    }\n\n    let bg = match phase {\n        Phase::Work =\u003e [255u8, 59u8, 48u8, 255u8],\n        Phase::ShortBreak =\u003e [52u8, 199u8, 89u8, 255u8],\n        Phase::LongBreak =\u003e [0u8, 122u8, 255u8, 255u8],\n    };\n    let fg = if is_running {\n        [255u8, 255u8, 255u8, 255u8]\n    } else {\n        [255u8, 255u8, 255u8, 220u8]\n    };\n\n    let mut rgba = vec![0u8; 32 * 32 * 4];\n    fill_round_rect(\u0026mut rgba, 32, 32, 2, 2, 28, 28, 8, bg);\n\n    let bytes = text.as_bytes();\n    let d0 = bytes[0] - b'0';\n    let d1 = bytes[1] - b'0';\n    let d2 = bytes[3] - b'0';\n    let d3 = bytes[4] - b'0';\n\n    draw_digit(\u0026mut rgba, 32, 32, 4, 8, d0, fg);\n    draw_digit(\u0026mut rgba, 32, 32, 11, 8, d1, fg);\n    draw_colon(\u0026mut rgba, 32, 32, 18, 10, fg);\n    draw_digit(\u0026mut rgba, 32, 32, 20, 8, d2, fg);\n    draw_digit(\u0026mut rgba, 32, 32, 27, 8, d3, fg);\n\n    Ok(rgba)\n}\n\n/// 绘制 7 段数字（0-9）。\nfn draw_digit(buf: \u0026mut [u8], w: u32, h: u32, x: i32, y: i32, d: u8, color: [u8; 4]) {\n    let seg = digit_segments(d);\n\n    // 每段用小矩形表示（坐标相对 digit 原点）。\n    if seg \u0026 0b0000001 != 0 {\n        fill_rect(buf, w, h, x + 1, y, 4, 1, color); // a\n    }\n    if seg \u0026 0b0000010 != 0 {\n        fill_rect(buf, w, h, x + 5, y + 1, 1, 3, color); // b\n    }\n    if seg \u0026 0b0000100 != 0 {\n        fill_rect(buf, w, h, x + 5, y + 5, 1, 3, color); // c\n    }\n    if seg \u0026 0b0001000 != 0 {\n        fill_rect(buf, w, h, x + 1, y + 8, 4, 1, color); // d\n    }\n    if seg \u0026 0b0010000 != 0 {\n        fill_rect(buf, w, h, x, y + 5, 1, 3, color); // e\n    }\n    if seg \u0026 0b0100000 != 0 {\n        fill_rect(buf, w, h, x, y + 1, 1, 3, color); // f\n    }\n    if seg \u0026 0b1000000 != 0 {\n        fill_rect(buf, w, h, x + 1, y + 4, 4, 1, color); // g\n    }\n}\n\n/// 绘制冒号。\nfn draw_colon(buf: \u0026mut [u8], w: u32, h: u32, x: i32, y: i32, color: [u8; 4]) {\n    fill_rect(buf, w, h, x, y, 2, 2, color);\n    fill_rect(buf, w, h, x, y + 6, 2, 2, color);\n}\n\n/// 数字到 7 段（abcdefg）映射，返回位图。\nfn digit_segments(d: u8) -\u003e u8 {\n    match d {\n        0 =\u003e 0b0111111,\n        1 =\u003e 0b0000110,\n        2 =\u003e 0b1011011,\n        3 =\u003e 0b1001111,\n        4 =\u003e 0b1100110,\n        5 =\u003e 0b1101101,\n        6 =\u003e 0b1111101,\n        7 =\u003e 0b0000111,\n        8 =\u003e 0b1111111,\n        9 =\u003e 0b1101111,\n        _ =\u003e 0b0000000,\n    }\n}\n\n/// 填充矩形（RGBA 覆盖）。\n#[allow(clippy::too_many_arguments)]\nfn fill_rect(buf: \u0026mut [u8], w: u32, h: u32, x: i32, y: i32, rw: i32, rh: i32, c: [u8; 4]) {\n    for yy in y.max(0)..(y + rh).min(h as i32) {\n        for xx in x.max(0)..(x + rw).min(w as i32) {\n            let idx = ((yy as u32 * w + xx as u32) * 4) as usize;\n            buf[idx..idx + 4].copy_from_slice(\u0026c);\n        }\n    }\n}\n\n/// 填充圆角矩形（简单圆角裁切）。\n#[allow(clippy::too_many_arguments)]\nfn fill_round_rect(\n    buf: \u0026mut [u8],\n    w: u32,\n    h: u32,\n    x: i32,\n    y: i32,\n    rw: i32,\n    rh: i32,\n    r: i32,\n    c: [u8; 4],\n) {\n    for yy in y.max(0)..(y + rh).min(h as i32) {\n        for xx in x.max(0)..(x + rw).min(w as i32) {\n            let inside = is_inside_rounded_rect(xx - x, yy - y, rw, rh, r);\n            if inside {\n                let idx = ((yy as u32 * w + xx as u32) * 4) as usize;\n                buf[idx..idx + 4].copy_from_slice(\u0026c);\n            }\n        }\n    }\n}\n\n/// 判断像素点是否在圆角矩形内。\nfn is_inside_rounded_rect(px: i32, py: i32, w: i32, h: i32, r: i32) -\u003e bool {\n    let rx = px.clamp(0, w - 1);\n    let ry = py.clamp(0, h - 1);\n\n    // 中间矩形区域\n    if (r..(w - r)).contains(\u0026rx) || (r..(h - r)).contains(\u0026ry) {\n        return true;\n    }\n\n    // 四个角做圆形裁剪\n    let (cx, cy) = if rx \u003c r \u0026\u0026 ry \u003c r {\n        (r, r)\n    } else if rx \u003e= w - r \u0026\u0026 ry \u003c r {\n        (w - r - 1, r)\n    } else if rx \u003c r \u0026\u0026 ry \u003e= h - r {\n        (r, h - r - 1)\n    } else {\n        (w - r - 1, h - r - 1)\n    };\n\n    let dx = rx - cx;\n    let dy = ry - cy;\n    dx * dx + dy * dy \u003c= r * r\n}\n","traces":[{"line":32,"address":[28333840,28337185,28336997],"length":1,"stats":{"Line":0}},{"line":33,"address":[28333893],"length":1,"stats":{"Line":0}},{"line":34,"address":[28333930],"length":1,"stats":{"Line":0}},{"line":35,"address":[28333951],"length":1,"stats":{"Line":0}},{"line":37,"address":[28334027,28334091,28337165],"length":1,"stats":{"Line":0}},{"line":38,"address":[28337144,28334242,28334359],"length":1,"stats":{"Line":0}},{"line":39,"address":[28334623,28337123,28334510],"length":1,"stats":{"Line":0}},{"line":40,"address":[28334774,28337106,28334887],"length":1,"stats":{"Line":0}},{"line":41,"address":[28337089,28335151,28335038],"length":1,"stats":{"Line":0}},{"line":42,"address":[28335305,28335476,28337072],"length":1,"stats":{"Line":0}},{"line":44,"address":[28335626,28337055],"length":1,"stats":{"Line":0}},{"line":45,"address":[28336137,28337003,28336397,28335910,28336309],"length":1,"stats":{"Line":0}},{"line":46,"address":[28335982],"length":1,"stats":{"Line":0}},{"line":49,"address":[28336096,28336022,28336169,28337023],"length":1,"stats":{"Line":0}},{"line":51,"address":[28336235],"length":1,"stats":{"Line":0}},{"line":52,"address":[29738733,29738670],"length":1,"stats":{"Line":0}},{"line":53,"address":[29738741],"length":1,"stats":{"Line":0}},{"line":56,"address":[29738825],"length":1,"stats":{"Line":0}},{"line":57,"address":[29739357,29738899],"length":1,"stats":{"Line":0}},{"line":59,"address":[29738868,29738918],"length":1,"stats":{"Line":0}},{"line":60,"address":[29738965,29739319],"length":1,"stats":{"Line":0}},{"line":62,"address":[29738984,29738934],"length":1,"stats":{"Line":0}},{"line":63,"address":[29739100,29739028],"length":1,"stats":{"Line":0}},{"line":64,"address":[29739221,29739174],"length":1,"stats":{"Line":0}},{"line":65,"address":[29739256],"length":1,"stats":{"Line":0}},{"line":68,"address":[29739000,29739059],"length":1,"stats":{"Line":0}},{"line":69,"address":[29739091],"length":1,"stats":{"Line":0}},{"line":74,"address":[28336258],"length":1,"stats":{"Line":0}},{"line":76,"address":[29738196],"length":1,"stats":{"Line":0}},{"line":77,"address":[29738207],"length":1,"stats":{"Line":0}},{"line":78,"address":[29738214],"length":1,"stats":{"Line":0}},{"line":80,"address":[29738193],"length":1,"stats":{"Line":0}},{"line":82,"address":[29738308,29738221],"length":1,"stats":{"Line":0}},{"line":83,"address":[29738314],"length":1,"stats":{"Line":0}},{"line":85,"address":[29738352],"length":1,"stats":{"Line":0}},{"line":86,"address":[29738514,29738467],"length":1,"stats":{"Line":0}},{"line":87,"address":[29738549],"length":1,"stats":{"Line":0}},{"line":92,"address":[28336349,28336286],"length":1,"stats":{"Line":0}},{"line":94,"address":[28336500,28336735],"length":1,"stats":{"Line":0}},{"line":95,"address":[28336568],"length":1,"stats":{"Line":0}},{"line":96,"address":[28336583,28336637],"length":1,"stats":{"Line":0}},{"line":97,"address":[28336653],"length":1,"stats":{"Line":0}},{"line":100,"address":[28336791],"length":1,"stats":{"Line":0}},{"line":101,"address":[28336843],"length":1,"stats":{"Line":0}},{"line":105,"address":[28337520,28338637,28338672],"length":1,"stats":{"Line":0}},{"line":106,"address":[28337550],"length":1,"stats":{"Line":0}},{"line":107,"address":[28337651],"length":1,"stats":{"Line":0}},{"line":109,"address":[28337639],"length":1,"stats":{"Line":0}},{"line":111,"address":[28337700],"length":1,"stats":{"Line":0}},{"line":112,"address":[28338643,28337836,28337768],"length":1,"stats":{"Line":0}},{"line":113,"address":[28338586,28338260,28338377],"length":1,"stats":{"Line":0}},{"line":115,"address":[28338200,28338085,28338329],"length":1,"stats":{"Line":0}},{"line":118,"address":[28338402],"length":1,"stats":{"Line":0}},{"line":119,"address":[28338459],"length":1,"stats":{"Line":0}},{"line":121,"address":[28338514],"length":1,"stats":{"Line":0}},{"line":125,"address":[28337200],"length":1,"stats":{"Line":0}},{"line":126,"address":[28337233],"length":1,"stats":{"Line":0}},{"line":127,"address":[28337259],"length":1,"stats":{"Line":0}},{"line":128,"address":[28337274],"length":1,"stats":{"Line":0}},{"line":132,"address":[28341603,28341609,28339600],"length":1,"stats":{"Line":0}},{"line":133,"address":[28339898,28339710],"length":1,"stats":{"Line":0}},{"line":134,"address":[28339773],"length":1,"stats":{"Line":0}},{"line":137,"address":[28339942],"length":1,"stats":{"Line":0}},{"line":138,"address":[28339979],"length":1,"stats":{"Line":0}},{"line":139,"address":[28340013],"length":1,"stats":{"Line":0}},{"line":140,"address":[28340047],"length":1,"stats":{"Line":0}},{"line":142,"address":[28340086,28340124],"length":1,"stats":{"Line":0}},{"line":143,"address":[28340126],"length":1,"stats":{"Line":0}},{"line":145,"address":[28340092],"length":1,"stats":{"Line":0}},{"line":148,"address":[28340296,28340158],"length":1,"stats":{"Line":0}},{"line":149,"address":[28340269,28340369],"length":1,"stats":{"Line":0}},{"line":151,"address":[28340469],"length":1,"stats":{"Line":0}},{"line":152,"address":[28340518,28340607],"length":1,"stats":{"Line":0}},{"line":153,"address":[28340633,28340595,28340707],"length":1,"stats":{"Line":0}},{"line":154,"address":[28340695,28340813,28340736],"length":1,"stats":{"Line":0}},{"line":155,"address":[28340931,28340842,28340801],"length":1,"stats":{"Line":0}},{"line":157,"address":[28340902,28340966],"length":1,"stats":{"Line":0}},{"line":158,"address":[28341038],"length":1,"stats":{"Line":0}},{"line":159,"address":[28341153],"length":1,"stats":{"Line":0}},{"line":160,"address":[28341258],"length":1,"stats":{"Line":0}},{"line":161,"address":[28341373],"length":1,"stats":{"Line":0}},{"line":163,"address":[28341496],"length":1,"stats":{"Line":0}},{"line":167,"address":[28332656],"length":1,"stats":{"Line":0}},{"line":168,"address":[28332761],"length":1,"stats":{"Line":0}},{"line":171,"address":[28332780],"length":1,"stats":{"Line":0}},{"line":172,"address":[28332805],"length":1,"stats":{"Line":0}},{"line":174,"address":[28332790],"length":1,"stats":{"Line":0}},{"line":175,"address":[28332938],"length":1,"stats":{"Line":0}},{"line":177,"address":[28332919],"length":1,"stats":{"Line":0}},{"line":178,"address":[28333105],"length":1,"stats":{"Line":0}},{"line":180,"address":[28333086],"length":1,"stats":{"Line":0}},{"line":181,"address":[28333273],"length":1,"stats":{"Line":0}},{"line":183,"address":[28333254],"length":1,"stats":{"Line":0}},{"line":184,"address":[28333433],"length":1,"stats":{"Line":0}},{"line":186,"address":[28333421],"length":1,"stats":{"Line":0}},{"line":187,"address":[28333560],"length":1,"stats":{"Line":0}},{"line":189,"address":[28333548],"length":1,"stats":{"Line":0}},{"line":190,"address":[28333682],"length":1,"stats":{"Line":0}},{"line":195,"address":[28332416],"length":1,"stats":{"Line":0}},{"line":196,"address":[28332494],"length":1,"stats":{"Line":0}},{"line":197,"address":[28332543,28332634],"length":1,"stats":{"Line":0}},{"line":201,"address":[28338688],"length":1,"stats":{"Line":0}},{"line":202,"address":[28338695],"length":1,"stats":{"Line":0}},{"line":203,"address":[28338735],"length":1,"stats":{"Line":0}},{"line":204,"address":[28338742],"length":1,"stats":{"Line":0}},{"line":205,"address":[28338749],"length":1,"stats":{"Line":0}},{"line":206,"address":[28338756],"length":1,"stats":{"Line":0}},{"line":207,"address":[28338763],"length":1,"stats":{"Line":0}},{"line":208,"address":[28338770],"length":1,"stats":{"Line":0}},{"line":209,"address":[28338777],"length":1,"stats":{"Line":0}},{"line":210,"address":[28338784],"length":1,"stats":{"Line":0}},{"line":211,"address":[28338791],"length":1,"stats":{"Line":0}},{"line":212,"address":[28338798],"length":1,"stats":{"Line":0}},{"line":213,"address":[28338728],"length":1,"stats":{"Line":0}},{"line":219,"address":[28342752],"length":1,"stats":{"Line":0}},{"line":220,"address":[28342971,28342886],"length":1,"stats":{"Line":0}},{"line":221,"address":[28343021,28343072,28343113],"length":1,"stats":{"Line":0}},{"line":222,"address":[28343183,28343304],"length":1,"stats":{"Line":0}},{"line":223,"address":[28343285,28343337],"length":1,"stats":{"Line":0}},{"line":230,"address":[28338816],"length":1,"stats":{"Line":0}},{"line":241,"address":[28338963,28339048],"length":1,"stats":{"Line":0}},{"line":242,"address":[28339196,28339098,28339149],"length":1,"stats":{"Line":0}},{"line":243,"address":[28339357,28339265],"length":1,"stats":{"Line":0}},{"line":244,"address":[28339348],"length":1,"stats":{"Line":0}},{"line":245,"address":[28339498,28339378],"length":1,"stats":{"Line":0}},{"line":246,"address":[28339530,28339479],"length":1,"stats":{"Line":0}},{"line":253,"address":[28341632],"length":1,"stats":{"Line":0}},{"line":254,"address":[28341746,28341696],"length":1,"stats":{"Line":0}},{"line":255,"address":[28341733,28341767,28341802],"length":1,"stats":{"Line":0}},{"line":258,"address":[28341908,28341789,28341823],"length":1,"stats":{"Line":0}},{"line":259,"address":[28341890],"length":1,"stats":{"Line":0}},{"line":263,"address":[28342323,28341964,28342019,28341995],"length":1,"stats":{"Line":0}},{"line":264,"address":[28342005],"length":1,"stats":{"Line":0}},{"line":265,"address":[28342028,28342498,28342065,28341978],"length":1,"stats":{"Line":0}},{"line":266,"address":[28342503,28342450,28342079],"length":1,"stats":{"Line":0}},{"line":267,"address":[28342128,28342308,28342431,28342053],"length":1,"stats":{"Line":0}},{"line":268,"address":[28342172,28342383,28342433],"length":1,"stats":{"Line":0}},{"line":270,"address":[28342196,28342310,28342107],"length":1,"stats":{"Line":0}},{"line":273,"address":[28342355,28342548,28342524],"length":1,"stats":{"Line":0}},{"line":274,"address":[28342531,28342590,28342569],"length":1,"stats":{"Line":0}},{"line":275,"address":[28342607,28342720,28342576],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":141},{"path":["/","home","code","workspace","pomodoro-technique","src-tauri","src","typegen.rs"],"content":"//! TypeScript 类型生成用的“公共重导出”模块（用于 `ts-rs` 的 typegen 工具）。\n\npub use crate::analysis::{FocusAnalysis, TagEfficiency};\npub use crate::app_data::{\n    AppData, BlacklistItem, BlacklistTemplate, DateRange, HistoryDay, HistoryRecord, Phase,\n    Settings,\n};\npub use crate::commands::types::{AppSnapshot, ExportField, ExportFormat, ExportRequest, StorePaths};\npub use crate::processes::{KillSummary, ProcessInfo};\npub use crate::processes::termination::KillItem;\npub use crate::timer::{TimerSnapshot, WorkCompletedEvent};\npub use crate::timer::stats::{GoalProgress, TagCount, TodayStats, WeekStats};\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, '🌙'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '🌙';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '☀️';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '🌙';
    }
  });
})();
</script>
</body>
</html>